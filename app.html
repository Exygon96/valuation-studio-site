<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Valuation Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS â€” Warm Paper / Old New York
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #f4f0e8;
  --surface:   #faf8f4;
  --surface-2: #f0ece2;
  --border:    rgba(26,24,20,.1);
  --border-2:  rgba(26,24,20,.06);

  --ink:       #1a1814;
  --ink-2:     #2e2b26;
  --ink-3:     #4a4640;
  --ink-4:     #8a857c;
  --ink-5:     #b8b2a8;

  --blue:      #1a5c98;
  --blue-b:    #1a4a7a;
  --blue-bg:   #e8f0f8;

  --green:     #1a7a3c;
  --green-bg:  #e8f5ec;
  --green-dk:  #14612e;
  --red:       #c0392b;
  --red-bg:    #fdf0ee;
  --red-dk:    #922b21;

  --gold:      #b07d2e;
  --gold-bg:   #f8f0dc;

  --ff: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --ff-head: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --ff-mono: 'DM Mono', 'SF Mono', monospace;
  --r: 10px;
  --r-sm: 7px;
  --sidebar-w: 288px;
  --header-h: 52px;
  --shadow: 0 1px 3px rgba(26,24,20,.07), 0 1px 2px rgba(26,24,20,.04);
  --shadow-md: 0 4px 16px rgba(26,24,20,.1);
}
[data-theme="dark"] {
  --bg:        #0f0e0c;
  --surface:   #1a1814;
  --surface-2: #242018;
  --border:    rgba(244,240,232,.13);
  --border-2:  rgba(244,240,232,.07);

  --ink:       #f4f0e8;
  --ink-2:     #e2ddd4;
  --ink-3:     #c8c2b8;
  --ink-4:     #a8a29a;
  --ink-5:     #807b72;

  --blue:      #5a9fd4;
  --blue-b:    #7ab8e8;
  --blue-bg:   #0e1e2e;

  --green:     #4ade80;
  --green-bg:  #071a0f;
  --green-dk:  #4ade80;
  --red:       #f87171;
  --red-bg:    #1e0808;
  --red-dk:    #f87171;

  --gold:      #d4a030;
  --gold-bg:   #1a1200;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--ff);background:var(--bg);color:var(--ink);
  font-size:14px;line-height:1.5;letter-spacing:-.01em;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  transition:background .2s,color .2s;
}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}
a{color:inherit;text-decoration:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#shell{display:flex;flex-direction:column;height:100vh}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#header{
  height:var(--header-h);flex-shrink:0;z-index:50;
  background:rgba(244,240,232,.9);backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:8px;
}
[data-theme="dark"] #header{background:rgba(15,14,12,.9)}

.h-logo{display:flex;align-items:center;gap:9px}
.h-mark{
  width:28px;height:28px;border-radius:7px;
  background:var(--ink);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 1px 4px rgba(26,24,20,.2);
}
.h-mark svg{width:14px;height:14px}
.h-name{font-family:var(--ff-head);font-size:16px;font-weight:600;color:var(--ink);letter-spacing:-.2px}
.h-sep{flex:1}
.h-btn{
  height:28px;padding:0 12px;border-radius:6px;font-size:12px;font-weight:500;
  color:var(--ink-4);background:var(--surface);border:1px solid var(--border);
  display:inline-flex;align-items:center;gap:5px;transition:all .1s;
  box-shadow:var(--shadow);white-space:nowrap;
}
.h-btn:hover{color:var(--ink);background:var(--surface-2)}
.h-btn-group{display:flex;align-items:center;gap:0;border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:var(--shadow)}
.h-btn-group .h-btn{border:none;border-radius:0;box-shadow:none;border-right:1px solid var(--border)}
.h-btn-group .h-btn:last-child{border-right:none}
.h-btn-save{color:var(--ink-3)}
.h-btn-save:hover{color:var(--gold)!important}
.h-btn-icon{} /* always visible */
.h-note{font-size:11px;color:var(--ink-5);white-space:nowrap;font-family:var(--ff-mono);letter-spacing:.2px}
#dark-btn{width:28px;height:28px;padding:0;border-radius:6px;font-size:13px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow);color:var(--ink-4)}
#dark-btn:hover{color:var(--ink)}
#menu-btn{display:none;height:28px;padding:0 10px;border-radius:6px;font-size:12px;font-weight:500;color:var(--ink-4);background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow);align-items:center;gap:5px}
#menu-btn:hover{color:var(--ink)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#body{display:flex;flex:1;overflow:hidden}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  overflow-y:auto;padding:14px 14px 80px;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  transition:transform .25s ease,background .2s;
}
#sidebar::-webkit-scrollbar{width:0}

/* Section label */
.sb-lbl{
  font-size:9.5px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;
  color:var(--gold);padding:10px 0 5px;border-bottom:1px solid var(--border-2);
  margin-bottom:8px;font-family:var(--ff-mono);
}
.sb-lbl:first-child{padding-top:2px}

/* â”€â”€ Ticker search â”€â”€ */
/* â”€â”€ Ticker search â”€â”€ */
.ticker-search-wrap{position:relative;margin-bottom:12px}
.ticker-search-input{
  width:100%;padding:10px 34px 10px 34px;border-radius:var(--r);
  border:1.5px solid var(--border);background:var(--surface);
  color:var(--ink);font-size:13.5px;font-family:var(--ff);
  outline:none;transition:border-color .15s,box-shadow .15s,background .15s;
  -webkit-appearance:none;box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.ticker-search-input:focus{
  border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,92,152,.1);
  background:var(--surface);
}
.ticker-search-input::placeholder{color:var(--ink-5)}
.ticker-search-icon{
  position:absolute;left:11px;top:50%;transform:translateY(-50%);
  color:var(--ink-4);pointer-events:none;font-size:13px;line-height:1;
}
.ticker-search-clear{
  position:absolute;right:9px;top:50%;transform:translateY(-50%);
  color:var(--ink-5);cursor:pointer;font-size:14px;line-height:1;
  display:none;background:none;border:none;padding:3px;
  transition:color .1s;border-radius:3px;
}
.ticker-search-clear:hover{color:var(--ink);background:var(--surface-2)}
/* Dropdown */
.ticker-dropdown{
  position:absolute;top:calc(100% + 5px);left:0;right:0;z-index:200;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);box-shadow:0 8px 24px rgba(0,0,0,.12),0 2px 6px rgba(0,0,0,.06);
  overflow:hidden;display:none;
}
.ticker-dropdown.open{display:block}
.td-header{
  padding:7px 12px 5px;font-size:9.5px;font-weight:600;letter-spacing:.6px;
  text-transform:uppercase;color:var(--ink-4);background:var(--surface-2);
  border-bottom:1px solid var(--border-2);font-family:var(--ff-mono);
}
.td-item{
  display:grid;grid-template-columns:50px 1fr auto;align-items:center;
  gap:6px;padding:9px 12px;cursor:pointer;
  transition:background .08s;border-bottom:1px solid var(--border-2);
}
.td-item:last-child{border-bottom:none}
.td-item:hover,.td-item.focused{background:var(--blue-bg)}
.td-item:hover .td-ticker,.td-item.focused .td-ticker{color:var(--blue)}
.td-ticker{
  font-family:var(--ff-mono);font-size:12.5px;font-weight:700;
  color:var(--ink);letter-spacing:.2px;
}
.td-info{display:flex;flex-direction:column;min-width:0}
.td-name{font-size:12px;color:var(--ink-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
.td-sub{font-size:10px;color:var(--ink-5);margin-top:1px;font-family:var(--ff-mono)}
.td-badge{
  font-size:9px;font-weight:600;font-family:var(--ff-mono);
  background:var(--surface-2);color:var(--ink-4);
  padding:2px 6px;border-radius:4px;white-space:nowrap;flex-shrink:0;
  border:1px solid var(--border-2);
}
.td-loading{padding:14px 12px;text-align:center;font-size:12px;color:var(--ink-4)}
.td-empty{
  padding:14px 12px;text-align:center;font-size:12px;color:var(--ink-4);
  font-style:italic;
}
/* DB count badge next to search */
.search-db-note{
  display:flex;justify-content:flex-end;margin-top:-8px;margin-bottom:6px;
}
.sdb-badge{
  font-size:10px;color:var(--ink-5);font-family:var(--ff-mono);
  background:var(--surface-2);border:1px solid var(--border-2);
  border-radius:4px;padding:2px 7px;
}
/* Live data badges */
.live-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-family:var(--ff-mono);font-size:9.5px;font-weight:600;
  color:var(--green-dk);background:var(--green-bg);
  border-radius:10px;padding:1px 7px;margin-left:4px;vertical-align:middle;
}
[data-theme="dark"] .live-badge{color:var(--green)}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green-dk);animation:pulse-hint 2s ease-in-out infinite;flex-shrink:0}
[data-theme="dark"] .live-dot{background:var(--green)}
/* Price fetch states */
.price-loading-row{
  display:none;align-items:center;gap:7px;
  font-size:11px;color:var(--ink-4);margin-top:4px;
}
.price-loading-row.show{display:flex}
.price-spinner{
  width:12px;height:12px;border-radius:50%;flex-shrink:0;
  border:1.5px solid var(--border);border-top-color:var(--blue);
  animation:spin .7s linear infinite;
}
.price-status{font-size:10.5px;color:var(--ink-4);font-family:var(--ff-mono)}
/* Sidebar loading spinner overlay */
.sb-loading{
  display:none;position:absolute;inset:0;z-index:100;
  background:rgba(255,255,255,.6);backdrop-filter:blur(3px);
  align-items:center;justify-content:center;border-radius:var(--r);
}
[data-theme="dark"] .sb-loading{background:rgba(28,28,30,.6)}
.sb-loading.show{display:flex}
.sb-spinner{
  width:22px;height:22px;border-radius:50%;
  border:2.5px solid var(--border);border-top-color:var(--blue);
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.co-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:12px}
.co-pill{
  padding:9px 4px;border-radius:var(--r-sm);
  border:1px solid var(--border);background:var(--surface-2);
  cursor:pointer;transition:all .12s;text-align:center;
  display:flex;align-items:center;justify-content:center;
}
.co-pill .pt{font-size:12px;font-weight:600;font-family:var(--ff-mono);color:var(--ink-2);letter-spacing:.3px}
.co-pill:hover{border-color:var(--blue);background:var(--blue-bg)}
.co-pill:hover .pt{color:var(--blue)}
.co-pill.active{background:var(--ink);border-color:var(--ink)}
.co-pill.active .pt{color:var(--bg)}

/* Form fields */
.field{margin-bottom:8px}
.field>label{
  display:flex;justify-content:space-between;align-items:baseline;
  font-size:11px;font-weight:500;color:var(--ink-4);margin-bottom:3px;
}
.field>label .note{font-size:10px;color:var(--ink-5);font-weight:400}
.field input[type=text],.field input[type=number],.field select{
  width:100%;padding:7px 10px;border-radius:var(--r-sm);
  border:1px solid var(--border);background:var(--surface-2);
  color:var(--ink);font-size:13px;font-family:var(--ff-mono);
  outline:none;transition:border-color .1s,box-shadow .1s;
}
.field input:focus,.field select:focus{
  border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,92,152,.12);
  background:var(--surface);
}

/* Sliders */
.sl-row{margin-bottom:9px}
.sl-top{display:flex;justify-content:space-between;align-items:baseline;font-size:11px;font-weight:500;color:var(--ink-4);margin-bottom:4px}
.sl-top span{font-family:var(--ff-mono);font-size:12px;font-weight:600;color:var(--ink)}
input[type=range]{
  width:100%;height:3px;-webkit-appearance:none;appearance:none;
  background:var(--ink-5);border-radius:2px;outline:none;cursor:pointer;
  transition:background .1s;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:15px;height:15px;border-radius:50%;
  background:var(--surface);border:2px solid var(--ink-3);
  box-shadow:0 1px 4px rgba(26,24,20,.15);transition:transform .1s;
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.15)}

/* Benchmark reference anchors under growth slider */
.bench-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-top:8px}
.bench-pill{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:7px 4px 6px;border-radius:8px;cursor:pointer;
  background:var(--surface-2);border:1px solid var(--border);
  transition:all .14s ease;user-select:none;
}
.bench-pill:hover{background:var(--blue-bg);border-color:rgba(26,75,140,.2)}
.bench-pill.active{background:var(--blue-bg);border-color:rgba(26,75,140,.25)}
.bp-rate{font-family:var(--ff-mono);font-size:12px;font-weight:600;color:var(--ink-2)}
.bp-lbl{font-size:9px;color:var(--ink-5);font-weight:400;text-align:center;line-height:1.3}
.bench-pill:hover .bp-rate,.bench-pill.active .bp-rate{color:var(--blue)}
.bench-pill:hover .bp-lbl,.bench-pill.active .bp-lbl{color:var(--ink-4)}

/* Growth assumptions card */
.growth-card{
  background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r);padding:12px 12px 14px;margin-bottom:8px;
}

/* Segmented control */
.seg{
  display:flex;background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:2px;gap:2px;margin-bottom:8px;
}
.seg-btn{
  flex:1;padding:5px 0;text-align:center;font-size:11.5px;font-weight:500;
  color:var(--ink-4);border-radius:6px;border:none;background:none;
  cursor:pointer;transition:all .12s;
}
.seg-btn.active{background:var(--surface);color:var(--ink);box-shadow:var(--shadow);font-weight:600}

/* FCF margin chip */
.margin-chip{
  display:flex;justify-content:space-between;align-items:center;
  background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:6px 10px;margin-bottom:8px;
}
.mc-lbl{font-size:9px;font-weight:600;color:var(--ink-5);text-transform:uppercase;letter-spacing:.7px;font-family:var(--ff-mono)}
.mc-val{font-family:var(--ff-mono);font-size:14px;font-weight:600;color:var(--ink-2)}

/* Warn / err */
.warn{font-size:11px;color:#92400e;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;padding:5px 8px;margin-bottom:6px;display:none;line-height:1.5}
.err{font-size:11px;color:var(--red-dk);background:var(--red-bg);border:1px solid rgba(192,57,43,.2);border-radius:6px;padding:5px 8px;margin-bottom:6px;display:none;line-height:1.5}
[data-theme="dark"] .warn{background:#1a1000;border-color:#78350f;color:#fde68a}

/* Sidebar summary */
.sb-sum{
  background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r);padding:10px 12px;margin-top:10px;
}
.ss-row{display:flex;justify-content:space-between;font-size:11.5px;padding:3.5px 0;border-bottom:1px solid var(--border-2)}
.ss-row:last-child{border-bottom:none}
.ss-lbl{color:var(--ink-4)}.ss-val{font-family:var(--ff-mono);font-weight:500;color:var(--ink);font-size:11px}

/* Reset btn */
.sb-reset{
  width:100%;margin-top:8px;padding:7px;border-radius:var(--r-sm);
  font-size:12px;font-weight:500;color:var(--ink-4);
  background:var(--surface-2);border:1px solid var(--border);
  transition:all .1s;
}
.sb-reset:hover{color:var(--red-dk);border-color:rgba(192,57,43,.3)}

/* Currency row */
.ccy-row{display:flex;gap:6px}
.ccy-row .field{flex:1;margin-bottom:0}
.fx-box{background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-sm);padding:7px 10px;margin-bottom:8px}
.fx-box label{display:block;font-size:10px;font-weight:500;color:var(--ink-5);margin-bottom:3px}
.fx-box input{background:none;border:none;outline:none;width:100%;font-family:var(--ff-mono);font-size:13px;color:var(--ink)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0}
#main::-webkit-scrollbar{width:0}

/* Tab bar */
#tabbar{
  flex-shrink:0;display:flex;align-items:center;
  background:rgba(244,240,232,.9);backdrop-filter:saturate(180%) blur(20px);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:10;padding:0 20px;
}
[data-theme="dark"] #tabbar{background:rgba(15,14,12,.9)}
.tab-btn{
  padding:14px 0;margin-right:22px;font-size:13px;font-weight:500;
  color:var(--ink-5);border-bottom:2px solid transparent;margin-bottom:-1px;
  transition:color .1s,border-color .1s;background:none;white-space:nowrap;
  letter-spacing:.1px;
}
.tab-btn.active{color:var(--ink);border-bottom-color:var(--ink-3)}
.tab-btn:hover:not(.active){color:var(--ink-3)}
.tab-sep{flex:1}

/* Panels */
.tab-panel{display:none;padding:20px;animation:fadeIn .15s ease}
.tab-panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}

/* Empty state */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;text-align:center;gap:10px}
.empty svg{opacity:.1;width:40px;height:40px}
.empty-title{font-family:var(--ff-head);font-size:22px;font-weight:600;color:var(--ink-3)}
.empty-body{font-size:13px;color:var(--ink-5);max-width:280px;line-height:1.6}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULT CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-hero{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:20px 20px 16px;
  margin-bottom:12px;box-shadow:var(--shadow);
  display:grid;grid-template-columns:1fr 1fr;gap:0;
}
.rh-left{padding-right:20px;border-right:1px solid var(--border-2)}
.rh-right{padding-left:20px}
.rh-label{font-size:10.5px;font-weight:500;color:var(--ink-5);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px;font-family:var(--ff-mono)}
.rh-value{font-family:var(--ff-head);font-size:44px;font-weight:700;letter-spacing:-2px;line-height:1}
.rh-value.good{color:var(--green-dk)}
.rh-value.bad{color:var(--red-dk)}
.rh-value.neutral{color:var(--blue)}
[data-theme="dark"] .rh-value.good{color:var(--green)}
[data-theme="dark"] .rh-value.bad{color:var(--red)}
.rh-sub{font-size:12px;color:var(--ink-5);margin-top:5px}
.rh-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;
  margin-top:9px;font-family:var(--ff-mono);
}
.rh-badge.good{background:var(--green-bg);color:var(--green-dk)}
.rh-badge.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .rh-badge.good{color:var(--green)}
[data-theme="dark"] .rh-badge.bad{color:var(--red)}

/* Two stat row below hero */
.stat-row{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;
}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 16px;box-shadow:var(--shadow);
}
.sc-lbl{font-size:10.5px;font-weight:500;color:var(--ink-5);margin-bottom:5px;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.5px}
.sc-val{font-family:var(--ff-head);font-size:28px;font-weight:700;letter-spacing:-1px;color:var(--ink)}
.sc-sub{font-size:11px;color:var(--ink-5);margin-top:3px}

/* â”€â”€ Data provenance note â”€â”€ */
.data-provenance{
  display:flex;align-items:flex-start;gap:7px;
  background:var(--surface-2);border-radius:var(--r-sm);
  padding:8px 11px;margin-bottom:8px;
  font-size:11px;color:var(--ink-4);line-height:1.55;
  border:1px solid var(--border-2);
}
.data-provenance strong{color:var(--ink-3);font-weight:500}

/* â”€â”€ Calc warning card â”€â”€ */
.calc-warn{
  background:var(--surface);border:1px solid rgba(192,57,43,.25);
  border-radius:var(--r);padding:18px 20px;margin-bottom:12px;
  box-shadow:var(--shadow);
}
.cw-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.cw-icon{font-size:20px}
.cw-title{font-size:14px;font-weight:600;color:var(--red-dk)}
[data-theme="dark"] .cw-title{color:var(--red)}
.cw-body{font-size:12.5px;color:var(--ink-3);line-height:1.65;margin-bottom:10px}
.cw-list{display:flex;flex-direction:column;gap:5px;margin-top:6px}
.cw-item{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--ink-3);background:var(--surface-2);border-radius:6px;padding:7px 10px}
.cw-item-icon{font-size:11px;margin-top:1px;flex-shrink:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNIFIED VALUATION CARD
   One card: FV vs Market Â· Required return slider
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.val-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:12px;
  box-shadow:var(--shadow);overflow:hidden;
}
/* â€” top numbers section â€” */
.val-card-top{padding:20px 22px 18px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
.vc-side{display:flex;flex-direction:column}
.vc-side.right{align-items:flex-end;text-align:right}
.vc-lbl{font-size:10px;font-weight:500;color:var(--ink-5);text-transform:uppercase;
  letter-spacing:.6px;font-family:var(--ff-mono);margin-bottom:6px}
.vc-num{font-family:var(--ff-head);font-size:40px;font-weight:700;letter-spacing:-1.5px;line-height:1}
.vc-num.fv-good{color:var(--green-dk)}
.vc-num.fv-bad{color:var(--red-dk)}
.vc-num.mkt{color:var(--ink-2)}
[data-theme="dark"] .vc-num.fv-good{color:var(--green)}
[data-theme="dark"] .vc-num.fv-bad{color:var(--red)}
.vc-ccy{font-size:11px;color:var(--ink-5);font-family:var(--ff-mono);margin-top:4px}
.vc-mid{display:flex;flex-direction:column;align-items:center;padding:0 18px;gap:3px}
.vc-divider-v{width:1px;height:44px;background:var(--border)}
.vc-arrow{font-size:18px;line-height:1;color:var(--ink-4)}
.vc-delta{font-family:var(--ff-mono);font-size:13px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.vc-delta.good{color:var(--green-dk)}
.vc-delta.bad{color:var(--red-dk)}
[data-theme="dark"] .vc-delta.good{color:var(--green)}
[data-theme="dark"] .vc-delta.bad{color:var(--red)}
/* â€” verdict strip â€” */
.val-card-verdict{
  display:flex;align-items:center;gap:8px;
  padding:10px 22px;border-top:1px solid var(--border-2);
  background:var(--surface-2);
}
.vc-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 11px;
  border-radius:20px;font-size:11.5px;font-weight:600;font-family:var(--ff-mono)}
.vc-pill.good{background:var(--green-bg);color:var(--green-dk)}
.vc-pill.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .vc-pill.good{color:var(--green)}
[data-theme="dark"] .vc-pill.bad{color:var(--red)}
.vc-verdict-note{font-size:11.5px;color:var(--ink-4);font-weight:400}
.vc-verdict-note.good{color:var(--green-dk);font-weight:500}
.vc-verdict-note.bad{color:var(--red-dk);font-weight:500}
[data-theme="dark"] .vc-verdict-note.good{color:var(--green)}
[data-theme="dark"] .vc-verdict-note.bad{color:var(--red)}
/* â€” slider section â€” */
.val-card-slider{padding:14px 22px 16px;border-bottom:1px solid var(--border-2)}
.vcs-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vcs-label{display:flex;align-items:center;gap:7px}
.vcs-title{font-size:12px;font-weight:600;color:var(--ink)}
.vcs-tag{font-size:10px;font-weight:500;color:var(--gold);background:var(--gold-bg);
  border:1px solid rgba(176,125,46,.2);border-radius:10px;
  padding:1px 7px;font-family:var(--ff-mono);letter-spacing:.3px}
.vcs-val{font-family:var(--ff-mono);font-size:18px;font-weight:700;color:var(--ink);letter-spacing:-.5px}
.vcs-track{position:relative;height:4px;border-radius:2px;margin-bottom:10px;
  background:linear-gradient(90deg,var(--green) 0%,#d4a332 40%,var(--red) 75%,#7a1a1a 100%)}
.vcs-track input[type=range]{position:absolute;inset:0;width:100%;opacity:0;cursor:pointer;height:20px;top:-8px;margin:0}
.vcs-thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:15px;height:15px;
  border-radius:50%;background:var(--surface);border:2px solid var(--ink-3);
  box-shadow:0 1px 4px rgba(26,24,20,.2);pointer-events:none;transition:left .05s}
.vcs-hints{display:grid;grid-template-columns:repeat(4,1fr);gap:5px}
.vcs-hint{text-align:center;padding:5px 4px;background:var(--bg);border-radius:6px;
  cursor:pointer;transition:all .1s;border:1px solid transparent}
.vcs-hint:hover{border-color:var(--blue);background:var(--blue-bg)}
.vcs-hint-rate{font-size:11px;font-weight:600;font-family:var(--ff-mono);color:var(--ink-3)}
.vcs-hint-lbl{font-size:10px;color:var(--ink-5);margin-top:1px}

/* Discount slider area â€” keep for compat but hide */
.disc-area{display:none}

/* Chart card */
.chart-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:16px 18px;margin-bottom:12px;
  box-shadow:var(--shadow);
}
.chart-card-title{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.chart-card-sub{font-size:12px;color:var(--ink-4);margin-bottom:12px;line-height:1.5}
.chart-legend{display:flex;gap:14px;margin-top:8px;flex-wrap:wrap}
.leg{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--ink-4)}
.leg-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

/* Collapsible */
.coll{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:10px;
  box-shadow:var(--shadow);
}
.coll-hdr{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;font-size:13px;font-weight:500;color:var(--ink);
  cursor:pointer;user-select:none;transition:background .1s;
  border-bottom:1px solid transparent;
}
.coll-hdr:hover{background:var(--surface-2)}
.coll-hdr.open{border-bottom-color:var(--border-2)}
.coll-arrow{font-size:10px;color:var(--ink-5);transition:transform .15s}
.coll-hdr.open .coll-arrow{transform:rotate(180deg)}
.coll-body{display:none;padding:14px 16px;background:var(--surface)}
.coll-body.open{display:block}

/* Table */
.data-tbl{width:100%;border-collapse:collapse;font-size:12px}
.data-tbl th{text-align:left;padding:6px 8px;font-size:9.5px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-5);border-bottom:1px solid var(--border);background:var(--surface-2);font-family:var(--ff-mono)}
.data-tbl td{padding:7px 8px;border-bottom:1px solid var(--border-2);font-family:var(--ff-mono);font-size:12px;color:var(--ink)}
.data-tbl tr:last-child td{border-bottom:none}
.data-tbl tr:hover td{background:var(--surface-2)}

/* Bridge */
.bridge{border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin:10px 0}
.br-row{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;font-size:12.5px;border-bottom:1px solid var(--border-2);background:var(--surface)}
.br-row:last-child{border-bottom:none;font-weight:600;background:var(--surface-2);border-top:1px solid var(--border)}
.br-lbl{color:var(--ink-3)}.br-val{font-family:var(--ff-mono);font-size:12px;color:var(--ink)}

/* Download btn */
.btn-dl{
  padding:7px 14px;background:var(--surface-2);border:1px solid var(--border);
  border-radius:6px;font-size:12px;font-weight:500;color:var(--ink-3);
  display:inline-flex;align-items:center;gap:5px;transition:all .1s;
}
.btn-dl:hover{background:var(--blue-bg);border-color:var(--blue);color:var(--blue)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPLIED RETURN â€” new clean design
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Hero result card */
.irr-result-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:20px;margin-bottom:12px;
  box-shadow:var(--shadow);
}
.irc-top{display:flex;align-items:flex-start;gap:0;margin-bottom:16px}
.irc-num-block{flex-shrink:0;padding-right:24px;border-right:1px solid var(--border-2)}
.irc-num-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-5);font-family:var(--ff-mono);margin-bottom:6px}
.irc-num{font-family:var(--ff-head);font-size:56px;font-weight:700;letter-spacing:-3px;line-height:1}
.irc-num.good{color:var(--green-dk)}
.irc-num.bad{color:var(--red-dk)}
[data-theme="dark"] .irc-num.good{color:var(--green)}
[data-theme="dark"] .irc-num.bad{color:var(--red)}
.irc-verdict{padding-left:20px;flex:1}
.irc-verdict-main{font-family:var(--ff-head);font-size:17px;font-weight:600;color:var(--ink);margin-bottom:8px;line-height:1.25;letter-spacing:-.4px}
.irc-verdict-body{font-size:12.5px;color:var(--ink-4);line-height:1.7}
.irc-vs-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-family:var(--ff-mono);font-size:11.5px;font-weight:600}
.irc-vs-badge.good{background:var(--green-bg);color:var(--green-dk)}
.irc-vs-badge.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .irc-vs-badge.good{color:var(--green)}
[data-theme="dark"] .irc-vs-badge.bad{color:var(--red)}

/* Input summary row */
.irc-inputs{
  display:grid;grid-template-columns:repeat(4,1fr);gap:1px;
  background:var(--border-2);border:1px solid var(--border-2);
  border-radius:var(--r-sm);overflow:hidden;margin-top:4px;
}
.irc-inp-cell{background:var(--surface-2);padding:9px 12px}
.irc-inp-lbl{font-size:9.5px;font-weight:500;color:var(--ink-5);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;font-family:var(--ff-mono)}
.irc-inp-val{font-family:var(--ff-mono);font-size:12.5px;font-weight:600;color:var(--ink)}

/* Price adjuster card */
.rev-price-ctrl{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:18px 20px;margin-bottom:12px;
  box-shadow:var(--shadow);
}
.rpc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:14px}
.rpc-label{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:3px}
.rpc-sub{font-size:11.5px;color:var(--ink-4);line-height:1.5;max-width:400px}
.rpc-price-display{text-align:right;flex-shrink:0}
.rpc-price-val{font-family:var(--ff-head);font-size:28px;font-weight:700;color:var(--ink);letter-spacing:-1px;line-height:1}
.rpc-price-ccy{font-size:10.5px;color:var(--ink-5);text-align:right;margin-top:2px;font-family:var(--ff-mono)}
.rpc-slider-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.rpc-bound{font-family:var(--ff-mono);font-size:10px;color:var(--ink-5);white-space:nowrap;min-width:36px}
.rpc-bound:last-child{text-align:right}
.rpc-track-wrap{flex:1;position:relative}
.rpc-track-wrap input[type=range]{
  width:100%;height:3px;-webkit-appearance:none;appearance:none;
  background:linear-gradient(90deg,var(--blue) 50%,var(--border) 50%);
  border-radius:2px;outline:none;cursor:pointer;
}
.rpc-track-wrap input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:var(--surface);border:2px solid var(--blue);
  box-shadow:0 1px 6px rgba(26,92,152,.25);transition:transform .1s;
}
.rpc-track-wrap input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.12)}
/* Result strip */
.rpc-result{
  display:flex;align-items:stretch;
  background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r-sm);overflow:hidden;
}
.rpc-result-item{padding:10px 14px;flex:1}
.rpc-result-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-5);font-family:var(--ff-mono);margin-bottom:4px}
.rpc-result-val{font-family:var(--ff-head);font-size:18px;font-weight:700;color:var(--ink);letter-spacing:-.3px;line-height:1}
.rpc-result-div{width:1px;background:var(--border);align-self:stretch}
.rpc-reset{padding:8px 14px;background:transparent;border:none;border-left:1px solid var(--border);cursor:pointer;color:var(--ink-4);font-size:11px;font-family:var(--ff);transition:all .1s;white-space:nowrap;align-self:stretch}
.rpc-reset:hover{background:var(--bg);color:var(--ink)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REVERSE DCF (old styles â€” kept for calc-warn)
   irr-hero, irr-big, irr-num, irr-meta kept for error fallback
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.irr-meta{display:flex;gap:16px;flex-wrap:wrap}
.im-item{font-size:12px;color:var(--ink-4)}
.im-item span{font-family:var(--ff-mono);font-weight:600;color:var(--ink);margin-left:4px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATRIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sc-strip{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 16px;margin-bottom:10px;
  box-shadow:var(--shadow);
}
.sc-strip-title{font-size:10.5px;font-weight:600;color:var(--ink-5);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-family:var(--ff-mono)}
.sc-strip-sub{font-size:12px;color:var(--ink-3);margin-bottom:12px;line-height:1.5}
.sc-cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.sc-col{border-radius:var(--r-sm);padding:12px 14px;border:1px solid transparent}
.sc-col-bear{background:var(--red-bg);border-color:rgba(192,57,43,.15)}
.sc-col-base{background:var(--surface-2);border-color:var(--border)}
.sc-col-bull{background:var(--green-bg);border-color:rgba(26,122,60,.15)}
.sc-col-name{font-size:11px;font-weight:600;color:var(--ink-3);margin-bottom:2px}
.sc-col-desc{font-size:10px;color:var(--ink-5);margin-bottom:8px}
.sc-col-irr{font-family:var(--ff-head);font-size:24px;font-weight:700;letter-spacing:-.5px}
.sc-col-bear .sc-col-irr{color:var(--red-dk)}
.sc-col-base .sc-col-irr{color:var(--ink)}
.sc-col-bull .sc-col-irr{color:var(--green-dk)}
[data-theme="dark"] .sc-col-bear .sc-col-irr{color:var(--red)}
[data-theme="dark"] .sc-col-bull .sc-col-irr{color:var(--green)}
.sc-col-meta{font-size:10.5px;color:var(--ink-5);margin-top:4px;font-family:var(--ff-mono)}
.sc-col-badge{display:inline-block;font-size:9.5px;font-weight:600;padding:2px 6px;border-radius:20px;margin-top:4px;font-family:var(--ff-mono)}
.sc-col-badge.good{background:rgba(26,122,60,.15);color:var(--green-dk)}
.sc-col-badge.bad{background:rgba(192,57,43,.12);color:var(--red-dk)}
[data-theme="dark"] .sc-col-badge.good{color:var(--green)}
[data-theme="dark"] .sc-col-badge.bad{color:var(--red)}

/* Matrix controls */
.mc-ctrl{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 16px;margin-bottom:10px;
  display:grid;grid-template-columns:1fr 1fr;gap:14px;
  box-shadow:var(--shadow);
}
.mc-group-label{font-size:10.5px;font-weight:600;color:var(--ink-5);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;font-family:var(--ff-mono)}
.mc-inputs{display:flex;gap:6px}
.mc-inputs .field{flex:1;margin-bottom:0}

/* Heatmap */
.hm-legend{
  display:flex;align-items:center;gap:10px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:10px 14px;margin-bottom:10px;
  box-shadow:var(--shadow);
}
.hm-bar{flex:1;height:6px;border-radius:3px;background:linear-gradient(90deg,#7a1a1a 0%,#f87171 25%,#fef9f9 45%,#fef9f9 50%,#e8f5ec 60%,#86efac 78%,#14612e 100%)}
.hm-end{font-size:10.5px;font-family:var(--ff-mono);font-weight:500;white-space:nowrap}
.hm-end.bad{color:var(--red-dk)}.hm-end.good{color:var(--green-dk)}
[data-theme="dark"] .hm-end.bad{color:var(--red)}
[data-theme="dark"] .hm-end.good{color:var(--green)}
.hm-tick-row{display:flex;justify-content:space-between;font-size:9px;color:var(--ink-5);margin-top:2px;font-family:var(--ff-mono)}

.sc-tag{
  display:inline-flex;align-items:center;gap:5px;padding:4px 10px;
  border-radius:20px;font-size:11.5px;font-weight:600;margin:10px 0 6px;
}
.sc-tag-bear{background:var(--red-bg);color:var(--red-dk)}
.sc-tag-base{background:var(--surface-2);color:var(--ink-2);border:1px solid var(--border)}
.sc-tag-bull{background:var(--green-bg);color:var(--green-dk)}
[data-theme="dark"] .sc-tag-bear{color:var(--red)}
[data-theme="dark"] .sc-tag-bull{color:var(--green)}

.hm-tbl{border-collapse:collapse;width:100%;margin-bottom:6px}
.hm-tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:6px}
.hm-tbl th{padding:6px 8px;font-size:9.5px;font-weight:600;font-family:var(--ff-mono);color:var(--ink-5);background:var(--surface-2);text-align:center;border:1px solid var(--border)}
.hm-tbl th.rh{text-align:left;min-width:70px}
.hm-tbl td{padding:0;border:1px solid rgba(26,24,20,.04);text-align:center}
[data-theme="dark"] .hm-tbl td{border-color:rgba(244,240,232,.04)}
.hm-cell{padding:8px 6px;font-family:var(--ff-mono);font-size:11px;font-weight:600;min-width:54px}

@keyframes pulse-hint{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   METHODOLOGY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#methodology{display:none;flex:1;overflow-y:auto;padding:36px 40px;max-width:720px}
.mth-tag{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--gold);margin-bottom:10px;font-family:var(--ff-mono)}
.mth-h1{font-family:var(--ff-head);font-size:34px;font-weight:700;color:var(--ink);letter-spacing:-.8px;margin-bottom:10px;line-height:1.2}
.mth-intro{font-size:15px;color:var(--ink-3);line-height:1.75;margin-bottom:32px;font-weight:300}
.mth-sec{margin-bottom:30px;padding-bottom:30px;border-bottom:1px solid var(--border)}
.mth-sec:last-child{border-bottom:none}
.mth-h2{font-family:var(--ff-head);font-size:20px;font-weight:600;color:var(--ink);margin-bottom:8px;letter-spacing:-.3px}
.mth-p{font-size:13.5px;color:var(--ink-3);line-height:1.75;margin-bottom:8px}
.mth-formula{background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px 16px;font-family:var(--ff-mono);font-size:12.5px;color:var(--blue);margin:10px 0;line-height:2}
.mth-note{background:var(--gold-bg);border-left:3px solid var(--gold);border-radius:4px;padding:10px 14px;font-size:12.5px;color:var(--ink-3);line-height:1.6;margin-top:10px}
.mth-back{
  height:32px;padding:0 14px;border-radius:6px;font-size:12.5px;font-weight:500;
  background:var(--ink);color:var(--bg);display:inline-flex;align-items:center;gap:6px;
  margin-top:8px;transition:background .1s;
}
.mth-back:hover{background:var(--ink-2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST / MOBILE / OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);
  background:var(--ink);color:var(--bg);padding:8px 18px;border-radius:20px;
  font-size:13px;font-weight:500;opacity:0;transition:all .2s;
  z-index:999;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md);
  font-family:var(--ff-mono);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

#mobile-bar{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:60;
  background:rgba(244,240,232,.95);backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:10px 16px max(14px, env(safe-area-inset-bottom));
}
[data-theme="dark"] #mobile-bar{background:rgba(15,14,12,.95)}
.mb-row{display:flex;align-items:center;gap:8px}
.mb-lbl{font-size:10px;font-weight:500;color:var(--ink-5);margin-bottom:1px;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.5px}
.mb-val{font-family:var(--ff-head);font-size:17px;font-weight:700;color:var(--ink)}
.mb-div{width:1px;height:28px;background:var(--border);flex-shrink:0}
.mb-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;font-family:var(--ff-mono)}
.mb-badge.good{background:var(--green-bg);color:var(--green-dk)}
.mb-badge.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .mb-badge.good{color:var(--green)}
[data-theme="dark"] .mb-badge.bad{color:var(--red)}
.mb-action-btn{
  width:32px;height:32px;border-radius:8px;flex-shrink:0;
  background:var(--surface-2);border:1px solid var(--border);
  font-size:14px;display:flex;align-items:center;justify-content:center;
  color:var(--ink-4);transition:all .1s;cursor:pointer;
}
.mb-action-btn:hover{color:var(--ink);background:var(--surface)}
.mb-action-save:hover{color:var(--gold)!important}

#overlay{display:none;position:fixed;inset:0;background:rgba(26,24,20,.4);z-index:40;backdrop-filter:blur(4px)}

/* Matrix view toggle */
.mx-view-toggle{
  display:flex;align-items:center;gap:8px;margin-bottom:10px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:10px 14px;
  box-shadow:var(--shadow);
}
.mx-toggle-label{font-size:11px;font-weight:500;color:var(--ink-4);flex:1;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.4px}
.mx-seg{display:flex;background:var(--surface-2);border:1px solid var(--border-2);border-radius:7px;padding:2px;gap:2px}
.mx-seg .mx-seg-btn{border:none;border-radius:5px;padding:4px 14px;background:none}
.mx-seg .mx-seg-btn.active{background:var(--surface);color:var(--ink);border-color:transparent;box-shadow:var(--shadow)}
.mx-seg-btn{padding:5px 14px;border-radius:6px;font-size:11.5px;font-weight:500;color:var(--ink-4);background:none;border:1px solid var(--border);cursor:pointer;transition:all .1s}
.mx-seg-btn.active{background:var(--ink);color:var(--bg);border-color:var(--ink);font-weight:600}
.mx-seg-btn:hover:not(.active){background:var(--surface-2);color:var(--ink)}
/* Matrix chart canvas */
.matrix-chart-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:16px 18px;margin-bottom:10px;
  box-shadow:var(--shadow);
}
.mchart-title{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.mchart-sub{font-size:12px;color:var(--ink-4);margin-bottom:12px;line-height:1.5}


@media(max-width:900px){.result-hero{grid-template-columns:1fr;gap:12px}.rh-left{padding-right:0;border-right:none;border-bottom:1px solid var(--border-2);padding-bottom:12px}.rh-right{padding-left:0}}

@media(max-width:700px){
  :root{--sidebar-w:88vw}
  #sidebar{position:fixed;top:var(--header-h);left:0;bottom:0;z-index:45;transform:translateX(-100%);width:var(--sidebar-w);max-width:320px;
    padding-bottom:calc(80px + env(safe-area-inset-bottom, 20px))}
  #sidebar.open{transform:translateX(0)}
  #overlay{display:block;opacity:0;pointer-events:none;transition:opacity .2s}
  #overlay.show{opacity:1;pointer-events:auto}
  #menu-btn{display:inline-flex}
  .h-note{display:none}
  .h-btn#meth-btn{display:none}
  .h-btn-group .h-btn{padding:0 9px}
  .h-btn-group .h-btn .h-btn-text{display:none}
  .h-btn-group .h-btn .h-btn-icon{display:inline}
  .tab-panel{padding:12px}
  #main{width:100%;padding-bottom:calc(80px + env(safe-area-inset-bottom,16px))}
  #mobile-bar{display:block;padding-bottom:calc(12px + env(safe-area-inset-bottom,0px))}
  .irc-top{flex-direction:column;gap:14px}
  .irc-num-block{padding-right:0;border-right:none;padding-bottom:14px;border-bottom:1px solid var(--border-2)}
  .irc-num{font-size:44px}
  .irc-verdict{padding-left:0}
  .irc-inputs{grid-template-columns:1fr 1fr}
  .mc-ctrl{grid-template-columns:1fr}
  .sc-cols{grid-template-columns:1fr}
  .stat-row{grid-template-columns:1fr}
  .rpc-top{flex-direction:column;gap:8px}
  .rpc-price-display{text-align:left}
  .rpc-result{flex-wrap:wrap}
  .rpc-result-item{min-width:80px}
  .chart-card-sub{font-size:11px}
  .disc-hint{grid-template-columns:1fr 1fr}
}

@media(max-width:480px){
  #tabbar{padding:0 10px}
  .tab-btn{margin-right:12px;font-size:12px;padding:12px 0}
  .tab-btn[data-short]::before{content:attr(data-short);font-size:12px}
  .tab-btn[data-short]{font-size:0}
  .tab-btn[data-short]::before{font-size:12px}
  .field input[type=text],.field input[type=number],.field select{font-size:16px}
  .h-name{font-size:14px}
  .h-mark{width:24px;height:24px}
  .irr-result-card{padding:14px}
  .irc-num{font-size:40px}
  .hm-tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
}
</style>
</head>
<body>
<div id="shell">

<header id="header">
  <button id="menu-btn" onclick="toggleMobile()">â˜° Inputs</button>
  <div class="h-logo">
    <div class="h-mark">
      <svg viewBox="0 0 20 20" fill="none"><path d="M3 15l4-6 4 4 3-4 3 3" stroke="#f4f0e8" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <span class="h-name">Valuation Studio</span>
  </div>
  <div class="h-sep"></div>
  <button id="dark-btn" onclick="toggleDark()" title="Dark mode">ğŸŒ™</button>
  <button class="h-btn" onclick="showMethodology()" id="meth-btn">How it works</button>
  <div class="h-btn-group">
    <button class="h-btn" onclick="shareURL()" title="Copy a shareable link with all your current inputs"><span class="h-btn-icon">â¬†</span><span class="h-btn-text"> Share</span></button>
    <button class="h-btn h-btn-save" onclick="saveReport()" title="Download a self-contained valuation report â€” open in browser and print to PDF"><span class="h-btn-icon">â¬‡</span><span class="h-btn-text"> Save Report</span></button>
  </div>
  <div class="h-note">Not financial advice</div>
</header>

<div id="overlay" onclick="closeMobile()"></div>
<div id="body">

<!-- SIDEBAR -->
<aside id="sidebar">

  <!-- Ticker search -->
  <div style="position:relative;margin-bottom:2px">
    <div class="sb-loading" id="sb-loading"><div class="sb-spinner"></div></div>
    <div class="ticker-search-wrap">
      <span class="ticker-search-icon">
        <svg viewBox="0 0 14 14" fill="none" width="13" height="13"><circle cx="6" cy="6" r="4.5" stroke="currentColor" stroke-width="1.4"/><path d="M9.5 9.5L12 12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
      </span>
      <input
        class="ticker-search-input"
        id="ticker-search"
        type="text"
        placeholder="Search 50+ companies â€” AAPL, Netflixâ€¦"
        autocomplete="off"
        spellcheck="false"
        oninput="onTickerInput(this.value)"
        onkeydown="onTickerKey(event)"
        onfocus="onTickerFocus()"
        onblur="onTickerBlur()"
      />
      <button class="ticker-search-clear" id="ticker-clear" onclick="clearTickerSearch()" tabindex="-1">âœ•</button>
      <div class="ticker-dropdown" id="ticker-dropdown"></div>
    </div>
    <div class="search-db-note">
      <span class="sdb-badge" id="db-count-badge">Loadingâ€¦</span>
    </div>
    <div class="price-loading-row" id="price-loading-row">
      <div class="price-spinner"></div>
      <span class="price-status" id="price-status-text">Fetching end-of-day priceâ€¦</span>
    </div>
  </div>

  <div class="sb-lbl" style="padding-top:4px">Quick start <span id="onboard-hint" style="font-size:9px;font-weight:500;color:var(--gold);text-transform:none;letter-spacing:0;margin-left:4px;animation:pulse-hint 1.8s ease-in-out infinite">â† pick one to begin</span></div>
  <div class="co-grid" id="co-grid">
    <button class="co-pill" onclick="loadPreset('AAPL')"><span class="pt">AAPL</span></button>
    <button class="co-pill" onclick="loadPreset('MSFT')"><span class="pt">MSFT</span></button>
    <button class="co-pill" onclick="loadPreset('NVDA')"><span class="pt">NVDA</span></button>
    <button class="co-pill" onclick="loadPreset('META')"><span class="pt">META</span></button>
    <button class="co-pill" onclick="loadPreset('TSLA')"><span class="pt">TSLA</span></button>
    <button class="co-pill" onclick="loadPreset('NFLX')"><span class="pt">NFLX</span></button>
  </div>
  <div class="data-provenance" id="data-provenance">
    <svg viewBox="0 0 12 12" fill="none" width="10" height="10" style="flex-shrink:0;margin-top:1px"><circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.3"/><path d="M6 5v3.5M6 3.5v.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
    <span id="provenance-text">Data from annual reports. Prices as of <strong>Feb 2026</strong> â€” verify before use.</span>
  </div>

  <div class="field">
    <label>Company name</label>
    <input type="text" id="inp-company" placeholder="e.g. Netflix"/>
  </div>
  <div class="field">
    <label>Stock price <span class="note" id="price-ccy-note">USD</span><a id="price-check-link" href="#" target="_blank" rel="noopener noreferrer" onclick="return !!this.dataset.ready" style="display:none;margin-left:auto;font-size:10px;font-weight:500;color:var(--gold);text-decoration:none;font-family:var(--ff-mono);letter-spacing:.1px;white-space:nowrap;border-bottom:1px dashed currentColor;padding-bottom:1px" title="Opens a Google search for the current stock price in a new tab â€” the price stored here may be out of date">Check price on Google â†—</a></label>
    <input type="text" id="inp-price" placeholder="e.g. 78.00"/>
  </div>

  <div class="sb-lbl" style="margin-top:4px">Currency</div>
  <div class="ccy-row" style="margin-bottom:8px">
    <div class="field">
      <label>Financials in</label>
      <select id="sel-fccy" onchange="onCurrencyChange()">
        <option>USD</option><option>EUR</option><option>GBP</option><option>JPY</option>
        <option>CNY</option><option>KRW</option><option>INR</option><option>CAD</option>
        <option>AUD</option><option>NOK</option><option>SEK</option><option>CHF</option>
      </select>
    </div>
    <div class="field">
      <label>Price in</label>
      <select id="sel-pccy" onchange="onCurrencyChange()">
        <option>USD</option><option>EUR</option><option>GBP</option><option>JPY</option>
        <option>CNY</option><option>KRW</option><option>INR</option><option>CAD</option>
        <option>AUD</option><option>NOK</option><option>SEK</option><option>CHF</option>
      </select>
    </div>
  </div>
  <div id="fx-rate-row" style="display:none">
    <div class="fx-box">
      <label>1 <span id="fccy-lbl">USD</span> = ? <span id="pccy-lbl">USD</span></label>
      <input type="number" id="inp-fxrate" placeholder="1.0" step="0.0001" oninput="update()"/>
    </div>
  </div>

  <div class="sb-lbl">Financials (all in millions)</div>
  <div class="field">
    <label>Shares outstanding</label>
    <input type="text" id="inp-shares" placeholder="e.g. 4317"/>
  </div>
  <div class="field">
    <label>Revenue</label>
    <input type="text" id="inp-revenue" placeholder="e.g. 45183"/>
  </div>
  <div id="warn-scale" class="warn" style="display:none">âš  Revenue looks small â€” remember all figures should be in <strong>millions</strong>. Apple's revenue is ~416,000M, Netflix ~45,000M.</div>
  <div class="field">
    <label>Free cash flow</label>
    <input type="text" id="inp-fcf" placeholder="e.g. 9461"/>
  </div>
  <div class="field">
    <label>Net cash <span class="note">+ = cash Â· âˆ’ = debt</span></label>
    <input type="text" id="inp-netcash" placeholder="e.g. -4500"/>
  </div>

  <div id="margin-chip" style="display:none">
    <div class="margin-chip">
      <span class="mc-lbl">FCF Margin</span>
      <span class="mc-val" id="mc-val">â€”</span>
    </div>
  </div>
  <div id="warn-fcf" class="warn">âš  Negative cash flow â€” results may not be reliable.</div>
  <div id="err-rev" class="err">Revenue must be a positive number.</div>

  <div class="sb-lbl" style="margin-top:4px">Growth assumptions</div>
  <div class="growth-card">
    <div class="sl-row">
      <div class="sl-top"><span>Years to forecast</span><span id="lbl-years">8 yrs</span></div>
      <input type="range" id="sl-years" min="3" max="20" step="1" value="8" oninput="onSl('years')"/>
    </div>
    <div class="sl-row" style="margin-bottom:4px">
      <div class="sl-top"><span>Revenue growth per year</span><span id="lbl-cagr">10%</span></div>
      <input type="range" id="sl-cagr" min="-30" max="100" step="1" value="10" oninput="onSl('cagr')"/>
    </div>
    <div class="bench-grid" id="bench-grid">
      <div class="bench-pill" id="bp-5" onclick="setBench(5)"><span class="bp-rate">5%</span><span class="bp-lbl">Mature</span></div>
      <div class="bench-pill" id="bp-10" onclick="setBench(10)"><span class="bp-rate">10%</span><span class="bp-lbl">S&amp;P avg</span></div>
      <div class="bench-pill" id="bp-20" onclick="setBench(20)"><span class="bp-rate">20%</span><span class="bp-lbl">Fast growth</span></div>
    </div>
    <div class="sl-row" style="margin-top:10px;margin-bottom:0">
      <div class="sl-top"><span>Margin change per year</span><span id="lbl-dpp">0.0pp</span></div>
      <input type="range" id="sl-dpp" min="-5" max="5" step="0.1" value="0" oninput="onSl('dpp')"/>
    </div>
  </div>

  <div class="sb-lbl" style="margin-top:4px">Terminal value method</div>
  <div class="seg">
    <button class="seg-btn active" id="rb-tg" onclick="setTerm('growth')">Growth rate</button>
    <button class="seg-btn" id="rb-tm" onclick="setTerm('multiple')">Exit multiple</button>
  </div>
  <div id="tg-wrap">
    <div class="sl-row">
      <div class="sl-top"><span>Terminal growth rate</span><span id="lbl-tg">2.0%</span></div>
      <input type="range" id="sl-tg" min="-10" max="10" step="0.5" value="2" oninput="onSl('tg')"/>
    </div>
  </div>
  <div id="tm-wrap" style="display:none">
    <div class="sl-row">
      <div class="sl-top"><span>Exit multiple (Ã— FCF)</span><span id="lbl-tmult">15.0Ã—</span></div>
      <input type="range" id="sl-tmult" min="3" max="40" step="0.5" value="15" oninput="onSl('tmult')"/>
    </div>
  </div>

  <div id="sb-sum-wrap" style="display:none">
    <div class="sb-sum">
      <div class="ss-row"><span class="ss-lbl" id="sum-co">â€”</span><span class="ss-val" id="sum-px">â€”</span></div>
      <div class="ss-row"><span class="ss-lbl">FCF margin</span><span class="ss-val" id="sum-margin">â€”</span></div>
      <div class="ss-row"><span class="ss-lbl">Revenue growth</span><span class="ss-val" id="sum-growth">â€”</span></div>
      <div class="ss-row"><span class="ss-lbl">Forecast period</span><span class="ss-val" id="sum-years">â€”</span></div>
      <div class="ss-row"><span class="ss-lbl">Terminal</span><span class="ss-val" id="sum-terminal">â€”</span></div>
    </div>
  </div>
  <button class="sb-reset" id="btn-reset" style="display:none" onclick="resetInputs()">Clear all inputs</button>

</aside>

<!-- MAIN -->
<main id="main">

  <!-- Methodology -->
  <div id="methodology">
    <div class="mth-tag">How it works</div>
    <h1 class="mth-h1">The math behind every number</h1>
    <p class="mth-intro">All three tools use the same engine: discounted cash flow. Here's exactly what happens when you change an input.</p>

    <div class="mth-sec">
      <h2 class="mth-h2">1. Fair Value â€” what is the stock worth?</h2>
      <p class="mth-p">We estimate how much cash the company will generate each year, then shrink those future cash flows back to today's value (because $1 today is worth more than $1 in 10 years). The sum is the company's equity value. Divide by shares to get fair value per share.</p>
      <div class="mth-formula">
        Cash flow year t = Revenue Ã— Margin<br>
        Today's value = Cash flow Ã· (1 + your required return)^t<br><br>
        <strong>Gordon Growth terminal value:</strong><br>
        Terminal value = last FCF Ã— (1 + long-run growth) Ã· (return âˆ’ growth)<br><br>
        <strong>Exit Multiple terminal value:</strong><br>
        Terminal value = last FCF Ã— your chosen multiple<br><br>
        Fair value per share = (sum of all PVs + terminal PV âˆ’ net debt) Ã· shares
      </div>
      <div class="mth-note">Net cash <em>adds</em> to fair value. Net debt <em>reduces</em> it. With Gordon Growth, terminal growth must stay below your required return â€” otherwise the formula breaks.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">2. Implied return â€” what does the price say?</h2>
      <p class="mth-p">Instead of solving for fair value, we flip the question: what annual return would make the fair value equal to today's price? The result is your implied return â€” compare it to your own required return to judge whether the stock is attractive to you.</p>
      <div class="mth-formula">Find the return rate where: fair value = market price</div>
      <div class="mth-note">There is no universal "good" return â€” it depends on your personal required return, risk tolerance, and opportunity cost.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">3. Scenario grid â€” what if growth is different?</h2>
      <p class="mth-p">We run the implied return calculation across every combination of revenue growth and terminal value â€” all at once. Three versions run in parallel: one where margins shrink 1pp/year (Bear), one unchanged (Base), and one where margins improve 1pp/year (Bull). The colour scale goes from red (low return) to blue (high return) â€” you decide where your threshold is.</p>
      <div class="mth-note"><strong>The summary strip at the top</strong> shows the median implied return across all cells in the grid â€” Bear, Base, and Bull â€” so you can see the typical outcome rather than just one scenario.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">4. Limitations</h2>
      <p class="mth-p">Small changes to growth or terminal value can swing the output significantly. Treat this as a thinking tool, not a precise answer.</p>
      <ul style="font-size:13px;color:var(--ink-3);line-height:2.2;padding-left:16px">
        <li>Not investment advice</li>
        <li>Pre-loaded numbers are manually updated and may be out of date</li>
        <li>Does not account for dilution or one-off items</li>
      </ul>
    </div>
    <button class="mth-back" onclick="hideMethodology()">â† Back</button>
  </div>

  <!-- App view -->
  <div id="app-view" style="display:flex;flex-direction:column;flex:1">
    <nav id="tabbar">
      <button class="tab-btn active" onclick="switchTab('dcf')" data-short="Fair Value">Fair Value</button>
      <button class="tab-btn" onclick="switchTab('rev')" data-short="Impl. Return">Implied Return</button>
      <button class="tab-btn" onclick="switchTab('matrix')" data-short="Scenarios">Scenario Grid</button>
      <div class="tab-sep"></div>
    </nav>

    <!-- DCF Tab -->
    <div class="tab-panel active" id="tab-dcf">
      <div id="dcf-empty" class="empty">
        <svg viewBox="0 0 40 40" fill="none"><path d="M6 30l8-12 8 8 6-8 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div class="empty-title">Pick a company to start</div>
        <div class="empty-body" id="dcf-empty-body">Tap any ticker on the left â€” data loads in one click. Or fill in the fields manually.</div>
      </div>
      <div id="dcf-content" style="display:none">

        <!-- ONE unified card: required return (input) + FV vs Market (output) -->
        <div class="val-card" id="val-card">

          <!-- Required return slider â€” top, as it's the key input -->
          <div class="val-card-slider">
            <div class="vcs-top">
              <div class="vcs-label">
                <span class="vcs-title">Required return</span>
                <span class="vcs-tag">or WACC</span>
              </div>
              <span class="vcs-val" id="lbl-disc">12%</span>
            </div>
            <div class="vcs-track">
              <input type="range" id="sl-disc" min="1" max="50" step="1" value="12" oninput="onDiscChange()"/>
              <div class="vcs-thumb" id="disc-thumb"></div>
            </div>
            <div class="vcs-hints">
              <div class="vcs-hint" onclick="setDisc(8)"><div class="vcs-hint-rate">8%</div><div class="vcs-hint-lbl">Aggressive</div></div>
              <div class="vcs-hint" onclick="setDisc(12)"><div class="vcs-hint-rate">12%</div><div class="vcs-hint-lbl">Moderate</div></div>
              <div class="vcs-hint" onclick="setDisc(15)"><div class="vcs-hint-rate">15%</div><div class="vcs-hint-lbl">Careful</div></div>
              <div class="vcs-hint" onclick="setDisc(20)"><div class="vcs-hint-rate">20%</div><div class="vcs-hint-lbl">Very strict</div></div>
            </div>
          </div>

          <!-- Numbers + verdict â€” result of the input above -->
          <div class="val-card-top" id="dcf-hero"></div>
          <div id="dcf-verdict"></div>

        </div>

        <!-- hidden compat divs (JS still writes to dcf-cmp) -->
        <div id="dcf-cmp" style="display:none"></div>

        <!-- Chart -->
        <div class="chart-card">
          <div class="chart-card-title">Fair value at every discount rate</div>
          <div class="chart-card-sub"><span style="color:var(--green-dk);font-weight:500">Green zone</span> = stock looks cheap at that return target. <span style="color:var(--red-dk);font-weight:500">Red zone</span> = price exceeds fair value. The dot marks your current required return â€” adjust the slider above to move it.</div>
          <canvas id="chart-sens" height="220" style="width:100%"></canvas>
          <div class="chart-legend">
            <div class="leg"><div class="leg-dot" style="background:var(--blue)"></div>Fair value per share</div>
            <div class="leg"><div class="leg-dot" style="background:var(--ink-4);width:18px;height:1.5px;border-radius:0"></div>Market price</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(26,122,60,.18)"></div>Cheap zone</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(192,57,43,.12)"></div>Expensive zone</div>
          </div>
        </div>

        <div class="coll">
          <div class="coll-hdr" onclick="toggleColl(this)">Year-by-year numbers &amp; value breakdown <span class="coll-arrow">â–¼</span></div>
          <div class="coll-body">
            <div style="overflow-x:auto"><table class="data-tbl" id="forecast-tbl"></table></div>
            <div id="bridge-wrap"></div>
            <button class="btn-dl" onclick="downloadForecast()" style="margin-top:8px">â¬‡ Download CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reverse DCF Tab -->
    <div class="tab-panel" id="tab-rev">
      <div id="rev-empty" class="empty">
        <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="12" stroke="currentColor" stroke-width="2"/><path d="M20 14v6l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <div class="empty-title">Enter data to see the implied return</div>
        <div class="empty-body" id="rev-empty-body">The implied return answers: what annual gain does the current price assume?</div>
      </div>
      <div id="rev-content" style="display:none">

        <!-- Hero result card â€” filled by renderRev() -->
        <div id="irr-hero"></div>

        <!-- Price explorer -->
        <div class="rev-price-ctrl">
          <div class="rpc-top">
            <div>
              <div class="rpc-label">What if the price were different?</div>
              <div class="rpc-sub">Move the slider to explore any entry price. The implied annual return recalculates instantly â€” everything else (growth, margins, terminal value) stays the same.</div>
            </div>
            <div class="rpc-price-display">
              <div class="rpc-price-val" id="rev-price-display">â€”</div>
              <div class="rpc-price-ccy" id="rev-price-ccy">USD</div>
            </div>
          </div>
          <div class="rpc-slider-row">
            <span class="rpc-bound" id="rev-price-min">â€”</span>
            <div class="rpc-track-wrap">
              <input type="range" id="rev-sl-price" min="0" max="100" step="1" value="50" oninput="onRevPriceChange(this.value)"/>
            </div>
            <span class="rpc-bound" id="rev-price-max">â€”</span>
          </div>
          <div class="rpc-result" id="rpc-result-row" style="display:none">
            <div class="rpc-result-item">
              <div class="rpc-result-lbl">Implied return</div>
              <div class="rpc-result-val" id="rpc-explored-irr">â€”</div>
            </div>
            <div class="rpc-result-div"></div>
            <div class="rpc-result-item">
              <div class="rpc-result-lbl">vs current price</div>
              <div class="rpc-result-val" id="rpc-irr-delta">â€”</div>
            </div>
            <div class="rpc-result-div"></div>
            <div class="rpc-result-item">
              <div class="rpc-result-lbl">Price change</div>
              <div class="rpc-result-val" id="rpc-price-delta">â€”</div>
            </div>
            <button class="rpc-reset" onclick="resetRevPrice()">Reset</button>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-card-title">Implied return across prices</div>
          <div class="chart-card-sub">The dashed line marks your required return from the Fair Value tab. The green zone shows prices where the implied return exceeds it. <strong>Click or drag</strong> to explore.</div>
          <canvas id="chart-irr" height="220" style="width:100%;cursor:crosshair"></canvas>
          <div class="chart-legend" style="margin-top:10px" id="irr-chart-legend">
            <div class="leg"><div class="leg-dot" style="background:var(--blue)"></div>Implied return</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(26,122,60,.2)"></div>Above your required return</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(192,57,43,.12)"></div>Below your required return</div>
            <div class="leg"><div style="width:18px;height:1.5px;border-top:2px dashed var(--ink-4);margin-top:5px"></div><span id="irr-hurdle-legend-lbl">Your required return (12%)</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Matrix Tab -->
    <div class="tab-panel" id="tab-matrix">
      <div id="matrix-empty" class="empty">
        <svg viewBox="0 0 40 40" fill="none"><rect x="6" y="6" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/><rect x="23" y="6" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/><rect x="6" y="23" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/><rect x="23" y="23" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/></svg>
        <div class="empty-title">Enter data to see the scenario grid</div>
        <div class="empty-body" id="matrix-empty-body">The grid shows implied returns across every growth rate and exit assumption.</div>
      </div>
      <div id="matrix-content" style="display:none">

        <!-- Matrix-level warning banner (shown when many cells are blank) -->
        <div id="matrix-warn" style="display:none" class="calc-warn" style="margin-bottom:12px"></div>

        <!-- Scenario summary strip -->
        <div class="sc-strip" id="sc-strip"></div>

        <!-- View toggle -->
        <div class="mx-view-toggle">
          <span class="mx-toggle-label">View as</span>
          <div class="mx-seg">
            <button class="mx-seg-btn active" id="mx-btn-table" onclick="setMatrixView('table')">Heatmap</button>
            <button class="mx-seg-btn" id="mx-btn-chart" onclick="setMatrixView('chart')">Chart</button>
          </div>
        </div>

        <!-- Colour legend (table view) -->
        <div class="hm-legend" id="mx-hm-legend">
          <span class="hm-end bad">Low return</span>
          <div style="flex:1">
            <div class="hm-bar"></div>
            <div class="hm-tick-row"><span>0%</span><span>5%</span><span>10%</span><span>15%</span><span>20%+</span></div>
          </div>
          <span class="hm-end good">High return</span>
        </div>

        <!-- Matrix chart (chart view, hidden by default) -->
        <div class="matrix-chart-card" id="mx-chart-card" style="display:none">
          <div class="mchart-title">Return range by growth rate</div>
          <div class="mchart-sub">The band shows the spread of implied returns across all terminal value assumptions. The line is the median â€” wider band = more uncertainty from terminal value choice.</div>
          <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap" id="mx-chart-scenario-tabs">
            <button class="mx-seg-btn active" onclick="setMatrixChartScenario('base',this)">Base</button>
            <button class="mx-seg-btn" onclick="setMatrixChartScenario('bear',this)">Bear</button>
            <button class="mx-seg-btn" onclick="setMatrixChartScenario('bull',this)">Bull</button>
          </div>
          <!-- Compact legend -->
          <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px" id="mx-chart-legend">
            <div class="leg"><div style="width:18px;height:2.5px;background:var(--blue);border-radius:2px;flex-shrink:0"></div>Median</div>
            <div class="leg">
              <div style="width:16px;height:10px;background:rgba(26,92,152,.18);border-radius:2px;flex-shrink:0"></div>
              Middle 50% of range
            </div>
            <div class="leg">
              <div style="width:16px;height:10px;background:rgba(26,92,152,.07);border:1px dashed rgba(26,92,152,.3);border-radius:2px;flex-shrink:0"></div>
              Full range (minâ€“max)
            </div>
            <div class="leg" style="color:var(--ink-4)">
              <div style="width:18px;height:0;border-top:1.5px dashed rgba(74,70,64,.55);flex-shrink:0;margin-top:1px"></div>
              <span id="mx-hurdle-legend-lbl">Your return (12%) â€” from Fair Value tab</span>
            </div>
          </div>
          <canvas id="chart-matrix" style="width:100%" height="260"></canvas>

          <!-- How to read this chart -->
          <div class="coll" style="margin-top:10px;box-shadow:none;border-color:var(--border-2)">
            <div class="coll-hdr" onclick="toggleColl(this)" style="font-size:11.5px;padding:9px 14px;color:var(--ink-4)">
              How to read this chart <span class="coll-arrow">â–¼</span>
            </div>
            <div class="coll-body" style="padding:12px 14px;background:var(--surface-2)">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:18px;height:2.5px;background:var(--blue);border-radius:2px;flex-shrink:0;margin-top:7px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Median line</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">The middle implied return across all terminal value assumptions at that growth rate. Half the outcomes are above this line, half below.</div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:16px;height:10px;background:rgba(26,92,152,.18);border-radius:2px;flex-shrink:0;margin-top:4px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Middle 50% of range</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">The inner shaded band. If you have 5 terminal value columns, this is the spread between the 2nd-lowest and 2nd-highest result â€” the typical cluster, excluding extremes.</div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:16px;height:10px;background:rgba(26,92,152,.07);border:1px dashed rgba(26,92,152,.3);border-radius:2px;flex-shrink:0;margin-top:4px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Full range (minâ€“max)</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">The outer faint band bounded by dashed lines. Shows the best and worst implied return across every terminal value assumption â€” the full spread of uncertainty.</div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:18px;height:0;border-top:1.5px dashed rgba(74,70,64,.55);flex-shrink:0;margin-top:7px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Your required return</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">Pulled from your discount rate in the Fair Value tab. Results above this line meet your return target; results below do not.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Matrix controls -->
        <div class="mc-ctrl" id="mc-ctrl">
          <div>
            <div class="mc-group-label">Rows â€” revenue growth range</div>
            <div class="mc-inputs">
              <div class="field"><label>Min %</label><input type="number" id="mc-gmin" value="0" step="1" oninput="renderMatrix()"/></div>
              <div class="field"><label>Max %</label><input type="number" id="mc-gmax" value="20" step="1" oninput="renderMatrix()"/></div>
              <div class="field"><label>Rows</label><input type="number" id="mc-grows" value="6" min="2" max="12" oninput="renderMatrix()"/></div>
            </div>
          </div>
          <div>
            <div class="mc-group-label" id="mc-col-lbl">Columns â€” terminal growth range</div>
            <div class="mc-inputs">
              <div class="field"><label id="mc-min-lbl">Min %</label><input type="number" id="mc-tmin" value="0" step="0.5" oninput="renderMatrix()"/></div>
              <div class="field"><label id="mc-max-lbl">Max %</label><input type="number" id="mc-tmax" value="4" step="0.5" oninput="renderMatrix()"/></div>
              <div class="field"><label>Cols</label><input type="number" id="mc-tcols" value="5" min="2" max="10" oninput="renderMatrix()"/></div>
            </div>
          </div>
        </div>

        <div id="matrix-tables"></div>
      </div>
    </div>
  </div>
</main>
</div>
</div>

<!-- Mobile bar -->
<div id="mobile-bar">
  <div class="mb-row">
    <div><div class="mb-lbl">Fair Value</div><div class="mb-val" id="mb-fv">â€”</div></div>
    <div class="mb-div"></div>
    <div><div class="mb-lbl">Price</div><div class="mb-val" id="mb-px">â€”</div></div>
    <div class="mb-div"></div>
    <div id="mb-badge-wrap" style="flex:1"></div>
    <button class="mb-action-btn" onclick="shareURL()" title="Share">â¬†</button>
    <button class="mb-action-btn mb-action-save" onclick="saveReport()" title="Save Report">â¬‡</button>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PRESETS={
  NFLX:{company:'Netflix (NFLX)',price:'78.67',shares:'4317',revenue:'45183',fcf:'9461',netcash:'-4500',cagr:12,dpp:0,years:8,termMode:'growth',tg:3,tmult:'15',fccy:'USD',pccy:'USD'},
  AAPL:{company:'Apple (AAPL)',price:'264',shares:'14680',revenue:'416161',fcf:'98767',netcash:'34000',cagr:8,dpp:0.2,years:8,termMode:'growth',tg:2.5,tmult:'20',fccy:'USD',pccy:'USD'},
  MSFT:{company:'Microsoft (MSFT)',price:'397',shares:'7433',revenue:'281724',fcf:'71611',netcash:'27000',cagr:15,dpp:0.1,years:8,termMode:'growth',tg:3,tmult:'20',fccy:'USD',pccy:'USD'},
  NVDA:{company:'Nvidia (NVDA)',price:'190',shares:'24400',revenue:'130497',fcf:'60853',netcash:'38000',cagr:30,dpp:0,years:8,termMode:'growth',tg:3,tmult:'25',fccy:'USD',pccy:'USD'},
  META:{company:'Meta (META)',price:'656',shares:'2530',revenue:'164501',fcf:'52100',netcash:'52000',cagr:15,dpp:0.2,years:8,termMode:'growth',tg:3,tmult:'18',fccy:'USD',pccy:'USD'},
  TSLA:{company:'Tesla (TSLA)',price:'412',shares:'3200',revenue:'94830',fcf:'6200',netcash:'44100',cagr:20,dpp:0.5,years:8,termMode:'growth',tg:3,tmult:'20',fccy:'USD',pccy:'USD'},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pf(s){
  if(s===null||s===undefined||s==='')return NaN;
  s=String(s).trim();
  // Detect comma-as-decimal: if comma appears once and after it are exactly 1-2 digits at end
  // e.g. "199,78" or "1,5" â†’ treat comma as decimal point
  // But "1,000" or "1,000,000" â†’ treat commas as thousand separators
  const commaCount=(s.match(/,/g)||[]).length;
  const dotCount=(s.match(/\./g)||[]).length;
  if(commaCount===1&&dotCount===0&&/,\d{1,2}$/.test(s)){
    // Single comma followed by 1-2 digits â€” decimal separator
    s=s.replace(',','.');
  } else {
    // Strip commas as thousand separators
    s=s.replace(/,/g,'');
  }
  const n=parseFloat(s);
  return isNaN(n)?NaN:n;
}
function linspace(a,b,n){const r=[];for(let i=0;i<n;i++)r.push(a+(b-a)*i/Math.max(n-1,1));return r}

function projectFCFs(inp){
  const rows=[];let rev=inp.revLTM,marg=inp.fcfMargin;
  for(let y=1;y<=inp.years;y++){
    rev*=(1+inp.cagr);marg+=inp.dpp;
    const fcf=rev*marg,df=1/Math.pow(1+inp.disc,y);
    rows.push({year:y,rev,marg,fcf,df,discFcf:fcf*df});
  }
  return rows;
}
function terminalPV(inp,lastFCF){
  let tv;
  if(inp.termMode==='multiple')tv=lastFCF*inp.tmult;
  else{const gap=Math.max(inp.disc-inp.tg,.001);tv=lastFCF*(1+inp.tg)/gap}
  return tv/Math.pow(1+inp.disc,inp.years);
}
function fairValue(inp){
  const rows=projectFCFs(inp);
  const pvFCFs=rows.reduce((s,r)=>s+r.discFcf,0);
  const lastFCF=rows[rows.length-1].fcf;
  if(!isFinite(lastFCF)||lastFCF<=0)return{ok:false,rows};
  const pvTV=terminalPV(inp,lastFCF);
  const equityPV=pvFCFs+pvTV-inp.netDebt;
  if(equityPV<=0)return{ok:false,pvFCFs,pvTV,equityPV,lastFCF,rows};
  const fvLocal=equityPV/inp.shares;
  return{ok:true,pvFCFs,pvTV,equityPV,fvLocal,fvps:fvLocal*inp.fxRate,lastFCF,rows};
}
function impliedIRR(inp,price){
  const pl=price/inp.fxRate;
  let lo=.001,hi=2;
  for(let i=0;i<80;i++){
    const mid=(lo+hi)/2;
    const r=fairValue({...inp,disc:mid});
    if(!r.ok){hi=mid;continue}
    if(r.fvLocal>pl)lo=mid;else hi=mid;
    if(hi-lo<1e-7)break;
  }
  const mid=(lo+hi)/2;
  const r=fairValue({...inp,disc:mid});
  if(!r.ok||Math.abs(r.fvLocal-pl)/Math.max(pl,.01)>.02)return null;
  return mid;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE & HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let termMode='growth',activeTab='dcf';
let _sensData=[],_revData=[],_forecastRows=[];

function fmt(n,d=2){if(!isFinite(n))return'â€”';return n.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d})}
function fmtPct(n,d=1){if(!isFinite(n))return'â€”';return(n>=0?'+':'')+fmt(n*100,d)+'%'}
function fmtPctPlain(n,d=1){return fmt(n*100,d)+'%'}
function cssVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}

function irrColor(v){
  if(!isFinite(v))return{bg:'var(--surface-2)',fg:'var(--ink-4)'};
  const H=.10;let r,g,b,fg;
  if(v<0){const t=Math.min(-v/.25,1);r=Math.round(252+(127-252)*t);g=Math.round(165+(29-165)*t);b=Math.round(165+(29-165)*t);fg=t>.5?'#fff':'#7f1d1d'}
  else if(v<H){const t=v/H;r=Math.round(252+(254-252)*t);g=Math.round(165+(249-165)*t);b=Math.round(165+(240-165)*t);fg='#c0392b'}
  else if(v<.15){const t=(v-H)/.05;r=Math.round(254+(220-254)*t);g=Math.round(249+(252-249)*t);b=Math.round(240+(220-240)*t);fg='#1a7a30'}
  else{const t=Math.min((v-.15)/.15,1);r=Math.round(220+(20-220)*t);g=Math.round(252+(120-252)*t);b=Math.round(220+(60-220)*t);fg=t>.4?'#fff':'#166534'}
  return{bg:`rgb(${r},${g},${b})`,fg};
}

function getInputs(){
  return{
    company:document.getElementById('inp-company').value.trim(),
    price:pf(document.getElementById('inp-price').value),
    shares:pf(document.getElementById('inp-shares').value),
    revLTM:pf(document.getElementById('inp-revenue').value),
    fcfLTM:pf(document.getElementById('inp-fcf').value),
    netCashRaw:pf(document.getElementById('inp-netcash').value),
    cagr:parseInt(document.getElementById('sl-cagr').value)/100,
    dpp:parseFloat(document.getElementById('sl-dpp').value)/100,
    years:parseInt(document.getElementById('sl-years').value)||8,
    disc:parseInt(document.getElementById('sl-disc').value)/100,
    termMode,
    tg:parseFloat(document.getElementById('sl-tg').value)/100,
    tmult:parseFloat(document.getElementById('sl-tmult').value),
    fccy:document.getElementById('sel-fccy').value,
    pccy:document.getElementById('sel-pccy').value,
    fxRate:pf(document.getElementById('inp-fxrate').value)||1,
  };
}
function buildInp(raw){
  if(!isFinite(raw.revLTM)||raw.revLTM<=0)return null;
  if(!isFinite(raw.fcfLTM))return null;
  if(!isFinite(raw.shares)||raw.shares<=0)return null;
  if(!isFinite(raw.price)||raw.price<=0)return null;
  if(raw.termMode==='multiple'&&(!isFinite(raw.tmult)||raw.tmult<=0))return null;
  const margin=raw.fcfLTM/raw.revLTM;
  if(!isFinite(margin))return null;
  const netDebt=isFinite(raw.netCashRaw)?-raw.netCashRaw:0;
  const fxRate=(raw.fccy===raw.pccy)?1:(isFinite(raw.fxRate)&&raw.fxRate>0?raw.fxRate:1);
  return{...raw,fcfMargin:margin,netDebt,fxRate};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTROLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearPills(){document.querySelectorAll('.co-pill').forEach(b=>b.classList.remove('active'))}
function hideOnboardHint(){const h=document.getElementById('onboard-hint');if(h){h.style.display='none';localStorage.setItem('vs-onboarded','1')}}

function setBench(v){
  document.getElementById('sl-cagr').value=v;
  onSl('cagr');
}
function syncBenchPills(){
  const v=parseInt(document.getElementById('sl-cagr').value);
  [5,10,20].forEach(n=>{
    const el=document.getElementById('bp-'+n);
    if(el)el.classList.toggle('active',v===n);
  });
}

function onSl(k){
  clearPills();
  if(k==='cagr'){document.getElementById('lbl-cagr').textContent=document.getElementById('sl-cagr').value+'%';syncBenchPills();}
  else if(k==='dpp')document.getElementById('lbl-dpp').textContent=parseFloat(document.getElementById('sl-dpp').value).toFixed(1)+'pp';
  else if(k==='tg')document.getElementById('lbl-tg').textContent=parseFloat(document.getElementById('sl-tg').value).toFixed(1)+'%';
  else if(k==='tmult')document.getElementById('lbl-tmult').textContent=parseFloat(document.getElementById('sl-tmult').value).toFixed(1)+'Ã—';
  else if(k==='years')document.getElementById('lbl-years').textContent=document.getElementById('sl-years').value+' yrs';
  update();
}

function onDiscChange(){
  const v=parseInt(document.getElementById('sl-disc').value);
  document.getElementById('lbl-disc').textContent=v+'%';
  const pct=(v-1)/49*100;
  document.getElementById('disc-thumb').style.left=pct+'%';
  const rs=document.getElementById('rev-sl-disc');
  const rl=document.getElementById('rev-lbl-disc');
  if(rs)rs.value=v;
  if(rl)rl.textContent=v+'%';
  renderDCF();
}
function setDisc(v){document.getElementById('sl-disc').value=v;onDiscChange();}

['inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash']
  .forEach(id=>document.getElementById(id).addEventListener('input',()=>{clearPills();update()}));

// When company name is cleared, wipe the company-specific financials
// but leave all assumptions (growth, discount, terminal, years) intact
document.getElementById('inp-company').addEventListener('input',function(){
  clearPills();
  if(this.value.trim()===''){
    ['inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('btn-reset').style.display='none';
  }
  update();
});

function onCurrencyChange(){
  const f=document.getElementById('sel-fccy').value,p=document.getElementById('sel-pccy').value;
  const diff=f!==p;
  document.getElementById('fx-rate-row').style.display=diff?'':'none';
  document.getElementById('fccy-lbl').textContent=f;
  document.getElementById('pccy-lbl').textContent=p;
  document.getElementById('price-ccy-note').textContent=p;
  update();
}

function setTerm(mode){
  termMode=mode;
  document.getElementById('rb-tg').classList.toggle('active',mode==='growth');
  document.getElementById('rb-tm').classList.toggle('active',mode==='multiple');
  document.getElementById('tg-wrap').style.display=mode==='growth'?'':'none';
  document.getElementById('tm-wrap').style.display=mode==='multiple'?'':'none';
  const isM=mode==='multiple';
  document.getElementById('mc-col-lbl').textContent=isM?'Columns â€” exit multiple range':'Columns â€” terminal growth range';
  document.getElementById('mc-min-lbl').textContent=isM?'Min Ã—':'Min %';
  document.getElementById('mc-max-lbl').textContent=isM?'Max Ã—':'Max %';
  if(isM){document.getElementById('mc-tmin').value=8;document.getElementById('mc-tmax').value=16}
  else{document.getElementById('mc-tmin').value=0;document.getElementById('mc-tmax').value=4}
  update();
}

function toggleDark(){
  const d=document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme',d?'light':'dark');
  document.getElementById('dark-btn').textContent=d?'ğŸŒ™':'â˜€ï¸';
  localStorage.setItem('vs-theme',d?'light':'dark');
  setTimeout(()=>{const inp=buildInp(getInputs());if(!inp)return;if(activeTab==='dcf')drawSensChart(inp.price,inp.disc*100);else if(activeTab==='rev'){const irr=impliedIRR(inp,inp.price);drawIRRChart(inp.price,irr,inp.disc)}},50);
}

function loadPreset(key,isAuto){
  const p=PRESETS[key];if(!p)return;
  if(!isAuto)hideOnboardHint();
  document.querySelectorAll('.co-pill').forEach(b=>{
    b.classList.toggle('active',b.querySelector('.pt').textContent.trim()===key);
  });
  document.getElementById('inp-company').value=p.company;
  document.getElementById('inp-shares').value=p.shares;
  document.getElementById('inp-revenue').value=p.revenue;
  document.getElementById('inp-fcf').value=p.fcf;
  document.getElementById('inp-netcash').value=p.netcash;
  document.getElementById('sl-cagr').value=p.cagr;document.getElementById('lbl-cagr').textContent=p.cagr+'%';syncBenchPills();
  document.getElementById('sl-dpp').value=p.dpp;document.getElementById('lbl-dpp').textContent=p.dpp.toFixed(1)+'pp';
  document.getElementById('sl-years').value=p.years;document.getElementById('lbl-years').textContent=p.years+' yrs';
  setTerm(p.termMode);
  document.getElementById('sl-tg').value=p.tg;document.getElementById('lbl-tg').textContent=p.tg.toFixed(1)+'%';
  document.getElementById('sl-tmult').value=p.tmult;document.getElementById('lbl-tmult').textContent=parseFloat(p.tmult).toFixed(1)+'Ã—';
  document.getElementById('sel-fccy').value=p.fccy||'USD';
  document.getElementById('sel-pccy').value=p.pccy||'USD';
  onCurrencyChange();
  document.getElementById('btn-reset').style.display='';

  // Attempt live EOD price; fall back to preset hardcoded price
  const hasKey = POLYGON_KEY && POLYGON_KEY !== 'REPLACE_WITH_YOUR_POLYGON_KEY';
  if (hasKey) {
    document.getElementById('inp-price').value = '';
    const priceRow = document.getElementById('price-loading-row');
    const priceStatus = document.getElementById('price-status-text');
    if (priceRow) priceRow.classList.add('show');
    if (priceStatus) priceStatus.textContent = 'Fetching end-of-day priceâ€¦';
    update();
    // Async price fetch
    fetch(`https://api.polygon.io/v2/aggs/ticker/${key}/prev?adjusted=true&apiKey=${POLYGON_KEY}`,
      {signal: AbortSignal.timeout(8000)})
      .then(r => r.json())
      .then(data => {
        const c = data?.results?.[0]?.c;
        if (c) {
          document.getElementById('inp-price').value = fmt(c, 2);
          const t = data.results[0].t;
          const ds = t ? new Date(t).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : 'prev close';
          const prov = document.getElementById('provenance-text');
          if (prov) prov.innerHTML = `<strong>${p.company}</strong> Â· Price: ${ds} <span class="live-badge"><span class="live-dot"></span>EOD</span>`;
          if (priceStatus) priceStatus.textContent = `Price: ${ds}`;
        } else {
          document.getElementById('inp-price').value = p.price;
          if (priceStatus) priceStatus.textContent = 'Using preset price (fetch failed)';
        }
      })
      .catch(() => {
        document.getElementById('inp-price').value = p.price;
        if (priceStatus && priceStatus.textContent.includes('Fetching'))
          priceStatus.textContent = 'Using preset price';
      })
      .finally(() => {
        update();
        if (priceRow) setTimeout(() => priceRow.classList.remove('show'), 3000);
      });
  } else {
    document.getElementById('inp-price').value=p.price;
    update();
  }
}

function resetInputs(){
  clearPills();
  ['inp-company','inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('sl-years').value=8;document.getElementById('lbl-years').textContent='8 yrs';
  document.getElementById('sl-cagr').value=10;document.getElementById('lbl-cagr').textContent='10%';syncBenchPills();
  document.getElementById('sl-dpp').value=0;document.getElementById('lbl-dpp').textContent='0.0pp';
  document.getElementById('sl-tg').value=2;document.getElementById('lbl-tg').textContent='2.0%';
  document.getElementById('sl-tmult').value=15;document.getElementById('lbl-tmult').textContent='15.0Ã—';
  document.getElementById('sl-disc').value=12;onDiscChange();
  document.getElementById('sel-fccy').value='USD';document.getElementById('sel-pccy').value='USD';
  onCurrencyChange();setTerm('growth');
  document.getElementById('btn-reset').style.display='none';
  update();
}

function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',['dcf','rev','matrix'][i]===t));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  update();
}

function toggleColl(h){h.classList.toggle('open');h.nextElementSibling.classList.toggle('open')}
function showMethodology(){document.getElementById('app-view').style.display='none';document.getElementById('methodology').style.display='block';document.getElementById('meth-btn').textContent='â† App';document.getElementById('meth-btn').onclick=hideMethodology}
function hideMethodology(){document.getElementById('app-view').style.display='flex';document.getElementById('methodology').style.display='none';document.getElementById('meth-btn').textContent='How it works';document.getElementById('meth-btn').onclick=showMethodology}
function toggleMobile(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show')}
function closeMobile(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show')}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600)}
function saveReport(){
  const raw=getInputs();
  const inp=buildInp(raw);
  if(!inp){showToast('Enter company data first');return;}
  const res=fairValue(inp);
  const irr=impliedIRR(inp,inp.price);
  const up=res.ok?(res.fvps/inp.price-1):null;
  const date=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  const termStr=inp.termMode==='multiple'?`Exit multiple ${fmt(inp.tmult,1)}Ã—`:`Terminal growth ${fmt(inp.tg*100,1)}%`;

  // Scenario grid â€” base scenario across growth 0â€“20%, terminal range
  const isM=inp.termMode==='multiple';
  const growths=[0.05,0.08,0.10,0.12,0.15,0.20];
  const terminals=isM?[8,10,12,15,18]:[0.01,0.02,0.03,0.04];
  function gridHTML(dpp){
    let h=`<tr><th style="text-align:left;padding:6px 10px;font-size:10px;background:#f5f3ee;color:#8a857c;font-family:monospace;border:1px solid #e0dbd0">Growth â†“ / Terminal â†’</th>`;
    terminals.forEach(tv=>h+=`<th style="padding:6px 8px;font-size:10px;background:#f5f3ee;color:#8a857c;font-family:monospace;text-align:center;border:1px solid #e0dbd0">${isM?fmt(tv,0)+'Ã—':fmt(tv*100,1)+'%'}</th>`);
    h+=`</tr>`;
    growths.forEach(g=>{
      h+=`<tr><td style="padding:6px 10px;font-size:11px;font-family:monospace;font-weight:600;color:#4a4640;background:#faf9f6;border:1px solid #e0dbd0">${fmt(g*100,0)}%</td>`;
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv;}else{ci.termMode='growth';ci.tg=tv;}
        const r=impliedIRR(ci,ci.price);
        if(r===null){h+=`<td style="padding:6px 8px;text-align:center;background:#f5f3ee;border:1px solid #e0dbd0;font-family:monospace;font-size:11px;color:#b8b3aa">â€”</td>`;return;}
        // colour
        let bg,fg;
        if(r<0.05){bg='#fca5a5';fg='#7f1d1d';}
        else if(r<0.08){bg='#fdd8b8';fg='#78350f';}
        else if(r<0.10){bg='#fef3c7';fg='#92400e';}
        else if(r<0.13){bg='#d1fae5';fg='#065f46';}
        else if(r<0.17){bg='#6ee7b7';fg='#065f46';}
        else{bg='#047857';fg='#ffffff';}
        h+=`<td style="padding:6px 8px;text-align:center;background:${bg};border:1px solid #e0dbd0;font-family:monospace;font-size:11px;font-weight:700;color:${fg}">${fmt(r*100,1)}%</td>`;
      });
      h+=`</tr>`;
    });
    return h;
  }

  // SVG number line â€” anchored: fair value always at 28% from left,
  // market price proportional so visual gap reflects real ratio
  // (no SVG coordinate variables needed â€” using CSS layout now)

  const goodColor=up!==null&&up>=0?'#1a5c32':'#7a1a1a';
  const goodBg=up!==null&&up>=0?'#edf7f0':'#fdf0f0';
  const fvDisplay=res.ok?fmt(res.fvps):'N/A';
  const upDisplay=up!==null?`${up>=0?'+':''}${fmt(up*100,1)}%`:'N/A';
  const irrDisplay=irr!==null?`${fmt(irr*100,1)}%`:'N/A';
  // IRR: always neutral â€” no green/red judgement
  const irrNumColor='#1a1814';
  const irrBg='#f0ede6';
  const irrFactLine1=irr!==null
    ?`At the current price of ${fmt(inp.price,2)} ${inp.pccy}, these assumptions imply an annual return of ${fmt(irr*100,1)}%.`
    :'No valid implied return could be solved at this price and these assumptions.';
  const irrFactLine2=irr!==null
    ?`This is the discount rate at which the present value of projected cash flows equals the market price.`
    :'';

  const html=`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>${inp.company||'Valuation'} â€” Report</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,500;0,600;0,700;1,600&family=Inter:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Inter',sans-serif;background:#f4f0e8;color:#1a1814;font-size:13px;line-height:1.5;letter-spacing:-.01em;-webkit-font-smoothing:antialiased;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .page{max-width:800px;margin:0 auto;padding:48px 48px 64px;background:#f4f0e8}
  .report-header{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:18px;border-bottom:2px solid #1a1814;margin-bottom:28px}
  .rh-brand{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:#8a857c}
  .rh-date{font-family:'DM Mono',monospace;font-size:10px;color:#8a857c;text-align:right}
  .report-co{margin-bottom:32px}
  .co-name{font-family:'Cormorant Garamond',serif;font-size:40px;font-weight:700;letter-spacing:-1px;line-height:1;color:#1a1814;margin-bottom:7px}
  .co-sub{font-size:11.5px;color:#8a857c;font-family:'DM Mono',monospace;letter-spacing:.2px}
  .section{margin-bottom:28px}
  .section-title{font-family:'DM Mono',monospace;font-size:10px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;color:#b07d2e;margin-bottom:14px;padding-bottom:6px;border-bottom:1px solid #d8d3ca}
  /* Inputs grid */
  .inputs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .inp-item{background:#ede8de;border-radius:8px;padding:11px 13px}
  .inp-lbl{font-size:9.5px;color:#8a857c;margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
  .inp-val{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:#1a1814}
  /* Visual cards â€” stacked full-width */
  .visual-row{display:flex;flex-direction:column;gap:16px;margin-bottom:28px}
  .vis-card{border-radius:14px;padding:28px 32px;border:1px solid #d8d3ca}
  .vis-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.4px;text-transform:uppercase;color:#8a857c;margin-bottom:16px}
  /* Fair value card â€” two-number comparison layout */
  .fv-vc-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
  .fv-vc-side{display:flex;flex-direction:column}
  .fv-vc-side.right{align-items:flex-end;text-align:right}
  .fv-vc-lbl{font-family:'DM Mono',monospace;font-size:9.5px;font-weight:500;text-transform:uppercase;letter-spacing:.6px;color:#8a857c;margin-bottom:6px}
  .fv-vc-num{font-family:'Inter','Cormorant Garamond',serif;font-size:52px;font-weight:700;letter-spacing:-2px;line-height:1}
  .fv-vc-ccy{font-family:'DM Mono',monospace;font-size:11px;color:#8a857c;margin-top:5px}
  .fv-vc-mid{display:flex;flex-direction:column;align-items:center;padding:0 24px;gap:3px}
  .fv-vc-divider{width:1px;height:44px;background:#d8d3ca}
  .fv-vc-arrow{font-size:20px;line-height:1;color:#4a4640}
  .fv-vc-delta{font-family:'DM Mono',monospace;font-size:13px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
  .fv-vc-foot{display:flex;align-items:center;gap:8px;margin-top:18px;padding-top:14px;border-top:1px solid #d8d3ca}
  .fv-vc-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-family:'DM Mono',monospace;font-size:12px;font-weight:600}
  .fv-vc-note{font-size:12px;color:#6a6560}
  /* IRR card â€” horizontal layout: big number left, description right */
  .irr-row{display:flex;align-items:center;gap:0}
  .irr-left{flex-shrink:0;padding-right:28px;border-right:1px solid #d8d3ca;min-width:130px}
  .irr-num-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#8a857c;margin-bottom:6px}
  .irr-big{font-family:'Cormorant Garamond',serif;font-size:64px;font-weight:700;letter-spacing:-2.5px;line-height:1;color:#1a1814}
  .irr-right{flex:1;padding-left:28px}
  .irr-desc-head{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:#1a1814;line-height:1.25;margin-bottom:10px;letter-spacing:-.2px}
  .irr-desc-body{font-size:12.5px;color:#6a6560;line-height:1.7;font-weight:300}
  /* Scenario grid */
  .grid-note{font-size:11px;color:#8a857c;font-family:'DM Mono',monospace;margin-bottom:10px}
  table{width:100%;border-collapse:collapse}
  /* Disclaimer */
  .disclaimer{margin-top:36px;padding-top:16px;border-top:1px solid #d8d3ca;font-size:10px;color:#b8b3aa;line-height:1.7;font-family:'DM Mono',monospace}
  @media(max-width:600px){
    .page{padding:28px 20px 48px}
    .vis-card{padding:22px 20px}
    .fv-number{font-size:52px}
    .irr-big{font-size:52px}
    .irr-row{flex-direction:column;align-items:flex-start;gap:16px}
    .irr-left{border-right:none;border-bottom:1px solid #d8d3ca;padding-right:0;padding-bottom:16px;width:100%}
    .irr-right{padding-left:0}
    .co-name{font-size:32px}
    .inputs-grid{grid-template-columns:1fr 1fr}
  }
  @media print{body,html{background:#fff!important}.page{padding:32px 32px 48px;background:#fff!important}}
</style>
</head>
<body>
<div class="page">

  <div class="report-header">
    <div class="rh-brand">Valuation Studio â€” DCF Analysis</div>
    <div class="rh-date">Generated ${date}<br>Not financial advice</div>
  </div>

  <div class="report-co">
    <div class="co-name">${inp.company||'Unnamed Company'}</div>
    <div class="co-sub">${termStr} Â· ${inp.years}-year forecast Â· ${date}</div>
  </div>

  <!-- VISUAL CARDS -->
  <div class="visual-row">

    <!-- Fair Value Card -->
    <div class="vis-card" style="background:${goodBg}">
      <div class="vis-label">Fair Value per Share Â· at ${fmt(inp.disc*100,0)}% required return</div>
      ${res.ok?`
      <div class="fv-vc-row">
        <div class="fv-vc-side">
          <div class="fv-vc-lbl">Fair Value</div>
          <div class="fv-vc-num" style="color:${goodColor}">${fvDisplay}</div>
          <div class="fv-vc-ccy">${inp.pccy}</div>
        </div>
        <div class="fv-vc-mid">
          <div class="fv-vc-divider"></div>
          <div class="fv-vc-arrow">${up>=0?'â†':'â†’'}</div>
          <div class="fv-vc-delta" style="color:${goodColor}">${upDisplay}</div>
          <div class="fv-vc-divider"></div>
        </div>
        <div class="fv-vc-side right">
          <div class="fv-vc-lbl">Market Price</div>
          <div class="fv-vc-num" style="color:#2e2b26">${fmt(inp.price)}</div>
          <div class="fv-vc-ccy">${inp.pccy}</div>
        </div>
      </div>
      <div class="fv-vc-foot">
        <div class="fv-vc-badge" style="background:${up>=0?'rgba(45,106,79,.12)':'rgba(155,34,38,.1)'};color:${goodColor}">
          ${up>=0?'â–²':'â–¼'} ${upDisplay} implied ${up>=0?'upside':'downside'}
        </div>
        <div class="fv-vc-note">market price ${up>=0?'below':'above'} fair value estimate</div>
      </div>
      `:`<div style="color:#8a857c;font-size:13px;margin-top:8px">Could not calculate at these inputs.</div>`}
    </div>

    <!-- Implied Return Card -->
    <div class="vis-card" style="background:${irrBg}">
      <div class="vis-label">Implied Annual Return</div>
      ${irr!==null?`
      <div class="irr-row">
        <div class="irr-left">
          <div class="irr-num-lbl">per year</div>
          <div class="irr-big">${irrDisplay}</div>
        </div>
        <div class="irr-right">
          <div class="irr-desc-head">The return implied by the market price</div>
          <div class="irr-desc-body">${irrFactLine1}<br><br>${irrFactLine2}</div>
        </div>
      </div>
      `:`<div style="color:#8a857c;font-size:13px;margin-top:8px">Could not solve at this price.</div>`}
    </div>
  </div>

  <!-- INPUTS -->
  <div class="section">
    <div class="section-title">Inputs &amp; Assumptions</div>
    <div class="inputs-grid">
      <div class="inp-item"><div class="inp-lbl">Revenue (LTM)</div><div class="inp-val">${fmt(inp.revLTM,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">Free Cash Flow</div><div class="inp-val">${fmt(inp.fcfLTM,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">FCF Margin</div><div class="inp-val">${fmt(inp.fcfMargin*100,1)}%</div></div>
      <div class="inp-item"><div class="inp-lbl">Net Cash / (Debt)</div><div class="inp-val">${fmt(-inp.netDebt,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">Shares Outstanding</div><div class="inp-val">${fmt(inp.shares,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">Stock Price</div><div class="inp-val">${fmt(inp.price,2)} ${inp.pccy}</div></div>
      <div class="inp-item"><div class="inp-lbl">Revenue Growth / yr</div><div class="inp-val">${fmt(inp.cagr*100,1)}%</div></div>
      <div class="inp-item"><div class="inp-lbl">Margin Change / yr</div><div class="inp-val">${fmt(inp.dpp*100,1)} pp</div></div>
      <div class="inp-item"><div class="inp-lbl">Terminal Value</div><div class="inp-val">${termStr}</div></div>
    </div>
  </div>

  <!-- SCENARIO GRID -->
  <div class="section">
    <div class="section-title">Scenario Grid â€” Implied Returns (Base margins)</div>
    <div class="grid-note">Revenue growth Ã— ${isM?'exit multiple':'terminal growth rate'} â€” colour scale: red &lt; 8% Â· amber 8â€“10% Â· green &gt; 10%</div>
    <table><tbody>${gridHTML(0)}</tbody></table>
  </div>

  <div class="disclaimer">
    Generated by Valuation Studio on ${date}. For informational purposes only â€” not financial or investment advice.<br>
    Inputs reflect user-entered assumptions and may differ from actual reported financials. Always verify from primary sources before making any investment decision.
  </div>

</div>
</body>
</html>`;

  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  const safeName=(inp.company||'valuation').replace(/[^a-z0-9]/gi,'_').replace(/_+/g,'_').toLowerCase();
  a.download=safeName+'_valuation.html';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Report saved âœ“  Open in browser â†’ Print â†’ Save as PDF');
}

function shareURL(){
  const raw=getInputs();
  const p=new URLSearchParams({co:raw.company,px:raw.price,sh:raw.shares,rev:raw.revLTM,fcf:raw.fcfLTM,nc:raw.netCashRaw,cagr:document.getElementById('sl-cagr').value,dpp:document.getElementById('sl-dpp').value,yr:raw.years,disc:document.getElementById('sl-disc').value,tm:termMode,tg:document.getElementById('sl-tg').value,tmult:raw.tmult||'',fccy:raw.fccy,pccy:raw.pccy,fxr:raw.fxRate});
  const url=window.location.origin+window.location.pathname+'?'+p.toString();
  navigator.clipboard.writeText(url).then(()=>showToast('Link copied âœ“')).catch(()=>prompt('Copy this link:',url));
}
function loadFromURL(){
  const p=new URLSearchParams(window.location.search);
  // ?blank=1 â†’ full reset, open empty with defaults, show onboarding hint
  if(p.get('blank')==='1'){resetInputs();document.getElementById('btn-reset').style.display='none';return;}
  // ?preset=AAPL â†’ load a specific preset from landing page ticker pills
  if(p.has('preset')&&PRESETS[p.get('preset')]){loadPreset(p.get('preset'));return;}
  if(!p.has('co')&&!p.has('px'))return;
  clearPills();
  const set=(id,v)=>{if(v&&v!=='null')document.getElementById(id).value=v};
  set('inp-company',p.get('co'));set('inp-price',p.get('px'));set('inp-shares',p.get('sh'));
  set('inp-revenue',p.get('rev'));set('inp-fcf',p.get('fcf'));set('inp-netcash',p.get('nc'));
  if(p.get('yr')){const v=+p.get('yr');document.getElementById('sl-years').value=v;document.getElementById('lbl-years').textContent=v+' yrs'}
  if(p.get('tmult')){const v=+p.get('tmult');if(v>0){document.getElementById('sl-tmult').value=v;document.getElementById('lbl-tmult').textContent=v.toFixed(1)+'Ã—';}}
  if(p.get('cagr')){const v=+p.get('cagr');document.getElementById('sl-cagr').value=v;document.getElementById('lbl-cagr').textContent=v+'%';syncBenchPills()}
  if(p.get('dpp')){const v=+p.get('dpp');document.getElementById('sl-dpp').value=v;document.getElementById('lbl-dpp').textContent=v.toFixed(1)+'pp'}
  if(p.get('tg')){const v=+p.get('tg');document.getElementById('sl-tg').value=v;document.getElementById('lbl-tg').textContent=v.toFixed(1)+'%'}
  if(p.get('disc')){const v=+p.get('disc');document.getElementById('sl-disc').value=v;onDiscChange()}
  if(p.get('fccy'))document.getElementById('sel-fccy').value=p.get('fccy');
  if(p.get('pccy'))document.getElementById('sel-pccy').value=p.get('pccy');
  if(p.get('fxr'))document.getElementById('inp-fxrate').value=p.get('fxr');
  onCurrencyChange();if(p.get('tm'))setTerm(p.get('tm'));
  document.getElementById('btn-reset').style.display='';
  update();
}

function diagnoseMissing(raw){
  // Returns an array of {field, fix} objects explaining what's missing/wrong
  const issues=[];
  if(!isFinite(raw.price)||raw.price<=0)
    issues.push({field:'Stock price',fix:'Enter the current share price in the sidebar.'});
  if(!isFinite(raw.shares)||raw.shares<=0)
    issues.push({field:'Shares outstanding',fix:'Enter the total shares outstanding in millions.'});
  if(!isFinite(raw.revLTM)||raw.revLTM<=0)
    issues.push({field:'Revenue',fix:'Enter last twelve months revenue in millions. Must be a positive number.'});
  if(!isFinite(raw.fcfLTM))
    issues.push({field:'Free cash flow',fix:'Enter last twelve months free cash flow in millions. Use a negative number if FCF is negative.'});
  return issues;
}

function updateEmptyStates(raw){
  const issues=diagnoseMissing(raw);
  const ids=['dcf-empty-body','rev-empty-body','matrix-empty-body'];
  if(issues.length===0){
    ids.forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=''});
    return;
  }
  const fieldNames=issues.map(i=>i.field);
  const fixHtml=issues.map(i=>`<div class="cw-item" style="margin:3px 0"><span class="cw-item-icon">â†’</span><span><strong>${i.field}:</strong> ${i.fix}</span></div>`).join('');
  const summary=`Still needed: ${fieldNames.join(', ')}.`;
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.innerHTML=`${summary}<div class="cw-list" style="margin-top:8px;text-align:left">${fixHtml}</div>`;
  });
}


function update(){
  const raw=getInputs();
  const hasFCF=isFinite(raw.fcfLTM),hasRev=isFinite(raw.revLTM)&&raw.revLTM>0;
  const revFieldVal=document.getElementById('inp-revenue').value.trim();
  document.getElementById('warn-fcf').style.display=(hasFCF&&raw.fcfLTM<0)?'block':'none';
  document.getElementById('err-rev').style.display=(revFieldVal!==''&&!hasRev)?'block':'none';
  // Scale sanity check: revenue entered but suspiciously small given the stock price
  const showScaleWarn=hasRev&&isFinite(raw.price)&&raw.price>1&&raw.revLTM<50&&raw.revLTM>0;
  document.getElementById('warn-scale').style.display=showScaleWarn?'block':'none';
  document.getElementById('margin-chip').style.display=(hasFCF&&hasRev)?'':'none';
  if(hasFCF&&hasRev){
    const m=raw.fcfLTM/raw.revLTM;
    document.getElementById('mc-val').textContent=fmt(m*100,1)+'%';
    document.getElementById('mc-val').style.color='';
  }

  // â”€â”€ Price check link â†’ Google search (shows price widget inline)
  const priceLink=document.getElementById('price-check-link');
  const coName=raw.company||'';
  const tickerMatch=coName.match(/\(([A-Z]{1,5})\)/)||coName.match(/^([A-Z]{2,5})$/);
  if(tickerMatch||coName.length>1){
    const q=tickerMatch?`${tickerMatch[1]} stock price`:`${coName} stock price`;
    priceLink.setAttribute('href','https://www.google.com/search?q='+encodeURIComponent(q));
    priceLink.dataset.ready='1';
    priceLink.style.display='inline';
  } else {
    priceLink.style.display='none';
    priceLink.dataset.ready='';
  }

  const inp=buildInp(raw);
  // Update empty-state help text based on what's missing
  if(!inp)updateEmptyStates(raw);
  document.getElementById('sb-sum-wrap').style.display=inp?'':'none';
  if(inp){
    document.getElementById('sum-co').textContent=inp.company||'â€”';
    document.getElementById('sum-px').textContent=fmt(inp.price)+' '+inp.pccy;
    document.getElementById('sum-margin').textContent=fmt(inp.fcfMargin*100,1)+'%';
    document.getElementById('sum-growth').textContent=fmt(inp.cagr*100,0)+'% / yr';
    document.getElementById('sum-years').textContent=inp.years+' years';
    document.getElementById('sum-terminal').textContent=inp.termMode==='multiple'?fmt(inp.tmult,1)+'Ã—':fmt(inp.tg*100,1)+'% / yr';
  }
  if(activeTab==='dcf')renderDCF(inp);
  else if(activeTab==='rev')renderRev(inp);
  else if(activeTab==='matrix')renderMatrix(inp);
  updateMobileBar(inp);
}

function updateMobileBar(inp){
  if(!inp){document.getElementById('mb-fv').textContent='â€”';document.getElementById('mb-px').textContent='â€”';document.getElementById('mb-badge-wrap').innerHTML='';return}
  const res=fairValue(inp);
  document.getElementById('mb-px').textContent=fmt(inp.price)+' '+inp.pccy;
  if(res.ok){
    const up=res.fvps/inp.price-1;
    document.getElementById('mb-fv').textContent=fmt(res.fvps)+' '+inp.pccy;
    const cls=up>=0?'good':'bad';
    document.getElementById('mb-badge-wrap').innerHTML=`<div class="mb-badge ${cls}">${up>=0?'+':''}${fmt(up*100,1)}%</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1 â€” FAIR VALUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDCF(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=!!inp;
  document.getElementById('dcf-empty').style.display=show?'none':'';
  document.getElementById('dcf-content').style.display=show?'':'none';
  if(!show)return;
  const res=fairValue(inp);
  _forecastRows=res.rows||[];
  const pCcy=inp.pccy;
  if(res.ok){
    const up=res.fvps/inp.price-1;
    const good=up>=0;
    // Single unified card: FV | delta | Market + verdict strip
    document.getElementById('dcf-hero').innerHTML=`
      <div class="vc-side">
        <div class="vc-lbl">Fair Value</div>
        <div class="vc-num ${good?'fv-good':'fv-bad'}">${fmt(res.fvps)}</div>
        <div class="vc-ccy">${pCcy}</div>
      </div>
      <div class="vc-mid">
        <div class="vc-divider-v"></div>
        <div class="vc-arrow">${good?'â†':'â†’'}</div>
        <div class="vc-delta ${good?'good':'bad'}">${up>=0?'+':''}${fmt(up*100,1)}%</div>
        <div class="vc-divider-v"></div>
      </div>
      <div class="vc-side right">
        <div class="vc-lbl">Market Price</div>
        <div class="vc-num mkt">${fmt(inp.price)}</div>
        <div class="vc-ccy">${pCcy}</div>
      </div>`;
    document.getElementById('dcf-verdict').innerHTML=`
      <div class="val-card-verdict">
        <div class="vc-verdict-note ${good?'good':'bad'}">${good?'â–² Undervalued at this required return':'â–¼ Overvalued at this required return'}</div>
      </div>`;
  } else {
    // Detailed, actionable error diagnosis
    const diagnose=[];
    if(inp.termMode==='growth'&&inp.tg>=inp.disc){
      diagnose.push({icon:'âš¡',text:`Terminal growth rate (${fmt(inp.tg*100,1)}%) must be strictly lower than your required return (${fmt(inp.disc*100,0)}%). The Gordon Growth formula becomes undefined when r â‰¤ g. â†’ Reduce the "Terminal growth rate" slider below ${fmt(inp.disc*100,0)}%, or raise your required return.`});
    }
    const finalMarg=inp.fcfMargin+inp.dpp*inp.years;
    if(finalMarg<=0){
      diagnose.push({icon:'ğŸ“‰',text:`With a margin change of ${fmt(inp.dpp*100,1)}pp/yr, FCF margin reaches ${fmt(finalMarg*100,1)}% by year ${inp.years} â€” cash flow turns negative before the forecast ends. â†’ Reduce the "Margin change per year" slider, shorten the forecast period, or start with a higher FCF.`});
    }
    if(inp.fcfMargin<=0){
      diagnose.push({icon:'âš ï¸',text:`Starting FCF margin is ${fmt(inp.fcfMargin*100,1)}% â€” the company is not generating positive free cash flow. A standard DCF requires positive cash flows to produce a meaningful valuation. â†’ Check the Revenue and Free Cash Flow inputs, or enter a forward estimate of positive FCF.`});
    }
    if(inp.netDebt>0&&(inp.netDebt/inp.shares)>(inp.price/inp.fxRate)){
      diagnose.push({icon:'ğŸ¦',text:`Net debt per share (${fmt(inp.netDebt/inp.shares,2)}) exceeds the stock price â€” total equity value becomes negative, which produces no valid result. â†’ Check the "Net cash" field. Use a positive value for net cash, negative for net debt.`});
    }
    if(!diagnose.length){
      diagnose.push({icon:'ğŸ”§',text:`The model could not converge on a fair value with these inputs. â†’ Try lowering your required return, raising the revenue growth rate, or confirm that Revenue and Free Cash Flow are both entered correctly.`});
    }
    document.getElementById('dcf-hero').innerHTML=`<div style="grid-column:1/-1;padding:4px 0">
      <div class="calc-warn" style="margin-bottom:0;border:none;box-shadow:none;background:none">
        <div class="cw-head"><div class="cw-icon">â›”</div><div class="cw-title">Fair value cannot be calculated</div></div>
        <div class="cw-body">The current combination of inputs produces a mathematically invalid result. Here's what needs to change:</div>
        <div class="cw-list">${diagnose.map(d=>`<div class="cw-item"><span class="cw-item-icon">${d.icon}</span><span>${d.text}</span></div>`).join('')}</div>
      </div>
    </div>`;
    document.getElementById('dcf-verdict').innerHTML='';
    document.getElementById('dcf-cmp').innerHTML='';
  }
  // Sens data
  _sensData=[];
  for(let r=5;r<=30;r++){const v=fairValue({...inp,disc:r/100});_sensData.push({rate:r,fv:v.ok?v.fvps:null})}
  drawSensChart(inp.price,inp.disc*100);
  renderForecastTable();
  renderBridge(inp,res);
}

function drawSensChart(price,selRate){
  const cv=document.getElementById('chart-sens'),ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1,W=cv.offsetWidth,H=220;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  const PAD={t:20,r:24,b:36,l:60},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;
  const valid=_sensData.filter(d=>d.fv!==null);
  if(valid.length<2)return;
  const fvs=valid.map(d=>d.fv);
  const minFV=Math.min(...fvs,price)*.82,maxFV=Math.max(...fvs,price)*1.14;
  const xp=r=>PAD.l+(r-5)/25*cw,yp=v=>PAD.t+ch-(v-minFV)/(maxFV-minFV)*ch;
  const ink3=cssVar('--ink-3')||'#4a4640';
  const ink4=cssVar('--ink-4')||'#8a857c';
  const ink5=cssVar('--ink-5')||'#b8b2a8';
  const surf=cssVar('--surface')||'#faf8f4';
  const blueColor=cssVar('--blue')||'#1a5c98';
  const pCcy=(buildInp(getInputs())||{}).pccy||'';

  // â”€â”€ Chart background (rounded rect)
  ctx.fillStyle=surf;
  ctx.beginPath();
  ctx.roundRect?ctx.roundRect(PAD.l,PAD.t,cw,ch,4):ctx.rect(PAD.l,PAD.t,cw,ch);
  ctx.fill();

  // â”€â”€ Coloured zone fills FIRST (under grid lines)
  const py=yp(price);
  const above=valid.filter(d=>d.fv>=price);
  const below=valid.filter(d=>d.fv<price);
  if(above.length){
    const g=ctx.createLinearGradient(0,PAD.t,0,py);
    g.addColorStop(0,'rgba(26,122,60,.15)');g.addColorStop(1,'rgba(26,122,60,.03)');
    ctx.beginPath();
    ctx.moveTo(xp(above[0].rate),py);
    above.forEach(d=>ctx.lineTo(xp(d.rate),yp(d.fv)));
    ctx.lineTo(xp(above[above.length-1].rate),py);
    ctx.closePath();ctx.fillStyle=g;ctx.fill();
  }
  if(below.length){
    const g=ctx.createLinearGradient(0,py,0,PAD.t+ch);
    g.addColorStop(0,'rgba(192,57,43,.03)');g.addColorStop(1,'rgba(192,57,43,.13)');
    ctx.beginPath();
    ctx.moveTo(xp(below[0].rate),py);
    below.forEach(d=>ctx.lineTo(xp(d.rate),yp(d.fv)));
    ctx.lineTo(xp(below[below.length-1].rate),py);
    ctx.closePath();ctx.fillStyle=g;ctx.fill();
  }

  // â”€â”€ Zone labels (subtle text inside the zones)
  ctx.font=`500 9.5px 'Inter', sans-serif`;
  if(above.length){
    const midY=Math.max(PAD.t+10, (yp(above[0].fv)+py)/2);
    ctx.fillStyle='rgba(26,122,60,.45)';ctx.textAlign='right';
    ctx.fillText('CHEAP',PAD.l+cw-8,midY);
  }
  if(below.length){
    const midY=Math.min(PAD.t+ch-6,(py+yp(below[below.length-1].fv))/2+8);
    ctx.fillStyle='rgba(192,57,43,.35)';ctx.textAlign='right';
    ctx.fillText('EXPENSIVE',PAD.l+cw-8,midY);
  }

  // â”€â”€ Grid lines (over fills)
  for(let i=0;i<=4;i++){
    const y=PAD.t+i*ch/4;
    const val=minFV+(maxFV-minFV)*(1-i/4);
    ctx.strokeStyle=i===0||i===4?'rgba(26,24,20,.09)':'rgba(26,24,20,.05)';
    ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`500 9px 'DM Mono', monospace`;ctx.textAlign='right';
    ctx.fillText(fmt(val,0),PAD.l-8,y+3.5);
  }
  for(let r=5;r<=30;r+=5){
    const x=xp(r);
    ctx.strokeStyle='rgba(26,24,20,.04)';ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle=ink5;ctx.font=`9px 'DM Mono', monospace`;ctx.textAlign='center';
    ctx.fillText(r+'%',x,PAD.t+ch+16);
  }

  // â”€â”€ Market price horizontal reference line â€” clean dashed, no floating text
  ctx.setLineDash([5,4]);ctx.strokeStyle=ink4;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(PAD.l,py);ctx.lineTo(PAD.l+cw,py);ctx.stroke();
  ctx.setLineDash([]);

  // â”€â”€ Selected-rate vertical drop line
  const selRnd=Math.round(selRate);
  const sx=xp(selRnd);
  ctx.setLineDash([4,3]);ctx.strokeStyle='rgba(26,92,152,.35)';ctx.lineWidth=1.2;
  ctx.beginPath();ctx.moveTo(sx,PAD.t+ch);ctx.lineTo(sx,PAD.t);ctx.stroke();
  ctx.setLineDash([]);
  // Label the selected rate on x-axis with a pill
  const rateLbl=selRnd+'%';
  ctx.font=`600 9px 'DM Mono', monospace`;
  const rlW=ctx.measureText(rateLbl).width+8;
  ctx.fillStyle=blueColor;
  ctx.beginPath();ctx.roundRect?ctx.roundRect(sx-rlW/2,PAD.t+ch+3,rlW,13,3):ctx.rect(sx-rlW/2,PAD.t+ch+3,rlW,13);
  ctx.fill();
  ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(rateLbl,sx,PAD.t+ch+12);

  // â”€â”€ Fair value curve (shadow then line)
  ctx.shadowColor='rgba(26,92,152,.18)';ctx.shadowBlur=10;
  ctx.strokeStyle=blueColor;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';
  ctx.setLineDash([]);ctx.beginPath();
  valid.forEach((d,i)=>{if(i===0)ctx.moveTo(xp(d.rate),yp(d.fv));else ctx.lineTo(xp(d.rate),yp(d.fv))});
  ctx.stroke();ctx.shadowBlur=0;

  // â”€â”€ Selected point dot + callout
  const sel=valid.find(d=>d.rate===selRnd);
  if(sel){
    const ssx=xp(sel.rate),ssy=yp(sel.fv);
    // Dot
    ctx.beginPath();ctx.arc(ssx,ssy,6,0,Math.PI*2);
    ctx.fillStyle=blueColor;ctx.fill();
    ctx.strokeStyle=surf;ctx.lineWidth=2.5;ctx.stroke();
    // Value callout pill
    const valLbl=fmt(sel.fv,0)+' '+pCcy;
    ctx.font=`bold 10px 'DM Mono', monospace`;
    const vlW=ctx.measureText(valLbl).width+12;
    const vlX=Math.min(Math.max(ssx-vlW/2,PAD.l),PAD.l+cw-vlW);
    const vlY=ssy-28;
    ctx.fillStyle=blueColor;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(vlX,vlY,vlW,17,4):ctx.rect(vlX,vlY,vlW,17);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(valLbl,ssx,vlY+12);
    // Small triangle pointer
    ctx.beginPath();ctx.moveTo(ssx-4,ssy-11);ctx.lineTo(ssx+4,ssy-11);ctx.lineTo(ssx,ssy-5);
    ctx.fillStyle=blueColor;ctx.fill();
  }

  // â”€â”€ Axis labels
  ctx.fillStyle=ink5;ctx.font=`10px 'Inter', sans-serif`;ctx.textAlign='center';
  ctx.fillText('Required annual return (%)',PAD.l+cw/2,H-4);
  ctx.save();ctx.translate(11,PAD.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillText('Fair value per share',0,0);ctx.restore();
}

function renderForecastTable(){
  const t=document.getElementById('forecast-tbl');
  if(!_forecastRows.length){t.innerHTML='';return}
  let h=`<thead><tr><th>Year</th><th>Revenue (M)</th><th>FCF margin</th><th>Free cash flow (M)</th><th>Discount factor</th><th>Value today (M)</th></tr></thead><tbody>`;
  _forecastRows.forEach(r=>{h+=`<tr><td>${r.year}</td><td>${fmt(r.rev,0)}</td><td>${fmtPctPlain(r.marg,2)}</td><td>${fmt(r.fcf,0)}</td><td>${fmt(r.df,4)}</td><td>${fmt(r.discFcf,0)}</td></tr>`});
  t.innerHTML=h+'</tbody>';
}

function renderBridge(inp,res){
  const el=document.getElementById('bridge-wrap');
  if(!res.ok){el.innerHTML='';return}
  el.innerHTML=`<div class="bridge" style="margin-top:10px">
    <div class="br-row"><span class="br-lbl">Value of forecast cash flows</span><span class="br-val">${fmt(res.pvFCFs,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Value of terminal (beyond forecast)</span><span class="br-val">${fmt(res.pvTV,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Less: net debt</span><span class="br-val">(${fmt(inp.netDebt,0)} M)</span></div>
    <div class="br-row"><span class="br-lbl">Total equity value</span><span class="br-val">${fmt(res.equityPV,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Ã· Shares outstanding</span><span class="br-val">${fmt(inp.shares,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Fair value per share</span><span class="br-val">${fmt(res.fvps,2)} ${inp.pccy}</span></div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2 â€” IMPLIED RETURN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderRev(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=!!inp;
  document.getElementById('rev-empty').style.display=show?'none':'';
  document.getElementById('rev-content').style.display=show?'':'none';
  if(!show)return;

  const irr=impliedIRR(inp,inp.price);
  const reqReturn=inp.disc*100;
  const termStr=inp.termMode==='multiple'?fmt(inp.tmult,1)+'Ã— FCF':fmt(inp.tg*100,1)+'% / yr growth';
  const hero=document.getElementById('irr-hero');

  if(irr!==null){
    const irrPct=irr*100;
    const diff=irrPct-reqReturn;
    const diffAbs=fmt(Math.abs(diff),1);
    // Neutral headline â€” factual, not opinionated
    const headline='What the market price implies';
    // Two calm factual sentences
    const line1=`At the current price, these growth and terminal assumptions produce an implied annual return of ${fmt(irrPct,1)}%.`;
    const line2=diff>=0
      ?`That is ${fmt(diff,1)}pp above your ${fmt(reqReturn,0)}% required return on the Fair Value tab.`
      :`That is ${diffAbs}pp below your ${fmt(reqReturn,0)}% required return on the Fair Value tab.`;
    hero.innerHTML=`
      <div class="irr-result-card">
        <div class="irc-top">
          <div class="irc-num-block">
            <div class="irc-num-lbl">Implied return / yr</div>
            <div class="irc-num" style="color:var(--ink)">${fmt(irrPct,1)}%</div>
          </div>
          <div class="irc-verdict">
            <div class="irc-verdict-main">${headline}</div>
            <div class="irc-verdict-body">${line1} ${line2}</div>
          </div>
        </div>
        <div class="irc-inputs">
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Price</div><div class="irc-inp-val">${fmt(inp.price,2)} ${inp.pccy}</div></div>
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Revenue growth</div><div class="irc-inp-val">${fmt(inp.cagr*100,0)}% / yr</div></div>
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Terminal value</div><div class="irc-inp-val">${termStr}</div></div>
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Forecast</div><div class="irc-inp-val">${inp.years} years</div></div>
        </div>
      </div>`;
  } else {
    const diagnose2=[];
    if(inp.termMode==='growth'&&inp.tg>=inp.disc){
      diagnose2.push({icon:'âš¡',text:`Terminal growth rate (${fmt(inp.tg*100,1)}%) must be lower than the required return (${fmt(inp.disc*100,0)}%). The solver cannot find an implied return when g â‰¥ r. â†’ Reduce the "Terminal growth rate" slider, or raise your required return on the Fair Value tab.`});
    }
    const fm2=inp.fcfMargin+inp.dpp*inp.years;
    if(fm2<=0){
      diagnose2.push({icon:'ğŸ“‰',text:`Projected FCF margin reaches ${fmt(fm2*100,1)}% by year ${inp.years} â€” cash flow turns negative under these assumptions. No valid implied return exists. â†’ Reduce the margin decline or shorten the forecast period.`});
    }
    if(inp.fcfMargin<=0){
      diagnose2.push({icon:'âš ï¸',text:`Starting FCF margin is ${fmt(inp.fcfMargin*100,1)}%. The implied return solver requires positive free cash flows. â†’ Enter a positive FCF, or use a forward FCF estimate.`});
    }
    if(!diagnose2.length){
      diagnose2.push({icon:'ğŸ”§',text:`The solver could not converge on an implied return at this price. The growth and terminal assumptions may produce a fair value that is always below the market price regardless of the return rate. â†’ Try increasing the growth rate, raising the terminal value, or reducing the price being tested.`});
    }
    hero.innerHTML=`<div class="irr-result-card">
      <div class="calc-warn" style="margin:0;border:none;box-shadow:none;padding:12px 0 0">
        <div class="cw-head"><div class="cw-icon">â›”</div><div class="cw-title">Implied return cannot be calculated</div></div>
        <div class="cw-body">The current inputs produce no valid mathematical solution. Here's what to fix:</div>
        <div class="cw-list">${diagnose2.map(d=>`<div class="cw-item"><span class="cw-item-icon">${d.icon}</span><span>${d.text}</span></div>`).join('')}</div>
      </div></div>`;
  }

  // â”€â”€ Init price slider â€” range: 10% to 300% of current price (-90% to +200%)
  const pMin=inp.price*.10,pMax=inp.price*3.0;
  const defaultSliderVal=Math.round((inp.price-pMin)/(pMax-pMin)*100); // ~31%
  const sl=document.getElementById('rev-sl-price');
  sl.value=defaultSliderVal;
  sl.style.background=`linear-gradient(90deg,var(--blue) ${defaultSliderVal}%,var(--border) ${defaultSliderVal}%)`;
  document.getElementById('rev-price-display').textContent=fmt(inp.price,2);
  document.getElementById('rev-price-ccy').textContent=inp.pccy;
  document.getElementById('rev-price-min').textContent=fmt(pMin,0);
  document.getElementById('rev-price-max').textContent=fmt(pMax,0);
  document.getElementById('rpc-result-row').style.display='none';
  _revExplorePrice=null;
  // Update legend label with live required return
  const lLbl=document.getElementById('irr-hurdle-legend-lbl');
  if(lLbl)lLbl.textContent=`Your required return (${fmt(inp.disc*100,0)}%)`;

  // â”€â”€ Chart data
  _revData=[];
  for(let i=0;i<=80;i++){const p=pMin+(pMax-pMin)*i/80;const r=impliedIRR(inp,p);if(r!==null)_revData.push({price:p,irr:r})}
  drawIRRChart(inp.price,irr,inp.disc,null);
  renderRevTable(inp);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICE EXPLORER (Implied Return tab)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _revExplorePrice=null;
let _irrDragPrice=null; // kept for chart compatibility

function onRevPriceChange(sliderVal){
  const inp=buildInp(getInputs());
  if(!inp)return;
  const pMin=inp.price*.10,pMax=inp.price*3.0;
  const price=pMin+(pMax-pMin)*(sliderVal/100);
  _revExplorePrice=price;
  _irrDragPrice=price;
  // Update display
  document.getElementById('rev-price-display').textContent=fmt(price,2);
  // Slider fill
  const sl=document.getElementById('rev-sl-price');
  sl.style.background=`linear-gradient(90deg,var(--blue) ${sliderVal}%,var(--border) ${sliderVal}%)`;
  // Compute IRRs
  const explIRR=impliedIRR(inp,price);
  const baseIRR=impliedIRR(inp,inp.price);
  const isReset=Math.abs(price-inp.price)/inp.price<0.01;
  const row=document.getElementById('rpc-result-row');
  if(isReset){row.style.display='none';_revExplorePrice=null;_irrDragPrice=null;drawIRRChart(inp.price,baseIRR,inp.disc,null);return}
  row.style.display='flex';
  // Populate readout
  document.getElementById('rpc-explored-irr').textContent=explIRR!==null?fmt(explIRR*100,1)+'%':'â€”';
  document.getElementById('rpc-explored-irr').style.color=
    explIRR!==null&&explIRR>=inp.disc?'var(--green-dk)':'var(--red-dk)';
  if(explIRR!==null&&baseIRR!==null){
    const d=explIRR-baseIRR;
    document.getElementById('rpc-irr-delta').textContent=(d>=0?'+':'')+fmt(d*100,1)+'pp';
    document.getElementById('rpc-irr-delta').style.color=d>=0?'var(--green-dk)':'var(--red-dk)';
  }else document.getElementById('rpc-irr-delta').textContent='â€”';
  const pDelta=price/inp.price-1;
  document.getElementById('rpc-price-delta').textContent=(pDelta>=0?'+':'')+fmt(pDelta*100,1)+'%';
  document.getElementById('rpc-price-delta').style.color=pDelta>=0?'var(--green-dk)':'var(--red-dk)';
  drawIRRChart(inp.price,baseIRR,inp.disc,price);
}

function resetRevPrice(){
  _revExplorePrice=null;_irrDragPrice=null;
  const inp=buildInp(getInputs());
  if(!inp)return;
  const pMin=inp.price*.10,pMax=inp.price*3.0;
  const defaultSliderVal=Math.round((inp.price-pMin)/(pMax-pMin)*100);
  const sl=document.getElementById('rev-sl-price');
  sl.value=defaultSliderVal;
  sl.style.background=`linear-gradient(90deg,var(--blue) ${defaultSliderVal}%,var(--border) ${defaultSliderVal}%)`;
  document.getElementById('rev-price-display').textContent=fmt(inp.price,2);
  document.getElementById('rpc-result-row').style.display='none';
  drawIRRChart(inp.price,impliedIRR(inp,inp.price),inp.disc,null);
}

function resetIRRDrag(){resetRevPrice();}

function initIRRDrag(){
  const cv=document.getElementById('chart-irr');
  let dragging=false;

  function getClosestPoint(clientX){
    const rect=cv.getBoundingClientRect();
    const x=clientX-rect.left;
    const W=rect.width;
    const PAD_L=52,PAD_R=24;
    const cw=W-PAD_L-PAD_R;
    if(_revData.length<2)return null;
    const prices=_revData.map(d=>d.price);
    const minP=Math.min(...prices),maxP=Math.max(...prices);
    const frac=Math.max(0,Math.min(1,(x-PAD_L)/cw));
    const price=minP+frac*(maxP-minP);
    let best=null,bestDist=Infinity;
    _revData.forEach(d=>{const d2=Math.abs(d.price-price);if(d2<bestDist){bestDist=d2;best=d}});
    return best;
  }

  function handleMove(clientX){
    const pt=getClosestPoint(clientX);
    if(!pt)return;
    const inp=buildInp(getInputs());
    if(!inp)return;
    // Map the point back to slider 0-100
    const pMin=inp.price*.10,pMax=inp.price*3.0;
    const sliderVal=Math.round(Math.max(0,Math.min(100,(pt.price-pMin)/(pMax-pMin)*100)));
    const sl=document.getElementById('rev-sl-price');
    if(sl){sl.value=sliderVal;}
    onRevPriceChange(sliderVal);
  }

  cv.addEventListener('mousedown',e=>{dragging=true;handleMove(e.clientX)});
  cv.addEventListener('mousemove',e=>{if(dragging)handleMove(e.clientX)});
  window.addEventListener('mouseup',()=>dragging=false);
  cv.addEventListener('touchstart',e=>{dragging=true;handleMove(e.touches[0].clientX)},{passive:true});
  cv.addEventListener('touchmove',e=>{if(dragging)handleMove(e.touches[0].clientX)},{passive:true});
  window.addEventListener('touchend',()=>dragging=false);
  cv.addEventListener('click',e=>handleMove(e.clientX));
}

function drawIRRChart(curPrice,curIRR,userDisc,dragPrice){
  const cv=document.getElementById('chart-irr'),ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1,W=cv.offsetWidth,H=220;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  if(_revData.length<2)return;
  const hurdleRate=userDisc!==undefined?userDisc*100:12;
  const PAD={t:16,r:24,b:36,l:52},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;
  const prices=_revData.map(d=>d.price),irrs=_revData.map(d=>d.irr*100);
  const minP=Math.min(...prices),maxP=Math.max(...prices);
  const minI=Math.min(...irrs,hurdleRate-10)*1.06,maxI=Math.max(...irrs,hurdleRate+10)*1.06;
  const xp=p=>PAD.l+(p-minP)/(maxP-minP)*cw;
  const yp=v=>PAD.t+ch-(v-minI)/(maxI-minI)*ch;
  const ink3=cssVar('--ink-3')||'#4a4640';
  const ink4=cssVar('--ink-4')||'#8a857c';
  const ink5=cssVar('--ink-5')||'#b8b2a8';
  const surfBg=cssVar('--surface')||'#faf8f4';
  const bgColor=cssVar('--bg')||'#f4f0e8';
  const blueColor=cssVar('--blue')||'#1a5c98';
  const greenColor=cssVar('--green')||'#1a7a3c';
  const redColor=cssVar('--red')||'#c0392b';

  // â”€â”€ Background
  ctx.fillStyle=surfBg;
  ctx.beginPath();
  ctx.roundRect?ctx.roundRect(PAD.l,PAD.t,cw,ch,4):ctx.rect(PAD.l,PAD.t,cw,ch);
  ctx.fill();

  // â”€â”€ Grid lines
  const yTicks=5;
  for(let i=0;i<=yTicks;i++){
    const y=PAD.t+i*ch/yTicks;
    const val=minI+(maxI-minI)*(1-i/yTicks);
    ctx.strokeStyle=i===0||i===yTicks?'rgba(26,24,20,.1)':'rgba(26,24,20,.05)';
    ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle=ink5;ctx.font=`500 9px 'DM Mono', monospace`;ctx.textAlign='right';
    ctx.fillText(fmt(val,0)+'%',PAD.l-6,y+3.5);
  }
  // x-axis ticks: price range
  const xTicks=5;
  for(let i=0;i<=xTicks;i++){
    const x=PAD.l+i*cw/xTicks;
    const pval=minP+(maxP-minP)*i/xTicks;
    ctx.strokeStyle='rgba(26,24,20,.04)';ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle=ink5;ctx.font=`9px 'DM Mono', monospace`;ctx.textAlign='center';
    ctx.fillText(fmt(pval,0),x,PAD.t+ch+16);
  }

  // â”€â”€ Coloured fill zones (above = green, below = red)
  const hy=yp(hurdleRate);
  // Green zone above hurdle
  const aH=_revData.filter(d=>d.irr*100>=hurdleRate);
  if(aH.length){
    ctx.save();ctx.beginPath();
    ctx.moveTo(PAD.l,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t+ch);ctx.lineTo(PAD.l,PAD.t+ch);ctx.closePath();ctx.clip();
    const grad=ctx.createLinearGradient(0,PAD.t,0,hy);
    grad.addColorStop(0,'rgba(26,122,60,.14)');
    grad.addColorStop(1,'rgba(26,122,60,.04)');
    ctx.beginPath();
    ctx.moveTo(xp(aH[0].price),hy);
    aH.forEach(d=>ctx.lineTo(xp(d.price),yp(d.irr*100)));
    ctx.lineTo(xp(aH[aH.length-1].price),hy);
    ctx.closePath();ctx.fillStyle=grad;ctx.fill();
    ctx.restore();
  }
  // Red zone below hurdle
  const bH=_revData.filter(d=>d.irr*100<hurdleRate);
  if(bH.length){
    ctx.save();ctx.beginPath();
    ctx.moveTo(PAD.l,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t+ch);ctx.lineTo(PAD.l,PAD.t+ch);ctx.closePath();ctx.clip();
    const gradR=ctx.createLinearGradient(0,hy,0,PAD.t+ch);
    gradR.addColorStop(0,'rgba(192,57,43,.04)');
    gradR.addColorStop(1,'rgba(192,57,43,.14)');
    ctx.beginPath();
    ctx.moveTo(xp(bH[0].price),hy);
    bH.forEach(d=>ctx.lineTo(xp(d.price),yp(d.irr*100)));
    ctx.lineTo(xp(bH[bH.length-1].price),hy);
    ctx.closePath();ctx.fillStyle=gradR;ctx.fill();
    ctx.restore();
  }

  // â”€â”€ Required return reference line (dashed only â€” label shown below chart in legend)
  if(hy>=PAD.t&&hy<=PAD.t+ch){
    ctx.setLineDash([6,4]);ctx.strokeStyle=ink4;ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(PAD.l,hy);ctx.lineTo(PAD.l+cw,hy);ctx.stroke();
    ctx.setLineDash([]);
  }

  // â”€â”€ IRR curve
  ctx.setLineDash([]);
  ctx.shadowColor='rgba(26,92,152,.18)';ctx.shadowBlur=8;
  ctx.strokeStyle=blueColor;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';
  ctx.beginPath();
  _revData.forEach((d,i)=>{if(i===0)ctx.moveTo(xp(d.price),yp(d.irr*100));else ctx.lineTo(xp(d.price),yp(d.irr*100))});
  ctx.stroke();ctx.shadowBlur=0;

  // â”€â”€ Current price marker (vertical line + label)
  {
    const cx=xp(curPrice);
    ctx.setLineDash([3,4]);ctx.strokeStyle=ink4;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(cx,PAD.t+ch);ctx.lineTo(cx,PAD.t);ctx.stroke();
    ctx.setLineDash([]);
    // Price label at bottom
    const pLbl=fmt(curPrice,2);
    ctx.font=`500 9px 'DM Mono', monospace`;
    const pw=ctx.measureText(pLbl).width+8;
    ctx.fillStyle=ink3;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(cx-pw/2,PAD.t+ch+4,pw,13,3):ctx.rect(cx-pw/2,PAD.t+ch+4,pw,13);
    ctx.fill();
    ctx.fillStyle=surfBg;ctx.textAlign='center';ctx.fillText(pLbl,cx,PAD.t+ch+13.5);
  }

  // â”€â”€ Current price dot (the main blue circle)
  if(curIRR!==null){
    const cx=xp(curPrice),cy=yp(curIRR*100);
    // Drop line to x-axis
    ctx.setLineDash([3,4]);ctx.strokeStyle='rgba(26,92,152,.3)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(cx,PAD.t+ch);ctx.lineTo(cx,cy+7);ctx.stroke();ctx.setLineDash([]);
    // Dot
    ctx.beginPath();ctx.arc(cx,cy,6.5,0,Math.PI*2);
    ctx.fillStyle=blueColor;ctx.fill();
    ctx.strokeStyle=surfBg;ctx.lineWidth=2.5;ctx.stroke();
    // IRR label above dot
    const lbl=fmt(curIRR*100,1)+'%';
    ctx.font=`bold 10.5px 'DM Mono', monospace`;
    const lw=ctx.measureText(lbl).width+10;
    const lx=Math.min(Math.max(cx-lw/2,PAD.l),PAD.l+cw-lw);
    const ly=cy-26;
    ctx.fillStyle=blueColor;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(lx,ly,lw,16,4):ctx.rect(lx,ly,lw,16);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(lbl,cx,ly+11.5);
    // Small pointer triangle
    ctx.beginPath();ctx.moveTo(cx-4,cy-10);ctx.lineTo(cx+4,cy-10);ctx.lineTo(cx,cy-5);
    ctx.fillStyle=blueColor;ctx.fill();
  }

  // â”€â”€ Drag price marker (orange/gold, distinct from current)
  if(dragPrice!==null&&dragPrice!==undefined&&Math.abs(dragPrice-curPrice)>0.5){
    const dx=xp(dragPrice);
    const dragData=_revData.find(d=>Math.abs(d.price-dragPrice)<0.01)||_revData.reduce((a,b)=>Math.abs(b.price-dragPrice)<Math.abs(a.price-dragPrice)?b:a);
    const dy=yp(dragData.irr*100);
    // Highlight the explored price at x-axis
    const pLbl=fmt(dragData.price,2);
    ctx.font=`600 9px 'DM Mono', monospace`;
    const pw=ctx.measureText(pLbl).width+8;
    ctx.fillStyle=cssVar('--gold')||'#b07d2e';
    ctx.beginPath();ctx.roundRect?ctx.roundRect(dx-pw/2,PAD.t+ch+4,pw,13,3):ctx.rect(dx-pw/2,PAD.t+ch+4,pw,13);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(pLbl,dx,PAD.t+ch+13.5);
    // Drag dot
    ctx.beginPath();ctx.arc(dx,dy,6.5,0,Math.PI*2);
    const goldColor=cssVar('--gold')||'#b07d2e';
    ctx.fillStyle=goldColor;ctx.fill();
    ctx.strokeStyle=surfBg;ctx.lineWidth=2.5;ctx.stroke();
    // IRR label
    const irrlbl=fmt(dragData.irr*100,1)+'%';
    ctx.font=`bold 10.5px 'DM Mono', monospace`;
    const lw=ctx.measureText(irrlbl).width+10;
    const lx=Math.min(Math.max(dx-lw/2,PAD.l),PAD.l+cw-lw);
    const ly=dy-26;
    ctx.fillStyle=goldColor;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(lx,ly,lw,16,4):ctx.rect(lx,ly,lw,16);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(irrlbl,dx,ly+11.5);
    ctx.beginPath();ctx.moveTo(dx-4,dy-10);ctx.lineTo(dx+4,dy-10);ctx.lineTo(dx,dy-5);
    ctx.fillStyle=goldColor;ctx.fill();
  }

  // â”€â”€ Axis labels
  ctx.setLineDash([]);
  ctx.fillStyle=ink5;ctx.font=`10px 'Inter', sans-serif`;ctx.textAlign='center';
  ctx.fillText('Stock price ('+((buildInp(getInputs())||{}).pccy||'')+')',PAD.l+cw/2,H-4);
  ctx.save();ctx.translate(11,PAD.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillText('Implied annual return (%)',0,0);ctx.restore();
}

function renderRevTable(inp){
  const t=document.getElementById('rev-tbl');
  const prices=[];for(let i=-5;i<=5;i++){const p=inp.price*(1+.1*i);if(p>0)prices.push(p)}
  let h=`<thead><tr><th>Price</th><th>vs today</th><th>Implied return</th></tr></thead><tbody>`;
  prices.forEach(p=>{
    const r=impliedIRR(inp,p);const vs=p/inp.price-1;const isCur=Math.abs(p-inp.price)<.01;
    const{bg,fg}=r!==null?irrColor(r):{bg:'var(--surface-2)',fg:'var(--ink-4)'};
    h+=`<tr ${isCur?'style="font-weight:700;background:var(--blue-bg)"':''}><td>${fmt(p,2)}</td><td>${fmtPct(vs)}</td><td style="background:${bg};color:${fg};text-align:center">${r!==null?fmt(r*100,2)+'%':'â€”'}</td></tr>`;
  });
  t.innerHTML=h+'</tbody>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3 â€” SCENARIO GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMatrix(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=!!inp;
  document.getElementById('matrix-empty').style.display=show?'none':'';
  document.getElementById('matrix-content').style.display=show?'':'none';
  if(!show)return;
  const isM=inp.termMode==='multiple';
  const gMin=parseFloat(document.getElementById('mc-gmin').value)||0;
  const gMax=parseFloat(document.getElementById('mc-gmax').value)||20;
  const gRows=Math.max(2,Math.min(12,parseInt(document.getElementById('mc-grows').value)||6));
  const tMin=parseFloat(document.getElementById('mc-tmin').value)||(isM?8:0);
  const tMax=parseFloat(document.getElementById('mc-tmax').value)||(isM?16:4);
  const tCols=Math.max(2,Math.min(10,parseInt(document.getElementById('mc-tcols').value)||5));
  const growths=linspace(gMin/100,gMax/100,gRows);
  const terminals=linspace(isM?tMin:tMin/100,isM?tMax:tMax/100,tCols);
  const scenarios=[
    {key:'bear',label:'Bear',desc:'Margins fall 1% per year',dpp:-.01},
    {key:'base',label:'Base',desc:'Margins stay the same',dpp:0},
    {key:'bull',label:'Bull',desc:'Margins rise 1% per year',dpp:+.01},
  ];

  // Compute medians for the strip
  const medians=scenarios.map(sc=>{
    const irrs=[];
    growths.forEach(g=>{
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
        const lastFCF=ci.revLTM*Math.pow(1+ci.cagr,ci.years)*(ci.fcfMargin+ci.dpp*ci.years);
        if(!isFinite(lastFCF)||lastFCF<=0)return;
        const irr=impliedIRR(ci,ci.price);
        if(irr!==null)irrs.push(irr);
      });
    });
    irrs.sort((a,b)=>a-b);
    const median=irrs.length?irrs[Math.floor(irrs.length/2)]:null;
    return{...sc,median,count:irrs.length};
  });

  const termLabel=isM?'exit multiple':'terminal growth';
  const termRange=isM?`${fmt(tMin,0)}â€“${fmt(tMax,0)}Ã—`:`${fmt(tMin,1)}â€“${fmt(tMax,1)}%`;
  const growRange=`${fmt(gMin,0)}â€“${fmt(gMax,0)}% revenue growth`;

  document.getElementById('sc-strip').innerHTML=`
    <div class="sc-strip-title">Median implied return â€” across all ${gRows}Ã—${tCols} combinations</div>
    <div class="sc-strip-sub">Each number is the middle result from every row and column combination, at ${growRange} and ${termRange} ${termLabel}.</div>
    <div class="sc-cols">
      ${medians.map(s=>{
        return `<div class="sc-col sc-col-${s.key}">
          <div class="sc-col-name">${s.label}</div>
          <div class="sc-col-desc">${s.desc}</div>
          <div class="sc-col-irr">${s.median!==null?fmt(s.median*100,1)+'%':'â€”'}</div>
          <div class="sc-col-meta">${s.count} scenarios computed</div>
        </div>`;
      }).join('')}
    </div>`;

  // â”€â”€ Matrix warning banner: explain blank cells if many are invalid
  const totalCells=gRows*tCols*3; // 3 scenarios
  const computedCells=medians.reduce((s,m)=>s+m.count,0);
  const blankFraction=1-(computedCells/totalCells);
  const matrixWarn=document.getElementById('matrix-warn');
  if(blankFraction>0.3){
    const warnItems=[];
    if(inp.termMode==='growth'){
      const tooHigh=terminals.filter(tv=>tv>=inp.disc);
      if(tooHigh.length)warnItems.push({icon:'âš¡',text:`${tooHigh.length} terminal growth column${tooHigh.length>1?'s':''} (${tooHigh.map(v=>fmt(v*100,1)+'%').join(', ')}) meet or exceed the required return (${fmt(inp.disc*100,0)}%). Gordon Growth breaks down when g â‰¥ r â€” those cells show "â€”". â†’ Reduce the terminal growth range, or raise the required return on the Fair Value tab.`});
    }
    const badGrowths=growths.filter(g=>{const fm=inp.fcfMargin+inp.dpp*g*inp.years;return fm<=0});
    if(badGrowths.length)warnItems.push({icon:'ğŸ“‰',text:`At low growth rates, FCF margin falls negative before the forecast ends â€” those cells show "â€”". â†’ Increase the minimum growth rate, reduce the margin decline, or shorten the forecast period.`});
    if(!warnItems.length)warnItems.push({icon:'ğŸ”§',text:`Many cells cannot be solved with the current assumptions. â†’ Try adjusting the terminal value range, growth range, or required return until fewer cells show "â€”".`});
    matrixWarn.style.display='';
    matrixWarn.innerHTML=`
      <div class="cw-head"><div class="cw-icon">âš ï¸</div><div class="cw-title">${Math.round(blankFraction*100)}% of cells cannot be calculated</div></div>
      <div class="cw-body">Cells showing "â€”" have no valid mathematical solution under these assumptions. Most common reasons:</div>
      <div class="cw-list">${warnItems.map(w=>`<div class="cw-item"><span class="cw-item-icon">${w.icon}</span><span>${w.text}</span></div>`).join('')}</div>`;
  } else {
    matrixWarn.style.display='none';
  }

  let html='';
  scenarios.forEach(sc=>{
    html+=`<div class="sc-tag sc-tag-${sc.key}">${sc.label} â€” ${sc.desc}</div>`;
    html+=`<div class="hm-tbl-wrap" style="margin-bottom:6px"><table class="hm-tbl">`;
    html+=`<thead><tr><th class="rh">Growth â†“ / Terminal â†’</th>`;
    terminals.forEach(tv=>html+=`<th>${isM?fmt(tv,1)+'Ã—':fmt(tv*100,1)+'%'}</th>`);
    html+=`</tr></thead><tbody>`;
    growths.forEach(g=>{
      html+=`<tr><th class="rh" style="background:var(--surface-2);text-align:left;padding:6px 8px;color:var(--ink-3);font-weight:500">${fmt(g*100,1)}%</th>`;
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
        const lastFCF=ci.revLTM*Math.pow(1+ci.cagr,ci.years)*(ci.fcfMargin+ci.dpp*ci.years);
        if(!isFinite(lastFCF)||lastFCF<=0){html+=`<td><div class="hm-cell" style="background:var(--surface-2);color:var(--ink-4)">â€”</div></td>`;return}
        const irr=impliedIRR(ci,ci.price);
        if(irr===null){html+=`<td><div class="hm-cell" style="background:var(--surface-2);color:var(--ink-4)">â€”</div></td>`;return}
        const{bg,fg}=irrColor(irr);
        html+=`<td><div class="hm-cell" style="background:${bg};color:${fg}">${fmt(irr*100,1)}%</div></td>`;
      });
      html+=`</tr>`;
    });
    html+=`</tbody></table></div>`;
    html+=`<button class="btn-dl" onclick="downloadMatrix(${JSON.stringify(sc.label)})">â¬‡ Download CSV</button><div style="height:8px"></div>`;
  });
  document.getElementById('matrix-tables').innerHTML=html;
  document.getElementById('matrix-tables').style.display=_matrixView==='table'?'':'none';
  document.getElementById('mx-hm-legend').style.display=_matrixView==='table'?'':'none';
  document.getElementById('mx-chart-card').style.display=_matrixView==='chart'?'':'none';
  window._matrixState={inp,growths,terminals,scenarios,isM};
  if(_matrixView==='chart')setTimeout(()=>drawMatrixChart(_matrixChartScenario),50);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATRIX VIEW TOGGLE & CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _matrixView='table',_matrixChartScenario='base';

function setMatrixView(v){
  _matrixView=v;
  document.getElementById('mx-btn-table').classList.toggle('active',v==='table');
  document.getElementById('mx-btn-chart').classList.toggle('active',v==='chart');
  document.getElementById('mx-hm-legend').style.display=v==='table'?'':'none';
  document.getElementById('mx-chart-card').style.display=v==='chart'?'':'none';
  document.getElementById('matrix-tables').style.display=v==='table'?'':'none';
  document.getElementById('mc-ctrl').style.display='';
  if(v==='chart')drawMatrixChart(_matrixChartScenario);
}

function setMatrixChartScenario(sc,btn){
  _matrixChartScenario=sc;
  document.querySelectorAll('#mx-chart-scenario-tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  drawMatrixChart(sc);
}

function drawMatrixChart(scenarioKey){
  if(!window._matrixState)return;
  const{inp,growths,terminals,scenarios,isM}=window._matrixState;
  const sc=scenarios.find(s=>s.key===scenarioKey)||scenarios[1];
  const cv=document.getElementById('chart-matrix'),ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1,W=cv.offsetWidth,H=260;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  const PAD={t:20,r:16,b:36,l:52},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;

  // â”€â”€ Compute for each growth rate: min, median, max across terminal values
  const bands=growths.map(g=>{
    const irrs=terminals.map(tv=>{
      const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
      if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
      return impliedIRR(ci,ci.price);
    }).filter(v=>v!==null).map(v=>v*100).sort((a,b)=>a-b);
    if(!irrs.length)return null;
    return{
      g:g*100,
      min:irrs[0],
      max:irrs[irrs.length-1],
      median:irrs[Math.floor(irrs.length/2)],
      q1:irrs[Math.floor(irrs.length*.25)],
      q3:irrs[Math.floor(irrs.length*.75)]
    };
  }).filter(Boolean);

  if(!bands.length){
    ctx.fillStyle=cssVar('--ink-4');ctx.font=`12px 'Inter'`;ctx.textAlign='center';
    ctx.fillText('Not enough data',W/2,H/2);return;
  }

  const allIRRs=bands.flatMap(b=>[b.min,b.max]);
  const userDisc=(inp.disc||0.12)*100;
  const rawMin=Math.min(...allIRRs,userDisc);
  const rawMax=Math.max(...allIRRs,userDisc);
  const pad=(rawMax-rawMin)*.12;
  const minI=rawMin-pad,maxI=rawMax+pad;
  const minG=bands[0].g,maxG=bands[bands.length-1].g;
  const xp=g=>PAD.l+(g-minG)/(Math.max(maxG-minG,0.001))*cw;
  const yp=v=>PAD.t+ch-(v-minI)/(maxI-minI)*ch;

  const ink3=cssVar('--ink-3')||'#4a4640';
  const ink4=cssVar('--ink-4')||'#8a857c';
  const ink5=cssVar('--ink-5')||'#b8b2a8';
  const surf=cssVar('--surface')||'#faf8f4';
  const blueColor=cssVar('--blue')||'#1a5c98';
  const scColors={bear:cssVar('--red')||'#c0392b',base:cssVar('--blue')||'#1a5c98',bull:cssVar('--green')||'#1a7a3c'};
  const col=scColors[scenarioKey]||blueColor;

  // â”€â”€ Background
  ctx.fillStyle=surf;
  ctx.beginPath();
  ctx.roundRect?ctx.roundRect(PAD.l,PAD.t,cw,ch,4):ctx.rect(PAD.l,PAD.t,cw,ch);
  ctx.fill();

  // â”€â”€ Colour zone: above/below user's required return
  const hy=yp(userDisc);
  if(hy>PAD.t&&hy<PAD.t+ch){
    // green above
    ctx.fillStyle='rgba(26,122,60,.06)';
    ctx.fillRect(PAD.l,PAD.t,cw,Math.max(0,hy-PAD.t));
    // red below
    ctx.fillStyle='rgba(192,57,43,.05)';
    ctx.fillRect(PAD.l,hy,cw,Math.max(0,PAD.t+ch-hy));
  }

  // â”€â”€ Grid
  for(let i=0;i<=4;i++){
    const y=PAD.t+i*ch/4;
    const val=minI+(maxI-minI)*(1-i/4);
    ctx.strokeStyle=i===0||i===4?'rgba(26,24,20,.09)':'rgba(26,24,20,.05)';
    ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`500 9px 'DM Mono', monospace`;ctx.textAlign='right';
    ctx.fillText(fmt(val,1)+'%',PAD.l-6,y+3.5);
  }
  bands.forEach(b=>{
    const x=xp(b.g);
    ctx.strokeStyle='rgba(26,24,20,.04)';ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle=ink5;ctx.font=`9px 'DM Mono', monospace`;ctx.textAlign='center';
    ctx.fillText(fmt(b.g,0)+'%',x,PAD.t+ch+16);
  });

  // â”€â”€ User's required return â€” dashed line only (label shown in legend below)
  if(hy>=PAD.t&&hy<=PAD.t+ch){
    ctx.setLineDash([5,4]);ctx.strokeStyle='rgba(74,70,64,.5)';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.moveTo(PAD.l,hy);ctx.lineTo(PAD.l+cw,hy);ctx.stroke();
    ctx.setLineDash([]);
  }

  // â”€â”€ Min-max band (wide, very transparent)
  ctx.beginPath();
  bands.forEach((b,i)=>{if(i===0)ctx.moveTo(xp(b.g),yp(b.max));else ctx.lineTo(xp(b.g),yp(b.max))});
  [...bands].reverse().forEach(b=>ctx.lineTo(xp(b.g),yp(b.min)));
  ctx.closePath();
  ctx.fillStyle=col.replace('#','')===col?col+'28':`${col}28`;
  // Build rgba manually
  const hexToRGBA=(hex,a)=>{const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b2=parseInt(hex.slice(5,7),16);return`rgba(${r},${g},${b2},${a})`};
  const colHex=col.startsWith('#')?col:'#1a5c98';
  ctx.fillStyle=hexToRGBA(colHex,0.08);ctx.fill();

  // â”€â”€ Q1-Q3 band (narrower, more visible)
  if(bands[0].q1!==undefined){
    ctx.beginPath();
    bands.forEach((b,i)=>{if(i===0)ctx.moveTo(xp(b.g),yp(b.q3));else ctx.lineTo(xp(b.g),yp(b.q3))});
    [...bands].reverse().forEach(b=>ctx.lineTo(xp(b.g),yp(b.q1)));
    ctx.closePath();ctx.fillStyle=hexToRGBA(colHex,0.14);ctx.fill();
  }

  // â”€â”€ Median line
  ctx.shadowColor=hexToRGBA(colHex,0.2);ctx.shadowBlur=8;
  ctx.strokeStyle=colHex;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';ctx.setLineDash([]);
  ctx.beginPath();
  bands.forEach((b,i)=>{if(i===0)ctx.moveTo(xp(b.g),yp(b.median));else ctx.lineTo(xp(b.g),yp(b.median))});
  ctx.stroke();ctx.shadowBlur=0;

  // â”€â”€ Min/max boundary lines (thin, dashed)
  [bands.map(b=>({x:xp(b.g),y:yp(b.max)})),bands.map(b=>({x:xp(b.g),y:yp(b.min)}))].forEach((pts,pi)=>{
    ctx.setLineDash([3,4]);ctx.strokeStyle=hexToRGBA(colHex,0.3);ctx.lineWidth=1;
    ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
  });
  ctx.setLineDash([]);

  // â”€â”€ Dots on median line
  bands.forEach(b=>{
    const bx=xp(b.g),by=yp(b.median);
    ctx.beginPath();ctx.arc(bx,by,3.5,0,Math.PI*2);
    ctx.fillStyle=colHex;ctx.fill();
    ctx.strokeStyle=surf;ctx.lineWidth=1.5;ctx.stroke();
  });

  // â”€â”€ Axis labels
  ctx.setLineDash([]);
  ctx.fillStyle=ink5;ctx.font=`10px 'Inter', sans-serif`;ctx.textAlign='center';
  ctx.fillText('Revenue growth rate (% per year)',PAD.l+cw/2,H-4);
  ctx.save();ctx.translate(11,PAD.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillText('Implied annual return (%)',0,0);ctx.restore();

  // â”€â”€ Terminal value count annotation
  ctx.fillStyle=ink5;ctx.font=`9px 'Inter', sans-serif`;ctx.textAlign='left';
  ctx.fillText(`Range across ${terminals.length} terminal value${terminals.length>1?'s':''}`,PAD.l+4,PAD.t+ch-5);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dlCSV(fn,rows){const c=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(c);a.download=fn;a.click()}
function downloadForecast(){const rows=[['Year','Revenue (M)','FCF margin','Free cash flow (M)','Discount factor','Value today (M)']];_forecastRows.forEach(r=>rows.push([r.year,fmt(r.rev,0),fmtPctPlain(r.marg,2),fmt(r.fcf,0),fmt(r.df,4),fmt(r.discFcf,0)]));dlCSV('forecast.csv',rows)}
function downloadRevDCF(){const inp=buildInp(getInputs());if(!inp)return;const rows=[['Price','vs today','Implied return']];for(let i=-5;i<=5;i++){const p=inp.price*(1+.1*i);if(p>0){const r=impliedIRR(inp,p);rows.push([fmt(p,2),fmtPct(p/inp.price-1),r!==null?fmt(r*100,2)+'%':'â€”'])}}dlCSV('reverse_dcf.csv',rows)}
function downloadMatrix(scLabel){
  if(!window._matrixState)return;
  const{inp,growths,terminals,scenarios,isM}=window._matrixState;
  const sc=scenarios.find(s=>s.label===scLabel);if(!sc)return;
  const hdr=['Growth \\ Terminal'].concat(terminals.map(tv=>isM?fmt(tv,1)+'Ã—':fmt(tv*100,1)+'%'));
  const rows=[hdr];
  growths.forEach(g=>{const row=[fmt(g*100,1)+'%'];terminals.forEach(tv=>{const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}const irr=impliedIRR(ci,ci.price);row.push(irr!==null?fmt(irr*100,2)+'%':'â€”')});rows.push(row)});
  dlCSV(`irr_matrix_${sc.label.toLowerCase()}.csv`,rows);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPANY DATABASE + LIVE END-OF-DAY PRICE
   Fundamentals: manually curated, updated Feb 2026
   Price: Polygon.io free tier (prev close, CORS-safe)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Your Polygon.io API key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Free at polygon.io â€” end-of-day data, no CORS issues
// Replace the string below with your key to enable live prices
const POLYGON_KEY = 'REPLACE_WITH_YOUR_POLYGON_KEY';

// â”€â”€ Company database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// rev/fcf/netcash in millions. shares in millions. cagr = suggested growth %.
// sector codes: tech, semi, fin, con, hc, energy, ind
const _RAW_DB = [
  // â”€â”€ Mega-cap Tech â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'AAPL', n:'Apple',                rev:416161, fcf:98767,  sh:14773, nc:34000,   cagr:8,  cur:'USD', sec:'tech'},
  {t:'MSFT', n:'Microsoft',            rev:281724, fcf:71611,  sh:7433,  nc:27000,   cagr:15, cur:'USD', sec:'tech'},
  {t:'NVDA', n:'Nvidia',               rev:130497, fcf:60853,  sh:24400, nc:38000,   cagr:30, cur:'USD', sec:'semi'},
  {t:'GOOG', n:'Alphabet',             rev:350018, fcf:72764,  sh:12140, nc:93000,   cagr:12, cur:'USD', sec:'tech'},
  {t:'META', n:'Meta Platforms',       rev:164501, fcf:52100,  sh:2530,  nc:52000,   cagr:15, cur:'USD', sec:'tech'},
  {t:'AMZN', n:'Amazon',               rev:637959, fcf:38521,  sh:10580, nc:78000,   cagr:15, cur:'USD', sec:'tech'},
  {t:'TSLA', n:'Tesla',                rev:94830,  fcf:6200,   sh:3200,  nc:44100,   cagr:20, cur:'USD', sec:'tech'},
  {t:'NFLX', n:'Netflix',              rev:45183,  fcf:9461,   sh:4317,  nc:-4500,   cagr:12, cur:'USD', sec:'tech'},
  // â”€â”€ Software / Cloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'CRM',  n:'Salesforce',           rev:36472,  fcf:12386,  sh:960,   nc:4500,    cagr:12, cur:'USD', sec:'tech'},
  {t:'ADBE', n:'Adobe',                rev:21507,  fcf:7852,   sh:430,   nc:4000,    cagr:10, cur:'USD', sec:'tech'},
  {t:'NOW',  n:'ServiceNow',           rev:11516,  fcf:3482,   sh:204,   nc:4200,    cagr:20, cur:'USD', sec:'tech'},
  {t:'SNOW', n:'Snowflake',            rev:3634,   fcf:338,    sh:340,   nc:3800,    cagr:25, cur:'USD', sec:'tech'},
  {t:'PLTR', n:'Palantir',             rev:2865,   fcf:1142,   sh:2130,  nc:4600,    cagr:25, cur:'USD', sec:'tech'},
  {t:'ORCL', n:'Oracle',               rev:57400,  fcf:11800,  sh:2740,  nc:-88000,  cagr:8,  cur:'USD', sec:'tech'},
  {t:'INTU', n:'Intuit',               rev:17352,  fcf:4200,   sh:280,   nc:1200,    cagr:12, cur:'USD', sec:'tech'},
  {t:'SHOP', n:'Shopify',              rev:8877,   fcf:1551,   sh:1260,  nc:5100,    cagr:25, cur:'USD', sec:'tech'},
  // â”€â”€ Semiconductors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'AMD',  n:'Advanced Micro Devices',rev:25785, fcf:1611,   sh:1618,  nc:4000,    cagr:20, cur:'USD', sec:'semi'},
  {t:'INTC', n:'Intel',                rev:53101,  fcf:-15200, sh:4330,  nc:-11000,  cagr:5,  cur:'USD', sec:'semi'},
  {t:'QCOM', n:'Qualcomm',             rev:39116,  fcf:11200,  sh:1090,  nc:-4500,   cagr:8,  cur:'USD', sec:'semi'},
  {t:'AVGO', n:'Broadcom',             rev:51574,  fcf:21528,  sh:4690,  nc:-65000,  cagr:12, cur:'USD', sec:'semi'},
  {t:'TSM',  n:'TSMC (ADR)',           rev:88900,  fcf:16200,  sh:5180,  nc:25000,   cagr:15, cur:'USD', sec:'semi'},
  {t:'ASML', n:'ASML',                 rev:28262,  fcf:2600,   sh:394,   nc:2300,    cagr:15, cur:'USD', sec:'semi'},
  // â”€â”€ Finance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'JPM',  n:'JPMorgan Chase',       rev:177622, fcf:52000,  sh:2860,  nc:0,       cagr:5,  cur:'USD', sec:'fin'},
  {t:'V',    n:'Visa',                 rev:35926,  fcf:20400,  sh:2050,  nc:-7500,   cagr:10, cur:'USD', sec:'fin'},
  {t:'MA',   n:'Mastercard',           rev:28172,  fcf:12800,  sh:916,   nc:-5000,   cagr:12, cur:'USD', sec:'fin'},
  {t:'BRK-B',n:'Berkshire Hathaway',   rev:364482, fcf:42000,  sh:2170,  nc:141000,  cagr:8,  cur:'USD', sec:'fin'},
  {t:'GS',   n:'Goldman Sachs',        rev:53509,  fcf:12000,  sh:320,   nc:0,       cagr:5,  cur:'USD', sec:'fin'},
  {t:'PYPL', n:'PayPal',               rev:31797,  fcf:6400,   sh:1040,  nc:-3200,   cagr:6,  cur:'USD', sec:'fin'},
  {t:'COIN', n:'Coinbase',             rev:6641,   fcf:2118,   sh:253,   nc:7800,    cagr:20, cur:'USD', sec:'fin'},
  {t:'SQ',   n:'Block (Square)',       rev:23456,  fcf:866,    sh:1005,  nc:7800,    cagr:12, cur:'USD', sec:'fin'},
  // â”€â”€ Consumer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'WMT',  n:'Walmart',              rev:680984, fcf:17200,  sh:8020,  nc:-40000,  cagr:5,  cur:'USD', sec:'con'},
  {t:'COST', n:'Costco',               rev:254352, fcf:7490,   sh:443,   nc:2400,    cagr:8,  cur:'USD', sec:'con'},
  {t:'NKE',  n:'Nike',                 rev:51362,  fcf:4200,   sh:1498,  nc:-9800,   cagr:6,  cur:'USD', sec:'con'},
  {t:'MCD',  n:"McDonald's",           rev:25920,  fcf:7300,   sh:714,   nc:-47000,  cagr:5,  cur:'USD', sec:'con'},
  {t:'SBUX', n:'Starbucks',            rev:36176,  fcf:3100,   sh:1140,  nc:-13200,  cagr:6,  cur:'USD', sec:'con'},
  {t:'LULU', n:'Lululemon',            rev:10574,  fcf:1600,   sh:128,   nc:1800,    cagr:10, cur:'USD', sec:'con'},
  {t:'UBER', n:'Uber',                 rev:43975,  fcf:6940,   sh:2120,  nc:5900,    cagr:18, cur:'USD', sec:'con'},
  {t:'ABNB', n:'Airbnb',               rev:11000,  fcf:4070,   sh:634,   nc:9400,    cagr:12, cur:'USD', sec:'con'},
  {t:'SPOT', n:'Spotify',              rev:15673,  fcf:1816,   sh:196,   nc:5400,    cagr:15, cur:'USD', sec:'con'},
  {t:'DIS',  n:'Walt Disney',          rev:91361,  fcf:8600,   sh:1800,  nc:-40000,  cagr:6,  cur:'USD', sec:'con'},
  // â”€â”€ Healthcare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'LLY',  n:'Eli Lilly',            rev:45042,  fcf:8400,   sh:950,   nc:-19000,  cagr:20, cur:'USD', sec:'hc'},
  {t:'JNJ',  n:'Johnson & Johnson',    rev:89096,  fcf:18200,  sh:2400,  nc:-14000,  cagr:5,  cur:'USD', sec:'hc'},
  {t:'UNH',  n:'UnitedHealth',         rev:400278, fcf:22800,  sh:930,   nc:-8000,   cagr:10, cur:'USD', sec:'hc'},
  {t:'ABBV', n:'AbbVie',               rev:56334,  fcf:16600,  sh:1770,  nc:-62000,  cagr:6,  cur:'USD', sec:'hc'},
  {t:'PFE',  n:'Pfizer',               rev:63625,  fcf:12100,  sh:5680,  nc:-48000,  cagr:4,  cur:'USD', sec:'hc'},
  // â”€â”€ Energy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'XOM',  n:'ExxonMobil',           rev:398491, fcf:33000,  sh:4450,  nc:-43000,  cagr:3,  cur:'USD', sec:'energy'},
  {t:'CVX',  n:'Chevron',              rev:200949, fcf:15300,  sh:1830,  nc:-18000,  cagr:3,  cur:'USD', sec:'energy'},
  // â”€â”€ International â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {t:'SAP',  n:'SAP',                  rev:35380,  fcf:7600,   sh:1190,  nc:1800,    cagr:10, cur:'EUR', sec:'tech'},
  {t:'BABA', n:'Alibaba',              rev:130350, fcf:27900,  sh:2160,  nc:61000,   cagr:8,  cur:'USD', sec:'tech'},
  {t:'NOVO-B',n:'Novo Nordisk',        rev:232260, fcf:62100,  sh:4460,  nc:-19000,  cagr:15, cur:'USD', sec:'hc'},
];

// Deduplicate and build lookup
const DB_MAP = {};
_RAW_DB.forEach(c => { if (!DB_MAP[c.t]) DB_MAP[c.t] = c; });
const DB = Object.values(DB_MAP);

// Sector display labels
const SEC_LABEL = {
  tech:'Technology', semi:'Semiconductors', fin:'Finance',
  con:'Consumer', hc:'Healthcare', energy:'Energy', ind:'Industrial',
};

// Update DB count badge
document.addEventListener('DOMContentLoaded', () => {
  const el = document.getElementById('db-count-badge');
  if (el) el.textContent = `${DB.length} companies`;
});
// Also set it immediately in case DOM is already ready
setTimeout(() => {
  const el = document.getElementById('db-count-badge');
  if (el) el.textContent = `${DB.length} companies`;
}, 0);

// â”€â”€ Search input handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _searchTimer = null;
let _dropFocusIdx = -1;
let _lastResults = [];
let _blurTimer = null;

function onTickerInput(val) {
  const clear = document.getElementById('ticker-clear');
  if (clear) clear.style.display = val ? 'block' : 'none';
  clearTimeout(_searchTimer);
  if (!val.trim()) { closeDropdown(); return; }
  const results = searchDB(val.trim());
  _lastResults = results;
  renderDropdown(results, val.trim());
}

function onTickerFocus() {
  const val = document.getElementById('ticker-search').value.trim();
  if (val && _lastResults.length) renderDropdown(_lastResults, val);
}

function onTickerBlur() {
  _blurTimer = setTimeout(closeDropdown, 200);
}

function onTickerKey(e) {
  const dd = document.getElementById('ticker-dropdown');
  if (!dd.classList.contains('open')) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); moveFocus(1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); moveFocus(-1); }
  else if (e.key === 'Enter') {
    e.preventDefault();
    const pick = _lastResults[_dropFocusIdx] || (_lastResults.length === 1 ? _lastResults[0] : null);
    if (pick) pickTicker(pick.t);
  }
  else if (e.key === 'Escape') { closeDropdown(); document.getElementById('ticker-search').blur(); }
}

function moveFocus(dir) {
  const items = document.querySelectorAll('.td-item');
  if (!items.length) return;
  _dropFocusIdx = Math.max(0, Math.min(_lastResults.length - 1, _dropFocusIdx + dir));
  items.forEach((el, i) => el.classList.toggle('focused', i === _dropFocusIdx));
  items[_dropFocusIdx]?.scrollIntoView({ block:'nearest' });
}

function clearTickerSearch() {
  const inp = document.getElementById('ticker-search');
  inp.value = '';
  const clear = document.getElementById('ticker-clear');
  if (clear) clear.style.display = 'none';
  closeDropdown();
  inp.focus();
}

function closeDropdown() {
  const dd = document.getElementById('ticker-dropdown');
  if (dd) dd.classList.remove('open');
  _dropFocusIdx = -1;
}

// â”€â”€ Local DB search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function searchDB(q) {
  const s = q.toLowerCase();
  const exact    = DB.filter(c => c.t.toLowerCase() === s);
  const startT   = DB.filter(c => c.t.toLowerCase().startsWith(s) && c.t.toLowerCase() !== s);
  const startN   = DB.filter(c => c.n.toLowerCase().startsWith(s));
  const containN = DB.filter(c => c.n.toLowerCase().includes(s) && !c.n.toLowerCase().startsWith(s));
  const seen = new Set();
  return [...exact, ...startT, ...startN, ...containN]
    .filter(c => { if (seen.has(c.t)) return false; seen.add(c.t); return true; })
    .slice(0, 7);
}

// Highlight matching text
function highlight(text, q) {
  if (!q) return text;
  const idx = text.toLowerCase().indexOf(q.toLowerCase());
  if (idx < 0) return text;
  return text.slice(0, idx) +
    `<strong style="color:var(--blue)">${text.slice(idx, idx + q.length)}</strong>` +
    text.slice(idx + q.length);
}

function renderDropdown(results, q = '') {
  const dd = document.getElementById('ticker-dropdown');
  if (!results.length) {
    dd.innerHTML = `<div class="td-empty">No companies found for "<strong>${q}</strong>"<br><span style="font-size:10.5px;color:var(--ink-5)">Try a ticker like AAPL or company name</span></div>`;
    dd.classList.add('open');
    return;
  }
  const rows = results.map((r, i) => {
    const secLabel = SEC_LABEL[r.sec] || r.sec || '';
    const cagr = r.cagr ? `+${r.cagr}%/yr` : '';
    return `<div class="td-item" data-i="${i}" onmousedown="pickTicker('${r.t}')">
      <span class="td-ticker">${highlight(r.t, q.toUpperCase())}</span>
      <span class="td-info">
        <span class="td-name">${highlight(r.n, q)}</span>
        <span class="td-sub">${secLabel}${cagr ? ' Â· Est. ' + cagr : ''}</span>
      </span>
      <span class="td-badge">${r.cur}</span>
    </div>`;
  }).join('');
  dd.innerHTML = `<div class="td-header">${results.length} match${results.length > 1 ? 'es' : ''} in database</div>` + rows;
  dd.classList.add('open');
  _dropFocusIdx = -1;
}

function pickTicker(ticker) {
  clearTimeout(_blurTimer);
  closeDropdown();
  document.getElementById('ticker-search').value = '';
  const clear = document.getElementById('ticker-clear');
  if (clear) clear.style.display = 'none';
  loadCompany(ticker);
}

// â”€â”€ Load company from DB + fetch live EOD price â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCompany(ticker) {
  const co = DB_MAP[ticker];
  if (!co) { showToast('Company not found'); return; }

  // Show loading state
  const loading = document.getElementById('sb-loading');
  const priceRow = document.getElementById('price-loading-row');
  const priceStatus = document.getElementById('price-status-text');
  if (loading) loading.classList.add('show');
  clearPills();

  // â”€â”€ Populate fundamentals instantly from database â”€â”€
  document.getElementById('inp-company').value = `${co.n} (${co.t})`;
  document.getElementById('inp-shares').value  = fmt(co.sh, 0);
  document.getElementById('inp-revenue').value = fmt(co.rev, 0);
  document.getElementById('inp-fcf').value     = fmt(co.fcf, 0);
  document.getElementById('inp-netcash').value = fmt(co.nc, 0);

  // Suggested growth
  document.getElementById('sl-cagr').value = co.cagr;
  document.getElementById('lbl-cagr').textContent = co.cagr + '%';

  // Currency
  for (const sel of ['sel-fccy','sel-pccy']) {
    const el = document.getElementById(sel);
    if (el) for (const opt of el.options) if (opt.value === co.cur) { el.value = co.cur; break; }
  }
  onCurrencyChange();

  // Show reset, hide onboarding
  document.getElementById('btn-reset').style.display = '';
  const hint = document.getElementById('onboard-hint');
  if (hint) { hint.style.animation = 'none'; hint.style.opacity = '0'; }

  // â”€â”€ Clear price and show loading state â”€â”€
  document.getElementById('inp-price').value = '';
  if (loading) loading.classList.remove('show');
  if (priceRow) priceRow.classList.add('show');
  if (priceStatus) priceStatus.textContent = 'Fetching end-of-day priceâ€¦';

  // Run update immediately with blank price (shows partial state)
  update();
  showToast(`${co.n} loaded âœ“`);

  // â”€â”€ Fetch end-of-day price from Polygon â”€â”€
  const hasKey = POLYGON_KEY && POLYGON_KEY !== 'REPLACE_WITH_YOUR_POLYGON_KEY';

  if (hasKey) {
    try {
      // Use previous close endpoint â€” free tier, CORS-safe
      const res = await fetch(
        `https://api.polygon.io/v2/aggs/ticker/${ticker}/prev?adjusted=true&apiKey=${POLYGON_KEY}`,
        { signal: AbortSignal.timeout(8000) }
      );
      const data = await res.json();
      const result = data?.results?.[0];

      if (result?.c) {
        const price = result.c;
        const dateMs = result.t;
        const dateStr = dateMs
          ? new Date(dateMs).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})
          : 'prev close';

        document.getElementById('inp-price').value = fmt(price, 2);
        if (priceStatus) priceStatus.textContent = `Price: ${dateStr}`;

        // Update provenance
        const prov = document.getElementById('provenance-text');
        if (prov) prov.innerHTML =
          `<strong>${co.n}</strong> Â· Financials Feb 2026 Â· Price: ${dateStr}
           <span class="live-badge"><span class="live-dot"></span>EOD</span>`;

        update();
      } else {
        throw new Error('No price in response');
      }
    } catch(err) {
      console.warn('Polygon fetch failed:', err);
      if (priceStatus) priceStatus.textContent = 'Price unavailable â€” enter manually';
      const prov = document.getElementById('provenance-text');
      if (prov) prov.innerHTML = `<strong>${co.n}</strong> Â· Financials Feb 2026 Â· Price: enter manually`;
    }
  } else {
    // No API key â€” show helpful message with setup link
    if (priceStatus) priceStatus.innerHTML =
      `No price API key Â· <a href="https://polygon.io" target="_blank" rel="noopener" style="color:var(--blue)">Get free key</a> or enter price manually`;
    const prov = document.getElementById('provenance-text');
    if (prov) prov.innerHTML = `<strong>${co.n}</strong> Â· Financials from Feb 2026 filing Â· Enter current stock price above`;
  }

  if (priceRow) setTimeout(() => priceRow.classList.remove('show'), 3000);
}

// (search functions defined above in COMPANY DATABASE section)


let _rt;
window.addEventListener('resize',()=>{clearTimeout(_rt);_rt=setTimeout(()=>{const inp=buildInp(getInputs());if(!inp)return;if(activeTab==='dcf')drawSensChart(inp.price,inp.disc*100);else if(activeTab==='rev'){const irr=impliedIRR(inp,inp.price);drawIRRChart(inp.price,irr,inp.disc,_irrDragPrice)}else if(activeTab==='matrix'&&_matrixView==='chart')drawMatrixChart(_matrixChartScenario)},100)});

// Restore theme
const savedTheme=localStorage.getItem('vs-theme');
if(savedTheme){document.documentElement.setAttribute('data-theme',savedTheme);document.getElementById('dark-btn').textContent=savedTheme==='dark'?'â˜€ï¸':'ğŸŒ™'}
// Hide onboarding hint for returning users
if(localStorage.getItem('vs-onboarded')){const h=document.getElementById('onboard-hint');if(h)h.style.display='none';}
onDiscChange();
syncBenchPills();
// Init drag after DOM is ready
setTimeout(()=>initIRRDrag(),200);
loadFromURL();
if(!window.location.search||window.location.search==='?')loadPreset('NFLX',true);
// If blank=1, keep fields empty and show onboarding

</script>
</body>
</html>
