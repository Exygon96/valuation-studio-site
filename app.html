<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Valuation Studio â€” DCF Analysis</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,600;0,700;1,500&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --cream:#f5f2ec;--cream-b:#ede9e0;--cream-c:#e4dfd3;
  --white:#ffffff;--ink:#1c1917;--ink-2:#44403c;--ink-3:#78716c;
  --ink-4:#a8a29e;--ink-5:#d6d3cd;--navy:#1e3a5f;--gold:#92713a;
  --green:#14532d;--green-b:#dcfce7;--red:#7f1d1d;--red-b:#fee2e2;
  --ff-head:'Playfair Display',Georgia,serif;
  --ff-body:'DM Sans',system-ui,sans-serif;
  --ff-mono:'DM Mono','Courier New',monospace;
  --sidebar-w:300px;--header-h:52px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:var(--ff-body);background:var(--cream);color:var(--ink);-webkit-font-smoothing:antialiased;font-size:14px}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}
a{color:inherit}

/* â”€â”€ SHELL â”€â”€ */
#shell{display:flex;flex-direction:column;height:100vh}

/* â”€â”€ HEADER â”€â”€ */
#header{
  height:var(--header-h);flex-shrink:0;z-index:50;
  background:rgba(245,242,236,.92);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--ink-5);
  display:flex;align-items:center;padding:0 16px;gap:10px;
}
.h-logo{display:flex;align-items:center;gap:9px;text-decoration:none}
.h-logo-mark{width:26px;height:26px;border-radius:6px;background:var(--ink);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.h-logo-mark svg{width:14px;height:14px}
.h-logo-name{font-family:var(--ff-head);font-size:15px;font-weight:600;color:var(--ink);letter-spacing:-.2px}
.h-sep{flex:1}
.h-btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 12px;border-radius:6px;font-size:12px;font-weight:500;
  border:1px solid var(--ink-5);color:var(--ink-3);background:var(--white);
  transition:all .12s;white-space:nowrap;text-decoration:none;
}
.h-btn:hover{border-color:var(--ink-3);color:var(--ink)}
.h-btn.primary{background:var(--ink);color:var(--cream);border-color:var(--ink)}
.h-btn.primary:hover{background:var(--ink-2)}
.h-disclaimer{font-size:10.5px;color:var(--ink-4);max-width:300px;line-height:1.4;text-align:right}

/* â”€â”€ BODY â”€â”€ */
#body{display:flex;flex:1;overflow:hidden}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--cream);border-right:1px solid var(--ink-5);
  overflow-y:auto;padding:14px 14px 40px;
  display:flex;flex-direction:column;
  transition:transform .25s ease;
}
#sidebar::-webkit-scrollbar{width:3px}
#sidebar::-webkit-scrollbar-thumb{background:var(--ink-5);border-radius:2px}

.sb-hdr{
  font-family:var(--ff-mono);font-size:9px;font-weight:500;
  letter-spacing:1.4px;text-transform:uppercase;color:var(--ink-4);
  padding:14px 0 6px;border-bottom:1px solid var(--ink-5);margin-bottom:10px;
}
.sb-hdr:first-child{padding-top:4px}

/* Company pills */
.company-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:12px}
.co-pill{
  padding:6px 8px;border-radius:6px;font-size:11px;font-weight:500;
  border:1px solid var(--ink-5);color:var(--ink-3);background:var(--white);
  cursor:pointer;transition:all .12s;text-align:center;
}
.co-pill:hover{border-color:var(--ink-3);color:var(--ink)}
.co-pill.active{background:var(--ink);color:var(--cream);border-color:var(--ink)}

/* Currency row */
.currency-row{display:flex;gap:6px;margin-bottom:12px;align-items:flex-end}
.currency-row .field{flex:1;margin-bottom:0}
.fx-rate-wrap{flex:1}
.fx-rate-wrap label{display:block;font-size:10px;font-weight:500;color:var(--ink-3);margin-bottom:4px}
.fx-rate-val{
  background:var(--cream-b);border:1px solid var(--ink-5);border-radius:5px;
  padding:7px 8px;font-family:var(--ff-mono);font-size:12px;color:var(--ink-3);
}

/* Fields */
.field{margin-bottom:9px}
.field label{display:flex;justify-content:space-between;align-items:baseline;font-size:10px;font-weight:500;color:var(--ink-3);margin-bottom:3px}
.field label .label-note{font-size:9.5px;color:var(--ink-4);font-weight:400}
.field input[type=text],.field input[type=number],.field select{
  width:100%;background:var(--white);border:1px solid var(--ink-5);
  border-radius:5px;padding:6px 9px;font-size:12.5px;font-family:var(--ff-mono);
  color:var(--ink);transition:border-color .12s,box-shadow .12s;outline:none;
}
.field input:focus,.field select:focus{border-color:var(--navy);box-shadow:0 0 0 2px rgba(30,58,95,.1)}

/* Slider */
.sl-wrap{margin-bottom:11px}
.sl-wrap label{display:flex;justify-content:space-between;align-items:baseline;font-size:10px;font-weight:500;color:var(--ink-3);margin-bottom:5px}
.sl-wrap label span{font-family:var(--ff-mono);font-size:11.5px;font-weight:500;color:var(--ink)}
input[type=range]{width:100%;height:3px;-webkit-appearance:none;appearance:none;background:var(--ink-5);border-radius:2px;outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--navy);border:2px solid var(--white);box-shadow:0 0 0 1px var(--navy)}

/* Radio */
.radio-row{display:flex;gap:5px;margin-bottom:9px}
.rb{flex:1;padding:5px 0;text-align:center;font-size:11px;font-weight:500;border:1px solid var(--ink-5);border-radius:5px;color:var(--ink-3);background:var(--white);cursor:pointer;transition:all .12s}
.rb.active{background:var(--ink);color:var(--white);border-color:var(--ink)}

/* Margin pill */
.margin-pill{background:var(--white);border:1px solid var(--ink-5);border-radius:5px;padding:7px 11px;display:flex;justify-content:space-between;align-items:center;margin-bottom:9px}
.mp-lbl{font-size:9.5px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--ink-4)}
.mp-val{font-family:var(--ff-mono);font-size:16px;font-weight:500}

/* Summary */
.sb-sum{background:var(--white);border:1px solid var(--ink-5);border-radius:8px;padding:11px 13px;margin-top:14px}
.sb-sum-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--ink-4);margin-bottom:8px}
.sb-sum-row{display:flex;justify-content:space-between;font-size:11px;padding:3px 0;border-bottom:1px solid var(--cream-b)}
.sb-sum-row:last-child{border-bottom:none}
.sb-sum-lbl{color:var(--ink-3)}
.sb-sum-val{font-family:var(--ff-mono);font-size:11px;font-weight:500;color:var(--ink)}

/* Warning */
.warn{font-size:10.5px;color:#92400e;background:#fffbeb;border:1px solid #fde68a;border-radius:4px;padding:5px 8px;margin-top:3px;line-height:1.4;display:none}
.err{font-size:10.5px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;border-radius:4px;padding:5px 8px;margin-top:3px;line-height:1.4;display:none}

/* Sidebar buttons */
.sb-btn{width:100%;padding:8px 0;border-radius:5px;font-size:12px;font-weight:500;transition:all .12s;margin-top:8px}
.sb-btn.dark{background:var(--ink);color:var(--cream)}
.sb-btn.dark:hover{background:var(--ink-2)}
.sb-btn.light{background:var(--white);color:var(--ink-3);border:1px solid var(--ink-5)}
.sb-btn.light:hover{border-color:var(--ink-3);color:var(--ink)}

/* â”€â”€ MAIN â”€â”€ */
#main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0}
#main::-webkit-scrollbar{width:3px}
#main::-webkit-scrollbar-thumb{background:var(--ink-5);border-radius:2px}

/* Tabbar */
#tabbar{
  flex-shrink:0;display:flex;align-items:center;
  border-bottom:1px solid var(--ink-5);
  background:rgba(245,242,236,.95);backdrop-filter:blur(8px);
  position:sticky;top:0;z-index:10;padding:0 24px;gap:0;
}
.tab-btn{
  padding:12px 0;margin-right:24px;font-size:12.5px;font-weight:500;
  color:var(--ink-4);border-bottom:2px solid transparent;margin-bottom:-1px;
  transition:color .12s,border-color .12s;white-space:nowrap;background:none;
}
.tab-btn.active{color:var(--ink);border-bottom-color:var(--ink)}
.tab-btn:hover:not(.active){color:var(--ink-2)}
.tab-sep{flex:1}
.tab-action{
  font-size:11.5px;font-weight:500;color:var(--navy);
  display:flex;align-items:center;gap:5px;cursor:pointer;
  padding:5px 10px;border-radius:5px;border:1px solid rgba(30,58,95,.2);
  transition:all .12s;background:rgba(30,58,95,.04);
}
.tab-action:hover{background:rgba(30,58,95,.1)}

/* Tab panels */
.tab-panel{display:none;padding:24px;animation:fadeIn .2s ease}
.tab-panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* Empty state */
.empty{text-align:center;padding:64px 20px;color:var(--ink-4)}
.empty-icon{font-size:32px;opacity:.25;margin-bottom:12px}
.empty-title{font-family:var(--ff-head);font-size:17px;color:var(--ink-3);margin-bottom:5px}
.empty-body{font-size:12.5px;line-height:1.6}

/* Section header */
.sec-hdr{font-family:var(--ff-mono);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink-4);margin-bottom:12px;padding-bottom:7px;border-bottom:1px solid var(--ink-5)}

/* KPI grid */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:18px}
.kpi{background:var(--white);border:1px solid var(--ink-5);border-radius:8px;padding:12px 14px}
.kpi-lbl{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--ink-4);margin-bottom:7px}
.kpi-val{font-family:var(--ff-mono);font-size:21px;font-weight:500;letter-spacing:-.5px;line-height:1;color:var(--ink)}
.kpi-sub{font-size:10px;color:var(--ink-4);margin-top:3px}
.kpi-val.up{color:var(--green)}.kpi-val.down{color:var(--red)}

/* Bars */
.bars{margin-bottom:20px}
.bar-item{margin-bottom:7px}
.bar-meta{display:flex;justify-content:space-between;font-size:11px;color:var(--ink-3);margin-bottom:3px}
.bar-meta-val{font-family:var(--ff-mono);font-weight:500;color:var(--ink)}
.bar-track{background:var(--cream-b);border-radius:3px;height:17px;overflow:hidden;border:1px solid var(--ink-5)}
.bar-fill{height:100%;border-radius:3px;display:flex;align-items:center;padding:0 7px;font-family:var(--ff-mono);font-size:9.5px;font-weight:500;color:#fff;transition:width .8s cubic-bezier(.4,0,.2,1);white-space:nowrap}
.bar-fv{background:var(--green)}.bar-px{background:var(--navy)}
.upside-tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:4px;margin-top:7px;font-family:var(--ff-mono);font-size:12px;font-weight:500}
.upside-tag.up{background:var(--green-b);color:var(--green);border:1px solid #bbf7d0}
.upside-tag.down{background:var(--red-b);color:var(--red);border:1px solid #fecaca}

/* Two-col */
.two-col{display:grid;grid-template-columns:200px 1fr;gap:20px;margin-bottom:20px}

/* Hint box */
.hint{background:var(--cream-b);border-radius:5px;padding:10px 12px;border-left:2px solid var(--navy);margin-bottom:12px}
.hint-title{font-size:10.5px;font-weight:600;color:var(--ink);margin-bottom:2px}
.hint-body{font-size:11px;color:var(--ink-3);line-height:1.6}

/* Chart card */
.chart-card{background:var(--white);border:1px solid var(--ink-5);border-radius:10px;padding:18px 18px 12px;margin-bottom:18px}
.chart-title{font-family:var(--ff-head);font-size:14px;font-weight:600;color:var(--ink);margin-bottom:3px}
.chart-sub{font-size:11.5px;color:var(--ink-4);margin-bottom:14px;line-height:1.4}
.chart-legend{display:flex;gap:16px;margin-top:8px;flex-wrap:wrap}
.leg-item{display:flex;align-items:center;gap:5px;font-size:10.5px;color:var(--ink-3)}
.leg-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

/* Bridge */
.bridge{border:1px solid var(--ink-5);border-radius:8px;overflow:hidden;margin-bottom:18px}
.br-row{display:flex;justify-content:space-between;align-items:center;padding:8px 13px;font-size:12px;border-bottom:1px solid var(--cream-b);background:var(--white)}
.br-row:nth-child(even){background:#faf9f7}
.br-row:last-child{border-bottom:none;font-weight:600;font-size:12.5px;background:var(--cream-b);border-top:1px solid var(--ink-5)}
.br-lbl{color:var(--ink-3)}.br-val{font-family:var(--ff-mono);font-size:11.5px;color:var(--ink)}

/* Table */
.data-tbl{width:100%;border-collapse:collapse;font-size:11.5px;margin-bottom:10px}
.data-tbl th{text-align:left;padding:6px 9px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--ink-4);border-bottom:1px solid var(--ink-5);background:var(--cream-b);font-family:var(--ff-mono)}
.data-tbl td{padding:6px 9px;border-bottom:1px solid var(--cream-b);font-family:var(--ff-mono);font-size:11.5px;color:var(--ink)}
.data-tbl tr:last-child td{border-bottom:none}
.data-tbl tr:hover td{background:#faf6ee}

/* Collapsible */
.coll{border:1px solid var(--ink-5);border-radius:8px;overflow:hidden;margin-bottom:14px}
.coll-hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--white);cursor:pointer;font-size:12.5px;font-weight:500;color:var(--ink);border-bottom:1px solid transparent;transition:background .1s;user-select:none}
.coll-hdr:hover{background:var(--cream-b)}
.coll-hdr.open{border-bottom-color:var(--ink-5)}
.coll-arrow{font-size:10px;color:var(--ink-4);transition:transform .18s}
.coll-hdr.open .coll-arrow{transform:rotate(180deg)}
.coll-body{display:none;padding:14px;background:var(--white)}
.coll-body.open{display:block}

/* Download button */
.btn-dl{padding:6px 14px;background:var(--white);border:1px solid var(--ink-5);border-radius:5px;font-size:11.5px;font-weight:500;color:var(--navy);cursor:pointer;transition:all .12s;display:inline-flex;align-items:center;gap:5px}
.btn-dl:hover{background:var(--cream-b);border-color:var(--navy)}

/* Heatmap */
.hm-legend{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--white);border:1px solid var(--ink-5);border-radius:8px;margin-bottom:14px}
.hm-bar{flex:1;height:7px;border-radius:3px;background:linear-gradient(90deg,#7f1d1d 0%,#dc2626 12%,#fca5a5 26%,#fef9f0 44%,#fef9f0 50%,#dbeafe 62%,#3b82f6 78%,#1e3a8a 100%)}
.hm-end{font-size:10.5px;font-family:var(--ff-mono);color:var(--ink-3);white-space:nowrap}
.hm-ticks{display:flex;justify-content:space-between;font-size:8.5px;color:var(--ink-4);margin-top:2px;font-family:var(--ff-mono)}
.sc-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:4px;font-size:11px;font-weight:500;margin:10px 0 5px}
.sc-base{background:#f4f4f1;color:var(--ink-2);border:1px solid var(--ink-5)}
.sc-bear{background:var(--red-b);color:var(--red);border:1px solid #fecaca}
.sc-bull{background:var(--green-b);color:var(--green);border:1px solid #bbf7d0}
.hm-tbl{border-collapse:collapse;width:100%;margin-bottom:5px}
.hm-tbl th{padding:5px 7px;font-size:9px;font-weight:600;font-family:var(--ff-mono);color:var(--ink-4);background:var(--cream-b);text-align:center;border:1px solid var(--ink-5)}
.hm-tbl th.rh{text-align:left}
.hm-tbl td{padding:0;border:1px solid rgba(255,255,255,.4);text-align:center}
.hm-cell{padding:7px 5px;font-family:var(--ff-mono);font-size:11px;font-weight:500;min-width:54px}

/* Matrix controls */
.mc{background:var(--white);border:1px solid var(--ink-5);border-radius:8px;padding:14px 16px;margin-bottom:18px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
.mc-lbl{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--ink-4);margin-bottom:8px}
.mc-row{display:flex;gap:8px}
.mc-row .field{flex:1;margin-bottom:7px}

/* Toast */
#toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--ink);color:var(--cream);
  padding:9px 20px;border-radius:7px;font-size:12.5px;font-weight:500;
  opacity:0;transition:all .25s;z-index:999;pointer-events:none;white-space:nowrap;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Mobile menu button */
#menu-btn{display:none;padding:6px 10px;border-radius:5px;border:1px solid var(--ink-5);color:var(--ink-3);background:var(--white)}
#menu-btn:hover{color:var(--ink);border-color:var(--ink-3)}

/* Overlay */
#overlay{display:none;position:fixed;inset:0;background:rgba(28,25,23,.4);z-index:40}

/* â”€â”€ METHODOLOGY PAGE â”€â”€ */
#methodology{display:none;flex:1;overflow-y:auto;padding:36px 40px}
.meth-hero{margin-bottom:40px}
.meth-tag{font-family:var(--ff-mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);margin-bottom:10px}
.meth-title{font-family:var(--ff-head);font-size:clamp(28px,3vw,38px);font-weight:700;color:var(--ink);letter-spacing:-1px;line-height:1.1;margin-bottom:12px}
.meth-intro{font-size:15px;color:var(--ink-3);line-height:1.7;max-width:560px;font-weight:300}
.meth-section{margin-bottom:36px;padding-bottom:36px;border-bottom:1px solid var(--ink-5)}
.meth-section:last-child{border-bottom:none}
.meth-sec-title{font-family:var(--ff-head);font-size:20px;font-weight:600;color:var(--ink);margin-bottom:12px;letter-spacing:-.3px}
.meth-body{font-size:13.5px;color:var(--ink-3);line-height:1.75;margin-bottom:10px}
.meth-formula{background:var(--white);border:1px solid var(--ink-5);border-radius:8px;padding:14px 18px;font-family:var(--ff-mono);font-size:13px;color:var(--navy);margin:14px 0;line-height:2}
.meth-note{background:var(--cream-b);border-left:3px solid var(--gold);border-radius:4px;padding:10px 14px;font-size:12.5px;color:var(--ink-3);line-height:1.6;margin-top:10px}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:900px){
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .two-col{grid-template-columns:1fr}
}
@media(max-width:700px){
  :root{--sidebar-w:280px}
  #sidebar{
    position:fixed;top:var(--header-h);left:0;bottom:0;z-index:45;
    transform:translateX(-100%);
  }
  #sidebar.open{transform:translateX(0)}
  #overlay{display:block;opacity:0;pointer-events:none;transition:opacity .25s}
  #overlay.show{opacity:1;pointer-events:auto}
  #menu-btn{display:inline-flex;align-items:center;gap:6px}
  .h-disclaimer{display:none}
  .tab-panel{padding:16px}
  #main{width:100%}
  .kpi-grid{grid-template-columns:1fr 1fr}
  .mc{grid-template-columns:1fr}
}
@media(max-width:500px){
  .kpi-grid{grid-template-columns:1fr 1fr}
  #tabbar{padding:0 12px}
  .tab-btn{margin-right:14px;font-size:12px}
}
</style>
</head>
<body>
<div id="shell">

<!-- HEADER -->
<header id="header">
  <button id="menu-btn" onclick="toggleMobile()">â˜° Inputs</button>
  <a href="index.html" class="h-logo">
    <div class="h-logo-mark">
      <svg viewBox="0 0 20 20" fill="none"><path d="M3 15l4-6 4 4 3-4 3 3" stroke="#f5f2ec" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <span class="h-logo-name">Valuation Studio</span>
  </a>
  <div class="h-sep"></div>
  <button class="h-btn" onclick="showMethodology()" id="meth-btn">Methodology</button>
  <button class="h-btn" onclick="shareURL()" id="share-btn">â¬† Share</button>
  <div class="h-disclaimer">Illustrative only â€” not financial advice</div>
</header>
<div id="overlay" onclick="closeMobile()"></div>

<!-- BODY -->
<div id="body">

<!-- SIDEBAR -->
<aside id="sidebar">

  <div class="sb-hdr">Company</div>

  <div class="company-grid" id="company-grid">
    <button class="co-pill" onclick="loadPreset('AAPL')">AAPL</button>
    <button class="co-pill" onclick="loadPreset('MSFT')">MSFT</button>
    <button class="co-pill" onclick="loadPreset('NVDA')">NVDA</button>
    <button class="co-pill" onclick="loadPreset('META')">META</button>
    <button class="co-pill" onclick="loadPreset('TSLA')">TSLA</button>
    <button class="co-pill active" onclick="loadPreset('NFLX')">NFLX</button>
  </div>

  <div class="field">
    <label>Company Name</label>
    <input type="text" id="inp-company" placeholder="e.g. Netflix (NFLX)"/>
  </div>
  <div class="field">
    <label>Stock Price <span class="label-note" id="price-currency-note">USD</span></label>
    <input type="text" id="inp-price" placeholder="e.g. 78.00"/>
  </div>

  <!-- Currency converter -->
  <div class="sb-hdr">Currency</div>
  <div class="currency-row">
    <div class="field">
      <label>Financials in</label>
      <select id="sel-fccy" onchange="onCurrencyChange()">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
        <option value="JPY">JPY</option>
        <option value="CNY">CNY</option>
        <option value="KRW">KRW</option>
        <option value="INR">INR</option>
        <option value="CAD">CAD</option>
        <option value="AUD">AUD</option>
        <option value="NOK">NOK</option>
        <option value="SEK">SEK</option>
        <option value="DKK">DKK</option>
        <option value="CHF">CHF</option>
      </select>
    </div>
    <div class="field">
      <label>Price in</label>
      <select id="sel-pccy" onchange="onCurrencyChange()">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
        <option value="JPY">JPY</option>
        <option value="CNY">CNY</option>
        <option value="KRW">KRW</option>
        <option value="INR">INR</option>
        <option value="CAD">CAD</option>
        <option value="AUD">AUD</option>
        <option value="NOK">NOK</option>
        <option value="SEK">SEK</option>
        <option value="DKK">DKK</option>
        <option value="CHF">CHF</option>
      </select>
    </div>
  </div>
  <div id="fx-rate-row" style="display:none;margin-bottom:10px">
    <div class="fx-rate-wrap">
      <label>FX Rate (1 <span id="fccy-lbl">USD</span> = ? <span id="pccy-lbl">USD</span>)</label>
      <div class="fx-rate-val">
        <input type="number" id="inp-fxrate" placeholder="1.0" step="0.0001" style="background:none;border:none;outline:none;width:100%;font-family:var(--ff-mono);font-size:12px" oninput="update()"/>
      </div>
    </div>
  </div>

  <div class="sb-hdr">Financials (millions, local currency)</div>

  <div class="field">
    <label>Shares Outstanding (M)</label>
    <input type="text" id="inp-shares" placeholder="e.g. 4317"/>
  </div>
  <div class="field">
    <label>Revenue (M)</label>
    <input type="text" id="inp-revenue" placeholder="e.g. 45183"/>
  </div>
  <div class="field">
    <label>Free Cash Flow (M)</label>
    <input type="text" id="inp-fcf" placeholder="e.g. 9461"/>
  </div>
  <div class="field">
    <label>Net Cash / (Net Debt) (M) <span class="label-note">+ = cash, âˆ’ = debt</span></label>
    <input type="text" id="inp-netcash" placeholder="e.g. -4500"/>
  </div>

  <div id="margin-pill" style="display:none">
    <div class="margin-pill">
      <span class="mp-lbl">FCF Margin</span>
      <span class="mp-val" id="mp-val">â€”</span>
    </div>
  </div>
  <div id="warn-fcf" class="warn">âš  Negative FCF â€” results may be unreliable without margin improvement.</div>
  <div id="err-rev" class="err">Revenue must be a positive number.</div>

  <div class="sb-hdr">Projection</div>

  <div class="field">
    <label>Forecast Horizon (years)</label>
    <input type="number" id="inp-years" value="8" min="3" max="30" step="1" oninput="update()"/>
  </div>
  <div class="sl-wrap">
    <label>Revenue Growth (%/yr)<span id="lbl-cagr">10%</span></label>
    <input type="range" id="sl-cagr" min="-30" max="100" step="1" value="10" oninput="onSl('cagr')"/>
  </div>
  <div class="sl-wrap">
    <label>FCF Margin Change (pp/yr)<span id="lbl-dpp">0.0pp</span></label>
    <input type="range" id="sl-dpp" min="-5" max="5" step="0.1" value="0" oninput="onSl('dpp')"/>
  </div>

  <div class="sb-hdr">Terminal Value</div>

  <div class="radio-row">
    <button class="rb active" id="rb-tg" onclick="setTerm('growth')">Terminal Growth</button>
    <button class="rb" id="rb-tm" onclick="setTerm('multiple')">Exit Multiple</button>
  </div>
  <div id="tg-wrap">
    <div class="sl-wrap">
      <label>Terminal Growth (%/yr)<span id="lbl-tg">2.0%</span></label>
      <input type="range" id="sl-tg" min="-10" max="10" step="0.5" value="2" oninput="onSl('tg')"/>
    </div>
  </div>
  <div id="tm-wrap" style="display:none">
    <div class="field">
      <label>Exit Multiple (Ã— final FCF)</label>
      <input type="text" id="inp-tmult" placeholder="e.g. 15" oninput="update()"/>
    </div>
  </div>

  <div id="sb-sum-wrap" style="display:none">
    <div class="sb-sum">
      <div class="sb-sum-title">Summary</div>
      <div class="sb-sum-row"><span class="sb-sum-lbl" id="sum-co">â€”</span><span class="sb-sum-val" id="sum-px">â€”</span></div>
      <div class="sb-sum-row"><span class="sb-sum-lbl">Market Cap</span><span class="sb-sum-val" id="sum-mktcap">â€”</span></div>
      <div class="sb-sum-row"><span class="sb-sum-lbl">FCF Margin</span><span class="sb-sum-val" id="sum-margin">â€”</span></div>
      <div class="sb-sum-row"><span class="sb-sum-lbl">Growth Â· Horizon</span><span class="sb-sum-val" id="sum-growth">â€”</span></div>
      <div class="sb-sum-row"><span class="sb-sum-lbl">Terminal</span><span class="sb-sum-val" id="sum-terminal">â€”</span></div>
    </div>
  </div>

  <div id="last-updated" style="font-size:9.5px;color:var(--ink-4);text-align:center;margin-top:10px;font-family:var(--ff-mono)"></div>
  <button class="sb-btn light" id="btn-reset" style="display:none" onclick="resetInputs()">âœ•  Reset All Inputs</button>

</aside>

<!-- MAIN -->
<main id="main">

  <!-- Methodology page -->
  <div id="methodology">
    <div class="meth-hero">
      <div class="meth-tag">Methodology</div>
      <h1 class="meth-title">How Valuation Studio works</h1>
      <p class="meth-intro">All three tools use the same discounted cash flow engine. Here's the exact math behind every output.</p>
    </div>

    <div class="meth-section">
      <h2 class="meth-sec-title">1. Normal DCF â€” Fair Value per Share</h2>
      <p class="meth-body">We project free cash flow year-by-year using your revenue growth and FCF margin assumptions, then discount each year's FCF back to present value at your required return rate. We add a terminal value representing cash flows beyond the forecast horizon.</p>
      <div class="meth-formula">
        FCF<sub>t</sub> = Revenue<sub>t</sub> Ã— FCF Margin<sub>t</sub><br>
        Revenue<sub>t</sub> = Revenue<sub>0</sub> Ã— (1 + g)<sup>t</sup><br>
        Margin<sub>t</sub> = Margin<sub>0</sub> + (Î”pp Ã— t)<br>
        PV(FCF<sub>t</sub>) = FCF<sub>t</sub> / (1 + r)<sup>t</sup>
      </div>
      <p class="meth-body">The terminal value uses either the Gordon Growth Model or an exit multiple:</p>
      <div class="meth-formula">
        TV (Gordon Growth) = FCF<sub>n</sub> Ã— (1 + g<sub>âˆ</sub>) / (r âˆ’ g<sub>âˆ</sub>)<br>
        TV (Exit Multiple) = FCF<sub>n</sub> Ã— EV/FCF multiple<br>
        PV(TV) = TV / (1 + r)<sup>n</sup>
      </div>
      <div class="meth-formula">
        Equity Value = PV(FCFs) + PV(TV) âˆ’ Net Debt<br>
        Fair Value per Share = Equity Value / Shares Outstanding
      </div>
      <div class="meth-note">
        <strong>Net Debt</strong> = Total Debt âˆ’ Cash & Equivalents. A positive net cash position <em>increases</em> fair value; net debt <em>decreases</em> it. Enter as positive for cash, negative for debt.
      </div>
    </div>

    <div class="meth-section">
      <h2 class="meth-sec-title">2. Reverse DCF â€” Implied IRR</h2>
      <p class="meth-body">We invert the DCF: instead of solving for fair value, we solve for the discount rate (r) that makes the fair value equal to the current market price. This tells you the annual return the market is pricing in given your growth assumptions.</p>
      <div class="meth-formula">
        Find r such that: Fair Value(r) = Market Price<br>
        Solved via bisection over r âˆˆ [0.1%, 200%]
      </div>
      <div class="meth-note">
        If the implied IRR â‰¥ 10%, the stock may be offering an adequate return at current price. Below 10%, the price may be implying lower-than-typical returns. The 10% hurdle is illustrative â€” your required return may differ.
      </div>
    </div>

    <div class="meth-section">
      <h2 class="meth-sec-title">3. IRR Matrix â€” Scenario Grid</h2>
      <p class="meth-body">We run the Reverse DCF across every combination of revenue growth (rows) and terminal assumption (columns), for three margin scenarios: Bear (âˆ’1pp/yr margin decline), Base (unchanged margins), and Bull (+1pp/yr margin improvement).</p>
      <div class="meth-note">
        <strong>Reading the heatmap:</strong> Red cells â†’ implied IRR below 10% hurdle (market pricing in limited upside). Blue cells â†’ implied IRR above 10% hurdle (market may be underpricing the stock under those assumptions). The diverging scale is anchored at 10%.
      </div>
    </div>

    <div class="meth-section">
      <h2 class="meth-sec-title">4. Currency Conversion</h2>
      <p class="meth-body">When a company reports financials in one currency (e.g. JPY) but trades in another (e.g. USD), the fair value per share must be converted. Enter a manual FX rate â€” the app applies it automatically.</p>
      <div class="meth-formula">
        Fair Value (price currency) = Fair Value (financial currency) Ã— FX Rate
      </div>
    </div>

    <div class="meth-section">
      <h2 class="meth-sec-title">5. Important limitations</h2>
      <p class="meth-body">DCF analysis is highly sensitive to input assumptions â€” small changes in growth rate or terminal value can produce large swings in fair value. This tool is for educational and illustrative purposes only.</p>
      <ul style="font-size:13px;color:var(--ink-3);line-height:2;margin-left:16px">
        <li>Results are not financial advice</li>
        <li>Pre-loaded data is manually maintained and may be outdated</li>
        <li>The model does not account for dilution, debt covenants, or extraordinary items</li>
        <li>A DCF is only as good as its assumptions â€” always stress-test with the IRR Matrix</li>
      </ul>
    </div>

    <button class="sb-btn dark" style="max-width:200px" onclick="hideMethodology()">â† Back to App</button>
  </div>

  <!-- App tabs -->
  <div id="app-view" style="display:flex;flex-direction:column;flex:1">
    <nav id="tabbar">
      <button class="tab-btn active" onclick="switchTab('dcf')">Normal DCF</button>
      <button class="tab-btn" onclick="switchTab('rev')">Reverse DCF</button>
      <button class="tab-btn" onclick="switchTab('matrix')">IRR Matrix</button>
      <div class="tab-sep"></div>
    </nav>

    <!-- DCF Tab -->
    <div class="tab-panel active" id="tab-dcf">
      <div id="dcf-empty" class="empty">
        <div class="empty-icon">ğŸ“Š</div>
        <div class="empty-title">Select a company or enter data</div>
        <div class="empty-body">Choose a preset above or fill in the sidebar. Try Netflix â€” it loads in one click.</div>
      </div>
      <div id="dcf-content" style="display:none">
        <div class="two-col">
          <div>
            <div class="sec-hdr">Discount Rate</div>
            <div class="sl-wrap">
              <label>Required Return (%)<span id="lbl-disc">12%</span></label>
              <input type="range" id="sl-disc" min="1" max="50" step="1" value="12" oninput="onDiscChange()"/>
            </div>
            <div class="hint">
              <div class="hint-title">Choosing a discount rate</div>
              <div class="hint-body">
                <strong>8â€“10%</strong> â€” Aggressive<br>
                <strong>10â€“15%</strong> â€” Moderate<br>
                <strong>15â€“20%</strong> â€” Conservative<br><br>
                Higher rate = lower fair value = more safety margin built in.
              </div>
            </div>
          </div>
          <div>
            <div class="sec-hdr">Result</div>
            <div class="kpi-grid" id="dcf-kpis"></div>
            <div class="bars" id="dcf-bars"></div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Fair Value vs Discount Rate</div>
          <div class="chart-sub">How intrinsic value shifts as your required return changes. Green region = stock appears undervalued at that rate.</div>
          <canvas id="chart-sens" height="200" style="width:100%"></canvas>
          <div class="chart-legend">
            <div class="leg-item"><div class="leg-dot" style="background:var(--navy)"></div>Fair value</div>
            <div class="leg-item"><div class="leg-dot" style="background:var(--ink-4);width:18px;height:2px;border-radius:0"></div>Market price</div>
            <div class="leg-item"><div class="leg-dot" style="background:rgba(20,83,45,.1)"></div>Undervalued region</div>
          </div>
        </div>
        <div class="coll">
          <div class="coll-hdr" onclick="toggleColl(this)">Year-by-year forecast &amp; valuation bridge <span class="coll-arrow">â–¼</span></div>
          <div class="coll-body">
            <div style="overflow-x:auto"><table class="data-tbl" id="forecast-tbl"></table></div>
            <div id="bridge-wrap"></div>
            <button class="btn-dl" onclick="downloadForecast()">â¬‡ Download CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reverse DCF Tab -->
    <div class="tab-panel" id="tab-rev">
      <div id="rev-empty" class="empty">
        <div class="empty-icon">ğŸ”„</div>
        <div class="empty-title">Enter data to see implied return</div>
        <div class="empty-body">The Reverse DCF shows what annual return the current price implies given your growth assumptions.</div>
      </div>
      <div id="rev-content" style="display:none">
        <div class="sec-hdr">Implied Return at Current Price</div>
        <div class="kpi-grid" id="rev-kpis"></div>
        <div class="chart-card">
          <div class="chart-title">Implied IRR vs Stock Price</div>
          <div class="chart-sub">What return does each price level imply? Green shading = above 10% hurdle rate.</div>
          <canvas id="chart-irr" height="200" style="width:100%"></canvas>
          <div class="chart-legend">
            <div class="leg-item"><div class="leg-dot" style="background:var(--navy)"></div>Implied IRR</div>
            <div class="leg-item"><div class="leg-dot" style="background:rgba(20,83,45,.1)"></div>Above 10% hurdle</div>
            <div class="leg-item"><div class="leg-dot" style="background:var(--ink-4);width:18px;height:2px;border-radius:0"></div>10% hurdle</div>
          </div>
        </div>
        <div class="coll">
          <div class="coll-hdr" onclick="toggleColl(this)">Price sensitivity table <span class="coll-arrow">â–¼</span></div>
          <div class="coll-body">
            <div style="overflow-x:auto"><table class="data-tbl" id="rev-tbl"></table></div>
            <button class="btn-dl" style="margin-top:7px" onclick="downloadRevDCF()">â¬‡ Download CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Matrix Tab -->
    <div class="tab-panel" id="tab-matrix">
      <div id="matrix-empty" class="empty">
        <div class="empty-icon">ğŸ—‚ï¸</div>
        <div class="empty-title">Enter data to generate the matrix</div>
        <div class="empty-body">The IRR Matrix maps every combination of growth and terminal assumptions across Bear, Base, and Bull scenarios.</div>
      </div>
      <div id="matrix-content" style="display:none">
        <div class="hm-legend">
          <span class="hm-end" style="color:var(--red)">Low IRR</span>
          <div style="flex:1"><div class="hm-bar"></div><div class="hm-ticks"><span>0%</span><span>5%</span><span>10%</span><span>15%</span><span>20%</span><span>25%+</span></div></div>
          <span class="hm-end" style="color:#1e3a8a">High IRR</span>
        </div>
        <div class="mc" id="mc">
          <div>
            <div class="mc-lbl">Rows â€” Revenue Growth</div>
            <div class="mc-row">
              <div class="field"><label>Min (%)</label><input type="number" id="mc-gmin" value="0" step="1" oninput="renderMatrix()"/></div>
              <div class="field"><label>Max (%)</label><input type="number" id="mc-gmax" value="20" step="1" oninput="renderMatrix()"/></div>
              <div class="field"><label>Rows</label><input type="number" id="mc-grows" value="6" min="2" max="12" step="1" oninput="renderMatrix()"/></div>
            </div>
          </div>
          <div id="mc-right">
            <div class="mc-lbl" id="mc-col-lbl">Columns â€” Terminal Growth</div>
            <div class="mc-row">
              <div class="field"><label id="mc-min-lbl">Min (%)</label><input type="number" id="mc-tmin" value="0" step="0.5" oninput="renderMatrix()"/></div>
              <div class="field"><label id="mc-max-lbl">Max (%)</label><input type="number" id="mc-tmax" value="4" step="0.5" oninput="renderMatrix()"/></div>
              <div class="field"><label>Cols</label><input type="number" id="mc-tcols" value="5" min="2" max="10" step="1" oninput="renderMatrix()"/></div>
            </div>
          </div>
        </div>
        <div id="matrix-tables"></div>
      </div>
    </div>
  </div>
</main>
</div><!-- /body -->
</div><!-- /shell -->

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PRESETS={
  NFLX:{company:'Netflix (NFLX)',price:'78',shares:'4317',revenue:'45183',fcf:'9461',netcash:'-4500',cagr:12,dpp:0,years:8,termMode:'growth',tg:3,tmult:'15',updated:'FY2025',fccy:'USD',pccy:'USD'},
  AAPL:{company:'Apple (AAPL)',price:'227',shares:'14773',revenue:'416161',fcf:'98767',netcash:'34000',cagr:8,dpp:0.2,years:8,termMode:'growth',tg:2.5,tmult:'20',updated:'FY2025 (Sep)',fccy:'USD',pccy:'USD'},
  MSFT:{company:'Microsoft (MSFT)',price:'415',shares:'7433',revenue:'281724',fcf:'71611',netcash:'27000',cagr:15,dpp:0.1,years:8,termMode:'growth',tg:3,tmult:'20',updated:'FY2025 (Jun)',fccy:'USD',pccy:'USD'},
  NVDA:{company:'Nvidia (NVDA)',price:'131',shares:'24400',revenue:'130497',fcf:'60853',netcash:'38000',cagr:30,dpp:0,years:8,termMode:'growth',tg:3,tmult:'25',updated:'FY2025 (Jan)',fccy:'USD',pccy:'USD'},
  META:{company:'Meta Platforms (META)',price:'640',shares:'2530',revenue:'164501',fcf:'52100',netcash:'52000',cagr:15,dpp:0.2,years:8,termMode:'growth',tg:3,tmult:'18',updated:'FY2024',fccy:'USD',pccy:'USD'},
  TSLA:{company:'Tesla (TSLA)',price:'340',shares:'3200',revenue:'94830',fcf:'6200',netcash:'44100',cagr:20,dpp:0.5,years:8,termMode:'growth',tg:3,tmult:'20',updated:'FY2025',fccy:'USD',pccy:'USD'},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DCF ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pf(s){if(s===null||s===undefined||s==='')return NaN;const n=parseFloat(String(s).replace(/,/g,''));return isNaN(n)?NaN:n}
function linspace(a,b,n){if(n<2)return[a];const r=[];for(let i=0;i<n;i++)r.push(a+(b-a)*i/(n-1));return r}

function projectFCFs(inp){
  const rows=[];let rev=inp.revLTM,marg=inp.fcfMargin;
  for(let y=1;y<=inp.years;y++){
    rev*=(1+inp.cagr);marg+=inp.dpp;
    const fcf=rev*marg,df=1/Math.pow(1+inp.disc,y);
    rows.push({year:y,rev,marg,fcf,df,discFcf:fcf*df});
  }
  return rows;
}

function terminalPV(inp,lastFCF){
  let tv;
  if(inp.termMode==='multiple'){tv=lastFCF*inp.tmult}
  else{const gap=Math.max(inp.disc-inp.tg,.001);tv=lastFCF*(1+inp.tg)/gap}
  return tv/Math.pow(1+inp.disc,inp.years);
}

function fairValue(inp){
  const rows=projectFCFs(inp);
  const pvFCFs=rows.reduce((s,r)=>s+r.discFcf,0);
  const lastFCF=rows[rows.length-1].fcf;
  if(!isFinite(lastFCF)||lastFCF<=0)return{ok:false,rows};
  const pvTV=terminalPV(inp,lastFCF);
  const equityPV=pvFCFs+pvTV-inp.netDebt;
  if(equityPV<=0)return{ok:false,pvFCFs,pvTV,equityPV,lastFCF,rows};
  // Apply FX if needed
  const fvLocal=equityPV/inp.shares;
  const fvps=fvLocal*inp.fxRate;
  return{ok:true,pvFCFs,pvTV,equityPV,fvLocal,fvps,lastFCF,rows};
}

function impliedIRR(inp,price){
  // price is in price currency â€” convert to financial currency for comparison
  const priceLocal=price/inp.fxRate;
  // We need fvLocal(disc) = priceLocal
  const target=priceLocal;
  let lo=.001,hi=2;
  for(let i=0;i<80;i++){
    const mid=(lo+hi)/2;
    const res=fairValue({...inp,disc:mid});
    if(!res.ok){hi=mid;continue}
    if(res.fvLocal>target)lo=mid;else hi=mid;
    if(hi-lo<1e-7)break;
  }
  const mid=(lo+hi)/2;
  const res=fairValue({...inp,disc:mid});
  if(!res.ok)return null;
  if(Math.abs(res.fvLocal-target)/Math.max(target,.01)>0.02)return null;
  return mid;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE / INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let termMode='growth',activeTab='dcf',activePreset='NFLX';
let _sensData=[],_revData=[],_forecastRows=[];

function getInputs(){
  return{
    company:document.getElementById('inp-company').value.trim(),
    price:pf(document.getElementById('inp-price').value),
    shares:pf(document.getElementById('inp-shares').value),
    revLTM:pf(document.getElementById('inp-revenue').value),
    fcfLTM:pf(document.getElementById('inp-fcf').value),
    netCashRaw:pf(document.getElementById('inp-netcash').value),
    cagr:parseInt(document.getElementById('sl-cagr').value)/100,
    dpp:parseFloat(document.getElementById('sl-dpp').value)/100,
    years:parseInt(document.getElementById('inp-years').value)||8,
    disc:parseInt(document.getElementById('sl-disc').value)/100,
    termMode,
    tg:parseFloat(document.getElementById('sl-tg').value)/100,
    tmult:pf(document.getElementById('inp-tmult').value),
    fccy:document.getElementById('sel-fccy').value,
    pccy:document.getElementById('sel-pccy').value,
    fxRate:pf(document.getElementById('inp-fxrate').value)||1,
  };
}

function buildInp(raw){
  if(!isFinite(raw.revLTM)||raw.revLTM<=0)return null;
  if(!isFinite(raw.fcfLTM))return null;
  if(!isFinite(raw.shares)||raw.shares<=0)return null;
  if(!isFinite(raw.price)||raw.price<=0)return null;
  if(raw.termMode==='multiple'&&(!isFinite(raw.tmult)||raw.tmult<=0))return null;
  const margin=raw.fcfLTM/raw.revLTM;
  if(!isFinite(margin))return null;
  const netDebt=isFinite(raw.netCashRaw)?-raw.netCashRaw:0;
  const fxRate=(raw.fccy===raw.pccy)?1:(isFinite(raw.fxRate)&&raw.fxRate>0?raw.fxRate:1);
  return{...raw,fcfMargin:margin,netDebt,fxRate};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SLIDER LABELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onSl(k){
  if(k==='cagr'){document.getElementById('lbl-cagr').textContent=document.getElementById('sl-cagr').value+'%'}
  else if(k==='dpp'){document.getElementById('lbl-dpp').textContent=parseFloat(document.getElementById('sl-dpp').value).toFixed(1)+'pp'}
  else if(k==='tg'){document.getElementById('lbl-tg').textContent=parseFloat(document.getElementById('sl-tg').value).toFixed(1)+'%'}
  update();
}
function onDiscChange(){
  document.getElementById('lbl-disc').textContent=document.getElementById('sl-disc').value+'%';
  renderDCF();
}

/* Listen to text inputs */
['inp-company','inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash','inp-years','inp-tmult']
  .forEach(id=>document.getElementById(id).addEventListener('input',update));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURRENCY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onCurrencyChange(){
  const fccy=document.getElementById('sel-fccy').value;
  const pccy=document.getElementById('sel-pccy').value;
  const diff=fccy!==pccy;
  document.getElementById('fx-rate-row').style.display=diff?'':'none';
  document.getElementById('fccy-lbl').textContent=fccy;
  document.getElementById('pccy-lbl').textContent=pccy;
  document.getElementById('price-currency-note').textContent=pccy;
  update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TERMINAL MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setTerm(mode){
  termMode=mode;
  document.getElementById('rb-tg').classList.toggle('active',mode==='growth');
  document.getElementById('rb-tm').classList.toggle('active',mode==='multiple');
  document.getElementById('tg-wrap').style.display=mode==='growth'?'':'none';
  document.getElementById('tm-wrap').style.display=mode==='multiple'?'':'none';
  const isM=mode==='multiple';
  document.getElementById('mc-col-lbl').textContent=isM?'Columns â€” Exit Multiple':'Columns â€” Terminal Growth';
  document.getElementById('mc-min-lbl').textContent=isM?'Min (Ã—)':'Min (%)';
  document.getElementById('mc-max-lbl').textContent=isM?'Max (Ã—)':'Max (%)';
  if(isM){document.getElementById('mc-tmin').value=8;document.getElementById('mc-tmax').value=16}
  else{document.getElementById('mc-tmin').value=0;document.getElementById('mc-tmax').value=4}
  update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadPreset(key){
  const p=PRESETS[key];if(!p)return;
  activePreset=key;
  document.querySelectorAll('.co-pill').forEach((b,i)=>{
    b.classList.toggle('active',Object.keys(PRESETS)[i]===key);
  });
  document.getElementById('inp-company').value=p.company;
  document.getElementById('inp-price').value=p.price;
  document.getElementById('inp-shares').value=p.shares;
  document.getElementById('inp-revenue').value=p.revenue;
  document.getElementById('inp-fcf').value=p.fcf;
  document.getElementById('inp-netcash').value=p.netcash;
  document.getElementById('sl-cagr').value=p.cagr;document.getElementById('lbl-cagr').textContent=p.cagr+'%';
  document.getElementById('sl-dpp').value=p.dpp;document.getElementById('lbl-dpp').textContent=p.dpp.toFixed(1)+'pp';
  document.getElementById('inp-years').value=p.years;
  setTerm(p.termMode);
  document.getElementById('sl-tg').value=p.tg;document.getElementById('lbl-tg').textContent=p.tg.toFixed(1)+'%';
  document.getElementById('inp-tmult').value=p.tmult;
  document.getElementById('sel-fccy').value=p.fccy||'USD';
  document.getElementById('sel-pccy').value=p.pccy||'USD';
  onCurrencyChange();
  document.getElementById('last-updated').textContent='Data: '+p.updated+' (manually maintained)';
  document.getElementById('btn-reset').style.display='';
  update();
}

function resetInputs(){
  activePreset=null;
  document.querySelectorAll('.co-pill').forEach(b=>b.classList.remove('active'));
  ['inp-company','inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash','inp-tmult']
    .forEach(id=>document.getElementById(id).value='');
  document.getElementById('inp-years').value=8;
  document.getElementById('sl-cagr').value=10;document.getElementById('lbl-cagr').textContent='10%';
  document.getElementById('sl-dpp').value=0;document.getElementById('lbl-dpp').textContent='0.0pp';
  document.getElementById('sl-tg').value=2;document.getElementById('lbl-tg').textContent='2.0%';
  document.getElementById('sl-disc').value=12;document.getElementById('lbl-disc').textContent='12%';
  document.getElementById('sel-fccy').value='USD';document.getElementById('sel-pccy').value='USD';
  onCurrencyChange();
  document.getElementById('last-updated').textContent='';
  document.getElementById('btn-reset').style.display='none';
  setTerm('growth');
  update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>{
    b.classList.toggle('active',['dcf','rev','matrix'][i]===t);
  });
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLAPSIBLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleColl(hdr){hdr.classList.toggle('open');hdr.nextElementSibling.classList.toggle('open')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   METHODOLOGY PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showMethodology(){
  document.getElementById('app-view').style.display='none';
  document.getElementById('methodology').style.display='block';
  document.getElementById('meth-btn').textContent='â† App';
  document.getElementById('meth-btn').onclick=hideMethodology;
}
function hideMethodology(){
  document.getElementById('app-view').style.display='flex';
  document.getElementById('methodology').style.display='none';
  document.getElementById('meth-btn').textContent='Methodology';
  document.getElementById('meth-btn').onclick=showMethodology;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleMobile(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}
function closeMobile(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   URL SHARING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shareURL(){
  const raw=getInputs();
  const p=new URLSearchParams({
    co:raw.company,px:raw.price,sh:raw.shares,
    rev:raw.revLTM,fcf:raw.fcfLTM,nc:raw.netCashRaw,
    cagr:document.getElementById('sl-cagr').value,
    dpp:document.getElementById('sl-dpp').value,
    yr:raw.years,disc:document.getElementById('sl-disc').value,
    tm:termMode,tg:document.getElementById('sl-tg').value,
    tmult:raw.tmult||'',
    fccy:raw.fccy,pccy:raw.pccy,fxr:raw.fxRate,
  });
  const url=window.location.origin+window.location.pathname+'?'+p.toString();
  navigator.clipboard.writeText(url).then(()=>showToast('Link copied to clipboard âœ“')).catch(()=>{
    prompt('Copy this link:',url);
  });
}

function loadFromURL(){
  const p=new URLSearchParams(window.location.search);
  if(!p.has('co')&&!p.has('px'))return;
  // Clear preset highlights
  document.querySelectorAll('.co-pill').forEach(b=>b.classList.remove('active'));
  const set=(id,v)=>{if(v!==null&&v!==undefined&&v!=='null')document.getElementById(id).value=v};
  set('inp-company',p.get('co'));set('inp-price',p.get('px'));
  set('inp-shares',p.get('sh'));set('inp-revenue',p.get('rev'));
  set('inp-fcf',p.get('fcf'));set('inp-netcash',p.get('nc'));
  set('inp-years',p.get('yr'));set('inp-tmult',p.get('tmult'));
  if(p.get('cagr')){const v=parseInt(p.get('cagr'));document.getElementById('sl-cagr').value=v;document.getElementById('lbl-cagr').textContent=v+'%'}
  if(p.get('dpp')){const v=parseFloat(p.get('dpp'));document.getElementById('sl-dpp').value=v;document.getElementById('lbl-dpp').textContent=v.toFixed(1)+'pp'}
  if(p.get('tg')){const v=parseFloat(p.get('tg'));document.getElementById('sl-tg').value=v;document.getElementById('lbl-tg').textContent=v.toFixed(1)+'%'}
  if(p.get('disc')){const v=parseInt(p.get('disc'));document.getElementById('sl-disc').value=v;document.getElementById('lbl-disc').textContent=v+'%'}
  if(p.get('fccy'))document.getElementById('sel-fccy').value=p.get('fccy');
  if(p.get('pccy'))document.getElementById('sel-pccy').value=p.get('pccy');
  if(p.get('fxr'))document.getElementById('inp-fxrate').value=p.get('fxr');
  onCurrencyChange();
  if(p.get('tm'))setTerm(p.get('tm'));
  document.getElementById('btn-reset').style.display='';
  document.getElementById('last-updated').textContent='Loaded from shared link';
  update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMATTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n,d=2){if(!isFinite(n))return'â€”';return n.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d})}
function fmtPct(n,d=1){if(!isFinite(n))return'â€”';return(n>=0?'+':'')+fmt(n*100,d)+'%'}
function fmtPctPlain(n,d=1){if(!isFinite(n))return'â€”';return fmt(n*100,d)+'%'}

function irrColor(v){
  if(!isFinite(v))return{bg:'#f5f2ec',fg:'#a8a29e'};
  let r,g,b,fg;
  const H=.10;
  if(v<0){const t=Math.min(-v/.25,1);r=Math.round(252+(127-252)*t);g=Math.round(165+(29-165)*t);b=Math.round(165+(29-165)*t);fg=t>.5?'#fff':'#7f1d1d'}
  else if(v<H){const t=v/H;r=Math.round(252+(254-252)*t);g=Math.round(165+(249-165)*t);b=Math.round(165+(240-165)*t);fg='#7f1d1d'}
  else if(v<.15){const t=(v-H)/.05;r=Math.round(254+(219-254)*t);g=Math.round(249+(234-249)*t);b=Math.round(240+(254-240)*t);fg='#1e3a5f'}
  else{const t=Math.min((v-.15)/.15,1);r=Math.round(219+(15-219)*t);g=Math.round(234+(32-234)*t);b=Math.round(254+(80-254)*t);fg=t>.35?'#fff':'#1e3a5f'}
  return{bg:`rgb(${r},${g},${b})`,fg};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN UPDATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function update(){
  const raw=getInputs();
  const hasFCF=isFinite(raw.fcfLTM),hasRev=isFinite(raw.revLTM)&&raw.revLTM>0;
  document.getElementById('warn-fcf').style.display=(hasFCF&&raw.fcfLTM<0)?'block':'none';
  document.getElementById('err-rev').style.display=(raw.price&&raw.shares&&!hasRev)?'block':'none';
  const showMargin=hasFCF&&hasRev;
  document.getElementById('margin-pill').style.display=showMargin?'':'none';
  if(showMargin){
    const mv=document.getElementById('mp-val');
    const margin=raw.fcfLTM/raw.revLTM;
    mv.textContent=fmt(margin*100,1)+'%';
    mv.style.color=margin>0?'var(--green)':'var(--red)';
  }
  const inp=buildInp(raw);
  const showSum=inp!==null;
  document.getElementById('sb-sum-wrap').style.display=showSum?'':'none';
  if(showSum){
    document.getElementById('sum-co').textContent=inp.company||'â€”';
    document.getElementById('sum-px').textContent=fmt(inp.price)+' '+inp.pccy;
    document.getElementById('sum-mktcap').textContent=fmt(inp.price*inp.shares/inp.fxRate,0)+'M '+inp.fccy;
    document.getElementById('sum-margin').textContent=fmt(inp.fcfMargin*100,1)+'%';
    document.getElementById('sum-growth').textContent=fmt(inp.cagr*100,0)+'%/yr Â· '+inp.years+'y';
    document.getElementById('sum-terminal').textContent=inp.termMode==='multiple'?fmt(inp.tmult,1)+'Ã—':fmt(inp.tg*100,1)+'%/yr';
  }
  if(activeTab==='dcf')renderDCF(inp);
  else if(activeTab==='rev')renderRev(inp);
  else if(activeTab==='matrix')renderMatrix(inp);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1 â€” DCF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDCF(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=inp!==null;
  document.getElementById('dcf-empty').style.display=show?'none':'';
  document.getElementById('dcf-content').style.display=show?'':'none';
  if(!show)return;
  const res=fairValue(inp);
  _forecastRows=res.rows||[];
  const priceCcy=inp.pccy;
  if(res.ok){
    const up=res.fvps/inp.price-1;
    document.getElementById('dcf-kpis').innerHTML=`
      <div class="kpi"><div class="kpi-lbl">Fair Value / Share</div><div class="kpi-val">${fmt(res.fvps)}</div><div class="kpi-sub">${priceCcy}</div></div>
      <div class="kpi"><div class="kpi-lbl">Market Price</div><div class="kpi-val">${fmt(inp.price)}</div><div class="kpi-sub">${priceCcy}</div></div>
      <div class="kpi"><div class="kpi-lbl">Implied Upside</div><div class="kpi-val ${up>=0?'up':'down'}">${up>=0?'+':''}${fmt(up*100,1)}%</div><div class="kpi-sub">vs market price</div></div>
      <div class="kpi"><div class="kpi-lbl">Discount Rate</div><div class="kpi-val">${fmt(inp.disc*100,0)}%</div><div class="kpi-sub">required return</div></div>`;
    const mx=Math.max(res.fvps,inp.price);
    const fw=Math.max(res.fvps/mx*100,5),pw=Math.max(inp.price/mx*100,5);
    document.getElementById('dcf-bars').innerHTML=`
      <div class="bar-item"><div class="bar-meta"><span>Fair Value</span><span class="bar-meta-val">${fmt(res.fvps)} ${priceCcy}</span></div><div class="bar-track"><div class="bar-fill bar-fv" style="width:${fw.toFixed(1)}%">${fmt(res.fvps)}</div></div></div>
      <div class="bar-item"><div class="bar-meta"><span>Market Price</span><span class="bar-meta-val">${fmt(inp.price)} ${priceCcy}</span></div><div class="bar-track"><div class="bar-fill bar-px" style="width:${pw.toFixed(1)}%">${fmt(inp.price)}</div></div></div>
      <span class="upside-tag ${up>=0?'up':'down'}">${up>=0?'+':''}${fmt(up*100,1)}% implied ${up>=0?'upside':'downside'}</span>`;
  } else {
    document.getElementById('dcf-kpis').innerHTML=`<div class="kpi" style="grid-column:1/-1;text-align:center;color:var(--ink-3);padding:16px;font-size:12.5px">âš  N/A â€” equity PV â‰¤ 0. Try lower discount rate, higher growth, or improved margins.</div>`;
    document.getElementById('dcf-bars').innerHTML='';
  }
  // Sensitivity
  _sensData=[];
  for(let rr=5;rr<=30;rr++){
    const r2=fairValue({...inp,disc:rr/100});
    _sensData.push({rate:rr,fv:r2.ok?r2.fvps:null});
  }
  drawSensChart(inp.price,inp.disc*100);
  renderForecastTable(inp);
  renderBridge(inp,res);
}

function drawSensChart(price,selRate){
  const canvas=document.getElementById('chart-sens');
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth,H=200;
  canvas.width=W*dpr;canvas.height=H*dpr;ctx.scale(dpr,dpr);
  const PAD={t:10,r:16,b:32,l:52},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;
  const valid=_sensData.filter(d=>d.fv!==null);
  if(valid.length<2)return;
  const fvs=valid.map(d=>d.fv);
  const minFV=Math.min(...fvs,price)*.92,maxFV=Math.max(...fvs,price)*1.05;
  const xp=r=>PAD.l+(r-5)/(30-5)*cw;
  const yp=v=>PAD.t+ch-(v-minFV)/(maxFV-minFV)*ch;
  ctx.strokeStyle='#ede9e0';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=PAD.t+i*ch/4;ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle='#a8a29e';ctx.font='9px DM Mono';ctx.textAlign='right';
    ctx.fillText(fmt(minFV+(maxFV-minFV)*(1-i/4),0),PAD.l-5,y+3);
  }
  for(let r=5;r<=30;r+=5){
    const x=xp(r);ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle='#a8a29e';ctx.font='9px DM Mono';ctx.textAlign='center';ctx.fillText(r+'%',x,PAD.t+ch+14);
  }
  const above=valid.filter(d=>d.fv>=price);
  if(above.length){
    ctx.beginPath();const py=yp(price);ctx.moveTo(xp(above[0].rate),py);
    above.forEach(d=>ctx.lineTo(xp(d.rate),yp(d.fv)));
    ctx.lineTo(xp(above[above.length-1].rate),py);ctx.closePath();
    ctx.fillStyle='rgba(20,83,45,0.08)';ctx.fill();
  }
  ctx.setLineDash([4,4]);ctx.strokeStyle='#a8a29e';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(PAD.l,yp(price));ctx.lineTo(PAD.l+cw,yp(price));ctx.stroke();
  ctx.setLineDash([]);ctx.fillStyle='#a8a29e';ctx.font='9px DM Sans';ctx.textAlign='left';
  ctx.fillText('Market price',PAD.l+4,yp(price)-5);
  ctx.strokeStyle='#1e3a5f';ctx.lineWidth=2;ctx.lineJoin='round';ctx.beginPath();
  valid.forEach((d,i)=>{if(i===0)ctx.moveTo(xp(d.rate),yp(d.fv));else ctx.lineTo(xp(d.rate),yp(d.fv))});
  ctx.stroke();
  const sel=valid.find(d=>d.rate===Math.round(selRate));
  if(sel){ctx.beginPath();ctx.arc(xp(sel.rate),yp(sel.fv),4,0,Math.PI*2);ctx.fillStyle='#1e3a5f';ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke()}
  ctx.fillStyle='#78716c';ctx.font='10px DM Sans';ctx.textAlign='center';
  ctx.fillText('Discount Rate (%)',PAD.l+cw/2,H-4);
}

function renderForecastTable(inp){
  const t=document.getElementById('forecast-tbl');
  if(!_forecastRows.length){t.innerHTML='';return}
  let h=`<thead><tr><th>Year</th><th>Revenue (M)</th><th>FCF Margin</th><th>FCF (M)</th><th>Disc. Factor</th><th>Disc. FCF (M)</th></tr></thead><tbody>`;
  _forecastRows.forEach(r=>{h+=`<tr><td>${r.year}</td><td>${fmt(r.rev,0)}</td><td>${fmtPctPlain(r.marg,2)}</td><td>${fmt(r.fcf,0)}</td><td>${fmt(r.df,4)}</td><td>${fmt(r.discFcf,0)}</td></tr>`});
  t.innerHTML=h+'</tbody>';
}

function renderBridge(inp,res){
  const el=document.getElementById('bridge-wrap');
  if(!res.ok){el.innerHTML='';return}
  const priceCcy=inp.pccy,finCcy=inp.fccy;
  const fxNote=inp.fxRate!==1?` â†’ Ã—${fmt(inp.fxRate,4)} FX`:'';
  el.innerHTML=`<div class="bridge" style="margin-top:12px">
    <div class="br-row"><span class="br-lbl">PV of FCFs (Yrs 1â€“${inp.years})</span><span class="br-val">${fmt(res.pvFCFs,0)} M ${finCcy}</span></div>
    <div class="br-row"><span class="br-lbl">PV of Terminal Value</span><span class="br-val">${fmt(res.pvTV,0)} M ${finCcy}</span></div>
    <div class="br-row"><span class="br-lbl">Less: Net Debt</span><span class="br-val">(${fmt(inp.netDebt,0)} M)</span></div>
    <div class="br-row"><span class="br-lbl">Equity PV</span><span class="br-val">${fmt(res.equityPV,0)} M ${finCcy}</span></div>
    <div class="br-row"><span class="br-lbl">Ã· Shares Outstanding</span><span class="br-val">${fmt(inp.shares,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Fair Value per Share (local)${fxNote}</span><span class="br-val">${fmt(res.fvps,2)} ${priceCcy}</span></div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2 â€” REVERSE DCF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderRev(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=inp!==null;
  document.getElementById('rev-empty').style.display=show?'none':'';
  document.getElementById('rev-content').style.display=show?'':'none';
  if(!show)return;
  const irr=impliedIRR(inp,inp.price);
  const priceCcy=inp.pccy;
  if(irr!==null){
    const irrCls=irr>=.10?'up':irr<.06?'down':'';
    const termStr=inp.termMode==='multiple'?fmt(inp.tmult,1)+'Ã—':fmt(inp.tg*100,1)+'%/yr';
    document.getElementById('rev-kpis').innerHTML=`
      <div class="kpi"><div class="kpi-lbl">Implied IRR</div><div class="kpi-val ${irrCls}">${fmt(irr*100,2)}%</div><div class="kpi-sub">expected annual return</div></div>
      <div class="kpi"><div class="kpi-lbl">Stock Price</div><div class="kpi-val">${fmt(inp.price)}</div><div class="kpi-sub">${priceCcy}</div></div>
      <div class="kpi"><div class="kpi-lbl">Rev. Growth</div><div class="kpi-val">${fmt(inp.cagr*100,0)}%/yr</div><div class="kpi-sub">${inp.years} year horizon</div></div>
      <div class="kpi"><div class="kpi-lbl">Terminal</div><div class="kpi-val">${termStr}</div><div class="kpi-sub">${inp.termMode==='multiple'?'exit multiple':'Gordon growth'}</div></div>`;
  } else {
    document.getElementById('rev-kpis').innerHTML=`<div class="kpi" style="grid-column:1/-1;text-align:center;color:var(--ink-3);padding:16px;font-size:12.5px">âš  Could not solve for IRR. Adjust growth, margins, or terminal assumptions.</div>`;
  }
  _revData=[];
  const pMin=inp.price*.35,pMax=inp.price*1.65;
  for(let i=0;i<=50;i++){
    const p=pMin+(pMax-pMin)*i/50;
    const r=impliedIRR(inp,p);
    if(r!==null)_revData.push({price:p,irr:r});
  }
  drawIRRChart(inp.price,irr);
  renderRevTable(inp);
}

function drawIRRChart(curPrice,curIRR){
  const canvas=document.getElementById('chart-irr');
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth,H=200;
  canvas.width=W*dpr;canvas.height=H*dpr;ctx.scale(dpr,dpr);
  if(_revData.length<2)return;
  const PAD={t:10,r:16,b:32,l:48},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;
  const prices=_revData.map(d=>d.price),irrs=_revData.map(d=>d.irr*100);
  const minP=Math.min(...prices),maxP=Math.max(...prices);
  const minI=Math.min(...irrs,-5)*1.05,maxI=Math.max(...irrs,25)*1.05;
  const xp=p=>PAD.l+(p-minP)/(maxP-minP)*cw;
  const yp=v=>PAD.t+ch-(v-minI)/(maxI-minI)*ch;
  ctx.strokeStyle='#ede9e0';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=PAD.t+i*ch/4;ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle='#a8a29e';ctx.font='9px DM Mono';ctx.textAlign='right';
    ctx.fillText(fmt(minI+(maxI-minI)*(1-i/4),0)+'%',PAD.l-4,y+3);
  }
  for(let i=0;i<=4;i++){
    const x=PAD.l+i*cw/4;ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle='#a8a29e';ctx.font='9px DM Mono';ctx.textAlign='center';
    ctx.fillText(fmt(minP+(maxP-minP)*i/4,0),x,PAD.t+ch+14);
  }
  const aH=_revData.filter(d=>d.irr*100>=10);
  if(aH.length){
    const hy=yp(10);ctx.beginPath();ctx.moveTo(xp(aH[0].price),hy);
    aH.forEach(d=>ctx.lineTo(xp(d.price),yp(d.irr*100)));
    ctx.lineTo(xp(aH[aH.length-1].price),hy);ctx.closePath();
    ctx.fillStyle='rgba(20,83,45,0.08)';ctx.fill();
  }
  ctx.setLineDash([4,4]);ctx.strokeStyle='#a8a29e';ctx.lineWidth=1;
  const hly=yp(10);ctx.beginPath();ctx.moveTo(PAD.l,hly);ctx.lineTo(PAD.l+cw,hly);ctx.stroke();
  ctx.setLineDash([]);ctx.fillStyle='#a8a29e';ctx.font='9px DM Sans';ctx.textAlign='left';ctx.fillText('10% hurdle',PAD.l+4,hly-5);
  ctx.strokeStyle='#1e3a5f';ctx.lineWidth=2;ctx.lineJoin='round';ctx.beginPath();
  _revData.forEach((d,i)=>{if(i===0)ctx.moveTo(xp(d.price),yp(d.irr*100));else ctx.lineTo(xp(d.price),yp(d.irr*100))});
  ctx.stroke();
  if(curIRR!==null){
    const cx=xp(curPrice),cy=yp(curIRR*100);
    ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fillStyle='#1e3a5f';ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
    ctx.fillStyle='#1e3a5f';ctx.font='bold 10px DM Mono';ctx.textAlign='center';
    ctx.fillText(fmt(curIRR*100,1)+'%',cx,cy-9);
  }
  ctx.fillStyle='#78716c';ctx.font='10px DM Sans';ctx.textAlign='center';
  ctx.fillText('Stock Price',PAD.l+cw/2,H-4);
}

function renderRevTable(inp){
  const t=document.getElementById('rev-tbl');
  const half=5;const prices=[];
  for(let i=-half;i<=half;i++){const p=inp.price*(1+.1*i);if(p>0)prices.push(p)}
  let h=`<thead><tr><th>Price</th><th>vs Current</th><th>Implied IRR</th></tr></thead><tbody>`;
  prices.forEach(p=>{
    const r=impliedIRR(inp,p);
    const vs=p/inp.price-1;
    const isCur=Math.abs(p-inp.price)<.01;
    const{bg,fg}=r!==null?irrColor(r):{bg:'#f5f2ec',fg:'#a8a29e'};
    h+=`<tr ${isCur?'style="font-weight:700"':''}><td>${fmt(p,2)}</td><td>${fmtPct(vs)}</td><td style="background:${bg};color:${fg};text-align:center">${r!==null?fmt(r*100,2)+'%':'â€”'}</td></tr>`;
  });
  t.innerHTML=h+'</tbody>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3 â€” MATRIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMatrix(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=inp!==null;
  document.getElementById('matrix-empty').style.display=show?'none':'';
  document.getElementById('matrix-content').style.display=show?'':'none';
  if(!show)return;
  const isM=inp.termMode==='multiple';
  const gMin=parseFloat(document.getElementById('mc-gmin').value)||0;
  const gMax=parseFloat(document.getElementById('mc-gmax').value)||20;
  const gRows=Math.max(2,Math.min(12,parseInt(document.getElementById('mc-grows').value)||6));
  const tMin=parseFloat(document.getElementById('mc-tmin').value)||(isM?8:0);
  const tMax=parseFloat(document.getElementById('mc-tmax').value)||(isM?16:4);
  const tCols=Math.max(2,Math.min(10,parseInt(document.getElementById('mc-tcols').value)||5));
  const growths=linspace(gMin/100,gMax/100,gRows);
  const terminals=linspace(isM?tMin:tMin/100,isM?tMax:tMax/100,tCols);
  const scenarios=[
    {label:'Bear â€” margin âˆ’1pp/yr',cls:'sc-bear',icon:'â–¼',dpp:-.01},
    {label:'Base',cls:'sc-base',icon:'â—',dpp:0},
    {label:'Bull â€” margin +1pp/yr',cls:'sc-bull',icon:'â–²',dpp:+.01},
  ];
  let html='';
  scenarios.forEach(sc=>{
    html+=`<div class="sc-tag ${sc.cls}">${sc.icon} ${sc.label}</div>`;
    html+=`<div style="overflow-x:auto;margin-bottom:7px"><table class="hm-tbl">`;
    html+=`<thead><tr><th class="rh">Growth â†“ Terminal â†’</th>`;
    terminals.forEach(tv=>html+=`<th>${isM?fmt(tv,1)+'Ã—':fmt(tv*100,1)+'%'}</th>`);
    html+=`</tr></thead><tbody>`;
    growths.forEach(g=>{
      html+=`<tr><th class="rh" style="background:var(--cream-b);text-align:left;padding:5px 7px">${fmt(g*100,1)}%</th>`;
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
        let lastFCF=ci.revLTM*Math.pow(1+ci.cagr,ci.years)*(ci.fcfMargin+ci.dpp*ci.years);
        if(!isFinite(lastFCF)||lastFCF<=0){html+=`<td><div class="hm-cell" style="background:#f5f2ec;color:#a8a29e">â€”</div></td>`;return}
        const irr=impliedIRR(ci,ci.price);
        if(irr===null){html+=`<td><div class="hm-cell" style="background:#f5f2ec;color:#a8a29e">â€”</div></td>`;return}
        const{bg,fg}=irrColor(irr);
        html+=`<td><div class="hm-cell" style="background:${bg};color:${fg}">${fmt(irr*100,1)}%</div></td>`;
      });
      html+=`</tr>`;
    });
    html+=`</tbody></table></div>`;
    html+=`<button class="btn-dl" onclick="downloadMatrix(${JSON.stringify(sc.label)})">â¬‡ Download ${sc.label} CSV</button><div style="height:6px"></div>`;
  });
  document.getElementById('matrix-tables').innerHTML=html;
  window._matrixState={inp,growths,terminals,scenarios,isM};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV DOWNLOADS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dlCSV(filename,rows){
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download=filename;a.click();
}
function downloadForecast(){
  const rows=[['Year','Revenue (M)','FCF Margin','FCF (M)','Disc. Factor','Disc. FCF (M)']];
  _forecastRows.forEach(r=>rows.push([r.year,fmt(r.rev,0),fmtPctPlain(r.marg,2),fmt(r.fcf,0),fmt(r.df,4),fmt(r.discFcf,0)]));
  dlCSV('forecast.csv',rows);
}
function downloadRevDCF(){
  const inp=buildInp(getInputs());if(!inp)return;
  const rows=[['Price','vs Current','Implied IRR']];
  for(let i=-5;i<=5;i++){const p=inp.price*(1+.1*i);if(p>0){const r=impliedIRR(inp,p);rows.push([fmt(p,2),fmtPct(p/inp.price-1),r!==null?fmt(r*100,2)+'%':'â€”'])}}
  dlCSV('reverse_dcf.csv',rows);
}
function downloadMatrix(scLabel){
  if(!window._matrixState)return;
  const{inp,growths,terminals,scenarios,isM}=window._matrixState;
  const sc=scenarios.find(s=>s.label===scLabel);if(!sc)return;
  const hdr=['Growth \\ Terminal'].concat(terminals.map(tv=>isM?fmt(tv,1)+'Ã—':fmt(tv*100,1)+'%'));
  const rows=[hdr];
  growths.forEach(g=>{
    const row=[fmt(g*100,1)+'%'];
    terminals.forEach(tv=>{
      const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
      if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
      const irr=impliedIRR(ci,ci.price);
      row.push(irr!==null?fmt(irr*100,2)+'%':'â€”');
    });
    rows.push(row);
  });
  dlCSV(`irr_matrix_${sc.label.split(' ')[0].toLowerCase()}.csv`,rows);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESIZE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _rt;
window.addEventListener('resize',()=>{
  clearTimeout(_rt);_rt=setTimeout(()=>{
    const inp=buildInp(getInputs());if(!inp)return;
    if(activeTab==='dcf')drawSensChart(inp.price,inp.disc*100);
    else if(activeTab==='rev'){const irr=impliedIRR(inp,inp.price);drawIRRChart(inp.price,irr)}
  },100);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Check for URL params first, otherwise load default
loadFromURL();
if(!window.location.search){loadPreset('NFLX')}
</script>
</body>
</html>
