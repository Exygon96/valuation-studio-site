<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Valuation Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* ═══════════════════════════════════════
   TOKENS — Silver Gelatin / Old New York
   Unified palette · WCAG AA contrast
═══════════════════════════════════════ */
:root {
  /* Surfaces — warm parchment progression */
  --bg:        #F3EFE7;
  --surface:   #FAF8F3;
  --surface-2: #ECE8DF;
  --surface-3: #E2DDD3;
  --border:    rgba(28,26,22,.11);
  --border-2:  rgba(28,26,22,.06);

  /* Ink — warm charcoal hierarchy (all AA+ on --bg) */
  --ink:       #1C1A16;
  --ink-2:     #302D28;
  --ink-3:     #4D4943;
  --ink-4:     #7A756D;
  --ink-5:     #928D85;

  /* Accent — archival ink blue */
  --blue:      #2B5D8E;
  --blue-b:    #1E4A74;
  --blue-bg:   #E6EEF5;
  --blue-pill:  #1E4A74;  /* always dark enough for white text overlay */

  /* Semantic — vintage-toned, not garish */
  --green:     #2E7048;
  --green-bg:  #E6F2EA;
  --green-dk:  #1F5733;
  --red:       #A8382E;
  --red-bg:    #F8EDEB;
  --red-dk:    #853025;

  /* Accent — aged brass */
  --gold:      #9E7528;
  --gold-bg:   #F5EDDA;
  --gold-pill:  #6E5018;  /* dark enough for white text overlay */

  /* Typography */
  --ff: 'DM Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  --ff-head: 'DM Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  --ff-mono: 'JetBrains Mono', 'SF Mono', ui-monospace, monospace;

  /* Spatial */
  --r: 10px;
  --r-sm: 7px;
  --sidebar-w: 288px;
  --header-h: 52px;

  /* Elevation */
  --shadow: 0 1px 3px rgba(28,26,22,.06), 0 1px 2px rgba(28,26,22,.04);
  --shadow-md: 0 4px 14px rgba(28,26,22,.08), 0 2px 4px rgba(28,26,22,.04);
  --shadow-lg: 0 10px 40px rgba(28,26,22,.12);
}

[data-theme="dark"] {
  /* Surfaces — deep warm charcoal */
  --bg:        #121110;
  --surface:   #1C1A17;
  --surface-2: #262421;
  --surface-3: #32302C;
  --border:    rgba(240,236,228,.12);
  --border-2:  rgba(240,236,228,.06);

  /* Ink — cream hierarchy (all AA+ on --bg) */
  --ink:       #F0ECE4;
  --ink-2:     #DDD8CF;
  --ink-3:     #B5B0A7;
  --ink-4:     #8A857D;
  --ink-5:     #6E6A63;

  /* Accent — lighter archival blue for dark bg */
  --blue:      #6AAAD4;
  --blue-b:    #84BDE2;
  --blue-bg:   #141E28;
  --blue-pill:  #1E4A74;  /* same dark navy, high contrast with white */

  /* Semantic — warm-toned for dark mode */
  --green:     #5EAE78;
  --green-bg:  #0E1C14;
  --green-dk:  #5EAE78;
  --red:       #D47265;
  --red-bg:    #1E1210;
  --red-dk:    #D47265;

  /* Accent — brighter brass for readability */
  --gold:      #C8952A;
  --gold-bg:   #1A1508;
  --gold-pill:  #6E5018;  /* same dark gold for pill overlays */
}

/* ═══════════════════════════════════════
   RESET
═══════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--ff);background:var(--bg);color:var(--ink);
  font-size:14px;line-height:1.55;letter-spacing:-.005em;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  transition:background .25s ease,color .25s ease;
}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}
a{color:inherit;text-decoration:none}

/* ═══════════════════════════════════════
   SHELL
═══════════════════════════════════════ */
#shell{display:flex;flex-direction:column;height:100vh}

/* ═══════════════════════════════════════
   HEADER
═══════════════════════════════════════ */
#header{
  height:var(--header-h);flex-shrink:0;z-index:50;
  background:rgba(243,239,231,.92);backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:8px;
}
[data-theme="dark"] #header{background:rgba(18,17,16,.92)}

.h-logo{display:flex;align-items:center;gap:9px}
.h-mark{
  width:28px;height:28px;border-radius:7px;
  background:var(--ink);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 1px 4px rgba(28,26,22,.2);
}
.h-mark svg{width:14px;height:14px}
.h-name{font-family:var(--ff-head);font-size:17px;font-weight:600;color:var(--ink);letter-spacing:-.2px}
.h-sep{flex:1}
.h-btn{
  height:28px;padding:0 12px;border-radius:6px;font-size:12px;font-weight:500;
  color:var(--ink-3);
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  display:inline-flex;align-items:center;gap:5px;transition:all .12s;
  box-shadow:0 1px 3px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.6);
  white-space:nowrap;
}
.h-btn:hover{color:var(--ink);background:var(--surface-2)}
[data-theme="dark"] .h-btn{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 1px 3px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.h-btn-group{display:flex;align-items:center;gap:0;border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:var(--shadow)}
.h-btn-group .h-btn{border:none;border-radius:0;box-shadow:none;border-right:1px solid var(--border)}
.h-btn-group .h-btn:last-child{border-right:none}
.h-btn-save{color:var(--ink-3)}
.h-btn-save:hover{color:var(--gold)!important}
.h-btn-icon{} /* always visible */
.h-note{font-size:11px;color:var(--ink-5);white-space:nowrap;font-family:var(--ff-mono);letter-spacing:.2px}
#dark-btn{width:28px;height:28px;padding:0;border-radius:6px;font-size:13px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow);color:var(--ink-4)}
#dark-btn:hover{color:var(--ink)}
#menu-btn{display:none;height:28px;padding:0 10px;border-radius:6px;font-size:12px;font-weight:500;color:var(--ink-4);background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow);align-items:center;gap:5px}
#menu-btn:hover{color:var(--ink)}

/* ═══════════════════════════════════════
   BODY
═══════════════════════════════════════ */
#body{display:flex;flex:1;overflow:hidden}

/* ═══════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════ */
#sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  overflow-y:auto;padding:14px 14px 80px;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  transition:transform .25s ease,background .2s;
}
#sidebar::-webkit-scrollbar{width:0}

/* Section label */
.sb-lbl{
  font-size:10px;font-weight:600;letter-spacing:.7px;text-transform:uppercase;
  color:var(--ink-4);padding:12px 0 6px;
  margin-bottom:0;font-family:var(--ff-mono);
  display:flex;align-items:center;gap:6px;
}
.sb-lbl:first-child{padding-top:2px}
.sb-lbl .sb-lbl-icon{font-size:13px;opacity:.7;line-height:1}

/* ── Ticker search ── */
/* ── Ticker search ── */
.ticker-search-wrap{position:relative;margin-bottom:12px}
.ticker-search-input{
  width:100%;padding:10px 34px 10px 34px;border-radius:var(--r);
  border:1.5px solid var(--border);background:var(--surface);
  color:var(--ink);font-size:13.5px;font-family:var(--ff);
  outline:none;transition:border-color .15s,box-shadow .15s,background .15s;
  -webkit-appearance:none;box-shadow:var(--shadow);
}
.ticker-search-input:focus{
  border-color:var(--blue);box-shadow:0 0 0 3px rgba(43,93,142,.10);
  background:var(--surface);
}
.ticker-search-input::placeholder{color:var(--ink-5)}
.ticker-search-icon{
  position:absolute;left:11px;top:50%;transform:translateY(-50%);
  color:var(--ink-4);pointer-events:none;font-size:13px;line-height:1;
}
.ticker-search-clear{
  position:absolute;right:9px;top:50%;transform:translateY(-50%);
  color:var(--ink-5);cursor:pointer;font-size:14px;line-height:1;
  display:none;background:none;border:none;padding:3px;
  transition:color .1s;border-radius:3px;
}
.ticker-search-clear:hover{color:var(--ink);background:var(--surface-2)}
/* Dropdown */
.ticker-dropdown{
  position:absolute;top:calc(100% + 5px);left:0;right:0;z-index:200;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);box-shadow:var(--shadow-lg);
  overflow:hidden;display:none;
}
.ticker-dropdown.open{display:block}
.td-header{
  padding:7px 12px 5px;font-size:10px;font-weight:600;letter-spacing:.6px;
  text-transform:uppercase;color:var(--ink-3);background:var(--surface-2);
  border-bottom:1px solid var(--border-2);font-family:var(--ff-mono);
}
.td-item{
  display:grid;grid-template-columns:50px 1fr auto;align-items:center;
  gap:6px;padding:9px 12px;cursor:pointer;
  transition:background .08s;border-bottom:1px solid var(--border-2);
}
.td-item:last-child{border-bottom:none}
.td-item:hover,.td-item.focused{background:var(--blue-bg)}
.td-item:hover .td-ticker,.td-item.focused .td-ticker{color:var(--blue)}
.td-ticker{
  font-family:var(--ff-mono);font-size:12.5px;font-weight:700;
  color:var(--ink);letter-spacing:.2px;
}
.td-info{display:flex;flex-direction:column;min-width:0}
.td-name{font-size:12px;color:var(--ink-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
.td-sub{font-size:10.5px;color:var(--ink-4);margin-top:1px;font-family:var(--ff-mono)}
.td-badge{
  font-size:10px;font-weight:600;font-family:var(--ff-mono);
  background:var(--surface-2);color:var(--ink-4);
  padding:2px 6px;border-radius:4px;white-space:nowrap;flex-shrink:0;
  border:1px solid var(--border-2);
}
.td-loading{padding:14px 12px;text-align:center;font-size:12px;color:var(--ink-4)}
.td-empty{
  padding:14px 12px;text-align:center;font-size:12px;color:var(--ink-4);
  font-style:italic;
}
/* Live data badges */
.live-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-family:var(--ff-mono);font-size:9.5px;font-weight:600;
  color:var(--green-dk);background:var(--green-bg);
  border-radius:10px;padding:1px 7px;margin-left:4px;vertical-align:middle;
}
[data-theme="dark"] .live-badge{color:var(--green)}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green-dk);animation:pulse-hint 2s ease-in-out infinite;flex-shrink:0}
[data-theme="dark"] .live-dot{background:var(--green)}
/* Price fetch states */
.price-loading-row{
  display:none;align-items:center;gap:7px;
  font-size:11px;color:var(--ink-4);margin-top:4px;
}
.price-loading-row.show{display:flex}
.price-spinner{
  width:12px;height:12px;border-radius:50%;flex-shrink:0;
  border:1.5px solid var(--border);border-top-color:var(--blue);
  animation:spin .7s linear infinite;
}
.price-status{font-size:10.5px;color:var(--ink-4);font-family:var(--ff-mono)}
/* Sidebar loading spinner overlay */
.sb-loading{
  display:none;position:absolute;inset:0;z-index:100;
  background:rgba(250,248,243,.65);backdrop-filter:blur(4px);
  -webkit-backdrop-filter:blur(4px);
  align-items:center;justify-content:center;border-radius:var(--r);
}
[data-theme="dark"] .sb-loading{background:rgba(28,26,23,.65)}
.sb-loading.show{display:flex}
.sb-spinner{
  width:22px;height:22px;border-radius:50%;
  border:2.5px solid var(--border);border-top-color:var(--blue);
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Data dates strip ── */
.data-dates{
  background:var(--surface-2);border:1px solid var(--border-2);
  border-radius:var(--r-sm);padding:6px 10px;margin-bottom:10px;
}
.dd-row{display:flex;justify-content:space-between;align-items:baseline;
  font-size:12px;padding:2px 0;}
.dd-row:first-child{border-bottom:1px solid var(--border-2);padding-bottom:4px;margin-bottom:2px}
.dd-lbl{color:var(--ink-3);font-weight:500}
.dd-val{font-family:var(--ff-mono);font-size:11px;color:var(--ink-2);font-weight:500}

/* ── Info button ── */
.info-btn{
  display:inline-flex;align-items:center;justify-content:center;
  width:16px;height:16px;border-radius:50%;
  color:var(--ink-4);background:var(--surface-2);border:1px solid var(--border);
  cursor:pointer;transition:all .12s;padding:0;vertical-align:middle;margin-left:4px;
  flex-shrink:0;
}
.info-btn svg{width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.info-btn:hover{color:var(--blue);border-color:var(--blue);background:var(--blue-bg)}

/* ── Info modal overlay ── */
.info-modal-overlay{
  display:none;position:fixed;inset:0;z-index:500;
  background:rgba(28,26,22,.35);backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  align-items:center;justify-content:center;padding:20px;
}
.info-modal-overlay.show{display:flex}
.info-modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;box-shadow:var(--shadow-lg);
  max-width:420px;width:100%;max-height:85vh;overflow-y:auto;
  animation:slideUp .18s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.im-header{
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:18px 20px 12px;border-bottom:1px solid var(--border-2);
}
.im-title{font-size:15px;font-weight:700;color:var(--ink);letter-spacing:-.3px}
.im-subtitle{font-size:11px;color:var(--ink-4);margin-top:2px}
.im-close{
  width:26px;height:26px;border-radius:50%;background:var(--surface-2);
  border:1px solid var(--border);font-size:13px;color:var(--ink-4);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;transition:all .1s;margin-top:-2px;
}
.im-close:hover{background:var(--red-bg);color:var(--red-dk);border-color:rgba(168,56,46,.2)}
.im-body{padding:16px 20px 20px;font-size:13px;color:var(--ink-3);line-height:1.7}
.im-section{margin-bottom:14px}
.im-section:last-child{margin-bottom:0}
.im-section-title{font-size:11px;font-weight:700;text-transform:uppercase;
  letter-spacing:.5px;color:var(--ink-4);margin-bottom:5px}
.im-formula{
  background:var(--surface-2);border:1px solid var(--border-2);
  border-radius:6px;padding:8px 12px;font-family:var(--ff-mono);
  font-size:11.5px;color:var(--blue);line-height:1.8;margin:8px 0;
}
.im-warn{
  background:var(--red-bg);border:1px solid rgba(168,56,46,.15);
  border-radius:6px;padding:8px 12px;font-size:12px;color:var(--red-dk);
  margin-top:8px;line-height:1.6;
}
[data-theme="dark"] .im-warn{color:var(--red)}
.im-note{
  background:var(--blue-bg);border-left:3px solid var(--blue);
  border-radius:4px;padding:8px 12px;font-size:12px;color:var(--ink-3);
  line-height:1.6;margin-top:8px;
}
[data-theme="dark"] .im-note{background:var(--blue-bg)}
.im-tag{
  display:inline-flex;align-items:center;gap:4px;
  font-size:10px;font-weight:600;font-family:var(--ff-mono);
  padding:2px 7px;border-radius:4px;margin-right:4px;margin-bottom:4px;
}
.im-tag-green{background:var(--green-bg);color:var(--green-dk)}
.im-tag-red{background:var(--red-bg);color:var(--red-dk)}
.im-tag-blue{background:var(--blue-bg);color:var(--blue)}
[data-theme="dark"] .im-tag-green{color:var(--green)}
[data-theme="dark"] .im-tag-red{color:var(--red)}

/* Toggle switch */
.toggle-switch{position:relative;flex-shrink:0;margin-left:8px}
.toggle-switch input{position:absolute;opacity:0;width:0;height:0}
.toggle-track{
  display:flex;align-items:center;
  width:34px;height:18px;border-radius:9px;
  background:var(--ink-5);transition:background .2s;cursor:pointer;
  position:relative;
}
.toggle-switch input:checked ~ .toggle-track{background:var(--blue)}
.toggle-thumb{
  position:absolute;left:2px;width:14px;height:14px;border-radius:50%;
  background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.2);
  transition:left .2s cubic-bezier(.4,0,.2,1);
}
.toggle-switch input:checked ~ .toggle-track .toggle-thumb{left:18px}
.co-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:12px}
.co-pill{
  padding:9px 4px;border-radius:var(--r-sm);
  border:1px solid var(--border);background:var(--surface-2);
  cursor:pointer;transition:all .12s;text-align:center;
  display:flex;align-items:center;justify-content:center;
}
.co-pill .pt{font-size:12px;font-weight:600;font-family:var(--ff-mono);color:var(--ink-2);letter-spacing:.3px}
.co-pill:hover{border-color:var(--blue);background:var(--blue-bg)}
.co-pill:hover .pt{color:var(--blue)}
.co-pill.active{background:var(--ink);border-color:var(--ink)}
.co-pill.active .pt{color:var(--bg)}

/* ── Sidebar section cards ── */
.sb-card{
  background:var(--surface-2);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:12px;
  margin-bottom:8px;
  transition:border-color .15s;
}
.sb-card:hover{border-color:var(--border)}
[data-theme="dark"] .sb-card{
  background:rgba(255,255,255,.02);
  border-color:rgba(240,236,228,.07);
}

/* Form fields */
.field{margin-bottom:10px}
.field:last-child{margin-bottom:0}
.field>label{
  display:flex;justify-content:space-between;align-items:center;
  font-size:11.5px;font-weight:500;color:var(--ink-3);margin-bottom:4px;line-height:1.4;
}
.field>label .note{font-size:10.5px;color:var(--ink-4);font-weight:400}
.field>label .field-hint{
  font-size:10.5px;color:var(--ink-4);font-weight:400;font-style:italic;
  display:block;margin-top:1px;
}
.field input[type=text],.field input[type=number],.field select{
  width:100%;padding:8px 10px;border-radius:var(--r-sm);
  border:1px solid var(--border);background:var(--surface);
  color:var(--ink);font-size:13px;font-family:var(--ff-mono);
  outline:none;transition:border-color .1s,box-shadow .1s;
}
.field input:focus,.field select:focus{
  border-color:var(--blue);box-shadow:0 0 0 3px rgba(43,93,142,.10);
  background:var(--surface);
}

/* Sliders */
.sl-row{margin-bottom:10px}
.sl-row:last-child{margin-bottom:0}
.sl-top{display:flex;justify-content:space-between;align-items:center;font-size:11.5px;font-weight:500;color:var(--ink-3);margin-bottom:5px}
.sl-top span{font-family:var(--ff-mono);font-size:12px;font-weight:600;color:var(--ink)}
input[type=range]{
  width:100%;height:3px;-webkit-appearance:none;appearance:none;
  background:var(--ink-5);border-radius:2px;outline:none;cursor:pointer;
  transition:background .1s;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:15px;height:15px;border-radius:50%;
  background:var(--surface);border:2px solid var(--ink-3);
  box-shadow:0 1px 4px rgba(28,26,22,.15);transition:transform .1s;
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.15)}

/* Benchmark reference anchors under growth slider */
.bench-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-top:8px}
.bench-pill{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:7px 4px 6px;border-radius:8px;cursor:pointer;
  background:var(--surface);border:1px solid var(--border-2);
  transition:all .14s ease;user-select:none;
}
.bench-pill:hover{background:var(--blue-bg);border-color:rgba(43,93,142,.2)}
.bench-pill.active{background:var(--blue-bg);border-color:rgba(43,93,142,.25)}
.bp-rate{font-family:var(--ff-mono);font-size:12px;font-weight:700;color:var(--ink-2)}
.bp-lbl{font-size:10px;color:var(--ink-4);font-weight:500;text-align:center;line-height:1.3}
.bench-pill:hover .bp-rate,.bench-pill.active .bp-rate{color:var(--blue)}
.bench-pill:hover .bp-lbl,.bench-pill.active .bp-lbl{color:var(--ink-3)}

/* Growth assumptions card */
.growth-card{
  background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r);padding:12px 12px 14px;margin-bottom:8px;
}

/* Segmented control */
.seg{
  display:flex;background:var(--surface-2);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:2px;gap:2px;margin-bottom:8px;
}
.seg-btn{
  flex:1;padding:5px 0;text-align:center;font-size:11.5px;font-weight:500;
  color:var(--ink-3);border-radius:6px;border:none;background:none;
  cursor:pointer;transition:all .12s;
}
.seg-btn.active{background:var(--surface);color:var(--ink);box-shadow:var(--shadow);font-weight:600}

/* FCF margin chip */
.margin-chip{
  display:flex;justify-content:space-between;align-items:center;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:6px 10px;margin-bottom:8px;
}
.mc-lbl{font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.6px;font-family:var(--ff-mono)}
.mc-val{font-family:var(--ff-mono);font-size:14px;font-weight:600;color:var(--ink-2)}

/* Warn / err */
.warn{font-size:11px;color:#7A5A20;background:var(--gold-bg);border:1px solid rgba(158,117,40,.2);border-radius:6px;padding:5px 8px;margin-bottom:6px;display:none;line-height:1.5}
.err{font-size:11px;color:var(--red-dk);background:var(--red-bg);border:1px solid rgba(168,56,46,.2);border-radius:6px;padding:5px 8px;margin-bottom:6px;display:none;line-height:1.5}
[data-theme="dark"] .warn{background:var(--gold-bg);border-color:rgba(200,149,42,.2);color:#D4B060}

/* Sidebar summary */
.sb-sum{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:10px 12px;margin-top:10px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .sb-sum{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.ss-row{display:flex;justify-content:space-between;font-size:11.5px;padding:3.5px 0;border-bottom:1px solid var(--border-2)}
.ss-row:last-child{border-bottom:none}
.ss-lbl{color:var(--ink-3)}.ss-val{font-family:var(--ff-mono);font-weight:500;color:var(--ink);font-size:11px}

/* Reset btn */
.sb-reset{
  width:100%;margin-top:8px;padding:8px;border-radius:var(--r-sm);
  font-size:12px;font-weight:500;color:var(--ink-4);
  background:var(--surface-2);border:1px solid var(--border);
  transition:all .1s;
}
.sb-reset:hover{color:var(--red-dk);border-color:rgba(168,56,46,.25)}

/* Currency row */
.ccy-row{display:flex;gap:6px}
.ccy-row .field{flex:1;margin-bottom:0}
.fx-box{background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-sm);padding:7px 10px;margin-bottom:8px}
.fx-box label{display:block;font-size:10.5px;font-weight:500;color:var(--ink-4);margin-bottom:3px}
.fx-box input{background:none;border:none;outline:none;width:100%;font-family:var(--ff-mono);font-size:13px;color:var(--ink)}

/* Option toggle rows */
.sb-option-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0;border-bottom:1px solid var(--border-2);
}
.sb-option-row:last-child{border-bottom:none}
.sb-option-lbl{
  font-size:11.5px;font-weight:500;color:var(--ink-3);
  display:flex;align-items:center;gap:4px;flex:1;min-width:0;
}
.sb-option-lbl .sb-opt-desc{
  display:block;font-size:10.5px;color:var(--ink-4);font-weight:400;margin-top:2px;
  line-height:1.4;
}

/* Section divider */
.sb-divider{
  height:1px;background:var(--border-2);margin:4px 0 2px;
}

/* ═══════════════════════════════════════
   MAIN
═══════════════════════════════════════ */
#main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0}
#main::-webkit-scrollbar{width:0}

/* Tab bar */
#tabbar{
  flex-shrink:0;display:flex;align-items:center;
  background:rgba(243,239,231,.92);backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:10;padding:0 20px;
}
[data-theme="dark"] #tabbar{background:rgba(18,17,16,.92)}
.tab-btn{
  padding:14px 0;margin-right:22px;font-size:13px;font-weight:500;
  color:var(--ink-4);border-bottom:2px solid transparent;margin-bottom:-1px;
  transition:color .1s,border-color .1s;background:none;white-space:nowrap;
  letter-spacing:.1px;
}
.tab-btn.active{color:var(--ink);border-bottom-color:var(--ink-3)}
.tab-btn:hover:not(.active){color:var(--ink-3)}
.tab-sep{flex:1}

/* Panels */
.tab-panel{display:none;padding:20px;animation:fadeIn .15s ease}
.tab-panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}

/* Empty state */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;text-align:center;gap:10px}
.empty svg{opacity:.1;width:40px;height:40px}
.empty-title{font-family:var(--ff-head);font-size:22px;font-weight:600;color:var(--ink-3)}
.empty-body{font-size:13px;color:var(--ink-4);max-width:280px;line-height:1.6}

/* ═══════════════════════════════════════
   RESULT CARD
═══════════════════════════════════════ */
.result-hero{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:22px 22px 18px;
  margin-bottom:12px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
  display:grid;grid-template-columns:1fr 1fr;gap:0;
}
[data-theme="dark"] .result-hero{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.rh-left{padding-right:20px;border-right:1px solid var(--border-2)}
.rh-right{padding-left:20px}
.rh-label{font-size:11px;font-weight:600;color:var(--ink-3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-family:var(--ff-mono)}
.rh-value{font-family:var(--ff-head);font-size:44px;font-weight:700;letter-spacing:-2px;line-height:1}
.rh-value.good{color:var(--green-dk)}
.rh-value.bad{color:var(--red-dk)}
.rh-value.neutral{color:var(--blue)}
[data-theme="dark"] .rh-value.good{color:var(--green)}
[data-theme="dark"] .rh-value.bad{color:var(--red)}
.rh-sub{font-size:12px;color:var(--ink-4);margin-top:5px}
.rh-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;
  margin-top:9px;font-family:var(--ff-mono);
}
.rh-badge.good{background:var(--green-bg);color:var(--green-dk)}
.rh-badge.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .rh-badge.good{color:var(--green)}
[data-theme="dark"] .rh-badge.bad{color:var(--red)}

/* Two stat row below hero */
.stat-row{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;
}
.stat-card{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:14px 16px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .stat-card{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.sc-lbl{font-size:11px;font-weight:600;color:var(--ink-3);margin-bottom:5px;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.5px}
.sc-val{font-family:var(--ff-head);font-size:28px;font-weight:700;letter-spacing:-1px;color:var(--ink)}
.sc-sub{font-size:11px;color:var(--ink-4);margin-top:3px}

/* ── Calc warning card ── */
.calc-warn{
  background:var(--surface);border:1px solid rgba(168,56,46,.2);
  border-radius:var(--r);padding:18px 20px;margin-bottom:12px;
  box-shadow:var(--shadow);
}
.cw-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.cw-icon{font-size:20px}
.cw-title{font-size:14px;font-weight:600;color:var(--red-dk)}
[data-theme="dark"] .cw-title{color:var(--red)}
.cw-body{font-size:12.5px;color:var(--ink-3);line-height:1.65;margin-bottom:10px}
.cw-list{display:flex;flex-direction:column;gap:5px;margin-top:6px}
.cw-item{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--ink-3);background:var(--surface-2);border-radius:6px;padding:7px 10px}
.cw-item-icon{font-size:11px;margin-top:1px;flex-shrink:0}

/* ══════════════════════════════════════════
   UNIFIED VALUATION CARD
   One card: FV vs Market · Required return slider
══════════════════════════════════════════ */
.val-card{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);margin-bottom:12px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
  overflow:hidden;
}
[data-theme="dark"] .val-card{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
/* — top numbers section — */
.val-card-top{padding:20px 22px 18px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
.vc-side{display:flex;flex-direction:column}
.vc-side.right{align-items:flex-end;text-align:right}
.vc-lbl{font-size:11px;font-weight:600;color:var(--ink-3);text-transform:uppercase;
  letter-spacing:.5px;font-family:var(--ff-mono);margin-bottom:6px}
.vc-num{font-family:var(--ff-head);font-size:40px;font-weight:700;letter-spacing:-1.5px;line-height:1}
.vc-num.fv-good{color:var(--green-dk)}
.vc-num.fv-bad{color:var(--red-dk)}
.vc-num.mkt{color:var(--ink-2)}
[data-theme="dark"] .vc-num.fv-good{color:var(--green)}
[data-theme="dark"] .vc-num.fv-bad{color:var(--red)}
.vc-ccy{font-size:11px;color:var(--ink-4);font-family:var(--ff-mono);margin-top:4px}
.vc-mid{display:flex;flex-direction:column;align-items:center;padding:0 18px;gap:3px}
.vc-divider-v{width:1px;height:44px;background:var(--border)}
.vc-arrow{font-size:18px;line-height:1;color:var(--ink-4)}
.vc-delta{font-family:var(--ff-mono);font-size:13px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.vc-delta.good{color:var(--green-dk)}
.vc-delta.bad{color:var(--red-dk)}
[data-theme="dark"] .vc-delta.good{color:var(--green)}
[data-theme="dark"] .vc-delta.bad{color:var(--red)}
/* — verdict strip — */
.val-card-verdict{
  display:flex;align-items:center;gap:8px;
  padding:10px 22px;border-top:1px solid rgba(28,26,22,.07);
  background:rgba(28,26,22,.03);
}
[data-theme="dark"] .val-card-verdict{
  border-top-color:rgba(240,236,228,.06);
  background:rgba(240,236,228,.02);
}
.vc-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 11px;
  border-radius:20px;font-size:11.5px;font-weight:600;font-family:var(--ff-mono)}
.vc-pill.good{background:var(--green-bg);color:var(--green-dk)}
.vc-pill.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .vc-pill.good{color:var(--green)}
[data-theme="dark"] .vc-pill.bad{color:var(--red)}
.vc-verdict-note{font-size:12px;color:var(--ink-3);font-weight:400}
.vc-verdict-note.good{color:var(--green-dk);font-weight:500}
.vc-verdict-note.bad{color:var(--red-dk);font-weight:500}
[data-theme="dark"] .vc-verdict-note.good{color:var(--green)}
[data-theme="dark"] .vc-verdict-note.bad{color:var(--red)}
/* — slider section — */
.val-card-slider{padding:14px 22px 16px;border-bottom:1px solid var(--border-2)}
.vcs-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vcs-label{display:flex;align-items:center;gap:7px}
.vcs-title{font-size:13px;font-weight:600;color:var(--ink)}
.vcs-tag{font-size:10px;font-weight:500;color:var(--ink-4);background:var(--surface-2);
  border:1px solid var(--border);border-radius:10px;
  padding:2px 8px;font-family:var(--ff-mono);letter-spacing:.2px}
.vcs-val{font-family:var(--ff-mono);font-size:18px;font-weight:700;color:var(--ink);letter-spacing:-.5px}
.vcs-track{position:relative;height:4px;border-radius:2px;margin-bottom:10px;
  background:linear-gradient(90deg,var(--green) 0%,var(--gold) 40%,var(--red) 75%,#5C1A18 100%)}
.vcs-track input[type=range]{position:absolute;inset:0;width:100%;opacity:0;cursor:pointer;height:20px;top:-8px;margin:0}
.vcs-thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:15px;height:15px;
  border-radius:50%;background:var(--surface);border:2px solid var(--ink-3);
  box-shadow:0 1px 4px rgba(28,26,22,.2);pointer-events:none;transition:left .05s}
.vcs-hints{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.vcs-hint{text-align:center;padding:7px 4px;background:var(--bg);border-radius:6px;
  cursor:pointer;transition:all .1s;border:1px solid var(--border-2)}
.vcs-hint:hover{border-color:var(--blue);background:var(--blue-bg)}
.vcs-hint-rate{font-size:12px;font-weight:700;font-family:var(--ff-mono);color:var(--ink-2)}
.vcs-hint-lbl{font-size:10.5px;color:var(--ink-3);margin-top:2px;font-weight:500}

/* Discount slider area — keep for compat but hide */
.disc-area{display:none}

/* Chart card */
.chart-card{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:16px 18px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .chart-card{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.chart-card-title{font-size:14px;font-weight:600;color:var(--ink);margin-bottom:2px}
.chart-card-sub{font-size:12px;color:var(--ink-3);margin-bottom:12px;line-height:1.5}
.chart-legend{display:flex;gap:14px;margin-top:8px;flex-wrap:wrap}
.leg{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--ink-3)}
.leg-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

/* Collapsible */
.coll{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);overflow:hidden;margin-bottom:10px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .coll{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.coll-hdr{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;font-size:14px;font-weight:500;color:var(--ink);
  cursor:pointer;user-select:none;transition:background .1s;
  border-bottom:1px solid transparent;
}
.coll-hdr:hover{background:var(--surface-2)}
.coll-hdr.open{border-bottom-color:var(--border-2)}
.coll-arrow{font-size:10px;color:var(--ink-5);transition:transform .15s}
.coll-hdr.open .coll-arrow{transform:rotate(180deg)}
.coll-body{display:none;padding:14px 16px;background:var(--surface)}
.coll-body.open{display:block}

/* Table */
.data-tbl{width:100%;border-collapse:collapse;font-size:12px}
.data-tbl th{text-align:left;padding:6px 8px;font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-3);border-bottom:1px solid var(--border);background:var(--surface-2);font-family:var(--ff-mono)}
.data-tbl td{padding:7px 8px;border-bottom:1px solid var(--border-2);font-family:var(--ff-mono);font-size:12px;color:var(--ink)}
.data-tbl tr:last-child td{border-bottom:none}
.data-tbl tr:hover td{background:var(--surface-2)}

/* Bridge */
.bridge{
  border:1px solid rgba(28,26,22,.09);border-radius:var(--r);overflow:hidden;margin:10px 0;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .bridge{
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}

/* Calculation step-by-step */
.calc-step{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--border-2)}
.calc-step:last-child{border-bottom:none}
.calc-step-num{
  flex-shrink:0;width:28px;height:28px;border-radius:50%;
  background:var(--blue-bg);color:var(--blue);
  font-family:var(--ff-mono);font-size:12px;font-weight:700;
  display:flex;align-items:center;justify-content:center;margin-top:1px;
}
.calc-step-body{flex:1;min-width:0}
.calc-step-title{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:5px}
.calc-step-detail{font-size:12.5px;color:var(--ink-3);line-height:1.7}
.br-row{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;font-size:12.5px;border-bottom:1px solid var(--border-2);background:var(--surface)}
.br-row:last-child{border-bottom:none;font-weight:600;background:var(--surface-2);border-top:1px solid var(--border)}
.br-lbl{color:var(--ink-3)}.br-val{font-family:var(--ff-mono);font-size:12px;color:var(--ink)}

/* Download btn */
.btn-dl{
  padding:8px 16px;
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:8px;font-size:12px;font-weight:500;color:var(--ink-3);
  display:inline-flex;align-items:center;gap:6px;transition:all .15s;
  box-shadow:0 1px 4px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
  font-family:var(--ff);
}
.btn-dl:hover{background:var(--blue-bg);border-color:var(--blue);color:var(--blue);box-shadow:0 2px 8px rgba(43,93,142,.10)}
[data-theme="dark"] .btn-dl{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);color:var(--ink-4);
  box-shadow:0 1px 4px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
[data-theme="dark"] .btn-dl:hover{background:var(--blue-bg);border-color:var(--blue);color:var(--blue)}

/* ═══════════════════════════════════════
   IMPLIED RETURN — new clean design
═══════════════════════════════════════ */

/* Hero result card */
.irr-result-card{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:20px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .irr-result-card{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.irc-top{display:flex;align-items:flex-start;gap:0;margin-bottom:16px}
.irc-num-block{flex-shrink:0;padding-right:24px;border-right:1px solid var(--border-2)}
.irc-num-lbl{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-3);font-family:var(--ff-mono);margin-bottom:6px}
.irc-num{font-family:var(--ff-head);font-size:56px;font-weight:700;letter-spacing:-3px;line-height:1}
.irc-num.good{color:var(--green-dk)}
.irc-num.bad{color:var(--red-dk)}
[data-theme="dark"] .irc-num.good{color:var(--green)}
[data-theme="dark"] .irc-num.bad{color:var(--red)}
.irc-verdict{padding-left:20px;flex:1}
.irc-verdict-main{font-family:var(--ff-head);font-size:18px;font-weight:600;color:var(--ink);margin-bottom:8px;line-height:1.3;letter-spacing:-.3px}
.irc-verdict-body{font-size:13px;color:var(--ink-3);line-height:1.7}
.irc-vs-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-family:var(--ff-mono);font-size:11.5px;font-weight:600}
.irc-vs-badge.good{background:var(--green-bg);color:var(--green-dk)}
.irc-vs-badge.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .irc-vs-badge.good{color:var(--green)}
[data-theme="dark"] .irc-vs-badge.bad{color:var(--red)}

/* Input summary row */
.irc-inputs{
  display:grid;grid-template-columns:repeat(4,1fr);gap:0;
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.10);
  border-radius:var(--r);overflow:hidden;margin-top:8px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
.irc-inp-cell{padding:13px 18px;border-right:1px solid rgba(28,26,22,.07)}
.irc-inp-cell:last-child{border-right:none}
.irc-inp-lbl{font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;font-family:var(--ff-mono)}
.irc-inp-val{font-family:var(--ff-mono);font-size:14px;font-weight:700;color:var(--ink);letter-spacing:-.2px}
[data-theme="dark"] .irc-inputs{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
[data-theme="dark"] .irc-inp-cell{border-right-color:rgba(240,236,228,.06)}
[data-theme="dark"] .irc-inp-lbl{color:var(--ink-4)}
[data-theme="dark"] .irc-inp-val{color:var(--ink)}

/* Price adjuster card */
.rev-price-ctrl{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:18px 20px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .rev-price-ctrl{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.rpc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:14px}
.rpc-label{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:3px}
.rpc-sub{font-size:12px;color:var(--ink-3);line-height:1.5;max-width:400px}
.rpc-price-display{text-align:right;flex-shrink:0}
.rpc-price-val{font-family:var(--ff-head);font-size:28px;font-weight:700;color:var(--ink);letter-spacing:-1px;line-height:1}
.rpc-price-ccy{font-size:10.5px;color:var(--ink-4);text-align:right;margin-top:2px;font-family:var(--ff-mono)}
.rpc-slider-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.rpc-bound{font-family:var(--ff-mono);font-size:10px;color:var(--ink-4);white-space:nowrap;min-width:36px}
.rpc-bound:last-child{text-align:right}
.rpc-track-wrap{flex:1;position:relative}
.rpc-track-wrap input[type=range]{
  width:100%;height:3px;-webkit-appearance:none;appearance:none;
  background:linear-gradient(90deg,var(--blue) 50%,var(--border) 50%);
  border-radius:2px;outline:none;cursor:pointer;
}
.rpc-track-wrap input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:var(--surface);border:2px solid var(--blue);
  box-shadow:0 1px 6px rgba(43,93,142,.25);transition:transform .1s;
}
.rpc-track-wrap input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.12)}
/* Result strip */
.rpc-result{
  display:flex;align-items:stretch;
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r-sm);overflow:hidden;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .rpc-result{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.rpc-result-item{padding:10px 14px;flex:1}
.rpc-result-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-3);font-family:var(--ff-mono);margin-bottom:4px}
.rpc-result-val{font-family:var(--ff-head);font-size:18px;font-weight:700;color:var(--ink);letter-spacing:-.3px;line-height:1}
.rpc-result-div{width:1px;background:var(--border);align-self:stretch}
.rpc-reset{padding:8px 14px;background:transparent;border:none;border-left:1px solid var(--border);cursor:pointer;color:var(--ink-4);font-size:11px;font-family:var(--ff);transition:all .1s;white-space:nowrap;align-self:stretch}
.rpc-reset:hover{background:var(--bg);color:var(--ink)}

/* ═══════════════════════════════════════
   REVERSE DCF (old styles — kept for calc-warn)
   irr-hero, irr-big, irr-num, irr-meta kept for error fallback
═══════════════════════════════════════ */
.irr-meta{display:flex;gap:16px;flex-wrap:wrap}
.im-item{font-size:12px;color:var(--ink-4)}
.im-item span{font-family:var(--ff-mono);font-weight:600;color:var(--ink);margin-left:4px}

/* ═══════════════════════════════════════
   MATRIX
═══════════════════════════════════════ */
.sc-strip{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:14px 16px;margin-bottom:10px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .sc-strip{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.sc-strip-title{font-size:10.5px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-family:var(--ff-mono)}
.sc-strip-sub{font-size:12px;color:var(--ink-3);margin-bottom:12px;line-height:1.5}
.sc-cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.sc-col{border-radius:var(--r-sm);padding:12px 14px;border:1px solid transparent}
.sc-col-bear{background:var(--red-bg);border-color:rgba(192,57,43,.15)}
.sc-col-base{background:var(--surface-2);border-color:var(--border)}
.sc-col-bull{background:var(--green-bg);border-color:rgba(26,122,60,.15)}
.sc-col-name{font-size:11px;font-weight:600;color:var(--ink-3);margin-bottom:2px}
.sc-col-desc{font-size:10.5px;color:var(--ink-4);margin-bottom:8px}
.sc-col-irr{font-family:var(--ff-head);font-size:24px;font-weight:700;letter-spacing:-.5px}
.sc-col-bear .sc-col-irr{color:var(--red-dk)}
.sc-col-base .sc-col-irr{color:var(--ink)}
.sc-col-bull .sc-col-irr{color:var(--green-dk)}
[data-theme="dark"] .sc-col-bear .sc-col-irr{color:var(--red)}
[data-theme="dark"] .sc-col-bull .sc-col-irr{color:var(--green)}
.sc-col-meta{font-size:10.5px;color:var(--ink-4);margin-top:4px;font-family:var(--ff-mono)}
.sc-col-badge{display:inline-block;font-size:9.5px;font-weight:600;padding:2px 6px;border-radius:20px;margin-top:4px;font-family:var(--ff-mono)}
.sc-col-badge.good{background:rgba(26,122,60,.15);color:var(--green-dk)}
.sc-col-badge.bad{background:rgba(192,57,43,.12);color:var(--red-dk)}
[data-theme="dark"] .sc-col-badge.good{color:var(--green)}
[data-theme="dark"] .sc-col-badge.bad{color:var(--red)}

/* Scenario guide — collapsible */
.sc-guide{margin:0 0 12px;border:1px solid var(--border-2);border-radius:var(--r-sm);background:var(--surface-2);overflow:hidden}
.sc-guide-toggle{display:block;padding:10px 14px;font-size:12px;font-weight:500;color:var(--blue);cursor:pointer;user-select:none;list-style:none}
.sc-guide-toggle::-webkit-details-marker{display:none}
.sc-guide-toggle::before{content:'▸';display:inline-block;margin-right:6px;transition:transform .15s}
.sc-guide[open] .sc-guide-toggle::before{transform:rotate(90deg)}
.sc-guide-body{padding:0 14px 14px;font-size:12.5px;color:var(--ink-3);line-height:1.7}
.sc-guide-body p{margin-bottom:8px}
.sc-guide-body p:last-child{margin-bottom:0}
.sc-guide-body strong{color:var(--ink-2);font-weight:500}

/* Matrix controls */
.mc-ctrl{margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.mc-card{
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);overflow:hidden;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
.mc-card:last-child{}
[data-theme="dark"] .mc-card{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.mc-card-hdr{padding:10px 16px;border-bottom:1px solid rgba(28,26,22,.07);font-size:10.5px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.5px;font-family:var(--ff-mono)}
[data-theme="dark"] .mc-card-hdr{border-bottom-color:rgba(240,236,228,.06)}
.mc-card-cells{display:grid;grid-template-columns:repeat(3,1fr)}
.mc-card-cell{padding:10px 16px;border-right:1px solid rgba(28,26,22,.07)}
.mc-card-cell:last-child{border-right:none}
[data-theme="dark"] .mc-card-cell{border-right-color:rgba(240,236,228,.06)}
.mc-card-cell label{display:block;font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-family:var(--ff-mono)}
.mc-card-cell input{width:100%;border:1px solid var(--border);border-radius:var(--r-sm);padding:6px 8px;font-size:13px;font-family:var(--ff-mono);font-weight:600;color:var(--ink);background:var(--bg);text-align:center}

/* Heatmap */
.hm-legend{
  display:flex;align-items:center;gap:10px;
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:10px 14px;margin-bottom:10px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .hm-legend{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.hm-bar{flex:1;height:6px;border-radius:3px;background:linear-gradient(90deg,#5C1A18 0%,var(--red) 25%,var(--red-bg) 45%,var(--red-bg) 50%,var(--green-bg) 60%,var(--green) 78%,var(--green-dk) 100%)}
.hm-end{font-size:10.5px;font-family:var(--ff-mono);font-weight:500;white-space:nowrap}
.hm-end.bad{color:var(--red-dk)}.hm-end.good{color:var(--green-dk)}
[data-theme="dark"] .hm-end.bad{color:var(--red)}
[data-theme="dark"] .hm-end.good{color:var(--green)}
.hm-tick-row{display:flex;justify-content:space-between;font-size:9.5px;color:var(--ink-4);margin-top:2px;font-family:var(--ff-mono)}

.sc-tag{
  display:inline-flex;align-items:center;gap:5px;padding:4px 10px;
  border-radius:20px;font-size:11.5px;font-weight:600;margin:10px 0 6px;
}
.sc-tag-bear{background:var(--red-bg);color:var(--red-dk)}
.sc-tag-base{background:var(--surface-2);color:var(--ink-2);border:1px solid var(--border)}
.sc-tag-bull{background:var(--green-bg);color:var(--green-dk)}
[data-theme="dark"] .sc-tag-bear{color:var(--red)}
[data-theme="dark"] .sc-tag-bull{color:var(--green)}

.hm-tbl{border-collapse:collapse;width:100%;margin-bottom:6px}
.hm-tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:6px}
.hm-tbl th{padding:6px 8px;font-size:10.5px;font-weight:600;font-family:var(--ff-mono);color:var(--ink-3);background:var(--surface-2);text-align:center;border:1px solid var(--border)}
.hm-tbl th.rh{text-align:left;min-width:70px}
.hm-tbl td{padding:0;border:1px solid rgba(28,26,22,.04);text-align:center}
[data-theme="dark"] .hm-tbl td{border-color:rgba(240,236,228,.04)}
.hm-cell{padding:8px 6px;font-family:var(--ff-mono);font-size:11.5px;font-weight:700;min-width:54px}

@keyframes pulse-hint{0%,100%{opacity:1}50%{opacity:.3}}

/* ═══════════════════════════════════════
   METHODOLOGY
═══════════════════════════════════════ */
#methodology{display:none;flex:1;overflow-y:auto;padding:36px 40px;max-width:720px}
.mth-tag{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-3);margin-bottom:10px;font-family:var(--ff-mono)}
.mth-h1{font-family:var(--ff-head);font-size:34px;font-weight:700;color:var(--ink);letter-spacing:-.8px;margin-bottom:10px;line-height:1.2}
.mth-intro{font-size:15px;color:var(--ink-3);line-height:1.75;margin-bottom:32px;font-weight:300}
.mth-sec{margin-bottom:30px;padding-bottom:30px;border-bottom:1px solid var(--border)}
.mth-sec:last-child{border-bottom:none}
.mth-h2{font-family:var(--ff-head);font-size:20px;font-weight:600;color:var(--ink);margin-bottom:8px;letter-spacing:-.3px}
.mth-p{font-size:13.5px;color:var(--ink-3);line-height:1.75;margin-bottom:8px}
.mth-formula{background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px 16px;font-family:var(--ff-mono);font-size:12.5px;color:var(--blue);margin:10px 0;line-height:2}
.mth-note{background:var(--gold-bg);border-left:3px solid var(--gold);border-radius:4px;padding:10px 14px;font-size:12.5px;color:var(--ink-3);line-height:1.6;margin-top:10px}
.mth-back{
  height:32px;padding:0 14px;border-radius:6px;font-size:12.5px;font-weight:500;
  background:var(--ink);color:var(--bg);display:inline-flex;align-items:center;gap:6px;
  margin-top:8px;transition:background .1s;
}
.mth-back:hover{background:var(--ink-2)}

/* ═══════════════════════════════════════
   TOAST / MOBILE / OVERLAY
═══════════════════════════════════════ */
#toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);
  background:var(--ink);color:var(--bg);padding:8px 18px;border-radius:20px;
  font-size:13px;font-weight:500;opacity:0;transition:all .2s;
  z-index:999;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md);
  font-family:var(--ff-mono);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

#mobile-bar{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:60;
  background:rgba(243,239,231,.95);backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:10px 16px max(14px, env(safe-area-inset-bottom));
}
[data-theme="dark"] #mobile-bar{background:rgba(18,17,16,.95)}
.mb-row{display:flex;align-items:center;gap:8px}
.mb-lbl{font-size:10px;font-weight:500;color:var(--ink-4);margin-bottom:1px;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.5px}
.mb-val{font-family:var(--ff-head);font-size:17px;font-weight:700;color:var(--ink)}
.mb-div{width:1px;height:28px;background:var(--border);flex-shrink:0}
.mb-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;font-family:var(--ff-mono)}
.mb-badge.good{background:var(--green-bg);color:var(--green-dk)}
.mb-badge.bad{background:var(--red-bg);color:var(--red-dk)}
[data-theme="dark"] .mb-badge.good{color:var(--green)}
[data-theme="dark"] .mb-badge.bad{color:var(--red)}
.mb-action-btn{
  width:32px;height:32px;border-radius:8px;flex-shrink:0;
  background:var(--surface-2);border:1px solid var(--border);
  font-size:14px;display:flex;align-items:center;justify-content:center;
  color:var(--ink-4);transition:all .1s;cursor:pointer;
}
.mb-action-btn:hover{color:var(--ink);background:var(--surface)}
.mb-action-save:hover{color:var(--gold)!important}

#overlay{display:none;position:fixed;inset:0;background:rgba(28,26,22,.35);z-index:40;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}

/* Matrix view toggle */
.mx-view-toggle{
  display:flex;align-items:center;gap:8px;margin-bottom:10px;
  background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);
  border:1px solid rgba(28,26,22,.09);
  border-radius:var(--r);padding:10px 14px;
  box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7);
}
[data-theme="dark"] .mx-view-toggle{
  background:linear-gradient(135deg,#1E1C19 0%,#242220 100%);
  border-color:rgba(240,236,228,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);
}
.mx-toggle-label{font-size:11px;font-weight:500;color:var(--ink-3);flex:1;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.4px}
.mx-seg{display:flex;background:var(--surface-2);border:1px solid var(--border-2);border-radius:7px;padding:2px;gap:2px}
.mx-seg .mx-seg-btn{border:none;border-radius:5px;padding:4px 14px;background:none}
.mx-seg .mx-seg-btn.active{background:var(--surface);color:var(--ink);border-color:transparent;box-shadow:var(--shadow)}
.mx-seg-btn{padding:5px 14px;border-radius:6px;font-size:11.5px;font-weight:500;color:var(--ink-3);background:none;border:1px solid var(--border);cursor:pointer;transition:all .1s}
.mx-seg-btn.active{background:var(--ink);color:var(--bg);border-color:var(--ink);font-weight:600}
.mx-seg-btn:hover:not(.active){background:var(--surface-2);color:var(--ink)}
/* Matrix chart canvas */
.matrix-chart-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:16px 18px;margin-bottom:10px;
  box-shadow:var(--shadow);
}
.mchart-title{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.mchart-sub{font-size:12px;color:var(--ink-3);margin-bottom:12px;line-height:1.5}


@media(max-width:900px){.result-hero{grid-template-columns:1fr;gap:12px}.rh-left{padding-right:0;border-right:none;border-bottom:1px solid var(--border-2);padding-bottom:12px}.rh-right{padding-left:0}}

@media(max-width:700px){
  :root{--sidebar-w:88vw}
  #sidebar{position:fixed;top:var(--header-h);left:0;bottom:0;z-index:45;transform:translateX(-100%);width:var(--sidebar-w);max-width:320px;
    padding-bottom:calc(80px + env(safe-area-inset-bottom, 20px))}
  #sidebar.open{transform:translateX(0)}
  #overlay{display:block;opacity:0;pointer-events:none;transition:opacity .2s}
  #overlay.show{opacity:1;pointer-events:auto}
  #menu-btn{display:inline-flex}
  .h-note{display:none}
  .h-btn#meth-btn{display:none}
  .h-btn-group .h-btn{padding:0 9px}
  .h-btn-group .h-btn .h-btn-text{display:none}
  .h-btn-group .h-btn .h-btn-icon{display:inline}
  .tab-panel{padding:12px}
  #main{width:100%;padding-bottom:calc(80px + env(safe-area-inset-bottom,16px))}
  #mobile-bar{display:block;padding-bottom:calc(12px + env(safe-area-inset-bottom,0px))}
  .irc-top{flex-direction:column;gap:14px}
  .irc-num-block{padding-right:0;border-right:none;padding-bottom:14px;border-bottom:1px solid var(--border-2)}
  .irc-num{font-size:44px}
  .irc-verdict{padding-left:0}
  .irc-inputs{grid-template-columns:1fr 1fr}
  .mc-ctrl{grid-template-columns:1fr}
  .mc-card-cells{grid-template-columns:repeat(3,1fr)}
  .sc-cols{grid-template-columns:1fr}
  .stat-row{grid-template-columns:1fr}
  .rpc-top{flex-direction:column;gap:8px}
  .rpc-price-display{text-align:left}
  .rpc-result{flex-wrap:wrap}
  .rpc-result-item{min-width:80px}
  .chart-card-sub{font-size:11px}
  .disc-hint{grid-template-columns:1fr 1fr}
}

@media(max-width:480px){
  #tabbar{padding:0 10px}
  .tab-btn{margin-right:12px;font-size:12px;padding:12px 0}
  .tab-btn[data-short]::before{content:attr(data-short);font-size:12px}
  .tab-btn[data-short]{font-size:0}
  .tab-btn[data-short]::before{font-size:12px}
  .field input[type=text],.field input[type=number],.field select{font-size:16px}
  .h-name{font-size:14px}
  .h-mark{width:24px;height:24px}
  .irr-result-card{padding:14px}
  .irc-num{font-size:40px}
  .hm-tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
}
</style>
</head>
<body>
<div id="shell">

<header id="header">
  <button id="menu-btn" onclick="toggleMobile()">☰ Inputs</button>
  <div class="h-logo">
    <div class="h-mark">
      <svg viewBox="0 0 20 20" fill="none"><path d="M3 15l4-6 4 4 3-4 3 3" stroke="#F0ECE4" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <span class="h-name">Valuation Studio</span>
  </div>
  <div class="h-sep"></div>
  <button id="dark-btn" onclick="toggleDark()" title="Dark mode">🌙</button>
  <button class="h-btn" onclick="showMethodology()" id="meth-btn">How it works</button>
  <div class="h-btn-group">
    <button class="h-btn" onclick="shareURL()" title="Copy a shareable link with all your current inputs"><span class="h-btn-icon">⬆</span><span class="h-btn-text"> Share</span></button>
    <button class="h-btn h-btn-save" onclick="saveReport()" title="Download a self-contained valuation report — open in browser and print to PDF"><span class="h-btn-icon">⬇</span><span class="h-btn-text"> Save Report</span></button>
  </div>
  <div class="h-note">Not financial advice</div>
</header>

<div id="overlay" onclick="closeMobile()"></div>
<div id="body">

<!-- SIDEBAR -->
<aside id="sidebar">

  <!-- ═══ SECTION 1: Find a company ═══ -->
  <div style="position:relative;margin-bottom:2px">
    <div class="sb-loading" id="sb-loading"><div class="sb-spinner"></div></div>
    <div class="ticker-search-wrap">
      <span class="ticker-search-icon">
        <svg viewBox="0 0 14 14" fill="none" width="13" height="13"><circle cx="6" cy="6" r="4.5" stroke="currentColor" stroke-width="1.4"/><path d="M9.5 9.5L12 12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
      </span>
      <input
        class="ticker-search-input"
        id="ticker-search"
        type="text"
        placeholder="Search or enter a company…"
        autocomplete="off"
        spellcheck="false"
        oninput="onTickerInput(this.value)"
        onkeydown="onTickerKey(event)"
        onfocus="onTickerFocus()"
        onblur="onTickerBlur()"
      />
      <button class="ticker-search-clear" id="ticker-clear" onclick="clearTickerSearch()" tabindex="-1">✕</button>
      <div class="ticker-dropdown" id="ticker-dropdown"></div>
    </div>
    <div class="price-loading-row" id="price-loading-row">
      <div class="price-spinner"></div>
      <span class="price-status" id="price-status-text">Fetching end-of-day price…</span>
    </div>
  </div>

  <div style="font-size:10.5px;color:var(--ink-4);margin-bottom:8px;line-height:1.4">Quick start:</div>
  <div class="co-grid" id="co-grid">
    <button class="co-pill" onclick="loadPreset('AAPL')"><span class="pt">AAPL</span></button>
    <button class="co-pill" onclick="loadPreset('MSFT')"><span class="pt">MSFT</span></button>
    <button class="co-pill" onclick="loadPreset('NVDA')"><span class="pt">NVDA</span></button>
    <button class="co-pill" onclick="loadPreset('META')"><span class="pt">META</span></button>
    <button class="co-pill" onclick="loadPreset('TSLA')"><span class="pt">TSLA</span></button>
    <button class="co-pill" onclick="loadPreset('NFLX')"><span class="pt">NFLX</span></button>
  </div>

  <!-- Per-company data dates (shown after load) -->
  <div class="data-dates" id="data-dates" style="display:none">
    <div class="dd-row"><span class="dd-lbl">Last filing</span><span class="dd-val" id="dd-filing">—</span></div>
    <div class="dd-row"><span class="dd-lbl">Price date</span><span class="dd-val" id="dd-price">—</span></div>
  </div>

  <div class="sb-divider"></div>

  <!-- ═══ SECTION 2: Company numbers ═══ -->
  <div class="sb-lbl"><span class="sb-lbl-icon">📊</span> Company numbers <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:9.5px;color:var(--ink-4)">(all in millions)</span></div>

  <div class="sb-card">
    <div class="field">
      <label>Company name</label>
      <input type="text" id="inp-company" placeholder="e.g. Netflix"/>
    </div>
    <div class="field">
      <label>Stock price <span class="note" id="price-ccy-note">USD</span>
        <button class="info-btn" onclick="showInfo('price')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
      </label>
      <input type="text" id="inp-price" placeholder="Current share price"/>
      <a id="price-check-link" href="#" target="_blank" rel="noopener" style="display:none;font-size:10.5px;color:var(--blue);margin-top:3px;text-decoration:none" title="Check current price on Google">↗ Check current price</a>
    </div>
    <div class="field">
      <label>Total shares
        <button class="info-btn" onclick="showInfo('shares')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
      </label>
      <input type="text" id="inp-shares" placeholder="Shares outstanding (M)"/>
    </div>
    <div class="field">
      <label>Total revenue
        <button class="info-btn" onclick="showInfo('revenue')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
      </label>
      <input type="text" id="inp-revenue" placeholder="Annual revenue (M)"/>
    </div>
    <div id="warn-scale" class="warn" style="display:none">⚠ Revenue looks small — all numbers should be in <strong>millions</strong>. Apple's revenue is ~416,000M, Netflix ~45,000M.</div>
    <div class="field">
      <label>Free cash flow (FCF)
        <button class="info-btn" onclick="showInfo('fcf')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
      </label>
      <input type="text" id="inp-fcf" placeholder="Annual free cash flow (M)"/>
    </div>

    <!-- SBC input (editable) -->
    <div id="sbc-field-wrap">
      <div class="field" style="margin-bottom:4px">
        <label>Stock-based compensation (SBC)
          <button class="info-btn" onclick="showInfo('sbc')" title="About SBC"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
          <span class="note">subtracted from FCF</span>
        </label>
        <input type="text" id="inp-sbc" placeholder="SBC amount (M)" oninput="onSBCInput()"/>
      </div>
    </div>

    <div id="margin-chip" style="display:none">
      <div class="margin-chip">
        <span class="mc-lbl">FCF margin</span>
        <span class="mc-val" id="mc-val">—</span>
      </div>
    </div>
    <!-- CAPEX notes (acquisitions, intangibles, divestitures) -->

    <div id="warn-fcf" class="warn">⚠ Negative cash flow — results may not be meaningful.</div>
    <div id="err-rev" class="err">Revenue must be a positive number.</div>
  </div>

  <!-- ═══ SECTION 3: Options (SBC, FCFF, Currency) ═══ -->
  <div class="sb-lbl"><span class="sb-lbl-icon">⚙</span> Options</div>
  <div class="sb-card" style="padding:4px 12px">
    <!-- SBC toggle -->
    <div class="sb-option-row" id="sbc-toggle-row">
      <div class="sb-option-lbl">
        <span>
          Subtract SBC from FCF
          <button class="info-btn" onclick="showInfo('sbc')" title="About SBC"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
          <span class="sb-opt-desc">On = SBC subtracted (conservative)</span>
        </span>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="toggle-sbc" checked onchange="onSBCToggle()"/>
        <span class="toggle-track"><span class="toggle-thumb"></span></span>
      </label>
    </div>
    <!-- FCFF toggle -->
    <div class="sb-option-row">
      <div class="sb-option-lbl">
        <span>
          Use whole-firm valuation
          <button class="info-btn" onclick="showInfo('fcff')" title="About net debt adjustment"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
          <span class="sb-opt-desc">Off = value just shareholder cash (FCFE). On = value the whole firm, then subtract debt (FCFF).</span>
        </span>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="toggle-fcff" onchange="onFCFFToggle()"/>
        <span class="toggle-track"><span class="toggle-thumb"></span></span>
      </label>
    </div>
    <!-- Currency -->
    <div class="sb-option-row" style="flex-direction:column;align-items:stretch;gap:6px;padding-bottom:10px">
      <div class="ccy-row">
        <div class="field" style="margin:0">
          <label style="font-size:10.5px">Financials in</label>
          <select id="sel-fccy" onchange="onCurrencyChange()">
            <option>USD</option><option>EUR</option><option>GBP</option><option>JPY</option>
            <option>CNY</option><option>KRW</option><option>INR</option><option>CAD</option>
            <option>AUD</option><option>NOK</option><option>SEK</option><option>CHF</option>
          </select>
        </div>
        <div class="field" style="margin:0">
          <label style="font-size:10.5px">Price in</label>
          <select id="sel-pccy" onchange="onCurrencyChange()">
            <option>USD</option><option>EUR</option><option>GBP</option><option>JPY</option>
            <option>CNY</option><option>KRW</option><option>INR</option><option>CAD</option>
            <option>AUD</option><option>NOK</option><option>SEK</option><option>CHF</option>
          </select>
        </div>
      </div>
      <div id="fx-rate-row" style="display:none">
        <div class="fx-box" style="margin:0">
          <label>1 <span id="fccy-lbl">USD</span> = ? <span id="pccy-lbl">USD</span></label>
          <input type="number" id="inp-fxrate" placeholder="1.0" step="0.0001" oninput="update()"/>
        </div>
      </div>
    </div>
  </div>

  <div id="netcash-wrap" style="display:none">
    <div class="sb-card">
      <div class="field" style="margin:0">
        <label>Net cash <span class="note">+ = cash, − = debt</span>
          <button class="info-btn" onclick="showInfo('netcash')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
        </label>
        <input type="text" id="inp-netcash" placeholder="e.g. -4500"/>
      </div>
    </div>
  </div>

  <div class="sb-divider"></div>

  <!-- ═══ SECTION 4: Your assumptions ═══ -->
  <div class="sb-lbl"><span class="sb-lbl-icon">🎯</span> Your assumptions</div>

  <div class="sb-card">
    <div class="sl-row">
      <div class="sl-top"><span>How many years to project? <button class="info-btn" onclick="showInfo('years')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button></span><span id="lbl-years">8 yrs</span></div>
      <input type="range" id="sl-years" min="3" max="20" step="1" value="10" oninput="onSl('years')"/>
    </div>
    <div class="sl-row" style="margin-bottom:4px">
      <div class="sl-top"><span>How fast will revenue grow? <button class="info-btn" onclick="showInfo('cagr')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button></span><span id="lbl-cagr">10%</span></div>
      <input type="range" id="sl-cagr" min="-30" max="100" step="1" value="10" oninput="onSl('cagr')"/>
    </div>
    <div class="bench-grid" id="bench-grid">
      <div class="bench-pill" id="bp-5" onclick="setBench(5)"><span class="bp-rate">5%</span><span class="bp-lbl">Slow</span></div>
      <div class="bench-pill" id="bp-10" onclick="setBench(10)"><span class="bp-rate">10%</span><span class="bp-lbl">Average</span></div>
      <div class="bench-pill" id="bp-20" onclick="setBench(20)"><span class="bp-rate">20%</span><span class="bp-lbl">Fast</span></div>
    </div>
    <div class="sl-row" style="margin-top:10px;margin-bottom:0">
      <div class="sl-top"><span>FCF margin change <button class="info-btn" onclick="showInfo('dpp')" title="About this field"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button></span><span id="lbl-dpp">0.0pp</span></div>
      <input type="range" id="sl-dpp" min="-5" max="5" step="0.1" value="0" oninput="onSl('dpp')"/>
    </div>
  </div>

  <div class="sb-lbl"><span class="sb-lbl-icon">🔮</span> After the forecast <button class="info-btn" onclick="showInfo('terminal')" title="About terminal value"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button></div>
  <div class="sb-card">
    <div class="seg">
      <button class="seg-btn active" id="rb-tg" onclick="setTerm('growth')">Perpetual growth</button>
      <button class="seg-btn" id="rb-tm" onclick="setTerm('multiple')">Exit multiple</button>
    </div>
    <div id="tg-wrap">
      <div class="sl-row" style="margin:0">
        <div class="sl-top"><span>Long-run growth rate</span><span id="lbl-tg">2.5%</span></div>
        <input type="range" id="sl-tg" min="-10" max="10" step="0.5" value="2.5" oninput="onSl('tg')"/>
      </div>
    </div>
    <div id="tm-wrap" style="display:none">
      <div class="sl-row" style="margin:0">
        <div class="sl-top"><span>Exit price (× FCF)</span><span id="lbl-tmult">15.0×</span></div>
        <input type="range" id="sl-tmult" min="3" max="40" step="0.5" value="15" oninput="onSl('tmult')"/>
      </div>
    </div>
  </div>

  <div id="sb-sum-wrap" style="display:none">
    <div class="sb-sum">
      <div class="ss-row"><span class="ss-lbl" id="sum-co">—</span><span class="ss-val" id="sum-px">—</span></div>
      <div class="ss-row"><span class="ss-lbl">FCF margin</span><span class="ss-val" id="sum-margin">—</span></div>
      <div class="ss-row"><span class="ss-lbl">Revenue growth</span><span class="ss-val" id="sum-growth">—</span></div>
      <div class="ss-row"><span class="ss-lbl">Forecast period</span><span class="ss-val" id="sum-years">—</span></div>
      <div class="ss-row"><span class="ss-lbl">After forecast</span><span class="ss-val" id="sum-terminal">—</span></div>
    </div>
  </div>
  <button class="sb-reset" id="btn-reset" style="display:none" onclick="resetInputs()">Clear everything</button>

</aside>

<!-- MAIN -->
<main id="main">

  <!-- Methodology -->
  <div id="methodology">
    <div class="mth-tag">How it works</div>
    <h1 class="mth-h1">The math behind every number</h1>
    <p class="mth-intro">All three tools use the same idea: how much cash will this company make in the future, and what is that worth today? Everything is shown step by step — no black boxes.</p>

    <div class="mth-sec">
      <h2 class="mth-h2">Getting started — search or enter manually</h2>
      <p class="mth-p">You have two ways to load a company:</p>
      <p class="mth-p"><strong>Search</strong> — type a ticker (like AAPL) or company name into the search box. We have over 100 companies with numbers already filled in from their latest annual reports. Pick one and everything loads automatically, including a live stock price.</p>
      <p class="mth-p"><strong>Enter manually</strong> — you can type any company's numbers by hand: price, shares, revenue, free cash flow. This works for any company in the world, even private ones not in our list.</p>
      <div class="mth-note"><strong>Important:</strong> Pre-loaded numbers are sourced from annual reports and may become outdated. Always verify against the latest filings before making any decisions.</div>
      <div class="mth-note"><strong>Important:</strong> The pre-loaded numbers come from annual reports and are a starting point. Revenue, margins, and cash flows change every quarter. Always check the latest numbers before making decisions. The report date is shown in the sidebar.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">1. Fair Value — what is the stock worth?</h2>
      <p class="mth-p">We estimate how much cash the company will make each year, then shrink those future amounts back to today's value (because a dollar today is worth more than a dollar in 10 years). Add it all up, divide by the number of shares, and you get a fair price per share.</p>
      <div class="mth-formula">
        <strong>Default FCF formula:</strong><br>
        FCF = Cash from operations − Equipment spending − Stock-based pay<br><br>
        Yearly cash = Revenue × FCF margin<br>
        Today's value = Future cash ÷ (1 + your discount rate)^year<br><br>
        <strong>After the forecast (perpetual growth):</strong><br>
        Value = last year's cash × (1 + long-run growth) ÷ (return − growth)<br><br>
        <strong>After the forecast (exit multiple):</strong><br>
        Value = last year's cash × your chosen multiple<br><br>
        <strong>Fair value per share:</strong><br>
        Default (FCFE): (sum of all future cash) ÷ shares<br>
        Whole-firm mode (FCFF): (sum of all future cash − debt + cash on hand) ÷ shares
      </div>
      <p class="mth-p"><strong>Stock-based pay:</strong> By default, we subtract what the company gives employees in stock because it shrinks your ownership over time. This is the safer approach. You can turn this off under "Options" in the sidebar if you prefer the standard calculation.</p>
      <p class="mth-p"><strong>Discount rate starts at 12%.</strong> The same number for every company. This is higher than what most stocks "should" return based on theory (usually 8–12%), giving you a built-in safety cushion. Move the slider to set your own target.</p>
      <p class="mth-p"><strong>Revenue growth defaults to 10%.</strong> This is roughly the long-run average return of the stock market, making it a neutral starting point. Every company is different — adjust it to match your own view.</p>
      <p class="mth-p"><strong>Forecast period defaults to 10 years.</strong> Long enough for growing companies to show their potential, short enough to keep predictions honest. You can change this with the slider.</p>
      <p class="mth-p">Click the <strong>ⓘ button next to the fair value number</strong> to see the full step-by-step calculation — every number explained in plain language.</p>
      <div class="mth-note">When using perpetual growth, the growth rate must be lower than your discount rate — otherwise the math breaks.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">2. Implied return — what does the price tell you?</h2>
      <p class="mth-p">Instead of asking "what should the stock cost?", we flip it: "if I buy at today's price, what yearly return am I getting?" If that return is higher than your target (like 12%), the stock might be a good deal. If it's lower, the market might be too optimistic.</p>
      <div class="mth-formula">Find the return rate where: fair value = today's market price</div>
      <p class="mth-p">The Implied Return tab has its own step-by-step breakdown — open <strong>"How the implied return was calculated"</strong> to see exactly how the number was found.</p>
      <div class="mth-note">There is no single "good" return — it depends on your personal target and what else you could invest in.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">3. Scenario grid — what if things are different?</h2>
      <p class="mth-p">Nobody knows exactly how fast a company will grow. The scenario grid tests every combination of growth speed and after-forecast value at once. It runs three versions: one where margins get worse each year (Bear), one where they stay the same (Base), and one where they improve (Bull). Red means low returns, blue means high returns — you pick what's good enough for you.</p>
      <div class="mth-note"><strong>The summary strip at the top</strong> shows the middle result across all scenarios — so you can see the typical outcome, not just the best or worst case.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">4. Where the numbers come from</h2>
      <p class="mth-p">Every ⓘ button in the app opens a plain-English explanation of that number — where it came from, how it's used, and what to watch out for.</p>
      <p class="mth-p"><strong>Stock prices:</strong> fetched live from Polygon.io (previous trading day close). <strong>Company numbers:</strong> from the most recent annual report available at the time of entry, including revenue, cash from operations, equipment spending, stock-based pay, shares, and cash/debt. The report date is shown in the sidebar.</p>
      <div class="mth-note"><strong>Data may be outdated.</strong> The pre-loaded figures were entered at a specific point in time and may not reflect the company's latest filings. Always check the numbers against the most recent reports before relying on them.</div>
    </div>

    <div class="mth-sec">
      <h2 class="mth-h2">5. What this tool can't do</h2>
      <p class="mth-p">Small changes to growth or the after-forecast value can swing results a lot. Use this as a thinking tool, not a final answer.</p>
      <ul style="font-size:13px;color:var(--ink-3);line-height:2.2;padding-left:16px">
        <li>This is not investment advice</li>
        <li>Pre-loaded numbers are from annual reports and may be out of date — always check</li>
        <li>Stock-based pay is subtracted by default, but future stock awards are not predicted</li>
        <li>Does not include one-time costs or unusual gains</li>
        <li>Uses one growth rate — real companies grow unevenly</li>
      </ul>
    </div>
    <button class="mth-back" onclick="hideMethodology()">← Back</button>
  </div>

  <!-- App view -->
  <div id="app-view" style="display:flex;flex-direction:column;flex:1">
    <nav id="tabbar">
      <button class="tab-btn active" onclick="switchTab('dcf')" data-short="Fair Value">Fair Value</button>
      <button class="tab-btn" onclick="switchTab('rev')" data-short="Impl. Return">Implied Return</button>
      <button class="tab-btn" onclick="switchTab('matrix')" data-short="Scenarios">Scenario Grid</button>
      <div class="tab-sep"></div>
    </nav>

    <!-- DCF Tab -->
    <div class="tab-panel active" id="tab-dcf">
      <div id="dcf-empty" class="empty">
        <svg viewBox="0 0 40 40" fill="none"><path d="M6 30l8-12 8 8 6-8 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div class="empty-title">Search or enter a company to start</div>
        <div class="empty-body" id="dcf-empty-body">Search for a company in the database, or enter any company's numbers manually in the sidebar. Pre-loaded data may be out of date — always verify against the latest filings. Every calculation is shown step by step.</div>
      </div>
      <div id="dcf-content" style="display:none">

        <!-- ONE unified card: required return (input) + FV vs Market (output) -->
        <div class="val-card" id="val-card">

          <!-- Required return slider — top, as it's the key input -->
          <div class="val-card-slider">
            <div class="vcs-top">
              <div class="vcs-label">
                <span class="vcs-title" id="disc-title-text">Discount rate</span>
                <button class="info-btn" onclick="showInfo('discrate')" title="About the discount rate"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button>
              </div>
              <span class="vcs-val" id="lbl-disc">12%</span>
            </div>
            <div class="vcs-track">
              <input type="range" id="sl-disc" min="1" max="50" step="1" value="12" oninput="onDiscChange()"/>
              <div class="vcs-thumb" id="disc-thumb"></div>
            </div>
            <div class="vcs-hints">
              <div class="vcs-hint" onclick="setDisc(8)"><div class="vcs-hint-rate">8%</div><div class="vcs-hint-lbl">Aggressive</div></div>
              <div class="vcs-hint" onclick="setDisc(12)"><div class="vcs-hint-rate">12%</div><div class="vcs-hint-lbl">Moderate</div></div>
              <div class="vcs-hint" onclick="setDisc(15)"><div class="vcs-hint-rate">15%</div><div class="vcs-hint-lbl">Careful</div></div>
              <div class="vcs-hint" onclick="setDisc(20)"><div class="vcs-hint-rate">20%</div><div class="vcs-hint-lbl">Very strict</div></div>
            </div>
          </div>

          <!-- Numbers + verdict — result of the input above -->
          <div class="val-card-top" id="dcf-hero"></div>
          <div id="dcf-verdict"></div>

        </div>

        <!-- hidden compat divs (JS still writes to dcf-cmp) -->
        <div id="dcf-cmp" style="display:none"></div>

        <!-- Chart -->
        <div class="chart-card">
          <div class="chart-card-title">Fair value at every discount rate</div>
          <div class="chart-card-sub"><span style="color:var(--green-dk);font-weight:500">Green zone</span> = stock looks cheap at that discount rate. <span style="color:var(--red-dk);font-weight:500">Red zone</span> = price exceeds fair value. The dot marks your current discount rate — adjust the slider above to move it.</div>
          <canvas id="chart-sens" height="220" style="width:100%"></canvas>
          <div class="chart-legend">
            <div class="leg"><div class="leg-dot" style="background:var(--blue)"></div>Fair value per share</div>
            <div class="leg"><div class="leg-dot" style="background:var(--ink-4);width:18px;height:1.5px;border-radius:0"></div>Market price</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(26,122,60,.18)"></div>Cheap zone</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(192,57,43,.12)"></div>Expensive zone</div>
          </div>
        </div>

        <div class="coll" id="dcf-calc-section">
          <div class="coll-hdr" id="dcf-calc-hdr" onclick="toggleColl(this)">How this fair value was calculated — step by step <span class="coll-arrow">▼</span></div>
          <div class="coll-body">
            <div id="dcf-calc-steps"></div>
            <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border-2)">
              <div style="font-size:11px;color:var(--ink-4);margin-bottom:8px;font-family:var(--ff-mono);text-transform:uppercase;letter-spacing:.5px">Detailed year-by-year table</div>
              <div style="overflow-x:auto"><table class="data-tbl" id="forecast-tbl"></table></div>
              <div id="bridge-wrap"></div>
              <button class="btn-dl" onclick="downloadForecast()" style="margin-top:8px">⬇ Download CSV</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reverse DCF Tab -->
    <div class="tab-panel" id="tab-rev">
      <div id="rev-empty" class="empty">
        <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="12" stroke="currentColor" stroke-width="2"/><path d="M20 14v6l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <div class="empty-title">Search or enter a company to see the implied return</div>
        <div class="empty-body" id="rev-empty-body">Search the database or enter numbers manually. The implied return tells you: what yearly return does today's price assume? Pre-loaded data should be verified before use.</div>
      </div>
      <div id="rev-content" style="display:none">

        <!-- Hero result card — filled by renderRev() -->
        <div id="irr-hero"></div>

        <!-- Price explorer -->
        <div class="rev-price-ctrl">
          <div class="rpc-top">
            <div>
              <div class="rpc-label">What if the price were different?</div>
              <div class="rpc-sub">Move the slider to try any buy price. The yearly return updates instantly — everything else (growth, margins, after-forecast) stays the same.</div>
            </div>
            <div class="rpc-price-display">
              <div class="rpc-price-val" id="rev-price-display">—</div>
              <div class="rpc-price-ccy" id="rev-price-ccy">USD</div>
            </div>
          </div>
          <div class="rpc-slider-row">
            <span class="rpc-bound" id="rev-price-min">—</span>
            <div class="rpc-track-wrap">
              <input type="range" id="rev-sl-price" min="0" max="100" step="1" value="50" oninput="onRevPriceChange(this.value)"/>
            </div>
            <span class="rpc-bound" id="rev-price-max">—</span>
          </div>
          <div class="rpc-result" id="rpc-result-row" style="display:none">
            <div class="rpc-result-item">
              <div class="rpc-result-lbl">Implied return</div>
              <div class="rpc-result-val" id="rpc-explored-irr">—</div>
            </div>
            <div class="rpc-result-div"></div>
            <div class="rpc-result-item">
              <div class="rpc-result-lbl">vs current price</div>
              <div class="rpc-result-val" id="rpc-irr-delta">—</div>
            </div>
            <div class="rpc-result-div"></div>
            <div class="rpc-result-item">
              <div class="rpc-result-lbl">Price change</div>
              <div class="rpc-result-val" id="rpc-price-delta">—</div>
            </div>
            <button class="rpc-reset" onclick="resetRevPrice()">Reset</button>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-card-title">Implied return across prices</div>
          <div class="chart-card-sub">The dashed line marks your discount rate from the Fair Value tab. The green zone shows prices where the implied return exceeds it. <strong>Click or drag</strong> to explore.</div>
          <canvas id="chart-irr" height="220" style="width:100%;cursor:crosshair"></canvas>
          <div class="chart-legend" style="margin-top:10px" id="irr-chart-legend">
            <div class="leg"><div class="leg-dot" style="background:var(--blue)"></div>Implied return</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(26,122,60,.2)"></div>Above your discount rate</div>
            <div class="leg"><div class="leg-dot" style="background:rgba(192,57,43,.12)"></div>Below your discount rate</div>
            <div class="leg"><div style="width:18px;height:1.5px;border-top:2px dashed var(--ink-4);margin-top:5px"></div><span id="irr-hurdle-legend-lbl">Your discount rate (12%)</span></div>
          </div>
        </div>

        <div class="coll" id="irr-calc-section">
          <div class="coll-hdr" id="irr-calc-hdr" onclick="toggleColl(this)">How the implied return was calculated <span class="coll-arrow">▼</span></div>
          <div class="coll-body">
            <div id="irr-calc-steps"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-panel" id="tab-matrix">
      <div id="matrix-empty" class="empty">
        <svg viewBox="0 0 40 40" fill="none"><rect x="6" y="6" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/><rect x="23" y="6" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/><rect x="6" y="23" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/><rect x="23" y="23" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.8"/></svg>
        <div class="empty-title">Search or enter a company to see scenarios</div>
        <div class="empty-body" id="matrix-empty-body">The scenario grid tests many combinations of growth and exit assumptions at once, showing your implied return for each. Pre-loaded data should be verified before use.</div>
      </div>
      <div id="matrix-content" style="display:none">

        <!-- Matrix-level warning banner (shown when many cells are blank) -->
        <div id="matrix-warn" style="display:none" class="calc-warn" style="margin-bottom:12px"></div>

        <!-- Scenario summary strip -->
        <div class="sc-strip" id="sc-strip"></div>

        <!-- How to read this — collapsible beginner explanation -->
        <details class="sc-guide" id="sc-guide">
          <summary class="sc-guide-toggle">How to read this</summary>
          <div class="sc-guide-body">
            <p><strong>What is this grid?</strong> Each cell shows a number — that's the yearly return you'd earn if you bought the stock today and the company performed according to that particular combination of assumptions.</p>
            <p><strong>Rows</strong> = how fast the company grows its revenue each year. Higher rows = faster growth.</p>
            <p><strong>Columns</strong> = what happens after the forecast ends (the "terminal value"). Higher columns = more optimistic exit.</p>
            <p><strong>Colours:</strong> Blue cells are higher returns (good). Red cells are lower returns (not as good). The darker the blue, the better the return. The darker the red, the worse.</p>
            <p><strong>Bear / Base / Bull:</strong> Three versions of the same grid. Bear = margins get worse over time. Base = margins stay the same. Bull = margins improve. This gives you a range of outcomes.</p>
            <p><strong>The summary strip above</strong> shows the middle (median) result across all the cells in each scenario — so you can quickly see the typical outcome, not just the best or worst case.</p>
            <p><strong>How to use it:</strong> Find the row and column that match what you think is most likely. If that cell shows a return higher than your target (like 12%), the stock might be worth a closer look. If most of the grid is blue, there's a wide margin of safety. If most is red, the stock may be priced for perfection.</p>
          </div>
        </details>

        <!-- View toggle -->
        <div class="mx-view-toggle">
          <span class="mx-toggle-label">View as</span>
          <div class="mx-seg">
            <button class="mx-seg-btn active" id="mx-btn-table" onclick="setMatrixView('table')">Heatmap</button>
            <button class="mx-seg-btn" id="mx-btn-chart" onclick="setMatrixView('chart')">Chart</button>
          </div>
        </div>

        <!-- Colour legend (table view) -->
        <div class="hm-legend" id="mx-hm-legend">
          <span class="hm-end bad">Low return</span>
          <div style="flex:1">
            <div class="hm-bar"></div>
            <div class="hm-tick-row"><span>0%</span><span>5%</span><span>10%</span><span>15%</span><span>20%+</span></div>
          </div>
          <span class="hm-end good">High return</span>
        </div>

        <!-- Matrix chart (chart view, hidden by default) -->
        <div class="matrix-chart-card" id="mx-chart-card" style="display:none">
          <div class="mchart-title">Return range by growth rate</div>
          <div class="mchart-sub">The band shows the spread of implied returns across all after-forecast assumptions. The line is the middle — wider band = more uncertainty.</div>
          <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap" id="mx-chart-scenario-tabs">
            <button class="mx-seg-btn active" onclick="setMatrixChartScenario('base',this)">Base</button>
            <button class="mx-seg-btn" onclick="setMatrixChartScenario('bear',this)">Bear</button>
            <button class="mx-seg-btn" onclick="setMatrixChartScenario('bull',this)">Bull</button>
          </div>
          <!-- Compact legend -->
          <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px" id="mx-chart-legend">
            <div class="leg"><div style="width:18px;height:2.5px;background:var(--blue);border-radius:2px;flex-shrink:0"></div>Median</div>
            <div class="leg">
              <div style="width:16px;height:10px;background:rgba(26,92,152,.18);border-radius:2px;flex-shrink:0"></div>
              Middle 50% of range
            </div>
            <div class="leg">
              <div style="width:16px;height:10px;background:rgba(26,92,152,.07);border:1px dashed rgba(26,92,152,.3);border-radius:2px;flex-shrink:0"></div>
              Full range (min–max)
            </div>
            <div class="leg" style="color:var(--ink-4)">
              <div style="width:18px;height:0;border-top:1.5px dashed rgba(74,70,64,.55);flex-shrink:0;margin-top:1px"></div>
              <span id="mx-hurdle-legend-lbl">Your return (12%) — from Fair Value tab</span>
            </div>
          </div>
          <canvas id="chart-matrix" style="width:100%" height="260"></canvas>

          <!-- How to read this chart -->
          <div class="coll" style="margin-top:10px;box-shadow:none;border-color:var(--border-2)">
            <div class="coll-hdr" onclick="toggleColl(this)" style="font-size:12.5px;padding:9px 14px;color:var(--ink-3)">
              How to read this chart <span class="coll-arrow">▼</span>
            </div>
            <div class="coll-body" style="padding:12px 14px;background:var(--surface-2)">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:18px;height:2.5px;background:var(--blue);border-radius:2px;flex-shrink:0;margin-top:7px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Median line</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">The middle implied return across all after-forecast assumptions at that growth rate. Half are above this line, half below.</div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:16px;height:10px;background:rgba(26,92,152,.18);border-radius:2px;flex-shrink:0;margin-top:4px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Middle 50% of range</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">The inner shaded band. Shows the range of typical results, excluding the most extreme best and worst cases.</div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:16px;height:10px;background:rgba(26,92,152,.07);border:1px dashed rgba(26,92,152,.3);border-radius:2px;flex-shrink:0;margin-top:4px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Full range (min–max)</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">The outer faint band with dashed edges. Shows the absolute best and worst returns across every after-forecast assumption — the full range of possibilities.</div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div style="width:18px;height:0;border-top:1.5px dashed rgba(74,70,64,.55);flex-shrink:0;margin-top:7px"></div>
                  <div>
                    <div style="font-size:11.5px;font-weight:600;color:var(--ink-2);margin-bottom:2px">Your discount rate</div>
                    <div style="font-size:11px;color:var(--ink-4);line-height:1.55">Pulled from your discount rate in the Fair Value tab. Results above this line meet your return target; results below do not.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Matrix controls -->
        <div class="mc-ctrl" id="mc-ctrl">
          <div class="mc-card">
            <div class="mc-card-hdr">Rows — revenue growth range</div>
            <div class="mc-card-cells">
              <div class="mc-card-cell"><label>Min %</label><input type="number" id="mc-gmin" value="0" step="1" oninput="renderMatrix()"/></div>
              <div class="mc-card-cell"><label>Max %</label><input type="number" id="mc-gmax" value="20" step="1" oninput="renderMatrix()"/></div>
              <div class="mc-card-cell"><label>Rows</label><input type="number" id="mc-grows" value="6" min="2" max="12" oninput="renderMatrix()"/></div>
            </div>
          </div>
          <div class="mc-card">
            <div class="mc-card-hdr" id="mc-col-lbl">Columns — terminal growth range</div>
            <div class="mc-card-cells">
              <div class="mc-card-cell"><label id="mc-min-lbl">Min %</label><input type="number" id="mc-tmin" value="0" step="0.5" oninput="renderMatrix()"/></div>
              <div class="mc-card-cell"><label id="mc-max-lbl">Max %</label><input type="number" id="mc-tmax" value="4" step="0.5" oninput="renderMatrix()"/></div>
              <div class="mc-card-cell"><label>Cols</label><input type="number" id="mc-tcols" value="5" min="2" max="10" oninput="renderMatrix()"/></div>
            </div>
          </div>
        </div>

        <div id="matrix-tables"></div>
      </div>
    </div>
  </div>
</main>
</div>
</div>

<!-- Mobile bar -->
<div id="mobile-bar">
  <div class="mb-row">
    <div><div class="mb-lbl">Fair Value</div><div class="mb-val" id="mb-fv">—</div></div>
    <div class="mb-div"></div>
    <div><div class="mb-lbl">Price</div><div class="mb-val" id="mb-px">—</div></div>
    <div class="mb-div"></div>
    <div id="mb-badge-wrap" style="flex:1"></div>
    <button class="mb-action-btn" onclick="shareURL()" title="Share">⬆</button>
    <button class="mb-action-btn mb-action-save" onclick="saveReport()" title="Save Report">⬇</button>
  </div>
</div>

<div id="toast"></div>

<!-- Info modal -->
<div class="info-modal-overlay" id="info-modal-overlay" onclick="closeInfoModal(event)">
  <div class="info-modal" id="info-modal">
    <div class="im-header">
      <div><div class="im-title" id="im-title"></div><div class="im-subtitle" id="im-subtitle"></div></div>
      <button class="im-close" onclick="closeInfoModal()">✕</button>
    </div>
    <div class="im-body" id="im-body"></div>
  </div>
</div>



<script>
/* ══════════════════════════════════════════
   PRESETS
══════════════════════════════════════════ */
const PRESETS={
  NFLX:{company:'Netflix (NFLX)',price:'78.67',shares:'4317',revenue:'45183',fcf:'9461',netcash:'-4500',cagr:12,dpp:0,years:10,termMode:'growth',tg:3,tmult:'15',fccy:'USD',pccy:'USD'},
  AAPL:{company:'Apple (AAPL)',price:'264',shares:'14680',revenue:'416161',fcf:'98767',netcash:'34000',cagr:8,dpp:0.2,years:10,termMode:'growth',tg:2.5,tmult:'20',fccy:'USD',pccy:'USD'},
  MSFT:{company:'Microsoft (MSFT)',price:'397',shares:'7433',revenue:'281724',fcf:'71611',netcash:'27000',cagr:15,dpp:0.1,years:10,termMode:'growth',tg:3,tmult:'20',fccy:'USD',pccy:'USD'},
  NVDA:{company:'Nvidia (NVDA)',price:'190',shares:'24400',revenue:'130497',fcf:'60853',netcash:'38000',cagr:30,dpp:0,years:10,termMode:'growth',tg:3,tmult:'25',fccy:'USD',pccy:'USD'},
  META:{company:'Meta (META)',price:'656',shares:'2530',revenue:'164501',fcf:'52100',netcash:'52000',cagr:15,dpp:0.2,years:10,termMode:'growth',tg:3,tmult:'18',fccy:'USD',pccy:'USD'},
  TSLA:{company:'Tesla (TSLA)',price:'412',shares:'3200',revenue:'94830',fcf:'6200',netcash:'44100',cagr:20,dpp:0.5,years:10,termMode:'growth',tg:3,tmult:'20',fccy:'USD',pccy:'USD'},
};
// Guard flag — prevents the company-name input listener from clearing fields during programmatic load
let _loadingPreset = false;
let _currentTicker = null; // Track loaded company for dynamic info modals

// Safe localStorage wrapper — sandbox iframes block localStorage and throw SecurityError
var _store = {
  get: function(k)    { try { return localStorage.getItem(k); }    catch(e) { return null; } },
  set: function(k, v) { try { localStorage.setItem(k, v); }        catch(e) { /* silent */ } },
};

/* ══════════════════════════════════════════
   DATABASE + POLYGON — declared first so all
   functions below can reference DB_MAP
══════════════════════════════════════════ */
// ── Live price fetch — completely sandboxed, never throws ──────────────
// Uses Polygon.io end-of-day API. Add your free key at polygon.io to enable.
var POLYGON_KEY = 'Jh93BPZQd6Hn83xAIHbCP4gqJXB2LXwC';

function _showPriceFail(filingDate) {
  var field = document.getElementById('inp-price');
  if (field && !field.value) {
    setDataDates(filingDate || '—', 'Enter price manually');
  }
}

function tryFetchLivePrice(ticker, filingDate) {
  // Hard exit if no key
  if (!POLYGON_KEY || POLYGON_KEY === 'YOUR_POLYGON_KEY') { _showPriceFail(filingDate); return; }

  var pt = ({
    'BRK-B': 'BRK.B',
    'GOOGL': 'GOOGL',
    'NOVO-B': 'NOVO-B'
  })[ticker] || ticker;

  var url = 'https://api.polygon.io/v2/aggs/ticker/' + pt + '/prev?adjusted=true&apiKey=' + POLYGON_KEY;

  try {
    if (typeof XMLHttpRequest === 'undefined') { _showPriceFail(filingDate); return; }
    var xhr = new XMLHttpRequest();
    xhr.timeout = 8000;
    xhr.open('GET', url, true);
    xhr.onload = function() {
      try {
        if (xhr.status !== 200) { _showPriceFail(filingDate); return; }
        var data = JSON.parse(xhr.responseText);
        var r = data && data.results && data.results[0];
        if (!r || !r.c) { _showPriceFail(filingDate); return; }
        var px = String(r.c);
        var dateStr = r.t ? new Date(r.t).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : '';
        var field = document.getElementById('inp-price');
        if (field && !field.value) {
          field.value = px;
          setDataDates(filingDate, 'Live · ' + dateStr);
          update();
        }
      } catch(e) { _showPriceFail(filingDate); }
    };
    xhr.onerror   = function() { _showPriceFail(filingDate); };
    xhr.ontimeout = function() { _showPriceFail(filingDate); };
    xhr.send();
  } catch(e) { _showPriceFail(filingDate); }
}



// ── Company database ────────────────────────────────────────────────
// Updated from dcf_input_data_finished.xlsx — TTM data as of 2025
// rev/cffo/fcf/cx/sbc in millions. shares in millions. cagr = suggested growth %.
// cn = capex notes (acquisitions, intangibles, divestitures for user reference)
const _RAW_DB = [
  {t:'AAPL', n:'Apple Inc.', filing:'TTM (Dec 2025)', px:245.55, rev:435617, fcf:123324, sh:14919.6, nc:34000, cagr:8, cur:'USD', sec:'tech', cx:12148, bt:1.24, sbc:13171, cffo:135472},
  {t:'MSFT', n:'Microsoft Corp.', filing:'TTM (Dec 2025)', px:399.72, rev:305453, fcf:77412, sh:7462.0, nc:27000, cagr:15, cur:'USD', sec:'tech', cx:83094, bt:0.9, sbc:12255, cffo:160506},
  {t:'NVDA', n:'NVIDIA Corp.', filing:'TTM (Oct 2025)', px:134.25, rev:187142, fcf:77324, sh:24582.8, nc:38000, cagr:30, cur:'USD', sec:'semi', cx:5835, bt:1.67, sbc:6074, cffo:83159},
  {t:'GOOGL', n:'Alphabet Inc.', filing:'TTM (Dec 2025)', px:191.93, rev:402836, fcf:73266, sh:12230.0, nc:93000, cagr:12, cur:'USD', sec:'tech', cx:91447, bt:1.06, sbc:24953, cffo:164713},
  {t:'META', n:'Meta Platforms', filing:'TTM (Dec 2025)', px:719.32, rev:200966, fcf:46109, sh:2574.0, nc:52000, cagr:15, cur:'USD', sec:'tech', cx:69691, bt:1.25, sbc:20427, cffo:115800},
  {t:'AMZN', n:'Amazon.com', filing:'TTM (Dec 2025)', px:228.85, rev:716924, fcf:7695, sh:10827.0, nc:78000, cagr:15, cur:'USD', sec:'tech', cx:131819, bt:1.16, sbc:19467, cffo:139514},
  {t:'TSLA', n:'Tesla Inc.', filing:'TTM (Dec 2025)', px:337.83, rev:94827, fcf:6220, sh:3528.0, nc:44100, cagr:20, cur:'USD', sec:'con', cx:8527, bt:2.05, sbc:2825, cffo:14747},
  {t:'NFLX', n:'Netflix Inc.', filing:'TTM (Dec 2025)', px:1013.74, rev:45183, fcf:9461, sh:4343.9, nc:-4500, cagr:12, cur:'USD', sec:'tech', cx:688, bt:1.4, sbc:368, cffo:10149},
  {t:'CRM', n:'Salesforce Inc.', filing:'TTM (Oct 2025)', px:316.4, rev:40317, fcf:12895, sh:964.3, nc:4500, cagr:12, cur:'USD', sec:'tech', cx:607, bt:1.3, sbc:3299, cffo:13502},
  {t:'ADBE', n:'Adobe Inc.', filing:'Nov 2025', px:462.5, rev:23769, fcf:9852, sh:427.0, nc:4000, cagr:10, cur:'USD', sec:'tech', cx:179, bt:1.15, sbc:1942, cffo:10031},
  {t:'NOW', n:'ServiceNow Inc.', filing:'TTM (Dec 2025)', px:1084.2, rev:13278, fcf:4576, sh:1046.7, nc:4200, cagr:20, cur:'USD', sec:'tech', cx:868, bt:1.1, sbc:1955, cffo:5444, cn:["Cash Aquisition of 1084"]},
  {t:'SNOW', n:'Snowflake Inc.', filing:'TTM (Oct 2025)', px:175.8, rev:4386, fcf:777, sh:334.8, nc:3800, cagr:25, cur:'USD', sec:'tech', cx:97, bt:1.8, sbc:1624, cffo:874, cn:["Cash Aquisition of 177,4"]},
  {t:'PLTR', n:'Palantir Technologies', filing:'TTM (Dec 2025)', px:95.35, rev:4475, fcf:2100, sh:2565.0, nc:4600, cagr:25, cur:'USD', sec:'tech', cx:34, bt:1.6, sbc:684, cffo:2134},
  {t:'ORCL', n:'Oracle Corp.', filing:'Nov 2025', px:174.2, rev:61016, fcf:-13181, sh:2894.0, nc:-88000, cagr:8, cur:'USD', sec:'tech', cx:35477, bt:1.05, sbc:4778, cffo:22296},
  {t:'INTU', n:'Intuit Inc.', filing:'TTM (Oct 2025)', px:609.5, rev:19433, fcf:6393, sh:282.5, nc:1200, cagr:12, cur:'USD', sec:'tech', cx:89, bt:1.15, sbc:2000, cffo:6482},
  {t:'SHOP', n:'Shopify Inc.', filing:'TTM (Dec 2025)', px:116.5, rev:11556, fcf:2007, sh:1305.0, nc:5100, cagr:25, cur:'USD', sec:'tech', cx:26, bt:1.75, sbc:449, cffo:2033},
  {t:'AMD', n:'Advanced Micro Devices', filing:'TTM (Dec 2025)', px:104.2, rev:34639, fcf:6735, sh:1636.0, nc:4000, cagr:20, cur:'USD', sec:'semi', cx:974, bt:1.55, sbc:1638, cffo:7709, cn:["Cash Aquisition 1760"]},
  {t:'INTC', n:'Intel Corp.', filing:'TTM (Dec 2025)', px:21.8, rev:52853, fcf:-4949, sh:4530.0, nc:-11000, cagr:5, cur:'USD', sec:'semi', cx:14646, bt:1.05, sbc:2434, cffo:9697, cn:["Divestitures of 6157"]},
  {t:'QCOM', n:'Qualcomm Inc.', filing:'TTM (Dec 2025)', px:156.9, rev:44867, fcf:12926, sh:1094.3, nc:-4500, cagr:8, cur:'USD', sec:'semi', cx:1464, bt:1.2, sbc:2912, cffo:14390, cn:["Cash Aquisition of 1573"]},
  {t:'AVGO', n:'Broadcom Inc.', filing:'Nov 2025', px:237.5, rev:63887, fcf:26914, sh:4853.0, nc:-65000, cagr:12, cur:'USD', sec:'semi', cx:623, bt:1.1, sbc:7568, cffo:27537},
  {t:'TSM', n:'Taiwan Semiconductor', filing:'TTM (Dec 2025)', px:194.2, rev:121353, fcf:31941, sh:5186.2, nc:25000, cagr:15, cur:'USD', sec:'semi', cx:40538, bt:1.15, sbc:0, cffo:72479},
  {t:'ASML', n:'ASML Holding', filing:'TTM (Dec 2025)', px:677.3, rev:38378, fcf:13022, sh:388.9, nc:2300, cagr:15, cur:'USD', sec:'semi', cx:1849, bt:1.2, sbc:238, cffo:14871},
  {t:'MRVL', n:'Marvell Technology', filing:'Nov 2025', px:88.2, rev:7793, fcf:1581, sh:868.8, nc:-2000, cagr:18, cur:'USD', sec:'semi', cx:310, bt:1.45, sbc:595, cffo:1891},
  {t:'ARM', n:'Arm Holdings', filing:'TTM (Dec 2025)', px:152.3, rev:4671, fcf:977, sh:1067.5, nc:2600, cagr:20, cur:'USD', sec:'semi', cx:545, bt:1.5, sbc:984, cffo:1522},
  {t:'KLAC', n:'KLA Corp.', filing:'TTM (Dec 2025)', px:768.4, rev:12744, fcf:4377, sh:132.6, nc:-6500, cagr:10, cur:'USD', sec:'semi', cx:389, bt:1.15, sbc:286, cffo:4766},
  {t:'LRCX', n:'Lam Research', filing:'TTM (Dec 2025)', px:77.6, rev:20560, fcf:6215, sh:1274.0, nc:-5200, cagr:10, cur:'USD', sec:'semi', cx:906, bt:1.2, sbc:367, cffo:7121},
  {t:'AMAT', n:'Applied Materials', filing:'TTM (Dec 2025)', px:179.2, rev:28214, fcf:6194, sh:803.0, nc:-3500, cagr:10, cur:'USD', sec:'semi', cx:2525, bt:1.25, sbc:680, cffo:8719},
  {t:'ON', n:'ON Semiconductor', filing:'TTM (Dec 2025)', px:49.3, rev:5995, fcf:1418, sh:411.8, nc:-3100, cagr:8, cur:'USD', sec:'semi', cx:341, bt:1.5, sbc:144, cffo:1759, cn:["Cash aquisition of 124,5"]},
  {t:'V', n:'Visa Inc.', filing:'TTM (Dec 2025)', px:358.1, rev:41391, fcf:31471, sh:1953.0, nc:-7500, cagr:10, cur:'USD', sec:'fin', cx:2079, bt:0.95, sbc:1241, cffo:33550},
  {t:'MA', n:'Mastercard Inc.', filing:'TTM (Dec 2025)', px:554.7, rev:32791, fcf:17159, sh:906.0, nc:-5000, cagr:12, cur:'USD', sec:'fin', cx:489, bt:1.0, sbc:597, cffo:17648, cn:["Purchase of intangibles of 726"]},

  {t:'PYPL', n:'PayPal Holdings', filing:'TTM (Dec 2025)', px:79.45, rev:33172, fcf:5564, sh:968.0, nc:-3200, cagr:6, cur:'USD', sec:'fin', cx:852, bt:1.3, sbc:1002, cffo:6416},
  {t:'BLK', n:'BlackRock Inc.', filing:'Sep 2025', px:1014.2, rev:24216, fcf:3933, sh:157.7, nc:-10000, cagr:8, cur:'USD', sec:'fin', cx:335, bt:1.15, sbc:1128, cffo:4268, cn:["Cash Aquisition of 6358"]},
  {t:'SPGI', n:'S&P Global', filing:'TTM (Dec 2025)', px:505.8, rev:15336, fcf:5456, sh:305.1, nc:-11000, cagr:10, cur:'USD', sec:'fin', cx:195, bt:1.05, sbc:236, cffo:5651, cn:["Cash Aquisition of 2023"]},
  {t:'ICE', n:'Intercontinental Exch.', filing:'TTM (Dec 2025)', px:163.4, rev:9931, fcf:4289, sh:575.0, nc:-18000, cagr:8, cur:'USD', sec:'fin', cx:373, bt:0.9, sbc:238, cffo:4662, cn:["Intangibles purchase of 418"]},
  {t:'WMT', n:'Walmart Inc.', filing:'Jan 2026', px:100.8, rev:713163, fcf:14923, sh:8022.0, nc:-40000, cagr:5, cur:'USD', sec:'con', cx:26642, bt:0.55, sbc:0, cffo:41565},
  {t:'COST', n:'Costco Wholesale', filing:'Nov 2025', px:1054.4, rev:280391, fcf:9003, sh:444.7, nc:2400, cagr:8, cur:'USD', sec:'con', cx:5760, bt:0.8, sbc:883, cffo:14763},
  {t:'NKE', n:'Nike Inc.', filing:'Nov 2025', px:73.3, rev:46513, fcf:2475, sh:1479.7, nc:-9800, cagr:6, cur:'USD', sec:'con', cx:581, bt:1.1, sbc:695, cffo:3056},
  {t:'MCD', n:'McDonald\'s Corp.', filing:'TTM (Dec 2025)', px:298.7, rev:26885, fcf:7186, sh:716.4, nc:-47000, cagr:5, cur:'USD', sec:'con', cx:3365, bt:0.7, sbc:0, cffo:10551},
  {t:'SBUX', n:'Starbucks Corp.', filing:'TTM (Dec 2025)', px:110.9, rev:35492, fcf:2337, sh:1140.0, nc:-13200, cagr:6, cur:'USD', sec:'con', cx:1936, bt:0.95, sbc:344, cffo:4273},
  {t:'LULU', n:'Lululemon Athletica', filing:'Nov 2025', px:307.2, rev:11073, fcf:1128, sh:120.2, nc:1800, cagr:10, cur:'USD', sec:'con', cx:733, bt:1.3, sbc:56, cffo:1861},
  {t:'TGT', n:'Target Corp.', filing:'Nov 2025', px:125.6, rev:105242, fcf:3009, sh:456.4, nc:-15800, cagr:3, cur:'USD', sec:'con', cx:3765, bt:1.0, sbc:272, cffo:6774},
  {t:'HD', n:'Home Depot', filing:'Nov 2025', px:398.2, rev:166189, fcf:13927, sh:994.5, nc:-52000, cagr:5, cur:'USD', sec:'con', cx:3722, bt:1.0, sbc:522, cffo:17649, cn:["Cash Aq of 5279"]},
  {t:'LOW', n:'Lowe\'s Companies', filing:'TTM (Oct 2025)', px:244.8, rev:84255, fcf:7050, sh:561.3, nc:-36000, cagr:5, cur:'USD', sec:'con', cx:2158, bt:1.05, sbc:234, cffo:9208, cn:["Cash Aq of 10055"]},
  {t:'PG', n:'Procter & Gamble', filing:'TTM (Dec 2025)', px:169.4, rev:85259, fcf:14848, sh:2438.6, nc:-29000, cagr:4, cur:'USD', sec:'con', cx:4222, bt:0.45, sbc:497, cffo:19070},
  {t:'KO', n:'Coca-Cola Co.', filing:'TTM (Dec 2025)', px:63.2, rev:47941, fcf:5296, sh:4313.0, nc:-38000, cagr:4, cur:'USD', sec:'con', cx:2112, bt:0.6, sbc:279, cffo:7408},
  {t:'PEP', n:'PepsiCo Inc.', filing:'TTM (Dec 2025)', px:150.3, rev:93925, fcf:7672, sh:1373.0, nc:-42000, cagr:4, cur:'USD', sec:'con', cx:4415, bt:0.55, sbc:288, cffo:12087, cn:["Cash Aq of 3391"]},
  {t:'MDLZ', n:'Mondelez Intl.', filing:'TTM (Dec 2025)', px:62.4, rev:38537, fcf:3235, sh:1298.0, nc:-21000, cagr:5, cur:'USD', sec:'con', cx:1279, bt:0.55, sbc:114, cffo:4514},
  {t:'EL', n:'Estee Lauder', filing:'TTM (Dec 2025)', px:70.3, rev:14671, fcf:1137, sh:361.1, nc:-8600, cagr:6, cur:'USD', sec:'con', cx:533, bt:1.15, sbc:306, cffo:1670},
  {t:'UBER', n:'Uber Technologies', filing:'TTM (Dec 2025)', px:74.5, rev:52017, fcf:9763, sh:2119.7, nc:5900, cagr:18, cur:'USD', sec:'con', cx:336, bt:1.4, sbc:1826, cffo:10099, cn:["Cash Aq of 815"]},
  {t:'ABNB', n:'Airbnb Inc.', filing:'TTM (Dec 2025)', px:141.2, rev:12241, fcf:4646, sh:623.0, nc:9400, cagr:12, cur:'USD', sec:'con', cx:0, bt:1.45, sbc:1592, cffo:4646},
  {t:'SPOT', n:'Spotify Technology', filing:'TTM (Dec 2025)', px:659.8, rev:20190, fcf:3374, sh:210.5, nc:5400, cagr:15, cur:'USD', sec:'con', cx:72, bt:1.6, sbc:290, cffo:3446},
  {t:'DIS', n:'Walt Disney Co.', filing:'TTM (Dec 2025)', px:100.2, rev:95716, fcf:7060, sh:1804.8, nc:-40000, cagr:6, cur:'USD', sec:'con', cx:8571, bt:1.05, sbc:1378, cffo:15631},
  {t:'BKNG', n:'Booking Holdings', filing:'TTM (Dec 2025)', px:4912.5, rev:26917, fcf:9087, sh:32.6, nc:-9500, cagr:10, cur:'USD', sec:'con', cx:322, bt:1.3, sbc:617, cffo:9409},
  {t:'CMG', n:'Chipotle Mexican Grill', filing:'TTM (Dec 2025)', px:58.4, rev:11926, fcf:1448, sh:1342.6, nc:-100, cagr:15, cur:'USD', sec:'con', cx:666, bt:1.2, sbc:120, cffo:2114},
  {t:'DASH', n:'DoorDash Inc.', filing:'TTM (Dec 2025)', px:185.7, rev:13717, fcf:2174, sh:439.7, nc:5100, cagr:20, cur:'USD', sec:'con', cx:257, bt:1.55, sbc:1051, cffo:2431, cn:["Cash Aq of 4151"]},
  {t:'LLY', n:'Eli Lilly & Co.', filing:'TTM (Dec 2025)', px:848.4, rev:65179, fcf:9332, sh:899.3, nc:-19000, cagr:20, cur:'USD', sec:'hc', cx:7481, bt:0.5, sbc:626, cffo:16813},
  {t:'JNJ', n:'Johnson & Johnson', filing:'TTM (Dec 2025)', px:157.3, rev:94193, fcf:19698, sh:2429.4, nc:-14000, cagr:5, cur:'USD', sec:'hc', cx:4832, bt:0.55, sbc:1354, cffo:24530, cn:["Cash Aq of 17541"]},
  {t:'UNH', n:'UnitedHealth Group', filing:'TTM (Dec 2025)', px:478.2, rev:447567, fcf:16075, sh:911.0, nc:-8000, cagr:10, cur:'USD', sec:'hc', cx:3622, bt:0.7, sbc:0, cffo:19697, cn:["Cash Aq of 4509"]},
  {t:'ABBV', n:'AbbVie Inc.', filing:'TTM (Dec 2025)', px:189.4, rev:61160, fcf:17816, sh:1773.0, nc:-62000, cagr:6, cur:'USD', sec:'hc', cx:1214, bt:0.6, sbc:955, cffo:19030, cn:["Cash Aq of 5411"]},
  {t:'PFE', n:'Pfizer Inc.', filing:'Sep 2025', px:27.2, rev:62579, fcf:10376, sh:5713.0, nc:-48000, cagr:4, cur:'USD', sec:'hc', cx:2701, bt:0.65, sbc:751, cffo:13077},
  {t:'TMO', n:'Thermo Fisher Sci.', filing:'TTM (Dec 2025)', px:557.3, rev:44556, fcf:6293, sh:378.0, nc:-30000, cagr:8, cur:'USD', sec:'hc', cx:1525, bt:0.75, sbc:0, cffo:7818, cn:["Cash Aq of 4037"]},
  {t:'ISRG', n:'Intuitive Surgical', filing:'TTM (Dec 2025)', px:582.8, rev:10064, fcf:2491, sh:362.7, nc:8200, cagr:15, cur:'USD', sec:'hc', cx:539, bt:1.1, sbc:788, cffo:3030},
  {t:'AMGN', n:'Amgen Inc.', filing:'TTM (Dec 2025)', px:292.4, rev:36751, fcf:8100, sh:542.0, nc:-56000, cagr:5, cur:'USD', sec:'hc', cx:1858, bt:0.65, sbc:494, cffo:9958},
  {t:'GILD', n:'Gilead Sciences', filing:'TTM (Dec 2025)', px:107.8, rev:29443, fcf:9456, sh:1255.0, nc:-22000, cagr:4, cur:'USD', sec:'hc', cx:563, bt:0.65, sbc:835, cffo:10019},
  {t:'VRTX', n:'Vertex Pharma', filing:'TTM (Dec 2025)', px:432.6, rev:12001, fcf:3194, sh:258.0, nc:11400, cagr:18, cur:'USD', sec:'hc', cx:437, bt:0.45, sbc:686, cffo:3631},
  {t:'BMY', n:'Bristol-Myers Squibb', filing:'TTM (Dec 2025)', px:53.8, rev:48194, fcf:12845, sh:2039.0, nc:-48000, cagr:3, cur:'USD', sec:'hc', cx:1311, bt:0.5, sbc:553, cffo:14156, cn:["Cash Aq of 3944"]},
  {t:'MDT', n:'Medtronic PLC', filing:'Jan 2026', px:84.6, rev:35484, fcf:5410, sh:1288.1, nc:-23000, cagr:5, cur:'USD', sec:'hc', cx:1875, bt:0.75, sbc:451, cffo:7285},
  {t:'DHR', n:'Danaher Corp.', filing:'TTM (Dec 2025)', px:222.5, rev:24568, fcf:5260, sh:716.1, nc:-17000, cagr:8, cur:'USD', sec:'hc', cx:1156, bt:0.8, sbc:298, cffo:6416},
  {t:'ABT', n:'Abbott Laboratories', filing:'TTM (Dec 2025)', px:122.4, rev:44328, fcf:7395, sh:1748.0, nc:-14000, cagr:6, cur:'USD', sec:'hc', cx:2171, bt:0.7, sbc:644, cffo:9566},
  {t:'REGN', n:'Regeneron Pharma', filing:'TTM (Dec 2025)', px:729.5, rev:14343, fcf:4081, sh:108.6, nc:16000, cagr:8, cur:'USD', sec:'hc', cx:898, bt:0.35, sbc:994, cffo:4979, cn:["Intangibles purchase of 315"]},
  {t:'XOM', n:'Exxon Mobil', filing:'TTM (Dec 2025)', px:108.5, rev:323905, fcf:23612, sh:4305.0, nc:-43000, cagr:3, cur:'USD', sec:'energy', cx:28358, bt:0.8, sbc:0, cffo:51970, cn:["Sale of CAPEX of 3158"]},
  {t:'CVX', n:'Chevron Corp.', filing:'TTM (Dec 2025)', px:151.8, rev:186031, fcf:16600, sh:1855.6, nc:-18000, cagr:3, cur:'USD', sec:'energy', cx:17300, bt:0.85, sbc:0, cffo:33900},
  {t:'COP', n:'ConocoPhillips', filing:'TTM (Dec 2025)', px:98.6, rev:60279, fcf:7243, sh:1253.0, nc:-12000, cagr:3, cur:'USD', sec:'energy', cx:12553, bt:0.95, sbc:0, cffo:19796, cn:["Sale of CAPEX of 3248"]},
  {t:'SLB', n:'Schlumberger (SLB)', filing:'TTM (Dec 2025)', px:42.3, rev:35708, fcf:4367, sh:1437.0, nc:-12000, cagr:5, cur:'USD', sec:'energy', cx:2122, bt:1.2, sbc:332, cffo:6489},
  {t:'ENB', n:'Enbridge Inc.', filing:'TTM (Dec 2025)', px:38.4, rev:47497, fcf:2402, sh:2186.0, nc:-68000, cagr:4, cur:'USD', sec:'energy', cx:6537, bt:0.65, sbc:0, cffo:8939},
  {t:'SHEL', n:'Shell PLC', filing:'TTM (Dec 2025)', px:70.2, rev:266886, fcf:23916, sh:5948.6, nc:-47000, cagr:2, cur:'USD', sec:'energy', cx:18947, bt:0.55, sbc:0, cffo:42863, cn:["Sale of Capex of 1148"]},
  {t:'LMT', n:'Lockheed Martin', filing:'TTM (Dec 2025)', px:457.3, rev:75048, fcf:6908, sh:233.5, nc:-16000, cagr:5, cur:'USD', sec:'ind', cx:1649, bt:0.45, sbc:304, cffo:8557},
  {t:'RTX', n:'RTX Corp.', filing:'TTM (Dec 2025)', px:128.4, rev:88603, fcf:7940, sh:1356.4, nc:-35000, cagr:5, cur:'USD', sec:'ind', cx:2627, bt:0.7, sbc:1092, cffo:10567, cn:["Intangibles purschase of 492", "Divestitures of 1931"]},
  {t:'GE', n:'GE Aerospace', filing:'TTM (Dec 2025)', px:200.8, rev:45855, fcf:7264, sh:1068.0, nc:-9800, cagr:10, cur:'USD', sec:'ind', cx:1273, bt:1.15, sbc:0, cffo:8537},
  {t:'HON', n:'Honeywell Intl.', filing:'TTM (Dec 2025)', px:217.4, rev:37442, fcf:5422, sh:642.8, nc:-24000, cagr:5, cur:'USD', sec:'ind', cx:986, bt:0.9, sbc:196, cffo:6408, cn:["Cash Aq of 2211", "Divestitures of 1157"]},
  {t:'CAT', n:'Caterpillar Inc.', filing:'TTM (Dec 2025)', px:372.8, rev:67589, fcf:7453, sh:472.3, nc:-25000, cagr:5, cur:'USD', sec:'ind', cx:4286, bt:0.95, sbc:0, cffo:11739, cn:["Sale of Capex of 708"]},
  {t:'DE', n:'Deere & Co.', filing:'Feb 2026', px:468.5, rev:46731, fcf:3576, sh:271.4, nc:-60000, cagr:5, cur:'USD', sec:'ind', cx:4125, bt:0.85, sbc:164, cffo:7701, cn:["Sale of Capex of 1861"]},
  {t:'UNP', n:'Union Pacific', filing:'TTM (Dec 2025)', px:237.5, rev:24510, fcf:5499, sh:595.9, nc:-32000, cagr:5, cur:'USD', sec:'ind', cx:3791, bt:0.9, sbc:0, cffo:9290},
  {t:'WM', n:'Waste Management', filing:'TTM (Dec 2025)', px:210.3, rev:25204, fcf:2816, sh:404.2, nc:-18000, cagr:6, cur:'USD', sec:'ind', cx:3227, bt:0.65, sbc:169, cffo:6043},
  {t:'PANW', n:'Palo Alto Networks', filing:'Jan 2026', px:192.3, rev:9894, fcf:3566, sh:711.3, nc:1200, cagr:18, cur:'USD', sec:'tech', cx:408, bt:1.3, sbc:1351, cffo:3974, cn:["Cash Aq of 3133"]},
  {t:'CRWD', n:'CrowdStrike Holdings', filing:'TTM (Oct 2025)', px:390.5, rev:4565, fcf:1173, sh:249.2, nc:2900, cagr:22, cur:'USD', sec:'tech', cx:287, bt:1.45, sbc:1095, cffo:1460, cn:["Cash Aq of 594"]},
  {t:'ZS', n:'Zscaler Inc.', filing:'TTM (Oct 2025)', px:203.7, rev:2833, fcf:924, sh:155.9, nc:2400, cagr:25, cur:'USD', sec:'tech', cx:164, bt:1.5, sbc:693, cffo:1089, cn:["Cash Aq of 673"]},
  {t:'DDOG', n:'Datadog Inc.', filing:'TTM (Dec 2025)', px:132.4, rev:3427, fcf:1000, sh:363.5, nc:2800, cagr:22, cur:'USD', sec:'tech', cx:50, bt:1.4, sbc:751, cffo:1050, cn:["Purchase of Intangibles of 85", "Cash Aq of 118"]},
  {t:'NET', n:'Cloudflare Inc.', filing:'TTM (Dec 2025)', px:113.8, rev:2167, fcf:288, sh:348.4, nc:1300, cagr:28, cur:'USD', sec:'tech', cx:315, bt:1.65, sbc:452, cffo:603},
  {t:'MDB', n:'MongoDB Inc.', filing:'TTM (Oct 2025)', px:242.5, rev:2317, fcf:346, sh:80.4, nc:1800, cagr:20, cur:'USD', sec:'tech', cx:30, bt:1.55, sbc:532, cffo:376},
  {t:'TEAM', n:'Atlassian Corp.', filing:'TTM (Dec 2025)', px:274.3, rev:5759, fcf:1281, sh:263.1, nc:2200, cagr:18, cur:'USD', sec:'tech', cx:53, bt:1.2, sbc:1501, cffo:1334, cn:["Cash Aq of 1238"]},
  {t:'WDAY', n:'Workday Inc.', filing:'TTM (Oct 2025)', px:263.7, rev:9231, fcf:2585, sh:269.8, nc:3200, cagr:15, cur:'USD', sec:'tech', cx:188, bt:1.15, sbc:1624, cffo:2773, cn:["Cash Aq of 975"]},
  {t:'TWLO', n:'Twilio Inc.', filing:'TTM (Dec 2025)', px:107.6, rev:5067, fcf:997, sh:159.8, nc:3800, cagr:10, cur:'USD', sec:'tech', cx:6, bt:1.35, sbc:600, cffo:1003, cn:["Purschase of Intangibles of 52", "Cash Aq of 61,5"]},
  {t:'HUBS', n:'HubSpot Inc.', filing:'TTM (Dec 2025)', px:746.2, rev:3131, fcf:707, sh:53.2, nc:1900, cagr:18, cur:'USD', sec:'tech', cx:53, bt:1.4, sbc:528, cffo:760, cn:["Purschase of Intangibles of 131", "Cash Aq of 87"]},
  {t:'SAP', n:'SAP SE', filing:'TTM (Dec 2025)', px:258.4, rev:43233, fcf:9888, sh:1175.0, nc:1800, cagr:10, cur:'EUR', sec:'tech', cx:868, bt:1.0, sbc:1031, cffo:10756, cn:["Cash Aq of 824", "Sale of Capex of 142"]},
  {t:'BABA', n:'Alibaba Group', filing:'Sep 2025', px:144.2, rev:142156, fcf:370, sh:2395.7, nc:61000, cagr:8, cur:'USD', sec:'tech', cx:17778, bt:0.6, sbc:1962, cffo:18148},
  {t:'TCEHY', n:'Tencent Holdings', filing:'Sep 2025', px:56.8, rev:102516, fcf:29260, sh:9268.5, nc:76000, cagr:10, cur:'USD', sec:'tech', cx:11561, bt:0.65, sbc:2907, cffo:40821, cn:["Intangibles purchase of 4652", "Cash aq of 1102"]},
  {t:'SONY', n:'Sony Group Corp.', filing:'TTM (Dec 2025)', px:21.3, rev:84085, fcf:10370, sh:5998.0, nc:-3000, cagr:8, cur:'USD', sec:'con', cx:2724, bt:0.9, sbc:0, cffo:13094, cn:["Cash aq of 662"]},
  {t:'TM', n:'Toyota Motor Corp.', filing:'TTM (Dec 2025)', px:188.2, rev:322103, fcf:2581, sh:13041.2, nc:-140000, cagr:4, cur:'USD', sec:'con', cx:27062, bt:0.6, sbc:0, cffo:29643, cn:["Sale of Intangibles of 6990,6"]},
  {t:'LVMUY', n:'LVMH Moët Hennessy', filing:'TTM (Dec 2025)', px:130.6, rev:94933, fcf:17655, sh:498.0, nc:-26000, cagr:8, cur:'EUR', sec:'con', cx:4518, bt:0.85, sbc:0, cffo:22173, cn:["Purchase of intangibles of 962,2"]},
  {t:'NVO', n:'Novo Nordisk', filing:'TTM (Dec 2025)', px:80.4, rev:48631, fcf:9278, sh:4447.7, nc:-5000, cagr:15, cur:'USD', sec:'hc', cx:9462, bt:0.55, sbc:226, cffo:18740, cn:["Purchase of intangibles of 4716"]},
  {t:'AZN', n:'AstraZeneca PLC', filing:'TTM', px:68.5, rev:58739, fcf:11765, sh:1562.0, nc:-22000, cagr:10, cur:'USD', sec:'hc', cx:2810, bt:0.4, sbc:0, cffo:14575, cn:["Purchase of intangibles of 2959", "Cash aquisition of 1230"]},];
// Deduplicate and build lookup
const DB_MAP = {};
_RAW_DB.forEach(c => { if (!DB_MAP[c.t]) DB_MAP[c.t] = c; });
const DB = Object.values(DB_MAP);

// Sector display labels
const SEC_LABEL = {
  tech:'Technology', semi:'Semiconductors', fin:'Finance',
  con:'Consumer', hc:'Healthcare', energy:'Energy', ind:'Industrial',
};


/* ══════════════════════════════════════════
   ENGINE
══════════════════════════════════════════ */
function pf(s){
  if(s===null||s===undefined||s==='')return NaN;
  s=String(s).trim();
  // Strip any spaces used as thousand separators (regular, thin, non-breaking)
  s=s.replace(/[\s\u2009\u00A0]/g,'');
  // Detect comma-as-decimal: if comma appears once and after it are exactly 1-2 digits at end
  // e.g. "199,78" or "1,5" → treat comma as decimal point
  // But "1,000" or "1,000,000" → treat commas as thousand separators
  const commaCount=(s.match(/,/g)||[]).length;
  const dotCount=(s.match(/\./g)||[]).length;
  if(commaCount===1&&dotCount===0&&/,\d{1,2}$/.test(s)){
    // Single comma followed by 1-2 digits — decimal separator
    s=s.replace(',','.');
  } else {
    // Strip commas as thousand separators
    s=s.replace(/,/g,'');
  }
  const n=parseFloat(s);
  return isNaN(n)?NaN:n;
}
function linspace(a,b,n){const r=[];for(let i=0;i<n;i++)r.push(a+(b-a)*i/Math.max(n-1,1));return r}

function projectFCFs(inp){
  const rows=[];let rev=inp.revLTM,marg=inp.fcfMargin;
  for(let y=1;y<=inp.years;y++){
    rev*=(1+inp.cagr);marg+=inp.dpp;
    const fcf=rev*marg,df=1/Math.pow(1+inp.disc,y);
    rows.push({year:y,rev,marg,fcf,df,discFcf:fcf*df});
  }
  return rows;
}
function terminalPV(inp,lastFCF){
  let tv;
  if(inp.termMode==='multiple')tv=lastFCF*inp.tmult;
  else{const gap=Math.max(inp.disc-inp.tg,.001);tv=lastFCF*(1+inp.tg)/gap}
  return tv/Math.pow(1+inp.disc,inp.years);
}
function fairValue(inp){
  const rows=projectFCFs(inp);
  const pvFCFs=rows.reduce((s,r)=>s+r.discFcf,0);
  const lastFCF=rows[rows.length-1].fcf;
  if(!isFinite(lastFCF)||lastFCF<=0)return{ok:false,rows};
  const pvTV=terminalPV(inp,lastFCF);
  // FCFE (default): no net debt adjustment — cash flows already reflect equity perspective
  // FCFF (optional): subtract net debt to bridge enterprise value → equity value
  const netDebtAdj = inp.useFCFF ? inp.netDebt : 0;
  const equityPV=pvFCFs+pvTV-netDebtAdj;
  if(equityPV<=0)return{ok:false,pvFCFs,pvTV,equityPV,lastFCF,rows,netDebtAdj};
  const fvLocal=equityPV/inp.shares;
  return{ok:true,pvFCFs,pvTV,equityPV,fvLocal,fvps:fvLocal*inp.fxRate,lastFCF,rows,netDebtAdj};
}
function impliedIRR(inp,price){
  const pl=price/inp.fxRate;
  let lo=.001,hi=2;
  for(let i=0;i<80;i++){
    const mid=(lo+hi)/2;
    const r=fairValue({...inp,disc:mid});
    if(!r.ok){hi=mid;continue}
    if(r.fvLocal>pl)lo=mid;else hi=mid;
    if(hi-lo<1e-7)break;
  }
  const mid=(lo+hi)/2;
  const r=fairValue({...inp,disc:mid});
  if(!r.ok||Math.abs(r.fvLocal-pl)/Math.max(pl,.01)>.02)return null;
  return mid;
}

/* ══════════════════════════════════════════
   STATE & HELPERS
══════════════════════════════════════════ */
let termMode='growth',activeTab='dcf';
let _sensData=[],_revData=[],_forecastRows=[];

function fmt(n,d=2){if(!isFinite(n))return'—';var s=n.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});return s.replace(/,/g,'\u2009')}
function fmtPct(n,d=1){if(!isFinite(n))return'—';return(n>=0?'+':'')+fmt(n*100,d)+'%'}
function fmtPctPlain(n,d=1){return fmt(n*100,d)+'%'}
function cssVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}

function irrColor(v){
  if(!isFinite(v))return{bg:'var(--surface-2)',fg:'var(--ink-4)'};
  const H=.10;let r,g,b,fg;
  if(v<0){const t=Math.min(-v/.25,1);r=Math.round(235+(140-235)*t);g=Math.round(180+(50-180)*t);b=Math.round(175+(45-175)*t);fg=t>.35?'#fff':'#5C2420'}
  else if(v<H){const t=v/H;r=Math.round(235+(245-235)*t);g=Math.round(180+(230-180)*t);b=Math.round(175+(210-175)*t);fg='#853025'}
  else if(v<.15){const t=(v-H)/.05;r=Math.round(220+(190-220)*t);g=Math.round(235+(225-235)*t);b=Math.round(215+(195-215)*t);fg='#1F5733'}
  else{const t=Math.min((v-.15)/.15,1);r=Math.round(190+(30-190)*t);g=Math.round(225+(130-225)*t);b=Math.round(195+(70-195)*t);fg=t>.35?'#fff':'#1F5733'}
  return{bg:`rgb(${r},${g},${b})`,fg};
}

function getInputs(){
  return{
    company:document.getElementById('inp-company').value.trim(),
    price:pf(document.getElementById('inp-price').value),
    shares:pf(document.getElementById('inp-shares').value),
    revLTM:pf(document.getElementById('inp-revenue').value),
    fcfLTM:pf(document.getElementById('inp-fcf').value),
    netCashRaw:pf(document.getElementById('inp-netcash').value),
    useFCFF:document.getElementById('toggle-fcff')?.checked||false,
    cagr:parseInt(document.getElementById('sl-cagr').value)/100,
    dpp:parseFloat(document.getElementById('sl-dpp').value)/100,
    years:parseInt(document.getElementById('sl-years').value)||10,
    disc:parseInt(document.getElementById('sl-disc').value)/100,
    termMode,
    tg:parseFloat(document.getElementById('sl-tg').value)/100,
    tmult:parseFloat(document.getElementById('sl-tmult').value),
    fccy:document.getElementById('sel-fccy').value,
    pccy:document.getElementById('sel-pccy').value,
    fxRate:pf(document.getElementById('inp-fxrate').value)||1,
  };
}
function buildInp(raw){
  if(!isFinite(raw.revLTM)||raw.revLTM<=0)return null;
  if(!isFinite(raw.fcfLTM))return null;
  if(!isFinite(raw.shares)||raw.shares<=0)return null;
  if(!isFinite(raw.price)||raw.price<=0)return null;
  if(raw.termMode==='multiple'&&(!isFinite(raw.tmult)||raw.tmult<=0))return null;
  const margin=raw.fcfLTM/raw.revLTM;
  if(!isFinite(margin))return null;
  const netDebt=isFinite(raw.netCashRaw)?-raw.netCashRaw:0;
  const fxRate=(raw.fccy===raw.pccy)?1:(isFinite(raw.fxRate)&&raw.fxRate>0?raw.fxRate:1);
  // netDebt only applied in calculation when useFCFF is true
  return{...raw,fcfMargin:margin,netDebt,fxRate};
}

/* ══════════════════════════════════════════
   CONTROLS
══════════════════════════════════════════ */
function clearPills(){document.querySelectorAll('.co-pill').forEach(b=>b.classList.remove('active'))}

/* ══════════════════════════════════════════
   FCFF TOGGLE
══════════════════════════════════════════ */
function onFCFFToggle() {
  const on = document.getElementById('toggle-fcff').checked;
  document.getElementById('netcash-wrap').style.display = on ? '' : 'none';
  const title = document.getElementById('disc-title-text');
  if (title) title.textContent = on ? 'Discount rate (WACC)' : 'Discount rate';
  update();
}

/* ══════════════════════════════════════════
   SBC HANDLING — stock-based compensation
══════════════════════════════════════════ */
let _currentSBC = 0; // SBC amount for currently loaded company
let _baseFCF = null; // FCF before SBC adjustment (from DB or manual entry)
let _recalcingFCF = false; // flag to prevent circular updates

function onSBCToggle() {
  const subtractSBC = document.getElementById('toggle-sbc').checked;
  // Always show/hide SBC field based on toggle
  document.getElementById('sbc-field-wrap').style.display = subtractSBC ? '' : 'none';
  // Recalculate FCF based on toggle
  recalcFCFWithSBC();
  update();
}

function onSBCInput() {
  recalcFCFWithSBC();
  _checkShowReset();
  update();
}

function recalcFCFWithSBC() {
  // Works for both DB-loaded companies and manual entry
  if (_baseFCF === null) return; // no base FCF set yet
  const subtractSBC = document.getElementById('toggle-sbc').checked;
  const sbc = pf(document.getElementById('inp-sbc').value) || 0;
  const adjFCF = subtractSBC ? _baseFCF - sbc : _baseFCF;
  _recalcingFCF = true;
  document.getElementById('inp-fcf').value = fmt(adjFCF, 0);
  _recalcingFCF = false;
}

function applySBCToFCF(co) {
  // Apply SBC deduction based on current toggle state
  if (!co) return co.fcf;
  const subtractSBC = document.getElementById('toggle-sbc')?.checked || true;
  const sbc = co.sbc || 0;
  // Show SBC field and populate it
  const sbcWrap = document.getElementById('sbc-field-wrap');
  if (sbcWrap && sbc > 0 && subtractSBC) {
    sbcWrap.style.display = '';
  } else if (sbcWrap && !subtractSBC) {
    sbcWrap.style.display = 'none';
  }
  _currentSBC = sbc;
  return subtractSBC ? (co.fcf - sbc) : co.fcf;
}

/* ══════════════════════════════════════════
   INFO MODAL — transparency tooltips
══════════════════════════════════════════ */
const INFO_CONTENT = {
  price: {
    title: 'Stock Price',
    subtitle: 'What one piece of this company costs right now',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>Imagine a company is a giant pizza. The stock price is how much one slice costs. If the pizza is really good (the company makes lots of money), people will pay more for a slice. If it's not great, the price drops.</p>
        <p style="margin-top:6px">This is the price you'd pay <strong>right now</strong> to buy one share of the company.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Where does this number come from?</div>
        <p>When you pick a company from our list, we automatically grab yesterday's closing price from <strong>Polygon.io</strong> (a financial data service). It's not a live, second-by-second quote — it's the price from the end of the last trading day.</p>
        <div class="im-note">You can always type in a different price if you want to test "what if the stock drops to $X?" scenarios.</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">How is it used?</div>
        <p>We compare this price against the <strong>fair value</strong> our model calculates. If fair value is higher than the stock price, the model says the stock might be a bargain. If fair value is lower, the model says it might be expensive.</p>
      </div>
    `
  },
  shares: {
    title: 'Total Shares',
    subtitle: 'How many slices has this pizza been cut into?',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>If the company is a pizza, shares are the slices. The more slices, the smaller each one is. This number tells you how many total slices exist — in <strong>millions</strong>.</p>
        <p style="margin-top:6px">We use the <strong>"diluted"</strong> number, which includes extra slices the company might create in the future (from employee stock options). This is the safer number because it assumes the pie will be cut into more pieces.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Where does it come from?</div>
        <p>From the company's latest report to investors. The number changes over time — some companies buy back slices (making yours bigger), while others create new ones (making yours smaller).</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Why does it matter?</div>
        <p>To figure out what one slice is worth, we divide the total value of the pizza by the number of slices. More slices = each one is worth less.</p>
        <div class="im-warn">⚠ Companies that give lots of stock to their employees create new slices every year, which slowly makes your slice smaller.</div>
      </div>
    `
  },
  revenue: {
    title: 'Total Revenue',
    subtitle: 'How much money did the company take in this year?',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>Revenue is the total money that came in the door. If you run a lemonade stand and sold 1,000 cups at $1 each, your revenue is $1,000. It's the <strong>biggest number</strong> on the company's scorecard — everything else gets subtracted from it.</p>
        <p style="margin-top:6px">All numbers here are in <strong>millions</strong>. So "45,183" means $45,183,000,000 (about $45 billion).</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Where does it come from?</div>
        <p>From the company's latest annual report. We use the <strong>trailing twelve months (TTM)</strong> — the most recent four quarters added together.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How is it used?</div>
        <p>We take this starting revenue and <strong>grow it each year</strong> by the growth rate you pick. Then we multiply by the cash flow margin to estimate how much actual cash the company will pocket each year. Revenue is the starting line — everything else builds on it.</p>
      </div>
    `
  },
  fcf: {
    title: 'Free Cash Flow (FCF)',
    subtitle: 'The real cash left over after paying for everything',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>Imagine you run a lemonade stand. You sold $100 of lemonade (that's revenue). But you spent $60 on lemons, cups, and a new table. The $40 left over is your <strong>free cash flow</strong> — the real money you can put in your piggy bank.</p>
        <p style="margin-top:6px">For big companies, it's the same idea: cash that came in from selling stuff, minus cash spent running the business and buying equipment.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How we calculate it</div>
        <div class="im-formula">FCF = Cash from operations − Spending on equipment</div>
        <p style="margin-top:6px">When the <strong>"Subtract SBC"</strong> toggle is on (our default), we also subtract stock given to employees, because that dilutes your ownership. This is the safer, more cautious approach.</p>
        <div class="im-formula">Adjusted FCF = Cash from operations − Equipment − Stock pay to employees</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">Why it matters</div>
        <p>Free cash flow is the <strong>heartbeat</strong> of our model. The entire fair value calculation is built on how much free cash the company will generate in the future. More cash = higher value. Negative cash = the model struggles.</p>
        <div class="im-warn">⚠ Negative free cash flow means the company is spending more than it earns. The results will be unreliable unless you increase the FCF margin change slider.</div>
      </div>
    `
  },
  sbc: {
    title: 'Stock-Based Compensation (SBC)',
    subtitle: 'When the company pays workers with stock instead of cash',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>Some companies pay their workers partly with <strong>pieces of the company</strong> (stock) instead of all cash. This is very common at tech companies — sometimes 10–30% of cash flow goes to stock pay.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Why should you care?</div>
        <p>When the company gives stock to workers, it creates <strong>new slices of the pizza</strong>. Your slice doesn't get physically smaller, but the pizza is now cut into more pieces — so each piece is worth a little less. It looks "free" because no cash leaves the bank, but it's a real cost to you as an owner.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Our default: SBC subtracted ✓</div>
        <p>We subtract SBC from free cash flow by default. This is the <strong>safer, more careful</strong> approach. It gives a lower fair value, which protects you from overpaying.</p>
        <p style="margin-top:6px">You can <strong>edit the SBC amount</strong> directly in the field, or toggle it off entirely if the company's stock pay is very small (or if you prefer the standard definition most websites use).</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How we chose the default amount</div>
        <p>The SBC number comes from the company's <strong>cash flow statement</strong> in their most recent annual or quarterly filing. We pre-fill it for you, but you're free to change it to whatever number you think is fair.</p>
      </div>
    `
  },
  fcff: {
    title: 'Whole-Firm Valuation (FCFE vs FCFF)',
    subtitle: 'Two ways to figure out what a company is worth',
    body: `
      <div class="im-section">
        <div class="im-section-title">The simple way (default: off)</div>
        <p>Normally, we just look at <strong>the cash that belongs to you</strong>, the shareholder, and divide by the number of shares. Simple.</p>
        <div class="im-formula">Fair value = future shareholder cash ÷ number of shares</div>
        <p style="margin-top:6px">This works great for most companies. The cash flows already factor in any loan payments the company makes.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">The whole-firm way (toggle on)</div>
        <p>When you flip this on, we first value the <strong>entire business</strong> — what it's worth to everybody (shareholders + lenders). Then we subtract the company's debts and add its cash to figure out what's left for you.</p>
        <div class="im-formula">Fair value = (total business value − debt + cash) ÷ shares</div>
        <p style="margin-top:6px">This is useful for companies with <strong>huge cash piles</strong> (like Alphabet's $93B) or <strong>lots of debt</strong> (like some airlines), because those amounts really change what each share is worth.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Which should you use?</div>
        <p>For most companies, both give similar answers. Start with the default (off). Only turn it on if the company has extreme amounts of cash or debt.</p>
        <div class="im-note">When you turn this on, a "Net cash" field appears. We default it to <strong>zero</strong> — you fill in the company's cash minus debt if you want to use this method.</div>
      </div>
    `
  },
  netcash: {
    title: 'Net Cash / (Net Debt)',
    subtitle: 'How much cash the company has after paying off all its loans',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>Imagine you have $50 in your piggy bank but you owe your friend $30. Your "net cash" is $20. If you owed $80 instead, your "net cash" would be −$30 (that's net <em>debt</em>).</p>
        <div class="im-formula">Net cash = Money in the bank − Money owed to lenders</div>
        <p style="margin-top:6px"><strong>Positive number</strong> = the company has more cash than debt (good). <strong>Negative number</strong> = the company owes more than it has (adds risk).</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Our default: zero</div>
        <p>We start with <strong>zero</strong> because this field only matters when you turn on "whole-firm valuation." Rather than guessing, we leave it at zero and let you fill in the correct number from the balance sheet if you want to use this method.</p>
      </div>
      <div class="im-warn">⚠ This field is only used when the "Use whole-firm valuation" toggle is on. In the default mode, it is completely ignored.</div>
    `
  },
  years: {
    title: 'Forecast Period',
    subtitle: 'How many years into the future are we guessing?',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>This is how many years we look ahead and try to predict the company's cash flow, one year at a time. It's like saying "I'm going to guess how much this lemonade stand will make for the next 10 summers."</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Our default: 10 years</div>
        <p>We use <strong>10 years</strong> as the default. Why?</p>
        <p style="margin-top:6px">It's a sweet spot. Too short (3–4 years) and you miss a lot of the company's future growth. Too long (15+ years) and your guesses get really unreliable — nobody can predict that far ahead accurately.</p>
        <p style="margin-top:6px">10 years gives growing companies enough time to show their potential, while keeping us honest about the limits of predicting the future.</p>
        <div class="im-note">After these years, the "terminal value" takes over — that's our way of saying "and then it grows slowly forever." In most models, 60–80% of the fair value actually comes from that forever part.</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">When to change it</div>
        <p><strong>Shorter (3–5 years):</strong> for big, slow-growing companies where the growth phase is basically over.</p>
        <p><strong>Longer (12–15 years):</strong> for young, fast-growing companies where you believe the high growth will last a long time.</p>
      </div>
    `
  },
  cagr: {
    title: 'Revenue Growth Rate',
    subtitle: 'How fast do you think this company will grow each year?',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>If your lemonade stand made $100 this year and you think it'll make $110 next year, that's 10% growth. This slider sets how fast you think the company's revenue will grow <strong>every single year</strong> during the forecast period.</p>
        <div class="im-formula">Next year's revenue = This year's revenue × (1 + growth rate)</div>
        <p style="margin-top:6px">At 10% growth, revenue doubles in about 7 years. At 20%, it doubles in about 4.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How we chose the default</div>
        <p>We default to <strong>10% revenue growth</strong> for every company. Why?</p>
        <p style="margin-top:6px">The long-run average return of the stock market is roughly 10% per year, which makes it a sensible neutral starting point. It's high enough to be realistic for healthy growing companies, but conservative enough that you're not baking in aggressive assumptions from the start.</p>
        <p style="margin-top:6px">Of course, every company is different — a mature utility won't grow at 10%, and a hot tech company might grow much faster. That's why this is a slider: adjust it to match your own view of the company.</p>
        <div class="im-note">Tip: Start at 10%, then ask yourself — does this company deserve a higher or lower growth rate? Adjust from there.</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">How much does it matter?</div>
        <p>A <strong>lot.</strong> This is one of the most sensitive inputs. Changing the growth rate by just 5 percentage points can move the fair value by 30–50%. That's why we always recommend testing several different growth rates instead of trusting just one number.</p>
        <div class="im-warn">⚠ The S&P 500 grows revenue at roughly 5–7% per year over the long run. Anything above that is "above average" and carries more risk if the company disappoints.</div>
      </div>
    `
  },
  dpp: {
    title: 'FCF Margin Change',
    subtitle: 'Will the company get better or worse at turning sales into cash?',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>The "FCF margin" is what percentage of revenue turns into actual free cash. If a company makes $100 in sales and keeps $20 as free cash, its margin is 20%.</p>
        <p style="margin-top:6px">This slider lets you say: <strong>"I think the margin will go up (or down) a little bit each year."</strong> It's measured in "percentage points per year" (pp/yr).</p>
        <p style="margin-top:6px">For example: if the margin starts at 20% and you set +0.5pp/yr, after 10 years the margin would be 25%.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How we chose the default</div>
        <p>We default to <strong>0.0pp</strong> (no change). Why? Because most mature companies have fairly stable margins. Assuming the margin stays flat is the simplest and most honest starting point.</p>
        <p style="margin-top:6px"><strong>The one exception:</strong> if a company currently has <strong>negative free cash flow</strong> (it's losing money), we automatically set a small positive margin increase. This is because the model needs positive cash flow at some point to produce a meaningful value — and it would be unrealistic to assume a money-losing company stays that way forever.</p>
        <div class="im-note">When we auto-adjust for negative FCF, you'll see a notification explaining why. You can always change it yourself.</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">When to change it</div>
        <p><strong>Increase it</strong> (+0.2 to +1.0pp): if you believe the company is getting more efficient — for example, a young software company that will spend less on growth over time.</p>
        <p><strong>Decrease it</strong> (−0.2 to −1.0pp): if you think margins will shrink — for example, a company facing new competitors or rising costs.</p>
        <p><strong>Leave it at zero:</strong> if you think margins will stay roughly the same. This is the safest assumption for most companies.</p>
      </div>
    `
  },
  terminal: {
    title: 'After the Forecast — Terminal Value',
    subtitle: 'What happens to the company after we stop guessing year by year?',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>After our year-by-year forecast ends (say, after 10 years), the company doesn't just disappear. It keeps making money! The <strong>terminal value</strong> is our way of estimating all that future cash in one big number.</p>
        <p style="margin-top:6px">This is actually the <strong>most important part</strong> of the model — typically 60–80% of the total fair value comes from the terminal value. So small changes here make a big difference.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Method 1: Perpetual Growth (default)</div>
        <p>We assume the company grows at a <strong>slow, steady rate forever</strong> after the forecast ends. Think of it as the company cruising along at a comfortable speed.</p>
        <div class="im-formula">Terminal Value = Last year's cash flow × (1 + growth rate) ÷ (discount rate − growth rate)</div>
        <p style="margin-top:6px"><strong>Our default growth rate: 2.5%</strong> — This roughly matches the long-run growth of the economy (GDP). It's like saying "this company will grow about as fast as the economy overall." If the company's historical growth was very low (below 5%), we set the terminal rate even lower to be safe.</p>
        <div class="im-warn">⚠ The growth rate here must be <strong>lower</strong> than your discount rate. Otherwise the math gives an impossible (infinite) answer.</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">Method 2: Exit Multiple</div>
        <p>Instead of assuming forever-growth, we pretend someone <strong>buys the whole company</strong> at the end of the forecast for a certain price.</p>
        <div class="im-formula">Terminal Value = Last year's cash flow × a multiple (like 15×)</div>
        <p style="margin-top:6px">A multiple of 15–25× is typical for good businesses. This approach avoids the "forever growth" assumption but requires you to guess what a buyer would pay.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">Which should you use?</div>
        <p>Both are fine! Many professionals run both and compare. If the two methods give very different answers, it's a sign that one of your assumptions needs rethinking.</p>
      </div>
    `
  },
  disc: {
    title: 'Discount Rate',
    subtitle: 'A dollar today is worth more than a dollar in the future',
    body: `
      <div class="im-section">
        <div class="im-section-title">What is this?</div>
        <p>Imagine someone offers you $100 today or $100 in 10 years. You'd take the money today, right? Because you could invest it and turn it into more than $100 by then.</p>
        <p style="margin-top:6px">The <strong>discount rate</strong> is the number we use to figure out how much less future money is worth compared to money today. A 12% rate means: "$100 one year from now is only worth about $89 to me today."</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How we chose the default: 12%</div>
        <p>We default to <strong>12%</strong> because it builds in a safety cushion:</p>
        <p style="margin-top:6px">The stock market has returned about <strong>10% per year</strong> on average over the long run. By using 12%, we're saying "I want to do a little better than average." If a stock still looks good at 12%, it's probably a solid opportunity.</p>
        <p style="margin-top:6px">Think of it as your <strong>personal "bar"</strong> — the minimum return you want. If you're cautious, raise it. If you're optimistic, lower it.</p>
      </div>
      <div class="im-section">
        <div class="im-section-title">How does it change the result?</div>
        <p><strong>Higher rate → lower fair value</strong> (you're being stricter about what future cash is worth).</p>
        <p><strong>Lower rate → higher fair value</strong> (you're being more generous about future cash).</p>
        <div class="im-warn">⚠ This is the single most powerful slider. Small changes make big differences. Always try a few different rates to see how much the answer moves.</div>
      </div>
      <div class="im-section">
        <div class="im-section-title">Quick reference</div>
        <div style="margin:6px 0">
          <span class="im-tag im-tag-blue">8%</span> Easy-going — for very safe, boring companies
        </div>
        <div style="margin:6px 0">
          <span class="im-tag im-tag-blue">10%</span> Roughly the historical stock market average
        </div>
        <div style="margin:6px 0">
          <span class="im-tag im-tag-blue">12%</span> Our default — a cautious safety cushion above average
        </div>
        <div style="margin:6px 0">
          <span class="im-tag im-tag-blue">15%</span> Strict — Warren Buffett's often-cited personal target
        </div>
        <div style="margin:6px 0">
          <span class="im-tag im-tag-blue">20%+</span> Very strict — for risky or unpredictable businesses
        </div>
      </div>
    `
  },
};

// Dynamic info generators — return {title, subtitle, body} using live state
function _dynamicInfo(key) {
  const co = _currentTicker ? DB_MAP[_currentTicker] : null;
  const isFCFF = document.getElementById('toggle-fcff')?.checked || false;
  const curDisc = parseInt(document.getElementById('sl-disc')?.value || 12);

  if (key === 'discrate') {
    if (isFCFF) {
      return {
        title: 'Discount Rate (WACC mode)',
        subtitle: 'A dollar today is worth more than a dollar in the future',
        body: `
          <div class="im-section">
            <div class="im-section-title">What is a discount rate?</div>
            <p>Imagine someone offers you $100 today or $100 in 10 years. You'd take the money today, right? Because you could invest it and grow it. The <strong>discount rate</strong> is the number we use to figure out how much less future money is worth compared to today's money.</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">Why it says "WACC" right now</div>
            <p>You turned on <strong>whole-firm valuation</strong>. In this mode, we value the whole company — what shareholders own AND what the company borrowed. The "official" discount rate for this is called <strong>WACC</strong> (Weighted Average Cost of Capital).</p>
            <p style="margin-top:6px">WACC mixes two things: what shareholders want to earn (higher, ~10%) and what lenders charge (lower, ~4%). For most companies, WACC lands between <strong>7% and 12%</strong>.</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">You don't have to use WACC</div>
            <p>You can just use <strong>your own personal target</strong>. Ask yourself: "What return per year do I need from this investment?" and type that number. That's perfectly valid — even Warren Buffett does it this way.</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">Why we default to 12%</div>
            <p>The stock market has returned about <strong>10% per year</strong> on average. We add a little safety cushion and use 12%. If a stock still looks good at 12%, it's probably a solid deal.</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">Quick reference</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">8%</span> Typical WACC for stable companies with some debt</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">10%</span> Average stock market return</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">12%</span> Our default — cautious safety cushion</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">15%+</span> Very strict — for risky businesses</div>
          </div>
          <div class="im-section">
            <div class="im-section-title">Your current setting: ${curDisc}%</div>
            <p>The chart below shows how fair value changes at different rates. Play with the slider to see how sensitive the answer is.</p>
            <div class="im-warn">⚠ This is the most powerful slider. Small changes make big differences. Always try a few rates!</div>
          </div>
        `
      };
    } else {
      return {
        title: 'Discount Rate',
        subtitle: 'A dollar today is worth more than a dollar in the future',
        body: `
          <div class="im-section">
            <div class="im-section-title">What is this?</div>
            <p>Imagine someone offers you $100 today or $100 in 10 years. You'd take the money today, right? Because you could invest it and grow it into more than $100 by then.</p>
            <p style="margin-top:6px">The <strong>discount rate</strong> is the number we use to figure out how much less future money is worth compared to today's money. At 12%, "$100 next year is only worth about $89 to me today."</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">How to pick one (it's simpler than you think)</div>
            <p>Just ask yourself: <strong>"What yearly return do I need from this stock?"</strong></p>
            <p style="margin-top:6px">If you'd be happy earning 10% a year, use 10%. If you want 15%, use 15%. This is personal — it depends on your goals. Warren Buffett doesn't use fancy formulas — he just picks a personal target. If it works for him, it works.</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">Why we default to 12%</div>
            <p>The stock market has returned about <strong>10% per year</strong> on average over the long run. We use 12% — a little above average — as a <strong>built-in safety cushion</strong>. If a stock still looks like a good deal at 12%, it's probably worth a closer look.</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">How it changes the result</div>
            <p><strong>Higher rate → lower fair value</strong> (you're being stricter).</p>
            <p><strong>Lower rate → higher fair value</strong> (you're being more generous).</p>
          </div>
          <div class="im-section">
            <div class="im-section-title">Quick reference</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">8%</span> Easy-going — for very safe, boring companies</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">10%</span> Roughly the historical stock market average</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">12%</span> Our default — cautious safety cushion</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">15%</span> Strict — Buffett's often-cited personal target</div>
            <div style="margin:6px 0"><span class="im-tag im-tag-blue">20%+</span> Very strict — for risky or unpredictable businesses</div>
          </div>
          <div class="im-section">
            <div class="im-section-title">Your current setting: ${curDisc}%</div>
            <p>The chart below shows how fair value changes at different rates. Play with the slider to see how much the answer moves.</p>
            <div class="im-warn">⚠ This is the most powerful slider. Small changes make big differences. Always try a few rates!</div>
          </div>
          <div class="im-section">
            <div class="im-section-title">Tip: the Implied Return tab</div>
            <p>The "Implied Return" tab flips the question — instead of you picking a rate, it tells you what return the market price is <em>already baking in</em>. Compare that to your personal target to see if the stock meets your bar.</p>
          </div>
        `
      };
    }
  }

  if (key === 'fcf') {
    return null; // signal to use static content + append company section in showInfo
  }

  return null;
}

function _parseCN(note) {
  // Parse raw shorthand notes like "Cash Aq of 5279" into structured, professional descriptions
  var lower = note.toLowerCase().trim();
  // Extract the numeric amount (last number token, commas may be decimal separators)
  var amtMatch = note.match(/[\d]+[,.]?[\d]*/g);
  var rawAmt = amtMatch ? amtMatch[amtMatch.length - 1] : null;
  var numVal = rawAmt ? parseFloat(rawAmt.replace(',', '.')) : 0;
  var fmtAmt = fmt(numVal, 0);

  if (/cash\s*a[qc]/i.test(lower)) {
    return { label: 'Cash paid for acquisitions', amount: fmtAmt, deduct: true };
  }
  if (/intangible/i.test(lower) && /purchase|pursch/i.test(lower)) {
    return { label: 'Purchases of intangible assets', amount: fmtAmt, deduct: true };
  }
  if (/sale.*intangible/i.test(lower)) {
    return { label: 'Proceeds from intangible asset sales', amount: fmtAmt, deduct: false };
  }
  if (/sale.*cap/i.test(lower)) {
    return { label: 'Proceeds from asset sales', amount: fmtAmt, deduct: false };
  }
  if (/divestit/i.test(lower)) {
    return { label: 'Proceeds from divestitures', amount: fmtAmt, deduct: false };
  }
  return { label: note, amount: fmtAmt, deduct: false };
}

function showInfo(key) {
  // Try dynamic generator first
  const dyn = _dynamicInfo(key);
  if (dyn && key === 'discrate') {
    document.getElementById('im-title').textContent = dyn.title;
    document.getElementById('im-subtitle').textContent = dyn.subtitle;
    document.getElementById('im-body').innerHTML = dyn.body;
    document.getElementById('info-modal-overlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    return;
  }

  // For 'fcf', use static content + append company-specific section with SBC
  if (key === 'fcf') {
    const c = INFO_CONTENT[key];
    if (!c) return;
    let extraHtml = '';
    const co = _currentTicker ? DB_MAP[_currentTicker] : null;
    if (co && co.cx) {
      const ocf = co.cffo || (co.fcf + co.cx); // Use cffo if available, else compute
      const subtractSBC = document.getElementById('toggle-sbc')?.checked || true;
      const sbcVal = pf(document.getElementById('inp-sbc')?.value) || 0;
      const adjFCF = subtractSBC ? (co.fcf - sbcVal) : co.fcf;
      const margin = ((adjFCF / co.rev) * 100).toFixed(1);
      extraHtml = `
        <div class="im-section">
          <div class="im-section-title">${co.n} — actual numbers (${co.filing})</div>
          <div class="im-formula">
            Operating cash flow: ${fmt(ocf,0)} M ${co.cur}<br>
            Less: Capital expenditure: (${fmt(co.cx,0)}) M ${co.cur}<br>
            ${subtractSBC && sbcVal > 0 ? `Less: Stock-based compensation: (${fmt(sbcVal,0)}) M ${co.cur}<br>` : ''}
            <span style="border-top:1px solid var(--border);display:inline-block;padding-top:4px;margin-top:4px">
              <strong>Free cash flow: ${fmt(adjFCF,0)} M ${co.cur}</strong>${subtractSBC && sbcVal > 0 ? ' (SBC-adjusted)' : ''}
            </span>
          </div>
          <p style="margin-top:8px">FCF margin: <strong>${margin}%</strong> of revenue (${fmt(co.rev,0)} M).${sbcVal > 0 ? ` SBC of ${fmt(sbcVal,0)} M represents ${fmt(sbcVal/ocf*100,1)}% of operating cash flow.` : ''}</p>
        </div>`;
      // ── Additional investing activities (cn notes) ──
      if (co.cn && co.cn.length > 0) {
        const parsed = co.cn.map(_parseCN);
        const deductions = parsed.filter(p => p.deduct);
        const additions = parsed.filter(p => !p.deduct);
        let cnHtml = `<div class="im-section">
          <div class="im-section-title">Other investing activities not included in FCF</div>
          <p style="margin-bottom:8px">The following items from the cash flow statement are <strong>not</strong> included in the free cash flow figure above. Depending on the company, you may want to factor them in.</p>
          <div class="im-formula">`;
        if (deductions.length > 0) {
          deductions.forEach(d => {
            cnHtml += `${d.label}: <strong>${d.amount} M ${co.cur}</strong><br>`;
          });
        }
        if (additions.length > 0) {
          additions.forEach(a => {
            cnHtml += `${a.label}: <strong>${a.amount} M ${co.cur}</strong><br>`;
          });
        }
        cnHtml += `</div>`;
        if (deductions.length > 0) {
          cnHtml += `<p style="margin-top:8px"><strong>When to deduct:</strong> If the company makes <em>regular, recurring</em> acquisitions or intangible asset purchases as part of its core business strategy, consider subtracting these from free cash flow. One-off transactions may not need adjustment.</p>`;
        }
        if (additions.length > 0) {
          cnHtml += `<p style="margin-top:8px"><strong>When to add back:</strong> Proceeds from asset sales or divestitures increase cash available to shareholders. If these are non-recurring, they may not recur in future years — consider whether to include them.</p>`;
        }
        cnHtml += `<div class="im-note">These amounts are shown for reference only. To adjust, manually edit the Free Cash Flow field in the sidebar.</div></div>`;
        extraHtml += cnHtml;
      }
    }
    document.getElementById('im-title').textContent = c.title;
    document.getElementById('im-subtitle').textContent = c.subtitle;
    document.getElementById('im-body').innerHTML = c.body + extraHtml;
    document.getElementById('info-modal-overlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    return;
  }

  // Default static content
  const c = INFO_CONTENT[key];
  if (!c) return;
  document.getElementById('im-title').textContent = c.title;
  document.getElementById('im-subtitle').textContent = c.subtitle;
  document.getElementById('im-body').innerHTML = c.body;
  document.getElementById('info-modal-overlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeInfoModal(e) {
  if (e && e.target !== document.getElementById('info-modal-overlay')) return;
  document.getElementById('info-modal-overlay').classList.remove('show');
  document.body.style.overflow = '';
}

// Close on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeInfoModal({ target: document.getElementById('info-modal-overlay') });
});

/* ── Set data dates in sidebar ── */
function setDataDates(filingStr, priceStr) {
  const wrap = document.getElementById('data-dates');
  const filing = document.getElementById('dd-filing');
  const price = document.getElementById('dd-price');
  if (!wrap) return;
  wrap.style.display = '';
  if (filing) filing.textContent = filingStr || '—';
  if (price) price.textContent = priceStr || '—';
}

function hideOnboardHint(){const h=document.getElementById('onboard-hint');if(h){h.style.display='none';_store.set('vs-onboarded','1')}}

function setBench(v){
  document.getElementById('sl-cagr').value=v;
  onSl('cagr');
}
function syncBenchPills(){
  const v=parseInt(document.getElementById('sl-cagr').value);
  [5,10,20].forEach(n=>{
    const el=document.getElementById('bp-'+n);
    if(el)el.classList.toggle('active',v===n);
  });
}

function onSl(k){
  clearPills();
  if(k==='cagr'){document.getElementById('lbl-cagr').textContent=document.getElementById('sl-cagr').value+'%';syncBenchPills();}
  else if(k==='dpp')document.getElementById('lbl-dpp').textContent=parseFloat(document.getElementById('sl-dpp').value).toFixed(1)+'pp';
  else if(k==='tg')document.getElementById('lbl-tg').textContent=parseFloat(document.getElementById('sl-tg').value).toFixed(1)+'%';
  else if(k==='tmult')document.getElementById('lbl-tmult').textContent=parseFloat(document.getElementById('sl-tmult').value).toFixed(1)+'×';
  else if(k==='years')document.getElementById('lbl-years').textContent=document.getElementById('sl-years').value+' yrs';
  update();
}

function onDiscChange(){
  const v=parseInt(document.getElementById('sl-disc').value);
  document.getElementById('lbl-disc').textContent=v+'%';
  const pct=(v-1)/49*100;
  document.getElementById('disc-thumb').style.left=pct+'%';
  const rs=document.getElementById('rev-sl-disc');
  const rl=document.getElementById('rev-lbl-disc');
  if(rs)rs.value=v;
  if(rl)rl.textContent=v+'%';
  renderDCF();
}
function setDisc(v){document.getElementById('sl-disc').value=v;onDiscChange();}

// Event bindings — deferred to ensure DOM is ready in all environments
// Auto-format number with thin-space thousands on blur
function _autoFmtNum(el) {
  var raw = el.value.trim();
  if (!raw) return;
  var n = pf(raw);
  if (!isFinite(n)) return;
  // Format: integer part gets thin spaces, preserve decimals
  var isNeg = n < 0;
  var abs = Math.abs(n);
  var parts = abs.toString().split('.');
  var intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '\u2009');
  el.value = (isNeg ? '-' : '') + intPart + (parts[1] !== undefined ? '.' + parts[1] : '');
}

// Check if any input field has a value and show/hide reset button
function _checkShowReset() {
  var hasAny = ['inp-company','inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash','inp-sbc'].some(function(id) {
    var el = document.getElementById(id);
    return el && el.value.trim() !== '';
  });
  var rb = document.getElementById('btn-reset');
  if (rb) rb.style.display = hasAny ? '' : 'none';
}

function _bindInputEvents() {
  ['inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash']
    .forEach(function(id){
      var el = document.getElementById(id);
      if(el) {
        el.addEventListener('input',function(){
          clearPills();
          // Track base FCF when user manually types in FCF field
          if(id === 'inp-fcf' && !_recalcingFCF) {
            var val = pf(this.value);
            if(isFinite(val)) {
              var sbcOn = document.getElementById('toggle-sbc').checked;
              var sbcAmt = pf(document.getElementById('inp-sbc').value) || 0;
              // What user typed is the adjusted value; base = adjusted + SBC
              _baseFCF = sbcOn ? val + sbcAmt : val;
            }
          }
          _checkShowReset();
          update();
        });
        el.addEventListener('blur',function(){_autoFmtNum(this);});
      }
    });

  // SBC blur auto-format
  var sbcEl = document.getElementById('inp-sbc');
  if(sbcEl) sbcEl.addEventListener('blur', function(){ _autoFmtNum(this); });

  var companyEl = document.getElementById('inp-company');
  if(companyEl) companyEl.addEventListener('input',function(){
    if(_loadingPreset) return;
    clearPills();
    if(this.value.trim()===''){
      _currentTicker = null;
      _baseFCF = null;
      ['inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash'].forEach(function(id){
        var el=document.getElementById(id); if(el) el.value='';
      });
      var dd=document.getElementById('data-dates'); if(dd) dd.style.display='none';
      var sw=document.getElementById('sb-sum-wrap'); if(sw) sw.style.display='none';
      var pcl=document.getElementById('price-check-link'); if(pcl) pcl.style.display='none';
      document.getElementById('inp-sbc').value='';
    }
    _checkShowReset();
    update();
  });
}

function onCurrencyChange(){
  const f=document.getElementById('sel-fccy').value,p=document.getElementById('sel-pccy').value;
  const diff=f!==p;
  document.getElementById('fx-rate-row').style.display=diff?'':'none';
  document.getElementById('fccy-lbl').textContent=f;
  document.getElementById('pccy-lbl').textContent=p;
  document.getElementById('price-ccy-note').textContent=p;
  update();
}

function setTerm(mode){
  termMode=mode;
  document.getElementById('rb-tg').classList.toggle('active',mode==='growth');
  document.getElementById('rb-tm').classList.toggle('active',mode==='multiple');
  document.getElementById('tg-wrap').style.display=mode==='growth'?'':'none';
  document.getElementById('tm-wrap').style.display=mode==='multiple'?'':'none';
  const isM=mode==='multiple';
  document.getElementById('mc-col-lbl').textContent=isM?'Columns — exit multiple range':'Columns — terminal growth range';
  document.getElementById('mc-min-lbl').textContent=isM?'Min ×':'Min %';
  document.getElementById('mc-max-lbl').textContent=isM?'Max ×':'Max %';
  if(isM){document.getElementById('mc-tmin').value=8;document.getElementById('mc-tmax').value=16}
  else{document.getElementById('mc-tmin').value=0;document.getElementById('mc-tmax').value=4}
  update();
}

function toggleDark(){
  const d=document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme',d?'light':'dark');
  document.getElementById('dark-btn').textContent=d?'🌙':'☀️';
  _store.set('vs-theme',d?'light':'dark');
  setTimeout(()=>{const inp=buildInp(getInputs());if(!inp)return;if(activeTab==='dcf')drawSensChart(inp.price,inp.disc*100);else if(activeTab==='rev'){const irr=impliedIRR(inp,inp.price);drawIRRChart(inp.price,irr,inp.disc)}},50);
}

function loadPreset(key, isAuto) {
  try {
  // If company exists in DB, delegate to loadCompany for proper defaults
  if (DB_MAP[key]) {
    if (!isAuto) hideOnboardHint();
    document.querySelectorAll('.co-pill').forEach(function(b) {
      b.classList.toggle('active', b.querySelector('.pt').textContent.trim() === key);
    });
    loadCompany(key);
    return;
  }
  var p = PRESETS[key]; if (!p) return;
  _loadingPreset = true;
  _currentTicker = key;
  if (!isAuto) hideOnboardHint();

  // Highlight active pill
  document.querySelectorAll('.co-pill').forEach(function(b) {
    b.classList.toggle('active', b.querySelector('.pt').textContent.trim() === key);
  });

  // Fill every field synchronously — no async, no network
  var g = function(id) { return document.getElementById(id); };
  g('inp-company').value = p.company;
  g('inp-shares').value  = p.shares;
  g('inp-revenue').value = p.revenue;
  g('inp-fcf').value     = p.fcf;
  _baseFCF = pf(p.fcf);
  g('inp-netcash').value = p.netcash;
  g('sl-cagr').value     = p.cagr;  g('lbl-cagr').textContent = p.cagr + '%'; syncBenchPills();
  g('sl-dpp').value      = p.dpp;   g('lbl-dpp').textContent  = p.dpp.toFixed(1) + 'pp';
  g('sl-years').value    = p.years; g('lbl-years').textContent = p.years + ' yrs';
  setTerm(p.termMode);
  g('sl-tg').value       = p.tg;    g('lbl-tg').textContent   = p.tg.toFixed(1) + '%';
  g('sl-tmult').value    = p.tmult; g('lbl-tmult').textContent = parseFloat(p.tmult).toFixed(1) + '×';
  g('sel-fccy').value    = p.fccy || 'USD';
  g('sel-pccy').value    = p.pccy || 'USD';
  onCurrencyChange();
  g('btn-reset').style.display = '';

  // Price: always fetch live, never use stored
  g('inp-price').value = '';
  _loadingPreset = false;

  setDataDates('Annual report', 'Fetching price…');

  update();
  // Try to fetch live price for preset ticker
  tryFetchLivePrice(key, 'Annual report');
  } catch(e) { _loadingPreset = false; }
}


function resetInputs(){
  clearPills();
  _currentTicker = null;
  _currentSBC = 0;
  _baseFCF = null;
  document.getElementById('inp-sbc').value = '';
  document.getElementById('toggle-sbc').checked = true;
  // SBC field stays visible since toggle is on
  var sbcWrap = document.getElementById('sbc-field-wrap');
  if (sbcWrap) sbcWrap.style.display = '';
  // Hide data dates and summary
  var ddWrap = document.getElementById('data-dates');
  if (ddWrap) ddWrap.style.display = 'none';
  var sumWrap = document.getElementById('sb-sum-wrap');
  if (sumWrap) sumWrap.style.display = 'none';
  // Hide price check link
  var pcl = document.getElementById('price-check-link');
  if (pcl) pcl.style.display = 'none';
  ['inp-company','inp-price','inp-shares','inp-revenue','inp-fcf','inp-netcash'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('sl-years').value=10;document.getElementById('lbl-years').textContent='10 yrs';
  document.getElementById('sl-cagr').value=10;document.getElementById('lbl-cagr').textContent='10%';syncBenchPills();
  document.getElementById('sl-dpp').value=0;document.getElementById('lbl-dpp').textContent='0.0pp';
  document.getElementById('sl-tg').value=2.5;document.getElementById('lbl-tg').textContent='2.5%';
  document.getElementById('sl-tmult').value=15;document.getElementById('lbl-tmult').textContent='15.0×';
  document.getElementById('sl-disc').value=12;onDiscChange();
  document.getElementById('sel-fccy').value='USD';document.getElementById('sel-pccy').value='USD';
  onCurrencyChange();setTerm('growth');
  document.getElementById('btn-reset').style.display='none';
  update();
}

function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',['dcf','rev','matrix'][i]===t));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  update();
}

function toggleColl(h){h.classList.toggle('open');h.nextElementSibling.classList.toggle('open')}
function showMethodology(){document.getElementById('app-view').style.display='none';document.getElementById('methodology').style.display='block';document.getElementById('meth-btn').textContent='← App';document.getElementById('meth-btn').onclick=hideMethodology}
function hideMethodology(){document.getElementById('app-view').style.display='flex';document.getElementById('methodology').style.display='none';document.getElementById('meth-btn').textContent='How it works';document.getElementById('meth-btn').onclick=showMethodology}
function toggleMobile(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show')}
function closeMobile(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show')}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600)}
function saveReport(){
  const raw=getInputs();
  const inp=buildInp(raw);
  if(!inp){showToast('Enter company data first');return;}
  const res=fairValue(inp);
  const irr=impliedIRR(inp,inp.price);
  const up=res.ok?(res.fvps/inp.price-1):null;
  const date=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  const termStr=inp.termMode==='multiple'?`Exit multiple ${fmt(inp.tmult,1)}×`:`Terminal growth ${fmt(inp.tg*100,1)}%`;

  // Scenario grid — base scenario across growth 0–20%, terminal range
  const isM=inp.termMode==='multiple';
  const growths=[0.05,0.08,0.10,0.12,0.15,0.20];
  const terminals=isM?[8,10,12,15,18]:[0.01,0.02,0.03,0.04];
  function gridHTML(dpp){
    let h=`<tr><th style="text-align:left;padding:6px 10px;font-size:10px;background:#F3EFE7;color:#7A756D;font-family:'JetBrains Mono',monospace;border:1px solid #D5D0C7">Growth ↓ / Terminal →</th>`;
    terminals.forEach(tv=>h+=`<th style="padding:6px 8px;font-size:10px;background:#F3EFE7;color:#7A756D;font-family:'JetBrains Mono',monospace;text-align:center;border:1px solid #D5D0C7">${isM?fmt(tv,0)+'×':fmt(tv*100,1)+'%'}</th>`);
    h+=`</tr>`;
    growths.forEach(g=>{
      h+=`<tr><td style="padding:6px 10px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:600;color:#4D4943;background:#FAF8F3;border:1px solid #D5D0C7">${fmt(g*100,0)}%</td>`;
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv;}else{ci.termMode='growth';ci.tg=tv;}
        const r=impliedIRR(ci,ci.price);
        if(r===null){h+=`<td style="padding:6px 8px;text-align:center;background:#F3EFE7;border:1px solid #D5D0C7;font-family:'JetBrains Mono',monospace;font-size:11px;color:#A9A49B">—</td>`;return;}
        // colour
        let bg,fg;
        if(r<0.05){bg='#E8ABA5';fg='#853025';}
        else if(r<0.08){bg='#F5EDDA';fg='#7A5A20';}
        else if(r<0.10){bg='#F5EDDA';fg='#7A5A20';}
        else if(r<0.13){bg='#D1EDDA';fg='#1F5733';}
        else if(r<0.17){bg='#7CC8A0';fg='#1F5733';}
        else{bg='#1F5733';fg='#ffffff';}
        h+=`<td style="padding:6px 8px;text-align:center;background:${bg};border:1px solid #D5D0C7;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;color:${fg}">${fmt(r*100,1)}%</td>`;
      });
      h+=`</tr>`;
    });
    return h;
  }

  // SVG number line — anchored: fair value always at 28% from left,
  // market price proportional so visual gap reflects real ratio
  // (no SVG coordinate variables needed — using CSS layout now)

  const goodColor=up!==null&&up>=0?'#2E7048':'#853025';
  const goodBg=up!==null&&up>=0?'#E6F2EA':'#F8EDEB';
  const fvDisplay=res.ok?fmt(res.fvps):'N/A';
  const upDisplay=up!==null?`${up>=0?'+':''}${fmt(up*100,1)}%`:'N/A';
  const irrDisplay=irr!==null?`${fmt(irr*100,1)}%`:'N/A';
  // IRR: always neutral — no green/red judgement
  const irrNumColor='#1C1A16';
  const irrBg='#ECE8DF';
  const irrFactLine1=irr!==null
    ?`At the current price of ${fmt(inp.price,2)} ${inp.pccy}, these assumptions imply an annual return of ${fmt(irr*100,1)}%.`
    :'No valid implied return could be solved at this price and these assumptions.';
  const irrFactLine2=irr!==null
    ?`This is the discount rate at which the present value of projected cash flows equals the market price.`
    :'';

  const html=`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>${inp.company||'Valuation'} — Report</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'DM Sans',sans-serif;background:#F3EFE7;color:#1C1A16;font-size:13px;line-height:1.55;letter-spacing:-.005em;-webkit-font-smoothing:antialiased;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .page{max-width:800px;margin:0 auto;padding:48px 48px 64px;background:#F3EFE7}
  .report-header{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:18px;border-bottom:2px solid #1C1A16;margin-bottom:28px}
  .rh-brand{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:#7A756D}
  .rh-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:#7A756D;text-align:right}
  .report-co{margin-bottom:32px}
  .co-name{font-family:'DM Sans',sans-serif;font-size:40px;font-weight:700;letter-spacing:-1px;line-height:1;color:#1C1A16;margin-bottom:7px}
  .co-sub{font-size:11.5px;color:#7A756D;font-family:'JetBrains Mono',monospace;letter-spacing:.2px}
  .section{margin-bottom:28px}
  .section-title{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;color:#9E7528;margin-bottom:14px;padding-bottom:6px;border-bottom:1px solid #D0CBC3}
  /* Inputs grid */
  .inputs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .inp-item{background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);border-radius:8px;padding:11px 13px;border:1px solid rgba(28,26,22,.06);box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}
  .inp-lbl{font-size:9.5px;color:#7A756D;margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
  .inp-val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:500;color:#1C1A16}
  /* Visual cards — stacked full-width */
  .visual-row{display:flex;flex-direction:column;gap:16px;margin-bottom:28px}
  .vis-card{border-radius:14px;padding:28px 32px;border:1px solid rgba(28,26,22,.09);background:linear-gradient(135deg,#F9F7F2 0%,#F0EDE5 100%);box-shadow:0 2px 8px rgba(28,26,22,.05),inset 0 1px 0 rgba(255,255,255,.7)}
  .vis-label{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1.4px;text-transform:uppercase;color:#7A756D;margin-bottom:16px}
  /* Fair value card — two-number comparison layout */
  .fv-vc-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
  .fv-vc-side{display:flex;flex-direction:column}
  .fv-vc-side.right{align-items:flex-end;text-align:right}
  .fv-vc-lbl{font-family:'JetBrains Mono',monospace;font-size:9.5px;font-weight:500;text-transform:uppercase;letter-spacing:.6px;color:#7A756D;margin-bottom:6px}
  .fv-vc-num{font-family:'DM Sans',sans-serif;font-size:52px;font-weight:700;letter-spacing:-2px;line-height:1}
  .fv-vc-ccy{font-family:'JetBrains Mono',monospace;font-size:11px;color:#7A756D;margin-top:5px}
  .fv-vc-mid{display:flex;flex-direction:column;align-items:center;padding:0 24px;gap:3px}
  .fv-vc-divider{width:1px;height:44px;background:#D5D0C7}
  .fv-vc-arrow{font-size:20px;line-height:1;color:#4D4943}
  .fv-vc-delta{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
  .fv-vc-foot{display:flex;align-items:center;gap:8px;margin-top:18px;padding-top:14px;border-top:1px solid #D0CBC3}
  .fv-vc-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600}
  .fv-vc-note{font-size:12px;color:#7A756D}
  /* IRR card — horizontal layout: big number left, description right */
  .irr-row{display:flex;align-items:center;gap:0}
  .irr-left{flex-shrink:0;padding-right:28px;border-right:1px solid #D0CBC3;min-width:130px}
  .irr-num-lbl{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#7A756D;margin-bottom:6px}
  .irr-big{font-family:'DM Sans',sans-serif;font-size:64px;font-weight:700;letter-spacing:-2.5px;line-height:1;color:#1C1A16}
  .irr-right{flex:1;padding-left:28px}
  .irr-desc-head{font-family:'DM Sans',sans-serif;font-size:18px;font-weight:600;color:#1C1A16;line-height:1.25;margin-bottom:10px;letter-spacing:-.2px}
  .irr-desc-body{font-size:12.5px;color:#7A756D;line-height:1.7;font-weight:300}
  /* Scenario grid */
  .grid-note{font-size:11px;color:#7A756D;font-family:'JetBrains Mono',monospace;margin-bottom:10px}
  table{width:100%;border-collapse:collapse}
  /* Disclaimer */
  .disclaimer{margin-top:36px;padding-top:16px;border-top:1px solid #D0CBC3;font-size:10px;color:#A9A49B;line-height:1.7;font-family:'JetBrains Mono',monospace}
  @media(max-width:600px){
    .page{padding:28px 20px 48px}
    .vis-card{padding:22px 20px}
    .fv-number{font-size:52px}
    .irr-big{font-size:52px}
    .irr-row{flex-direction:column;align-items:flex-start;gap:16px}
    .irr-left{border-right:none;border-bottom:1px solid #D0CBC3;padding-right:0;padding-bottom:16px;width:100%}
    .irr-right{padding-left:0}
    .co-name{font-size:32px}
    .inputs-grid{grid-template-columns:1fr 1fr}
  }
  @media print{body,html{background:#fff!important}.page{padding:32px 32px 48px;background:#fff!important}}
</style>
</head>
<body>
<div class="page">

  <div class="report-header">
    <div class="rh-brand">Valuation Studio — DCF Analysis</div>
    <div class="rh-date">Generated ${date}<br>Not financial advice</div>
  </div>

  <div class="report-co">
    <div class="co-name">${inp.company||'Unnamed Company'}</div>
    <div class="co-sub">${termStr} · ${inp.years}-year forecast · ${date}</div>
  </div>

  <!-- VISUAL CARDS -->
  <div class="visual-row">

    <!-- Fair Value Card -->
    <div class="vis-card" style="background:${goodBg}">
      <div class="vis-label">Fair Value per Share · at ${fmt(inp.disc*100,0)}% discount rate</div>
      ${res.ok?`
      <div class="fv-vc-row">
        <div class="fv-vc-side">
          <div class="fv-vc-lbl">Fair Value</div>
          <div class="fv-vc-num" style="color:${goodColor}">${fvDisplay}</div>
          <div class="fv-vc-ccy">${inp.pccy}</div>
        </div>
        <div class="fv-vc-mid">
          <div class="fv-vc-divider"></div>
          <div class="fv-vc-arrow">${up>=0?'←':'→'}</div>
          <div class="fv-vc-delta" style="color:${goodColor}">${upDisplay}</div>
          <div class="fv-vc-divider"></div>
        </div>
        <div class="fv-vc-side right">
          <div class="fv-vc-lbl">Market Price</div>
          <div class="fv-vc-num" style="color:#302D28">${fmt(inp.price)}</div>
          <div class="fv-vc-ccy">${inp.pccy}</div>
        </div>
      </div>
      <div class="fv-vc-foot">
        <div class="fv-vc-badge" style="background:${up>=0?'rgba(45,106,79,.12)':'rgba(155,34,38,.1)'};color:${goodColor}">
          ${up>=0?'▲':'▼'} ${upDisplay} implied ${up>=0?'upside':'downside'}
        </div>
        <div class="fv-vc-note">market price ${up>=0?'below':'above'} fair value estimate</div>
      </div>
      `:`<div style="color:#7A756D;font-size:13px;margin-top:8px">Could not calculate at these inputs.</div>`}
    </div>

    <!-- Implied Return Card -->
    <div class="vis-card" style="background:${irrBg}">
      <div class="vis-label">Implied Annual Return</div>
      ${irr!==null?`
      <div class="irr-row">
        <div class="irr-left">
          <div class="irr-num-lbl">per year</div>
          <div class="irr-big">${irrDisplay}</div>
        </div>
        <div class="irr-right">
          <div class="irr-desc-head">The return implied by the market price</div>
          <div class="irr-desc-body">${irrFactLine1}<br><br>${irrFactLine2}</div>
        </div>
      </div>
      `:`<div style="color:#7A756D;font-size:13px;margin-top:8px">Could not solve at this price.</div>`}
    </div>
  </div>

  <!-- INPUTS -->
  <div class="section">
    <div class="section-title">Inputs &amp; Assumptions</div>
    <div class="inputs-grid">
      <div class="inp-item"><div class="inp-lbl">Revenue (LTM)</div><div class="inp-val">${fmt(inp.revLTM,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">Free Cash Flow</div><div class="inp-val">${fmt(inp.fcfLTM,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">FCF margin</div><div class="inp-val">${fmt(inp.fcfMargin*100,1)}%</div></div>
      <div class="inp-item"><div class="inp-lbl">Net Cash / (Debt)</div><div class="inp-val">${fmt(-inp.netDebt,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">Shares Outstanding</div><div class="inp-val">${fmt(inp.shares,0)} M</div></div>
      <div class="inp-item"><div class="inp-lbl">Stock Price</div><div class="inp-val">${fmt(inp.price,2)} ${inp.pccy}</div></div>
      <div class="inp-item"><div class="inp-lbl">Revenue growth / yr</div><div class="inp-val">${fmt(inp.cagr*100,1)}%</div></div>
      <div class="inp-item"><div class="inp-lbl">Margin Change / yr</div><div class="inp-val">${fmt(inp.dpp*100,1)} pp</div></div>
      <div class="inp-item"><div class="inp-lbl">After Forecast</div><div class="inp-val">${termStr}</div></div>
    </div>
  </div>

  <!-- STEP-BY-STEP CALCULATION -->
  <div class="section">
    <div class="section-title">How fair value was calculated — step by step</div>
    ${res.ok ? (() => {
      const lastRow = res.rows[res.rows.length - 1];
      const yr1 = res.rows[0];
      const fMargin = (inp.fcfMargin * 100).toFixed(1);
      const tvRaw = inp.termMode === 'multiple' ? lastRow.fcf * inp.tmult : lastRow.fcf * (1 + inp.tg) / Math.max(inp.disc - inp.tg, .001);
      const tvPctOfTotal = res.pvTV / (res.pvFCFs + res.pvTV) * 100;
      const termCalcStr = inp.termMode === 'multiple'
        ? 'Last-year FCF (' + fmt(lastRow.fcf, 0) + ' M) × ' + fmt(inp.tmult, 1) + '× = ' + fmt(lastRow.fcf * inp.tmult, 0) + ' M'
        : 'Last-year FCF × (1 + ' + fmt(inp.tg * 100, 1) + '%) ÷ (' + fmt(inp.disc * 100, 0) + '% − ' + fmt(inp.tg * 100, 1) + '%)';
      const co = _currentTicker ? DB_MAP[_currentTicker] : null;
      const subtractSBC = document.getElementById('toggle-sbc')?.checked || true;
      const sbcAmt = pf(document.getElementById('inp-sbc')?.value) || 0;
      const sbcReportNote = (co && sbcAmt > 0 && subtractSBC) ? ' (SBC-adjusted: ' + fmt(sbcAmt, 0) + ' M deducted)' : '';
      return '<div style="font-size:12px;color:#7A756D;line-height:1.8;margin-bottom:10px">Every number comes from the inputs above. Discount rate defaults to 12% for all companies. Change any input and the result changes.</div>' +
        '<div style="display:flex;flex-direction:column;gap:12px">' +
        '<div style="display:flex;gap:10px"><div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:#E6EFF7;color:#2B5D8E;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">1</div><div style="flex:1"><div style="font-size:12px;font-weight:600;color:#1C1A16;margin-bottom:3px">Start: Revenue of ' + fmt(inp.revLTM, 0) + ' M with ' + fMargin + '% FCF margin = ' + fmt(inp.revLTM * inp.fcfMargin, 0) + ' M free cash flow' + sbcReportNote + '</div></div></div>' +
        '<div style="display:flex;gap:10px"><div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:#E6EFF7;color:#2B5D8E;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">2</div><div style="flex:1"><div style="font-size:12px;font-weight:600;color:#1C1A16;margin-bottom:3px">Project ' + inp.years + ' years at ' + fmt(inp.cagr * 100, 0) + '% growth → year ' + inp.years + ' revenue: ' + fmt(lastRow.rev, 0) + ' M, FCF: ' + fmt(lastRow.fcf, 0) + ' M</div></div></div>' +
        '<div style="display:flex;gap:10px"><div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:#E6EFF7;color:#2B5D8E;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">3</div><div style="flex:1"><div style="font-size:12px;font-weight:600;color:#1C1A16;margin-bottom:3px">Discount each year back at ' + fmt(inp.disc * 100, 0) + '% discount rate' + (inp.disc === 0.12 ? ' (default)' : '') + ' → sum of discounted cash flows = ' + fmt(res.pvFCFs, 0) + ' M</div></div></div>' +
        '<div style="display:flex;gap:10px"><div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:#E6EFF7;color:#2B5D8E;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">4</div><div style="flex:1"><div style="font-size:12px;font-weight:600;color:#1C1A16;margin-bottom:3px">Terminal value: ' + termCalcStr + ' → discounted = ' + fmt(res.pvTV, 0) + ' M (' + fmt(tvPctOfTotal, 0) + '% of total)</div></div></div>' +
        '<div style="display:flex;gap:10px"><div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:#E6EFF7;color:#2B5D8E;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">5</div><div style="flex:1"><div style="font-size:12px;font-weight:600;color:#1C1A16;margin-bottom:3px">' + fmt(res.pvFCFs, 0) + ' M + ' + fmt(res.pvTV, 0) + ' M' + (inp.useFCFF ? ' − ' + fmt(inp.netDebt, 0) + ' M debt' : '') + ' = ' + fmt(res.equityPV, 0) + ' M equity ÷ ' + fmt(inp.shares, 0) + ' M shares = <span style="color:#9E7528">' + fmt(res.fvps, 2) + ' ' + inp.pccy + '</span></div></div></div>' +
        '</div>';
    })() : '<div style="font-size:12px;color:#7A756D">Could not calculate at these inputs.</div>'}
  </div>

  <!-- SCENARIO GRID -->
  <div class="section">
    <div class="section-title">Scenario Grid — Implied Returns (Base margins)</div>
    <div class="grid-note">Revenue growth × ${isM?'exit multiple':'terminal growth rate'} — colour scale: red &lt; 8% · amber 8–10% · green &gt; 10%</div>
    <table><tbody>${gridHTML(0)}</tbody></table>
  </div>

  <div class="disclaimer">
    Generated by Valuation Studio on ${date}. For informational purposes only — not financial or investment advice.<br>
    Inputs reflect user-entered assumptions and may differ from actual reported financials. Always verify from primary sources before making any investment decision.
  </div>

</div>
</body>
</html>`;

  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  const safeName=(inp.company||'valuation').replace(/[^a-z0-9]/gi,'_').replace(/_+/g,'_').toLowerCase();
  a.download=safeName+'_valuation.html';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Report saved ✓  Open in browser → Print → Save as PDF');
}

function shareURL(){
  const raw=getInputs();
  const p=new URLSearchParams({co:raw.company,px:raw.price,sh:raw.shares,rev:raw.revLTM,fcf:raw.fcfLTM,nc:raw.netCashRaw,cagr:document.getElementById('sl-cagr').value,dpp:document.getElementById('sl-dpp').value,yr:raw.years,disc:document.getElementById('sl-disc').value,tm:termMode,tg:document.getElementById('sl-tg').value,tmult:raw.tmult||'',fccy:raw.fccy,pccy:raw.pccy,fxr:raw.fxRate});
  const url=window.location.origin+window.location.pathname+'?'+p.toString();
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).then(function(){ showToast('Link copied ✓'); }).catch(function(){ prompt('Copy this link:',url); });
    } else {
      prompt('Copy this link:', url);
    }
  } catch(e) { prompt('Copy this link:', url); }
}
function loadFromURL(){
  const p=new URLSearchParams(window.location.search);
  // ?blank=1 → full reset, open empty with defaults, show onboarding hint
  if(p.get('blank')==='1'){resetInputs();document.getElementById('btn-reset').style.display='none';return;}
  // ?preset=AAPL → load a specific preset from landing page ticker pills
  if(p.has('preset')&&PRESETS[p.get('preset')]){loadPreset(p.get('preset'));return;}
  if(!p.has('co')&&!p.has('px'))return;
  clearPills();
  const set=(id,v)=>{if(v&&v!=='null')document.getElementById(id).value=v};
  set('inp-company',p.get('co'));set('inp-price',p.get('px'));set('inp-shares',p.get('sh'));
  set('inp-revenue',p.get('rev'));set('inp-fcf',p.get('fcf'));set('inp-netcash',p.get('nc'));
  if(p.get('fcf')) _baseFCF = pf(p.get('fcf'));
  if(p.get('yr')){const v=+p.get('yr');document.getElementById('sl-years').value=v;document.getElementById('lbl-years').textContent=v+' yrs'}
  if(p.get('tmult')){const v=+p.get('tmult');if(v>0){document.getElementById('sl-tmult').value=v;document.getElementById('lbl-tmult').textContent=v.toFixed(1)+'×';}}
  if(p.get('cagr')){const v=+p.get('cagr');document.getElementById('sl-cagr').value=v;document.getElementById('lbl-cagr').textContent=v+'%';syncBenchPills()}
  if(p.get('dpp')){const v=+p.get('dpp');document.getElementById('sl-dpp').value=v;document.getElementById('lbl-dpp').textContent=v.toFixed(1)+'pp'}
  if(p.get('tg')){const v=+p.get('tg');document.getElementById('sl-tg').value=v;document.getElementById('lbl-tg').textContent=v.toFixed(1)+'%'}
  if(p.get('disc')){const v=+p.get('disc');document.getElementById('sl-disc').value=v;onDiscChange()}
  if(p.get('fccy'))document.getElementById('sel-fccy').value=p.get('fccy');
  if(p.get('pccy'))document.getElementById('sel-pccy').value=p.get('pccy');
  if(p.get('fxr'))document.getElementById('inp-fxrate').value=p.get('fxr');
  onCurrencyChange();if(p.get('tm'))setTerm(p.get('tm'));
  document.getElementById('btn-reset').style.display='';
  update();
}

function diagnoseMissing(raw){
  // Returns an array of {field, fix} objects explaining what's missing/wrong
  const issues=[];
  if(!isFinite(raw.price)||raw.price<=0)
    issues.push({field:'Stock price',fix:'Enter the current share price in the sidebar.'});
  if(!isFinite(raw.shares)||raw.shares<=0)
    issues.push({field:'Shares outstanding',fix:'Enter the total shares outstanding in millions.'});
  if(!isFinite(raw.revLTM)||raw.revLTM<=0)
    issues.push({field:'Revenue',fix:'Enter last twelve months revenue in millions. Must be a positive number.'});
  if(!isFinite(raw.fcfLTM))
    issues.push({field:'Free cash flow',fix:'Enter last twelve months free cash flow in millions. Use a negative number if FCF is negative.'});
  return issues;
}

function updateEmptyStates(raw){
  const issues=diagnoseMissing(raw);
  const ids=['dcf-empty-body','rev-empty-body','matrix-empty-body'];
  if(issues.length===0){
    ids.forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=''});
    return;
  }
  const fieldNames=issues.map(i=>i.field);
  const fixHtml=issues.map(i=>`<div class="cw-item" style="margin:3px 0"><span class="cw-item-icon">→</span><span><strong>${i.field}:</strong> ${i.fix}</span></div>`).join('');
  const summary=`Still needed: ${fieldNames.join(', ')}.`;
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.innerHTML=`${summary}<div class="cw-list" style="margin-top:8px;text-align:left">${fixHtml}</div>`;
  });
}


function update(){
  const raw=getInputs();
  const hasFCF=isFinite(raw.fcfLTM),hasRev=isFinite(raw.revLTM)&&raw.revLTM>0;
  const revFieldVal=document.getElementById('inp-revenue').value.trim();
  document.getElementById('warn-fcf').style.display=(hasFCF&&raw.fcfLTM<0)?'block':'none';
  document.getElementById('err-rev').style.display=(revFieldVal!==''&&!hasRev)?'block':'none';
  // Scale sanity check: revenue entered but suspiciously small given the stock price
  const showScaleWarn=hasRev&&isFinite(raw.price)&&raw.price>1&&raw.revLTM<50&&raw.revLTM>0;
  document.getElementById('warn-scale').style.display=showScaleWarn?'block':'none';
  document.getElementById('margin-chip').style.display=(hasFCF&&hasRev)?'':'none';
  if(hasFCF&&hasRev){
    const m=raw.fcfLTM/raw.revLTM;
    document.getElementById('mc-val').textContent=fmt(m*100,1)+'%';
    document.getElementById('mc-val').style.color='';
  }

  // ── Price check link → Google search (shows price widget inline)
  const priceLink=document.getElementById('price-check-link');
  if(priceLink){
    const coName=raw.company||'';
    const tickerMatch=coName.match(/\(([A-Z]{1,5})\)/)||coName.match(/^([A-Z]{2,5})$/);
    if(tickerMatch||coName.length>1){
      const q=tickerMatch?tickerMatch[1]+' stock price':coName+' stock price';
      priceLink.setAttribute('href','https://www.google.com/search?q='+encodeURIComponent(q));
      priceLink.dataset.ready='1';
      priceLink.style.display='inline';
    } else {
      priceLink.style.display='none';
      priceLink.dataset.ready='';
    }
  }

  const inp=buildInp(raw);
  // Update empty-state help text based on what's missing
  if(!inp)updateEmptyStates(raw);
  document.getElementById('sb-sum-wrap').style.display=inp?'':'none';
  if(inp){
    document.getElementById('sum-co').textContent=inp.company||'—';
    document.getElementById('sum-px').textContent=fmt(inp.price)+' '+inp.pccy;
    document.getElementById('sum-margin').textContent=fmt(inp.fcfMargin*100,1)+'%';
    document.getElementById('sum-growth').textContent=fmt(inp.cagr*100,0)+'% / yr';
    document.getElementById('sum-years').textContent=inp.years+' years';
    document.getElementById('sum-terminal').textContent=inp.termMode==='multiple'?fmt(inp.tmult,1)+'×':fmt(inp.tg*100,1)+'% / yr';
  }
  if(activeTab==='dcf')renderDCF(inp);
  else if(activeTab==='rev')renderRev(inp);
  else if(activeTab==='matrix')renderMatrix(inp);
  updateMobileBar(inp);
}

function updateMobileBar(inp){
  if(!inp){document.getElementById('mb-fv').textContent='—';document.getElementById('mb-px').textContent='—';document.getElementById('mb-badge-wrap').innerHTML='';return}
  const res=fairValue(inp);
  document.getElementById('mb-px').textContent=fmt(inp.price)+' '+inp.pccy;
  if(res.ok){
    const up=res.fvps/inp.price-1;
    document.getElementById('mb-fv').textContent=fmt(res.fvps)+' '+inp.pccy;
    const cls=up>=0?'good':'bad';
    document.getElementById('mb-badge-wrap').innerHTML=`<div class="mb-badge ${cls}">${up>=0?'+':''}${fmt(up*100,1)}%</div>`;
  }
}

/* ══════════════════════════════════════════
   TAB 1 — FAIR VALUE
══════════════════════════════════════════ */
function renderDCF(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=!!inp;
  document.getElementById('dcf-empty').style.display=show?'none':'';
  document.getElementById('dcf-content').style.display=show?'':'none';
  if(!show)return;
  const res=fairValue(inp);
  _forecastRows=res.rows||[];
  const pCcy=inp.pccy;
  if(res.ok){
    const up=res.fvps/inp.price-1;
    const good=up>=0;
    // Single unified card: FV | delta | Market + verdict strip
    document.getElementById('dcf-hero').innerHTML=`
      <div class="vc-side">
        <div class="vc-lbl">Fair Value <button class="info-btn" onclick="document.getElementById('dcf-calc-hdr').click();document.getElementById('dcf-calc-section').scrollIntoView({behavior:'smooth',block:'start'})" title="See how this was calculated" style="vertical-align:middle"><svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="0.8" fill="currentColor" stroke="none"/><path d="M6 5.5v4"/></svg></button></div>
        <div class="vc-num ${good?'fv-good':'fv-bad'}">${fmt(res.fvps)}</div>
        <div class="vc-ccy">${pCcy}</div>
      </div>
      <div class="vc-mid">
        <div class="vc-divider-v"></div>
        <div class="vc-arrow">${good?'←':'→'}</div>
        <div class="vc-delta ${good?'good':'bad'}">${up>=0?'+':''}${fmt(up*100,1)}%</div>
        <div class="vc-divider-v"></div>
      </div>
      <div class="vc-side right">
        <div class="vc-lbl">Market Price</div>
        <div class="vc-num mkt">${fmt(inp.price)}</div>
        <div class="vc-ccy">${pCcy}</div>
      </div>`;
    document.getElementById('dcf-verdict').innerHTML=`
      <div class="val-card-verdict">
        <div class="vc-verdict-note ${good?'good':'bad'}">${good?'▲ Undervalued at this discount rate':'▼ Overvalued at this discount rate'}</div>
      </div>`;
  } else {
    // Detailed, actionable error diagnosis
    const diagnose=[];
    if(inp.termMode==='growth'&&inp.tg>=inp.disc){
      diagnose.push({icon:'⚡',text:`Terminal growth rate (${fmt(inp.tg*100,1)}%) must be strictly lower than your discount rate (${fmt(inp.disc*100,0)}%). The Gordon Growth formula becomes undefined when r ≤ g. → Reduce the "Terminal growth rate" slider below ${fmt(inp.disc*100,0)}%, or raise your discount rate.`});
    }
    const finalMarg=inp.fcfMargin+inp.dpp*inp.years;
    if(finalMarg<=0){
      diagnose.push({icon:'📉',text:`With a margin change of ${fmt(inp.dpp*100,1)}pp/yr, FCF margin reaches ${fmt(finalMarg*100,1)}% by year ${inp.years} — cash flow turns negative before the forecast ends. → Reduce the "Margin change per year" slider, shorten the forecast period, or start with a higher FCF.`});
    }
    if(inp.fcfMargin<=0){
      diagnose.push({icon:'⚠️',text:`Starting FCF margin is ${fmt(inp.fcfMargin*100,1)}% — the company is not generating positive free cash flow. A standard DCF requires positive cash flows to produce a meaningful valuation. → Check the Revenue and Free Cash Flow inputs, or enter a forward estimate of positive FCF.`});
    }
    if(inp.netDebt>0&&(inp.netDebt/inp.shares)>(inp.price/inp.fxRate)){
      diagnose.push({icon:'🏦',text:`Net debt per share (${fmt(inp.netDebt/inp.shares,2)}) exceeds the stock price — total equity value becomes negative, which produces no valid result. → Check the "Net cash" field. Use a positive value for net cash, negative for net debt.`});
    }
    if(!diagnose.length){
      diagnose.push({icon:'🔧',text:`The model could not converge on a fair value with these inputs. → Try lowering your discount rate, raising the revenue growth rate, or confirm that Revenue and Free Cash Flow are both entered correctly.`});
    }
    document.getElementById('dcf-hero').innerHTML=`<div style="grid-column:1/-1;padding:4px 0">
      <div class="calc-warn" style="margin-bottom:0;border:none;box-shadow:none;background:none">
        <div class="cw-head"><div class="cw-icon">⛔</div><div class="cw-title">Fair value cannot be calculated</div></div>
        <div class="cw-body">The current combination of inputs produces a mathematically invalid result. Here's what needs to change:</div>
        <div class="cw-list">${diagnose.map(d=>`<div class="cw-item"><span class="cw-item-icon">${d.icon}</span><span>${d.text}</span></div>`).join('')}</div>
      </div>
    </div>`;
    document.getElementById('dcf-verdict').innerHTML='';
    document.getElementById('dcf-cmp').innerHTML='';
  }
  // Sens data
  _sensData=[];
  for(let r=5;r<=30;r++){const v=fairValue({...inp,disc:r/100});_sensData.push({rate:r,fv:v.ok?v.fvps:null})}
  drawSensChart(inp.price,inp.disc*100);
  renderForecastTable();
  renderBridge(inp,res);
  renderCalcSteps(inp,res);
}

function drawSensChart(price,selRate){
  const cv=document.getElementById('chart-sens'),ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1,W=cv.offsetWidth,H=220;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  const PAD={t:20,r:24,b:36,l:60},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;
  const valid=_sensData.filter(d=>d.fv!==null);
  if(valid.length<2)return;
  const fvs=valid.map(d=>d.fv);
  const minFV=Math.min(...fvs,price)*.82,maxFV=Math.max(...fvs,price)*1.14;
  const xp=r=>PAD.l+(r-5)/25*cw,yp=v=>PAD.t+ch-(v-minFV)/(maxFV-minFV)*ch;
  const ink3=cssVar('--ink-3')||'#4D4943';
  const ink4=cssVar('--ink-4')||'#7A756D';
  const ink5=cssVar('--ink-5')||'#A9A49B';
  const surf=cssVar('--surface')||'#FAF8F3';
  const blueColor=cssVar('--blue')||'#2B5D8E';
  const bluePill=cssVar('--blue-pill')||'#1E4A74';
  const pCcy=(buildInp(getInputs())||{}).pccy||'';

  // ── Chart background (rounded rect)
  ctx.fillStyle=surf;
  ctx.beginPath();
  ctx.roundRect?ctx.roundRect(PAD.l,PAD.t,cw,ch,4):ctx.rect(PAD.l,PAD.t,cw,ch);
  ctx.fill();

  // ── Coloured zone fills FIRST (under grid lines)
  const py=yp(price);
  const above=valid.filter(d=>d.fv>=price);
  const below=valid.filter(d=>d.fv<price);
  if(above.length){
    const g=ctx.createLinearGradient(0,PAD.t,0,py);
    g.addColorStop(0,'rgba(26,122,60,.15)');g.addColorStop(1,'rgba(26,122,60,.03)');
    ctx.beginPath();
    ctx.moveTo(xp(above[0].rate),py);
    above.forEach(d=>ctx.lineTo(xp(d.rate),yp(d.fv)));
    ctx.lineTo(xp(above[above.length-1].rate),py);
    ctx.closePath();ctx.fillStyle=g;ctx.fill();
  }
  if(below.length){
    const g=ctx.createLinearGradient(0,py,0,PAD.t+ch);
    g.addColorStop(0,'rgba(192,57,43,.03)');g.addColorStop(1,'rgba(192,57,43,.13)');
    ctx.beginPath();
    ctx.moveTo(xp(below[0].rate),py);
    below.forEach(d=>ctx.lineTo(xp(d.rate),yp(d.fv)));
    ctx.lineTo(xp(below[below.length-1].rate),py);
    ctx.closePath();ctx.fillStyle=g;ctx.fill();
  }

  // ── Zone labels (subtle text inside the zones)
  ctx.font=`500 10.5px 'DM Sans', sans-serif`;
  if(above.length){
    const midY=Math.max(PAD.t+10, (yp(above[0].fv)+py)/2);
    ctx.fillStyle='rgba(26,122,60,.45)';ctx.textAlign='right';
    ctx.fillText('CHEAP',PAD.l+cw-8,midY);
  }
  if(below.length){
    const midY=Math.min(PAD.t+ch-6,(py+yp(below[below.length-1].fv))/2+8);
    ctx.fillStyle='rgba(192,57,43,.35)';ctx.textAlign='right';
    ctx.fillText('EXPENSIVE',PAD.l+cw-8,midY);
  }

  // ── Grid lines (over fills)
  for(let i=0;i<=4;i++){
    const y=PAD.t+i*ch/4;
    const val=minFV+(maxFV-minFV)*(1-i/4);
    ctx.strokeStyle=i===0||i===4?'rgba(28,26,22,.09)':'rgba(28,26,22,.05)';
    ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`500 10.5px 'JetBrains Mono', monospace`;ctx.textAlign='right';
    ctx.fillText(fmt(val,0),PAD.l-8,y+3.5);
  }
  for(let r=5;r<=30;r+=5){
    const x=xp(r);
    ctx.strokeStyle='rgba(28,26,22,.04)';ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`10.5px 'JetBrains Mono', monospace`;ctx.textAlign='center';
    ctx.fillText(r+'%',x,PAD.t+ch+16);
  }

  // ── Market price horizontal reference line — clean dashed, no floating text
  ctx.setLineDash([5,4]);ctx.strokeStyle=ink4;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(PAD.l,py);ctx.lineTo(PAD.l+cw,py);ctx.stroke();
  ctx.setLineDash([]);

  // ── Selected-rate vertical drop line
  const selRnd=Math.round(selRate);
  const sx=xp(selRnd);
  ctx.setLineDash([4,3]);ctx.strokeStyle='rgba(26,92,152,.35)';ctx.lineWidth=1.2;
  ctx.beginPath();ctx.moveTo(sx,PAD.t+ch);ctx.lineTo(sx,PAD.t);ctx.stroke();
  ctx.setLineDash([]);
  // Label the selected rate on x-axis with a pill
  const rateLbl=selRnd+'%';
  ctx.font=`700 11.5px 'JetBrains Mono', monospace`;
  const rlW=ctx.measureText(rateLbl).width+10;
  ctx.fillStyle=bluePill;
  ctx.beginPath();ctx.roundRect?ctx.roundRect(sx-rlW/2,PAD.t+ch+3,rlW,16,4):ctx.rect(sx-rlW/2,PAD.t+ch+3,rlW,16);
  ctx.fill();
  ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(rateLbl,sx,PAD.t+ch+14.5);

  // ── Fair value curve (shadow then line)
  ctx.shadowColor='rgba(26,92,152,.18)';ctx.shadowBlur=10;
  ctx.strokeStyle=blueColor;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';
  ctx.setLineDash([]);ctx.beginPath();
  valid.forEach((d,i)=>{if(i===0)ctx.moveTo(xp(d.rate),yp(d.fv));else ctx.lineTo(xp(d.rate),yp(d.fv))});
  ctx.stroke();ctx.shadowBlur=0;

  // ── Selected point dot + callout
  const sel=valid.find(d=>d.rate===selRnd);
  if(sel){
    const ssx=xp(sel.rate),ssy=yp(sel.fv);
    // Dot
    ctx.beginPath();ctx.arc(ssx,ssy,6,0,Math.PI*2);
    ctx.fillStyle=blueColor;ctx.fill();
    ctx.strokeStyle=surf;ctx.lineWidth=2.5;ctx.stroke();
    // Value callout pill
    const valLbl=fmt(sel.fv,0)+' '+pCcy;
    ctx.font=`bold 12px 'JetBrains Mono', monospace`;
    const vlW=ctx.measureText(valLbl).width+14;
    const vlX=Math.min(Math.max(ssx-vlW/2,PAD.l),PAD.l+cw-vlW);
    const vlY=ssy-32;
    ctx.fillStyle=bluePill;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(vlX,vlY,vlW,20,5):ctx.rect(vlX,vlY,vlW,20);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(valLbl,ssx,vlY+14);
    // Small triangle pointer
    ctx.beginPath();ctx.moveTo(ssx-5,ssy-12);ctx.lineTo(ssx+5,ssy-12);ctx.lineTo(ssx,ssy-5);
    ctx.fillStyle=bluePill;ctx.fill();
  }

  // ── Axis labels
  ctx.fillStyle=ink4;ctx.font=`11px 'DM Sans', sans-serif`;ctx.textAlign='center';
  ctx.fillText('Required annual return (%)',PAD.l+cw/2,H-4);
  ctx.save();ctx.translate(11,PAD.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillText('Fair value per share',0,0);ctx.restore();
}

function renderForecastTable(){
  const t=document.getElementById('forecast-tbl');
  if(!_forecastRows.length){t.innerHTML='';return}
  let h=`<thead><tr><th>Year</th><th>Revenue (M)</th><th>FCF margin</th><th>Free cash flow (M)</th><th>Discount factor</th><th>Value today (M)</th></tr></thead><tbody>`;
  _forecastRows.forEach(r=>{h+=`<tr><td>${r.year}</td><td>${fmt(r.rev,0)}</td><td>${fmtPctPlain(r.marg,2)}</td><td>${fmt(r.fcf,0)}</td><td>${fmt(r.df,4)}</td><td>${fmt(r.discFcf,0)}</td></tr>`});
  t.innerHTML=h+'</tbody>';
}

function renderBridge(inp,res){
  const el=document.getElementById('bridge-wrap');
  if(!res.ok){el.innerHTML='';return}
  el.innerHTML=`<div class="bridge" style="margin-top:10px">
    <div class="br-row"><span class="br-lbl">Value of forecast cash flows</span><span class="br-val">${fmt(res.pvFCFs,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Value after forecast period</span><span class="br-val">${fmt(res.pvTV,0)} M</span></div>
    ${inp.useFCFF ? `<div class="br-row"><span class="br-lbl">Less: net debt (whole-firm mode)</span><span class="br-val">(${fmt(inp.netDebt,0)} M)</span></div>` : ''}
    <div class="br-row"><span class="br-lbl">Total shareholder value</span><span class="br-val">${fmt(res.equityPV,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">÷ Total shares</span><span class="br-val">${fmt(inp.shares,0)} M</span></div>
    <div class="br-row"><span class="br-lbl">Fair value per share</span><span class="br-val">${fmt(res.fvps,2)} ${inp.pccy}</span></div>
  </div>`;
}

function renderCalcSteps(inp, res) {
  const el = document.getElementById('dcf-calc-steps');
  if (!el || !res.ok) { if(el) el.innerHTML=''; return; }
  const fMargin = (inp.fcfMargin * 100).toFixed(1);
  const lastRow = res.rows[res.rows.length - 1];
  const yr1 = res.rows[0];
  const termStr = inp.termMode === 'multiple'
    ? `Last-year FCF (${fmt(lastRow.fcf,0)} M) × ${fmt(inp.tmult,1)}× exit multiple = ${fmt(lastRow.fcf * inp.tmult,0)} M`
    : `Last-year FCF × (1 + ${fmt(inp.tg*100,1)}%) ÷ (${fmt(inp.disc*100,0)}% − ${fmt(inp.tg*100,1)}%) = ${fmt(lastRow.fcf*(1+inp.tg)/Math.max(inp.disc-inp.tg,.001),0)} M`;
  const tvRaw = inp.termMode === 'multiple' ? lastRow.fcf * inp.tmult : lastRow.fcf*(1+inp.tg)/Math.max(inp.disc-inp.tg,.001);
  const tvPctOfTotal = res.pvTV / (res.pvFCFs + res.pvTV) * 100;
  const companyName = document.getElementById('inp-company')?.value || 'This company';
  const co = _currentTicker ? DB_MAP[_currentTicker] : null;
  const subtractSBC2 = document.getElementById('toggle-sbc')?.checked || true;
  const sbcAmt2 = pf(document.getElementById('inp-sbc')?.value) || 0;
  const sbcNote = (co && sbcAmt2 > 0 && subtractSBC2) ? `<br><span style="font-size:11.5px;color:var(--ink-4)">Note: FCF has been reduced by ${fmt(sbcAmt2,0)} M in stock-based compensation (SBC-adjusted). Toggle off "Subtract SBC" in the sidebar to use standard FCF.</span>` : '';

  el.innerHTML = `
    <div style="font-size:13px;color:var(--ink-3);line-height:1.7;margin-bottom:14px">
      Here's exactly how we arrived at <strong style="color:var(--ink)">${fmt(res.fvps,2)} ${inp.pccy}</strong> per share for ${companyName}. Every number below comes from the inputs in the sidebar — change any input and this recalculates instantly.
    </div>

    <div class="calc-step">
      <div class="calc-step-num">1</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Start with today's revenue and cash flow margin</div>
        <div class="calc-step-detail">
          Revenue: <strong>${fmt(inp.revLTM,0)} M</strong> · Free cash flow: <strong>${fmt(inp.revLTM * inp.fcfMargin,0)} M</strong> (${fMargin}% of revenue)${sbcNote}
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">2</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Project cash flows ${inp.years} years into the future</div>
        <div class="calc-step-detail">
          Revenue grows at <strong>${fmt(inp.cagr*100,0)}% per year</strong>. By year ${inp.years}, revenue reaches ${fmt(lastRow.rev,0)} M and free cash flow reaches ${fmt(lastRow.fcf,0)} M.
          ${inp.dpp !== 0 ? `<br>FCF margin shifts by ${fmt(inp.dpp*100,1)}pp/yr → ends at ${fmtPctPlain(lastRow.marg)}.` : ''}
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">3</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Discount each year's cash flow back to today</div>
        <div class="calc-step-detail">
          Each future dollar is worth less than a dollar today. At your <strong>${fmt(inp.disc*100,0)}% discount rate</strong>${inp.disc === 0.12 ? ' (the default — applies equally to all companies as a conservative starting point)' : ''}, we divide each year's cash flow by (1 + ${fmt(inp.disc*100,0)}%)^year.<br>
          Year 1 FCF: ${fmt(yr1.fcf,0)} M ÷ ${fmt(1+inp.disc,2)} = <strong>${fmt(yr1.discFcf,0)} M today</strong><br>
          Sum of all ${inp.years} years' discounted cash flows = <strong>${fmt(res.pvFCFs,0)} M</strong>
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">4</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Estimate the value of everything beyond year ${inp.years}</div>
        <div class="calc-step-detail">
          The company doesn't stop making money after ${inp.years} years. We estimate the value of <em>all</em> the cash it will make after that using ${inp.termMode === 'multiple' ? 'a multiple of the last year\'s cash' : 'a slow-growth formula'}:<br>
          ${termStr}<br>
          Brought back to today's value: <strong>${fmt(res.pvTV,0)} M</strong> (${fmt(tvPctOfTotal,0)}% of total value — this is usually the biggest piece)
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">5</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Add it up to get fair value per share</div>
        <div class="calc-step-detail">
          <div class="bridge" style="margin:8px 0 0">
            <div class="br-row"><span class="br-lbl">Discounted cash flows (years 1–${inp.years})</span><span class="br-val">${fmt(res.pvFCFs,0)} M</span></div>
            <div class="br-row"><span class="br-lbl">+ Value after year ${inp.years}</span><span class="br-val">${fmt(res.pvTV,0)} M</span></div>
            ${inp.useFCFF ? `<div class="br-row"><span class="br-lbl">− Net debt</span><span class="br-val">${fmt(inp.netDebt,0)} M</span></div>` : ''}
            <div class="br-row"><span class="br-lbl">= Total company value</span><span class="br-val">${fmt(res.equityPV,0)} M</span></div>
            <div class="br-row"><span class="br-lbl">÷ Total shares</span><span class="br-val">${fmt(inp.shares,0)} M shares</span></div>
            <div class="br-row"><span class="br-lbl"><strong>= Fair value per share</strong></span><span class="br-val"><strong>${fmt(res.fvps,2)} ${inp.pccy}</strong></span></div>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ══════════════════════════════════════════
   TAB 2 — IMPLIED RETURN
══════════════════════════════════════════ */
function renderRev(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=!!inp;
  document.getElementById('rev-empty').style.display=show?'none':'';
  document.getElementById('rev-content').style.display=show?'':'none';
  if(!show)return;

  const irr=impliedIRR(inp,inp.price);
  const reqReturn=inp.disc*100;
  const termStr=inp.termMode==='multiple'?fmt(inp.tmult,1)+'× FCF':fmt(inp.tg*100,1)+'% / yr growth';
  const hero=document.getElementById('irr-hero');

  if(irr!==null){
    const irrPct=irr*100;
    const diff=irrPct-reqReturn;
    const diffAbs=fmt(Math.abs(diff),1);
    // Neutral headline — factual, not opinionated
    const headline='What the market price implies';
    // Two calm factual sentences
    const line1=`At the current price, these growth and terminal assumptions produce an implied annual return of ${fmt(irrPct,1)}%.`;
    const line2=diff>=0
      ?`That is ${fmt(diff,1)}pp above your ${fmt(reqReturn,0)}% discount rate on the Fair Value tab.`
      :`That is ${diffAbs}pp below your ${fmt(reqReturn,0)}% discount rate on the Fair Value tab.`;
    hero.innerHTML=`
      <div class="irr-result-card">
        <div class="irc-top">
          <div class="irc-num-block">
            <div class="irc-num-lbl">Implied return / yr</div>
            <div class="irc-num" style="color:var(--ink)">${fmt(irrPct,1)}%</div>
          </div>
          <div class="irc-verdict">
            <div class="irc-verdict-main">${headline}</div>
            <div class="irc-verdict-body">${line1} ${line2}</div>
          </div>
        </div>
        <div class="irc-inputs">
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Price</div><div class="irc-inp-val">${fmt(inp.price,2)} ${inp.pccy}</div></div>
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Revenue growth</div><div class="irc-inp-val">${fmt(inp.cagr*100,0)}% / yr</div></div>
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Terminal value</div><div class="irc-inp-val">${termStr}</div></div>
          <div class="irc-inp-cell"><div class="irc-inp-lbl">Forecast</div><div class="irc-inp-val">${inp.years} years</div></div>
        </div>
      </div>`;
  } else {
    const diagnose2=[];
    if(inp.termMode==='growth'&&inp.tg>=inp.disc){
      diagnose2.push({icon:'⚡',text:`Terminal growth rate (${fmt(inp.tg*100,1)}%) must be lower than the discount rate (${fmt(inp.disc*100,0)}%). The solver cannot find an implied return when g ≥ r. → Reduce the "Terminal growth rate" slider, or raise your discount rate on the Fair Value tab.`});
    }
    const fm2=inp.fcfMargin+inp.dpp*inp.years;
    if(fm2<=0){
      diagnose2.push({icon:'📉',text:`Projected FCF margin reaches ${fmt(fm2*100,1)}% by year ${inp.years} — cash flow turns negative under these assumptions. No valid implied return exists. → Reduce the margin decline or shorten the forecast period.`});
    }
    if(inp.fcfMargin<=0){
      diagnose2.push({icon:'⚠️',text:`Starting FCF margin is ${fmt(inp.fcfMargin*100,1)}%. The implied return solver requires positive free cash flows. → Enter a positive FCF, or use a forward FCF estimate.`});
    }
    if(!diagnose2.length){
      diagnose2.push({icon:'🔧',text:`The solver could not converge on an implied return at this price. The growth and terminal assumptions may produce a fair value that is always below the market price regardless of the return rate. → Try increasing the growth rate, raising the terminal value, or reducing the price being tested.`});
    }
    hero.innerHTML=`<div class="irr-result-card">
      <div class="calc-warn" style="margin:0;border:none;box-shadow:none;padding:12px 0 0">
        <div class="cw-head"><div class="cw-icon">⛔</div><div class="cw-title">Implied return cannot be calculated</div></div>
        <div class="cw-body">The current inputs produce no valid mathematical solution. Here's what to fix:</div>
        <div class="cw-list">${diagnose2.map(d=>`<div class="cw-item"><span class="cw-item-icon">${d.icon}</span><span>${d.text}</span></div>`).join('')}</div>
      </div></div>`;
  }

  // ── Init price slider — range: 10% to 300% of current price (-90% to +200%)
  const pMin=inp.price*.10,pMax=inp.price*3.0;
  const defaultSliderVal=Math.round((inp.price-pMin)/(pMax-pMin)*100); // ~31%
  const sl=document.getElementById('rev-sl-price');
  sl.value=defaultSliderVal;
  sl.style.background=`linear-gradient(90deg,var(--blue) ${defaultSliderVal}%,var(--border) ${defaultSliderVal}%)`;
  document.getElementById('rev-price-display').textContent=fmt(inp.price,2);
  document.getElementById('rev-price-ccy').textContent=inp.pccy;
  document.getElementById('rev-price-min').textContent=fmt(pMin,0);
  document.getElementById('rev-price-max').textContent=fmt(pMax,0);
  document.getElementById('rpc-result-row').style.display='none';
  _revExplorePrice=null;
  // Update legend label with live required return
  const lLbl=document.getElementById('irr-hurdle-legend-lbl');
  if(lLbl)lLbl.textContent=`Your discount rate (${fmt(inp.disc*100,0)}%)`;

  // ── Chart data
  _revData=[];
  for(let i=0;i<=80;i++){const p=pMin+(pMax-pMin)*i/80;const r=impliedIRR(inp,p);if(r!==null)_revData.push({price:p,irr:r})}
  drawIRRChart(inp.price,irr,inp.disc,null);
  renderRevTable(inp);
  renderIRRCalcSteps(inp,irr);
}

function renderIRRCalcSteps(inp, irr) {
  const el = document.getElementById('irr-calc-steps');
  if (!el) return;
  if (irr === null) { el.innerHTML = '<div style="font-size:13px;color:var(--ink-4);padding:8px 0">Could not solve for an implied return with these inputs. Try adjusting growth or terminal assumptions.</div>'; return; }

  const irrPct = irr * 100;
  const fvAtIRR = fairValue({...inp, disc: irr});
  const termStr = inp.termMode === 'multiple'
    ? `exit multiple of ${fmt(inp.tmult,1)}×`
    : `perpetual growth of ${fmt(inp.tg*100,1)}%`;
  const companyName = document.getElementById('inp-company')?.value || 'this company';

  el.innerHTML = `
    <div style="font-size:13px;color:var(--ink-3);line-height:1.7;margin-bottom:14px">
      The implied return is the annual rate that makes the fair value <em>exactly equal</em> to today's market price. Here's how we found <strong style="color:var(--ink)">${fmt(irrPct,1)}%</strong> for ${companyName}.
    </div>

    <div class="calc-step">
      <div class="calc-step-num">1</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Start with the same cash flow projections</div>
        <div class="calc-step-detail">
          Revenue of <strong>${fmt(inp.revLTM,0)} M</strong> growing at <strong>${fmt(inp.cagr*100,0)}%/yr</strong> for ${inp.years} years, with a FCF margin of ${fmtPctPlain(inp.fcfMargin)} and a terminal value based on ${termStr}. These are the same assumptions used in the Fair Value tab.
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">2</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Ask: what discount rate makes fair value = market price?</div>
        <div class="calc-step-detail">
          On the Fair Value tab, you choose the discount rate and we solve for fair value. Here we flip it: the market price is <strong>${fmt(inp.price,2)} ${inp.pccy}</strong>, so what annual return rate produces exactly that number?
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">3</div>
      <div class="calc-step-body">
        <div class="calc-step-title">The model solves iteratively</div>
        <div class="calc-step-detail">
          We test thousands of rates (from 0.1% to 200%) and narrow in on the one where the discounted value of all future cash flows, divided by ${fmt(inp.shares,0)} M shares, equals ${fmt(inp.price,2)} ${inp.pccy}. This is a standard numerical root-finding method (bisection).
        </div>
      </div>
    </div>

    <div class="calc-step">
      <div class="calc-step-num">4</div>
      <div class="calc-step-body">
        <div class="calc-step-title">Result: ${fmt(irrPct,1)}% implied annual return</div>
        <div class="calc-step-detail">
          At a discount rate of <strong>${fmt(irrPct,1)}%</strong>, the fair value equals the market price of ${fmt(inp.price,2)} ${inp.pccy}.
          <div class="bridge" style="margin:8px 0 0">
            <div class="br-row"><span class="br-lbl">Your discount rate (Fair Value tab)</span><span class="br-val">${fmt(inp.disc*100,0)}%</span></div>
            <div class="br-row"><span class="br-lbl">Implied return (market price implies)</span><span class="br-val">${fmt(irrPct,1)}%</span></div>
            <div class="br-row"><span class="br-lbl">Difference</span><span class="br-val" style="color:${irrPct >= inp.disc*100 ? 'var(--green-dk)' : 'var(--red-dk)'}">${irrPct >= inp.disc*100 ? '+' : ''}${fmt(irrPct - inp.disc*100,1)}pp</span></div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--ink-4)">If the implied return exceeds your discount rate, the assumptions suggest the stock is priced below your threshold. If it's lower, the price already reflects more optimism than you require.</div>
        </div>
      </div>
    </div>
  `;
}

/* ══════════════════════════════════════════
   PRICE EXPLORER (Implied Return tab)
══════════════════════════════════════════ */
let _revExplorePrice=null;
let _irrDragPrice=null; // kept for chart compatibility

function onRevPriceChange(sliderVal){
  const inp=buildInp(getInputs());
  if(!inp)return;
  const pMin=inp.price*.10,pMax=inp.price*3.0;
  const price=pMin+(pMax-pMin)*(sliderVal/100);
  _revExplorePrice=price;
  _irrDragPrice=price;
  // Update display
  document.getElementById('rev-price-display').textContent=fmt(price,2);
  // Slider fill
  const sl=document.getElementById('rev-sl-price');
  sl.style.background=`linear-gradient(90deg,var(--blue) ${sliderVal}%,var(--border) ${sliderVal}%)`;
  // Compute IRRs
  const explIRR=impliedIRR(inp,price);
  const baseIRR=impliedIRR(inp,inp.price);
  const isReset=Math.abs(price-inp.price)/inp.price<0.01;
  const row=document.getElementById('rpc-result-row');
  if(isReset){row.style.display='none';_revExplorePrice=null;_irrDragPrice=null;drawIRRChart(inp.price,baseIRR,inp.disc,null);return}
  row.style.display='flex';
  // Populate readout
  document.getElementById('rpc-explored-irr').textContent=explIRR!==null?fmt(explIRR*100,1)+'%':'—';
  document.getElementById('rpc-explored-irr').style.color=
    explIRR!==null&&explIRR>=inp.disc?'var(--green-dk)':'var(--red-dk)';
  if(explIRR!==null&&baseIRR!==null){
    const d=explIRR-baseIRR;
    document.getElementById('rpc-irr-delta').textContent=(d>=0?'+':'')+fmt(d*100,1)+'pp';
    document.getElementById('rpc-irr-delta').style.color=d>=0?'var(--green-dk)':'var(--red-dk)';
  }else document.getElementById('rpc-irr-delta').textContent='—';
  const pDelta=price/inp.price-1;
  document.getElementById('rpc-price-delta').textContent=(pDelta>=0?'+':'')+fmt(pDelta*100,1)+'%';
  document.getElementById('rpc-price-delta').style.color=pDelta>=0?'var(--green-dk)':'var(--red-dk)';
  drawIRRChart(inp.price,baseIRR,inp.disc,price);
}

function resetRevPrice(){
  _revExplorePrice=null;_irrDragPrice=null;
  const inp=buildInp(getInputs());
  if(!inp)return;
  const pMin=inp.price*.10,pMax=inp.price*3.0;
  const defaultSliderVal=Math.round((inp.price-pMin)/(pMax-pMin)*100);
  const sl=document.getElementById('rev-sl-price');
  sl.value=defaultSliderVal;
  sl.style.background=`linear-gradient(90deg,var(--blue) ${defaultSliderVal}%,var(--border) ${defaultSliderVal}%)`;
  document.getElementById('rev-price-display').textContent=fmt(inp.price,2);
  document.getElementById('rpc-result-row').style.display='none';
  drawIRRChart(inp.price,impliedIRR(inp,inp.price),inp.disc,null);
}

function resetIRRDrag(){resetRevPrice();}

function initIRRDrag(){
  const cv=document.getElementById('chart-irr');
  let dragging=false;

  function getClosestPoint(clientX){
    const rect=cv.getBoundingClientRect();
    const x=clientX-rect.left;
    const W=rect.width;
    const PAD_L=52,PAD_R=24;
    const cw=W-PAD_L-PAD_R;
    if(_revData.length<2)return null;
    const prices=_revData.map(d=>d.price);
    const minP=Math.min(...prices),maxP=Math.max(...prices);
    const frac=Math.max(0,Math.min(1,(x-PAD_L)/cw));
    const price=minP+frac*(maxP-minP);
    let best=null,bestDist=Infinity;
    _revData.forEach(d=>{const d2=Math.abs(d.price-price);if(d2<bestDist){bestDist=d2;best=d}});
    return best;
  }

  function handleMove(clientX){
    const pt=getClosestPoint(clientX);
    if(!pt)return;
    const inp=buildInp(getInputs());
    if(!inp)return;
    // Map the point back to slider 0-100
    const pMin=inp.price*.10,pMax=inp.price*3.0;
    const sliderVal=Math.round(Math.max(0,Math.min(100,(pt.price-pMin)/(pMax-pMin)*100)));
    const sl=document.getElementById('rev-sl-price');
    if(sl){sl.value=sliderVal;}
    onRevPriceChange(sliderVal);
  }

  cv.addEventListener('mousedown',e=>{dragging=true;handleMove(e.clientX)});
  cv.addEventListener('mousemove',e=>{if(dragging)handleMove(e.clientX)});
  window.addEventListener('mouseup',()=>dragging=false);
  cv.addEventListener('touchstart',e=>{dragging=true;handleMove(e.touches[0].clientX)},{passive:true});
  cv.addEventListener('touchmove',e=>{if(dragging)handleMove(e.touches[0].clientX)},{passive:true});
  window.addEventListener('touchend',()=>dragging=false);
  cv.addEventListener('click',e=>handleMove(e.clientX));
}

function drawIRRChart(curPrice,curIRR,userDisc,dragPrice){
  const cv=document.getElementById('chart-irr'),ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1,W=cv.offsetWidth,H=220;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  if(_revData.length<2)return;
  const hurdleRate=userDisc!==undefined?userDisc*100:12;
  const PAD={t:16,r:24,b:36,l:52},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;
  const prices=_revData.map(d=>d.price),irrs=_revData.map(d=>d.irr*100);
  const minP=Math.min(...prices),maxP=Math.max(...prices);
  const minI=Math.min(...irrs,hurdleRate-10)*1.06,maxI=Math.max(...irrs,hurdleRate+10)*1.06;
  const xp=p=>PAD.l+(p-minP)/(maxP-minP)*cw;
  const yp=v=>PAD.t+ch-(v-minI)/(maxI-minI)*ch;
  const ink3=cssVar('--ink-3')||'#4D4943';
  const ink4=cssVar('--ink-4')||'#7A756D';
  const ink5=cssVar('--ink-5')||'#A9A49B';
  const surfBg=cssVar('--surface')||'#FAF8F3';
  const bgColor=cssVar('--bg')||'#F3EFE7';
  const blueColor=cssVar('--blue')||'#2B5D8E';
  const bluePill=cssVar('--blue-pill')||'#1E4A74';
  const goldPill=cssVar('--gold-pill')||'#6E5018';
  const greenColor=cssVar('--green')||'#2E7048';
  const redColor=cssVar('--red')||'#A8382E';

  // ── Background
  ctx.fillStyle=surfBg;
  ctx.beginPath();
  ctx.roundRect?ctx.roundRect(PAD.l,PAD.t,cw,ch,4):ctx.rect(PAD.l,PAD.t,cw,ch);
  ctx.fill();

  // ── Grid lines
  const yTicks=5;
  for(let i=0;i<=yTicks;i++){
    const y=PAD.t+i*ch/yTicks;
    const val=minI+(maxI-minI)*(1-i/yTicks);
    ctx.strokeStyle=i===0||i===yTicks?'rgba(28,26,22,.1)':'rgba(28,26,22,.05)';
    ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle=ink5;ctx.font=`500 10.5px 'JetBrains Mono', monospace`;ctx.textAlign='right';
    ctx.fillText(fmt(val,0)+'%',PAD.l-6,y+3.5);
  }
  // x-axis ticks: price range
  const xTicks=5;
  for(let i=0;i<=xTicks;i++){
    const x=PAD.l+i*cw/xTicks;
    const pval=minP+(maxP-minP)*i/xTicks;
    ctx.strokeStyle='rgba(28,26,22,.04)';ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`10.5px 'JetBrains Mono', monospace`;ctx.textAlign='center';
    ctx.fillText(fmt(pval,0),x,PAD.t+ch+16);
  }

  // ── Coloured fill zones (above = green, below = red)
  const hy=yp(hurdleRate);
  // Green zone above hurdle
  const aH=_revData.filter(d=>d.irr*100>=hurdleRate);
  if(aH.length){
    ctx.save();ctx.beginPath();
    ctx.moveTo(PAD.l,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t+ch);ctx.lineTo(PAD.l,PAD.t+ch);ctx.closePath();ctx.clip();
    const grad=ctx.createLinearGradient(0,PAD.t,0,hy);
    grad.addColorStop(0,'rgba(26,122,60,.14)');
    grad.addColorStop(1,'rgba(26,122,60,.04)');
    ctx.beginPath();
    ctx.moveTo(xp(aH[0].price),hy);
    aH.forEach(d=>ctx.lineTo(xp(d.price),yp(d.irr*100)));
    ctx.lineTo(xp(aH[aH.length-1].price),hy);
    ctx.closePath();ctx.fillStyle=grad;ctx.fill();
    ctx.restore();
  }
  // Red zone below hurdle
  const bH=_revData.filter(d=>d.irr*100<hurdleRate);
  if(bH.length){
    ctx.save();ctx.beginPath();
    ctx.moveTo(PAD.l,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t);ctx.lineTo(PAD.l+cw,PAD.t+ch);ctx.lineTo(PAD.l,PAD.t+ch);ctx.closePath();ctx.clip();
    const gradR=ctx.createLinearGradient(0,hy,0,PAD.t+ch);
    gradR.addColorStop(0,'rgba(192,57,43,.04)');
    gradR.addColorStop(1,'rgba(192,57,43,.14)');
    ctx.beginPath();
    ctx.moveTo(xp(bH[0].price),hy);
    bH.forEach(d=>ctx.lineTo(xp(d.price),yp(d.irr*100)));
    ctx.lineTo(xp(bH[bH.length-1].price),hy);
    ctx.closePath();ctx.fillStyle=gradR;ctx.fill();
    ctx.restore();
  }

  // ── Required return reference line (dashed only — label shown below chart in legend)
  if(hy>=PAD.t&&hy<=PAD.t+ch){
    ctx.setLineDash([6,4]);ctx.strokeStyle=ink4;ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(PAD.l,hy);ctx.lineTo(PAD.l+cw,hy);ctx.stroke();
    ctx.setLineDash([]);
  }

  // ── IRR curve
  ctx.setLineDash([]);
  ctx.shadowColor='rgba(26,92,152,.18)';ctx.shadowBlur=8;
  ctx.strokeStyle=blueColor;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';
  ctx.beginPath();
  _revData.forEach((d,i)=>{if(i===0)ctx.moveTo(xp(d.price),yp(d.irr*100));else ctx.lineTo(xp(d.price),yp(d.irr*100))});
  ctx.stroke();ctx.shadowBlur=0;

  // ── Current price marker (vertical line + label)
  {
    const cx=xp(curPrice);
    ctx.setLineDash([3,4]);ctx.strokeStyle=ink4;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(cx,PAD.t+ch);ctx.lineTo(cx,PAD.t);ctx.stroke();
    ctx.setLineDash([]);
    // Price label at bottom
    const pLbl=fmt(curPrice,2);
    ctx.font=`600 11.5px 'JetBrains Mono', monospace`;
    const pw=ctx.measureText(pLbl).width+10;
    ctx.fillStyle=bluePill;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(cx-pw/2,PAD.t+ch+4,pw,16,4):ctx.rect(cx-pw/2,PAD.t+ch+4,pw,16);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(pLbl,cx,PAD.t+ch+15.5);
  }

  // ── Current price dot (the main blue circle)
  if(curIRR!==null){
    const cx=xp(curPrice),cy=yp(curIRR*100);
    // Drop line to x-axis
    ctx.setLineDash([3,4]);ctx.strokeStyle='rgba(26,92,152,.3)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(cx,PAD.t+ch);ctx.lineTo(cx,cy+7);ctx.stroke();ctx.setLineDash([]);
    // Dot
    ctx.beginPath();ctx.arc(cx,cy,6.5,0,Math.PI*2);
    ctx.fillStyle=blueColor;ctx.fill();
    ctx.strokeStyle=surfBg;ctx.lineWidth=2.5;ctx.stroke();
    // IRR label above dot
    const lbl=fmt(curIRR*100,1)+'%';
    ctx.font=`bold 12px 'JetBrains Mono', monospace`;
    const lw=ctx.measureText(lbl).width+12;
    const lx=Math.min(Math.max(cx-lw/2,PAD.l),PAD.l+cw-lw);
    const ly=cy-30;
    ctx.fillStyle=bluePill;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(lx,ly,lw,20,5):ctx.rect(lx,ly,lw,20);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(lbl,cx,ly+14);
    // Small pointer triangle
    ctx.beginPath();ctx.moveTo(cx-5,cy-11);ctx.lineTo(cx+5,cy-11);ctx.lineTo(cx,cy-5);
    ctx.fillStyle=bluePill;ctx.fill();
  }

  // ── Drag price marker (orange/gold, distinct from current)
  if(dragPrice!==null&&dragPrice!==undefined&&Math.abs(dragPrice-curPrice)>0.5){
    const dx=xp(dragPrice);
    const dragData=_revData.find(d=>Math.abs(d.price-dragPrice)<0.01)||_revData.reduce((a,b)=>Math.abs(b.price-dragPrice)<Math.abs(a.price-dragPrice)?b:a);
    const dy=yp(dragData.irr*100);
    // Highlight the explored price at x-axis
    const pLbl=fmt(dragData.price,2);
    ctx.font=`600 11.5px 'JetBrains Mono', monospace`;
    const pw=ctx.measureText(pLbl).width+10;
    ctx.fillStyle=goldPill;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(dx-pw/2,PAD.t+ch+4,pw,16,4):ctx.rect(dx-pw/2,PAD.t+ch+4,pw,16);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(pLbl,dx,PAD.t+ch+15.5);
    // Drag dot
    ctx.beginPath();ctx.arc(dx,dy,6.5,0,Math.PI*2);
    const goldColor=cssVar('--gold')||'#9E7528';
    ctx.fillStyle=goldColor;ctx.fill();
    ctx.strokeStyle=surfBg;ctx.lineWidth=2.5;ctx.stroke();
    // IRR label
    const irrlbl=fmt(dragData.irr*100,1)+'%';
    ctx.font=`bold 12px 'JetBrains Mono', monospace`;
    const lw=ctx.measureText(irrlbl).width+12;
    const lx=Math.min(Math.max(dx-lw/2,PAD.l),PAD.l+cw-lw);
    const ly=dy-30;
    ctx.fillStyle=goldPill;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(lx,ly,lw,20,5):ctx.rect(lx,ly,lw,20);
    ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(irrlbl,dx,ly+14);
    ctx.beginPath();ctx.moveTo(dx-5,dy-11);ctx.lineTo(dx+5,dy-11);ctx.lineTo(dx,dy-5);
    ctx.fillStyle=goldPill;ctx.fill();
  }

  // ── Axis labels
  ctx.setLineDash([]);
  ctx.fillStyle=ink4;ctx.font=`11px 'DM Sans', sans-serif`;ctx.textAlign='center';
  ctx.fillText('Stock price ('+((buildInp(getInputs())||{}).pccy||'')+')',PAD.l+cw/2,H-4);
  ctx.save();ctx.translate(11,PAD.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillText('Implied annual return (%)',0,0);ctx.restore();
}

function renderRevTable(inp){
  const t=document.getElementById('rev-tbl'); if(!t) return;
  const prices=[];for(let i=-5;i<=5;i++){const p=inp.price*(1+.1*i);if(p>0)prices.push(p)}
  let h=`<thead><tr><th>Price</th><th>vs today</th><th>Implied return</th></tr></thead><tbody>`;
  prices.forEach(p=>{
    const r=impliedIRR(inp,p);const vs=p/inp.price-1;const isCur=Math.abs(p-inp.price)<.01;
    const{bg,fg}=r!==null?irrColor(r):{bg:'var(--surface-2)',fg:'var(--ink-4)'};
    h+=`<tr ${isCur?'style="font-weight:700;background:var(--blue-bg)"':''}><td>${fmt(p,2)}</td><td>${fmtPct(vs)}</td><td style="background:${bg};color:${fg};text-align:center">${r!==null?fmt(r*100,2)+'%':'—'}</td></tr>`;
  });
  t.innerHTML=h+'</tbody>';
}

/* ══════════════════════════════════════════
   TAB 3 — SCENARIO GRID
══════════════════════════════════════════ */
function renderMatrix(inp){
  if(!inp)inp=buildInp(getInputs());
  const show=!!inp;
  document.getElementById('matrix-empty').style.display=show?'none':'';
  document.getElementById('matrix-content').style.display=show?'':'none';
  if(!show)return;
  const isM=inp.termMode==='multiple';
  const gMin=parseFloat(document.getElementById('mc-gmin').value)||0;
  const gMax=parseFloat(document.getElementById('mc-gmax').value)||20;
  const gRows=Math.max(2,Math.min(12,parseInt(document.getElementById('mc-grows').value)||6));
  const tMin=parseFloat(document.getElementById('mc-tmin').value)||(isM?8:0);
  const tMax=parseFloat(document.getElementById('mc-tmax').value)||(isM?16:4);
  const tCols=Math.max(2,Math.min(10,parseInt(document.getElementById('mc-tcols').value)||5));
  const growths=linspace(gMin/100,gMax/100,gRows);
  const terminals=linspace(isM?tMin:tMin/100,isM?tMax:tMax/100,tCols);
  const scenarios=[
    {key:'bear',label:'Bear',desc:'Margins fall 1% per year',dpp:-.01},
    {key:'base',label:'Base',desc:'Margins stay the same',dpp:0},
    {key:'bull',label:'Bull',desc:'Margins rise 1% per year',dpp:+.01},
  ];

  // Compute medians for the strip
  const medians=scenarios.map(sc=>{
    const irrs=[];
    growths.forEach(g=>{
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
        const lastFCF=ci.revLTM*Math.pow(1+ci.cagr,ci.years)*(ci.fcfMargin+ci.dpp*ci.years);
        if(!isFinite(lastFCF)||lastFCF<=0)return;
        const irr=impliedIRR(ci,ci.price);
        if(irr!==null)irrs.push(irr);
      });
    });
    irrs.sort((a,b)=>a-b);
    const median=irrs.length?irrs[Math.floor(irrs.length/2)]:null;
    return{...sc,median,count:irrs.length};
  });

  const termLabel=isM?'exit multiple':'terminal growth';
  const termRange=isM?`${fmt(tMin,0)}–${fmt(tMax,0)}×`:`${fmt(tMin,1)}–${fmt(tMax,1)}%`;
  const growRange=`${fmt(gMin,0)}–${fmt(gMax,0)}% revenue growth`;

  document.getElementById('sc-strip').innerHTML=`
    <div class="sc-strip-title">Median implied return — across all ${gRows}×${tCols} combinations</div>
    <div class="sc-strip-sub">Each number is the middle result from every row and column combination, at ${growRange} and ${termRange} ${termLabel}.</div>
    <div class="sc-cols">
      ${medians.map(s=>{
        return `<div class="sc-col sc-col-${s.key}">
          <div class="sc-col-name">${s.label}</div>
          <div class="sc-col-desc">${s.desc}</div>
          <div class="sc-col-irr">${s.median!==null?fmt(s.median*100,1)+'%':'—'}</div>
          <div class="sc-col-meta">${s.count} scenarios computed</div>
        </div>`;
      }).join('')}
    </div>`;

  // ── Matrix warning banner: explain blank cells if many are invalid
  const totalCells=gRows*tCols*3; // 3 scenarios
  const computedCells=medians.reduce((s,m)=>s+m.count,0);
  const blankFraction=1-(computedCells/totalCells);
  const matrixWarn=document.getElementById('matrix-warn');
  if(blankFraction>0.3){
    const warnItems=[];
    if(inp.termMode==='growth'){
      const tooHigh=terminals.filter(tv=>tv>=inp.disc);
      if(tooHigh.length)warnItems.push({icon:'⚡',text:`${tooHigh.length} terminal growth column${tooHigh.length>1?'s':''} (${tooHigh.map(v=>fmt(v*100,1)+'%').join(', ')}) meet or exceed the discount rate (${fmt(inp.disc*100,0)}%). Gordon Growth breaks down when g ≥ r — those cells show "—". → Reduce the terminal growth range, or raise the discount rate on the Fair Value tab.`});
    }
    const badGrowths=growths.filter(g=>{const fm=inp.fcfMargin+inp.dpp*g*inp.years;return fm<=0});
    if(badGrowths.length)warnItems.push({icon:'📉',text:`At low growth rates, FCF margin falls negative before the forecast ends — those cells show "—". → Increase the minimum growth rate, reduce the margin decline, or shorten the forecast period.`});
    if(!warnItems.length)warnItems.push({icon:'🔧',text:`Many cells cannot be solved with the current assumptions. → Try adjusting the terminal value range, growth range, or discount rate until fewer cells show "—".`});
    matrixWarn.style.display='';
    matrixWarn.innerHTML=`
      <div class="cw-head"><div class="cw-icon">⚠️</div><div class="cw-title">${Math.round(blankFraction*100)}% of cells cannot be calculated</div></div>
      <div class="cw-body">Cells showing "—" have no valid mathematical solution under these assumptions. Most common reasons:</div>
      <div class="cw-list">${warnItems.map(w=>`<div class="cw-item"><span class="cw-item-icon">${w.icon}</span><span>${w.text}</span></div>`).join('')}</div>`;
  } else {
    matrixWarn.style.display='none';
  }

  let html='';
  scenarios.forEach(sc=>{
    html+=`<div class="sc-tag sc-tag-${sc.key}">${sc.label} — ${sc.desc}</div>`;
    html+=`<div class="hm-tbl-wrap" style="margin-bottom:6px"><table class="hm-tbl">`;
    html+=`<thead><tr><th class="rh">Growth ↓ / Terminal →</th>`;
    terminals.forEach(tv=>html+=`<th>${isM?fmt(tv,1)+'×':fmt(tv*100,1)+'%'}</th>`);
    html+=`</tr></thead><tbody>`;
    growths.forEach(g=>{
      html+=`<tr><th class="rh" style="background:var(--surface-2);text-align:left;padding:6px 8px;color:var(--ink-3);font-weight:500">${fmt(g*100,1)}%</th>`;
      terminals.forEach(tv=>{
        const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
        if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
        const lastFCF=ci.revLTM*Math.pow(1+ci.cagr,ci.years)*(ci.fcfMargin+ci.dpp*ci.years);
        if(!isFinite(lastFCF)||lastFCF<=0){html+=`<td><div class="hm-cell" style="background:var(--surface-2);color:var(--ink-4)">—</div></td>`;return}
        const irr=impliedIRR(ci,ci.price);
        if(irr===null){html+=`<td><div class="hm-cell" style="background:var(--surface-2);color:var(--ink-4)">—</div></td>`;return}
        const{bg,fg}=irrColor(irr);
        html+=`<td><div class="hm-cell" style="background:${bg};color:${fg}">${fmt(irr*100,1)}%</div></td>`;
      });
      html+=`</tr>`;
    });
    html+=`</tbody></table></div>`;
    html+=`<button class="btn-dl" onclick="downloadMatrix(${JSON.stringify(sc.label)})">⬇ Download CSV</button><div style="height:8px"></div>`;
  });
  document.getElementById('matrix-tables').innerHTML=html;
  document.getElementById('matrix-tables').style.display=_matrixView==='table'?'':'none';
  document.getElementById('mx-hm-legend').style.display=_matrixView==='table'?'':'none';
  document.getElementById('mx-chart-card').style.display=_matrixView==='chart'?'':'none';
  window._matrixState={inp,growths,terminals,scenarios,isM};
  if(_matrixView==='chart')setTimeout(()=>drawMatrixChart(_matrixChartScenario),50);
}

/* ══════════════════════════════════════════
   MATRIX VIEW TOGGLE & CHART
══════════════════════════════════════════ */
let _matrixView='table',_matrixChartScenario='base';

function setMatrixView(v){
  _matrixView=v;
  document.getElementById('mx-btn-table').classList.toggle('active',v==='table');
  document.getElementById('mx-btn-chart').classList.toggle('active',v==='chart');
  document.getElementById('mx-hm-legend').style.display=v==='table'?'':'none';
  document.getElementById('mx-chart-card').style.display=v==='chart'?'':'none';
  document.getElementById('matrix-tables').style.display=v==='table'?'':'none';
  document.getElementById('mc-ctrl').style.display='';
  if(v==='chart')drawMatrixChart(_matrixChartScenario);
}

function setMatrixChartScenario(sc,btn){
  _matrixChartScenario=sc;
  document.querySelectorAll('#mx-chart-scenario-tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  drawMatrixChart(sc);
}

function drawMatrixChart(scenarioKey){
  if(!window._matrixState)return;
  const{inp,growths,terminals,scenarios,isM}=window._matrixState;
  const sc=scenarios.find(s=>s.key===scenarioKey)||scenarios[1];
  const cv=document.getElementById('chart-matrix'),ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1,W=cv.offsetWidth,H=260;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  const PAD={t:20,r:16,b:36,l:52},cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;

  // ── Compute for each growth rate: min, median, max across terminal values
  const bands=growths.map(g=>{
    const irrs=terminals.map(tv=>{
      const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};
      if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}
      return impliedIRR(ci,ci.price);
    }).filter(v=>v!==null).map(v=>v*100).sort((a,b)=>a-b);
    if(!irrs.length)return null;
    return{
      g:g*100,
      min:irrs[0],
      max:irrs[irrs.length-1],
      median:irrs[Math.floor(irrs.length/2)],
      q1:irrs[Math.floor(irrs.length*.25)],
      q3:irrs[Math.floor(irrs.length*.75)]
    };
  }).filter(Boolean);

  if(!bands.length){
    ctx.fillStyle=cssVar('--ink-4');ctx.font=`12px 'DM Sans'`;ctx.textAlign='center';
    ctx.fillText('Not enough data',W/2,H/2);return;
  }

  const allIRRs=bands.flatMap(b=>[b.min,b.max]);
  const userDisc=(inp.disc||0.12)*100;
  const rawMin=Math.min(...allIRRs,userDisc);
  const rawMax=Math.max(...allIRRs,userDisc);
  const pad=(rawMax-rawMin)*.12;
  const minI=rawMin-pad,maxI=rawMax+pad;
  const minG=bands[0].g,maxG=bands[bands.length-1].g;
  const xp=g=>PAD.l+(g-minG)/(Math.max(maxG-minG,0.001))*cw;
  const yp=v=>PAD.t+ch-(v-minI)/(maxI-minI)*ch;

  const ink3=cssVar('--ink-3')||'#4D4943';
  const ink4=cssVar('--ink-4')||'#7A756D';
  const ink5=cssVar('--ink-5')||'#A9A49B';
  const surf=cssVar('--surface')||'#FAF8F3';
  const blueColor=cssVar('--blue')||'#2B5D8E';
  const scColors={bear:cssVar('--red')||'#A8382E',base:cssVar('--blue')||'#2B5D8E',bull:cssVar('--green')||'#2E7048'};
  const col=scColors[scenarioKey]||blueColor;

  // ── Background
  ctx.fillStyle=surf;
  ctx.beginPath();
  ctx.roundRect?ctx.roundRect(PAD.l,PAD.t,cw,ch,4):ctx.rect(PAD.l,PAD.t,cw,ch);
  ctx.fill();

  // ── Colour zone: above/below user's required return
  const hy=yp(userDisc);
  if(hy>PAD.t&&hy<PAD.t+ch){
    // green above
    ctx.fillStyle='rgba(26,122,60,.06)';
    ctx.fillRect(PAD.l,PAD.t,cw,Math.max(0,hy-PAD.t));
    // red below
    ctx.fillStyle='rgba(192,57,43,.05)';
    ctx.fillRect(PAD.l,hy,cw,Math.max(0,PAD.t+ch-hy));
  }

  // ── Grid
  for(let i=0;i<=4;i++){
    const y=PAD.t+i*ch/4;
    const val=minI+(maxI-minI)*(1-i/4);
    ctx.strokeStyle=i===0||i===4?'rgba(28,26,22,.09)':'rgba(28,26,22,.05)';
    ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cw,y);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`500 10.5px 'JetBrains Mono', monospace`;ctx.textAlign='right';
    ctx.fillText(fmt(val,1)+'%',PAD.l-6,y+3.5);
  }
  bands.forEach(b=>{
    const x=xp(b.g);
    ctx.strokeStyle='rgba(28,26,22,.04)';ctx.lineWidth=1;ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,PAD.t+ch);ctx.stroke();
    ctx.fillStyle=ink4;ctx.font=`10.5px 'JetBrains Mono', monospace`;ctx.textAlign='center';
    ctx.fillText(fmt(b.g,0)+'%',x,PAD.t+ch+16);
  });

  // ── User's required return — dashed line only (label shown in legend below)
  if(hy>=PAD.t&&hy<=PAD.t+ch){
    ctx.setLineDash([5,4]);ctx.strokeStyle='rgba(74,70,64,.5)';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.moveTo(PAD.l,hy);ctx.lineTo(PAD.l+cw,hy);ctx.stroke();
    ctx.setLineDash([]);
  }

  // ── Min-max band (wide, very transparent)
  ctx.beginPath();
  bands.forEach((b,i)=>{if(i===0)ctx.moveTo(xp(b.g),yp(b.max));else ctx.lineTo(xp(b.g),yp(b.max))});
  [...bands].reverse().forEach(b=>ctx.lineTo(xp(b.g),yp(b.min)));
  ctx.closePath();
  ctx.fillStyle=col.replace('#','')===col?col+'28':`${col}28`;
  // Build rgba manually
  const hexToRGBA=(hex,a)=>{const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b2=parseInt(hex.slice(5,7),16);return`rgba(${r},${g},${b2},${a})`};
  const colHex=col.startsWith('#')?col:'#2B5D8E';
  ctx.fillStyle=hexToRGBA(colHex,0.08);ctx.fill();

  // ── Q1-Q3 band (narrower, more visible)
  if(bands[0].q1!==undefined){
    ctx.beginPath();
    bands.forEach((b,i)=>{if(i===0)ctx.moveTo(xp(b.g),yp(b.q3));else ctx.lineTo(xp(b.g),yp(b.q3))});
    [...bands].reverse().forEach(b=>ctx.lineTo(xp(b.g),yp(b.q1)));
    ctx.closePath();ctx.fillStyle=hexToRGBA(colHex,0.14);ctx.fill();
  }

  // ── Median line
  ctx.shadowColor=hexToRGBA(colHex,0.2);ctx.shadowBlur=8;
  ctx.strokeStyle=colHex;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';ctx.setLineDash([]);
  ctx.beginPath();
  bands.forEach((b,i)=>{if(i===0)ctx.moveTo(xp(b.g),yp(b.median));else ctx.lineTo(xp(b.g),yp(b.median))});
  ctx.stroke();ctx.shadowBlur=0;

  // ── Min/max boundary lines (thin, dashed)
  [bands.map(b=>({x:xp(b.g),y:yp(b.max)})),bands.map(b=>({x:xp(b.g),y:yp(b.min)}))].forEach((pts,pi)=>{
    ctx.setLineDash([3,4]);ctx.strokeStyle=hexToRGBA(colHex,0.3);ctx.lineWidth=1;
    ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
  });
  ctx.setLineDash([]);

  // ── Dots on median line
  bands.forEach(b=>{
    const bx=xp(b.g),by=yp(b.median);
    ctx.beginPath();ctx.arc(bx,by,3.5,0,Math.PI*2);
    ctx.fillStyle=colHex;ctx.fill();
    ctx.strokeStyle=surf;ctx.lineWidth=1.5;ctx.stroke();
  });

  // ── Axis labels
  ctx.setLineDash([]);
  ctx.fillStyle=ink4;ctx.font=`11px 'DM Sans', sans-serif`;ctx.textAlign='center';
  ctx.fillText('Revenue growth rate (% per year)',PAD.l+cw/2,H-4);
  ctx.save();ctx.translate(11,PAD.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillText('Implied annual return (%)',0,0);ctx.restore();

  // ── Terminal value count annotation
  ctx.fillStyle=ink4;ctx.font=`10px 'DM Sans', sans-serif`;ctx.textAlign='left';
  ctx.fillText(`Range across ${terminals.length} terminal value${terminals.length>1?'s':''}`,PAD.l+4,PAD.t+ch-5);
}

/* ══════════════════════════════════════════
   CSV
══════════════════════════════════════════ */
function dlCSV(fn,rows){const c=rows.map(r=>r.map(c=>`"${String(c).replace(/\u2009/g,'').replace(/"/g,'""')}"`).join(',')).join('\n');const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(c);a.download=fn;a.click()}
function downloadForecast(){const rows=[['Year','Revenue (M)','FCF margin','Free cash flow (M)','Discount factor','Value today (M)']];_forecastRows.forEach(r=>rows.push([r.year,fmt(r.rev,0),fmtPctPlain(r.marg,2),fmt(r.fcf,0),fmt(r.df,4),fmt(r.discFcf,0)]));dlCSV('forecast.csv',rows)}
function downloadRevDCF(){const inp=buildInp(getInputs());if(!inp)return;const rows=[['Price','vs today','Implied return']];for(let i=-5;i<=5;i++){const p=inp.price*(1+.1*i);if(p>0){const r=impliedIRR(inp,p);rows.push([fmt(p,2),fmtPct(p/inp.price-1),r!==null?fmt(r*100,2)+'%':'—'])}}dlCSV('reverse_dcf.csv',rows)}
function downloadMatrix(scLabel){
  if(!window._matrixState)return;
  const{inp,growths,terminals,scenarios,isM}=window._matrixState;
  const sc=scenarios.find(s=>s.label===scLabel);if(!sc)return;
  const hdr=['Growth \\ Terminal'].concat(terminals.map(tv=>isM?fmt(tv,1)+'×':fmt(tv*100,1)+'%'));
  const rows=[hdr];
  growths.forEach(g=>{const row=[fmt(g*100,1)+'%'];terminals.forEach(tv=>{const ci={...inp,cagr:g,dpp:inp.dpp+sc.dpp};if(isM){ci.termMode='multiple';ci.tmult=tv}else{ci.termMode='growth';ci.tg=tv}const irr=impliedIRR(ci,ci.price);row.push(irr!==null?fmt(irr*100,2)+'%':'—')});rows.push(row)});
  dlCSV(`irr_matrix_${sc.label.toLowerCase()}.csv`,rows);
}

/* ══════════════════════════════════════════
   COMPANY DATABASE + LIVE END-OF-DAY PRICE
   Fundamentals: manually curated, updated Feb 2026
   Price: Polygon.io free tier (prev close, CORS-safe)
══════════════════════════════════════════ */

// ── Your Polygon.io API key ─────────────────────────────────────────
// Free at polygon.io — end-of-day data, no CORS issues

// ── Search input handlers ─────────────────────────────────────────
let _searchTimer = null;
let _dropFocusIdx = -1;
let _lastResults = [];
let _blurTimer = null;

function onTickerInput(val) {
  const clear = document.getElementById('ticker-clear');
  if (clear) clear.style.display = val ? 'block' : 'none';
  clearTimeout(_searchTimer);
  if (!val.trim()) { closeDropdown(); return; }
  const results = searchDB(val.trim());
  _lastResults = results;
  renderDropdown(results, val.trim());
}

function onTickerFocus() {
  const val = document.getElementById('ticker-search').value.trim();
  if (val && _lastResults.length) renderDropdown(_lastResults, val);
}

function onTickerBlur() {
  _blurTimer = setTimeout(closeDropdown, 200);
}

function onTickerKey(e) {
  const dd = document.getElementById('ticker-dropdown');
  if (!dd.classList.contains('open')) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); moveFocus(1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); moveFocus(-1); }
  else if (e.key === 'Enter') {
    e.preventDefault();
    const pick = _lastResults[_dropFocusIdx] || (_lastResults.length === 1 ? _lastResults[0] : null);
    if (pick) pickTicker(pick.t);
  }
  else if (e.key === 'Escape') { closeDropdown(); document.getElementById('ticker-search').blur(); }
}

function moveFocus(dir) {
  const items = document.querySelectorAll('.td-item');
  if (!items.length) return;
  _dropFocusIdx = Math.max(0, Math.min(_lastResults.length - 1, _dropFocusIdx + dir));
  items.forEach((el, i) => el.classList.toggle('focused', i === _dropFocusIdx));
  items[_dropFocusIdx]?.scrollIntoView({ block:'nearest' });
}

function clearTickerSearch() {
  const inp = document.getElementById('ticker-search');
  inp.value = '';
  const clear = document.getElementById('ticker-clear');
  if (clear) clear.style.display = 'none';
  closeDropdown();
  inp.focus();
}

function closeDropdown() {
  const dd = document.getElementById('ticker-dropdown');
  if (dd) dd.classList.remove('open');
  _dropFocusIdx = -1;
}

// ── Local DB search ─────────────────────────────────────────────────
function searchDB(q) {
  const s = q.toLowerCase();
  const exact    = DB.filter(c => c.t.toLowerCase() === s);
  const startT   = DB.filter(c => c.t.toLowerCase().startsWith(s) && c.t.toLowerCase() !== s);
  const startN   = DB.filter(c => c.n.toLowerCase().startsWith(s));
  const containN = DB.filter(c => c.n.toLowerCase().includes(s) && !c.n.toLowerCase().startsWith(s));
  const seen = new Set();
  return [...exact, ...startT, ...startN, ...containN]
    .filter(c => { if (seen.has(c.t)) return false; seen.add(c.t); return true; })
    .slice(0, 7);
}

// Highlight matching text
function highlight(text, q) {
  if (!q) return text;
  const idx = text.toLowerCase().indexOf(q.toLowerCase());
  if (idx < 0) return text;
  return text.slice(0, idx) +
    `<strong style="color:var(--blue)">${text.slice(idx, idx + q.length)}</strong>` +
    text.slice(idx + q.length);
}

function renderDropdown(results, q = '') {
  const dd = document.getElementById('ticker-dropdown');
  if (!results.length) {
    dd.innerHTML = `<div class="td-empty">No matches for "<strong>${q}</strong>" in the database.<br><span style="font-size:10.5px;color:var(--ink-5)">Not listed? Enter any company's numbers manually in the fields below.</span></div>`;
    dd.classList.add('open');
    return;
  }
  const rows = results.map((r, i) => {
    const secLabel = SEC_LABEL[r.sec] || r.sec || '';
    return `<div class="td-item" data-i="${i}" onmousedown="pickTicker('${r.t}')">
      <span class="td-ticker">${highlight(r.t, q.toUpperCase())}</span>
      <span class="td-info">
        <span class="td-name">${highlight(r.n, q)}</span>
        <span class="td-sub">${secLabel}</span>
      </span>
      <span class="td-badge">${r.cur}</span>
    </div>`;
  }).join('');
  dd.innerHTML = `<div class="td-header">${results.length} match${results.length > 1 ? 'es' : ''} in database</div>` + rows;
  dd.classList.add('open');
  _dropFocusIdx = -1;
}

function pickTicker(ticker) {
  clearTimeout(_blurTimer);
  closeDropdown();
  document.getElementById('ticker-search').value = '';
  const clear = document.getElementById('ticker-clear');
  if (clear) clear.style.display = 'none';
  loadCompany(ticker);
}

// ── Load company from DB + fetch live EOD price ───────────────────
async function loadCompany(ticker) {
  const co = DB_MAP[ticker];
  if (!co) { showToast('Company not found'); return; }

  clearPills();
  _loadingPreset = true;
  _currentTicker = ticker;

  // ── Populate fundamentals instantly ──
  const filingDate = co.filing || 'Annual report';
  document.getElementById('inp-company').value = co.n + ' (' + co.t + ')';
  document.getElementById('inp-shares').value  = fmt(co.sh, 0);
  document.getElementById('inp-revenue').value = fmt(co.rev, 0);

  // ── SBC: populate editable field ──
  const sbcField = document.getElementById('inp-sbc');
  const sbcWrap = document.getElementById('sbc-field-wrap');
  const subtractSBC = document.getElementById('toggle-sbc').checked;
  if (co.sbc > 0) {
    if (sbcField) sbcField.value = fmt(co.sbc, 0);
  } else {
    if (sbcField) sbcField.value = '';
  }
  if (sbcWrap) sbcWrap.style.display = subtractSBC ? '' : 'none';
  _currentSBC = co.sbc || 0;
  _baseFCF = co.fcf; // Store base FCF for SBC recalculation

  // ── FCF: apply SBC based on toggle ──
  const adjFCF = (subtractSBC && co.sbc > 0) ? _baseFCF - co.sbc : _baseFCF;
  document.getElementById('inp-fcf').value = fmt(adjFCF, 0);
  document.getElementById('inp-netcash').value = '0';

  // ══ DEFAULT ASSUMPTIONS ══
  // Revenue growth: default 10% for all companies
  var defaultGrowth = 10;
  document.getElementById('sl-cagr').value = defaultGrowth;
  document.getElementById('lbl-cagr').textContent = defaultGrowth + '%';
  syncBenchPills();

  // Terminal growth: 2.5% standard, or lower if historical growth is lower
  var defaultTermGrowth = Math.min(2.5, Math.max(defaultGrowth * 0.5, 1));
  if (defaultGrowth <= 2) defaultTermGrowth = Math.min(defaultGrowth, 2);
  document.getElementById('sl-tg').value = defaultTermGrowth;
  var tgLabel = document.getElementById('lbl-tg');
  if (tgLabel) tgLabel.textContent = defaultTermGrowth.toFixed(1) + '%';

  // Margin increase: zero by default, UNLESS FCF is negative
  var defaultDpp = 0;
  var marginWarnEl = document.getElementById('warn-margin-adj');
  if (adjFCF < 0 && co.rev > 0) {
    // Calculate minimum dpp needed to turn FCF positive by end of projection
    var currentMargin = adjFCF / co.rev;
    // Target: at least 5% margin by year 10
    var targetMargin = 0.05;
    var dppNeeded = (targetMargin - currentMargin) / 10;
    defaultDpp = Math.min(Math.round(dppNeeded * 1000) / 10, 5); // cap at 5pp, round to 0.1
    defaultDpp = Math.max(defaultDpp, 0.5); // minimum 0.5pp if negative FCF
  }
  document.getElementById('sl-dpp').value = defaultDpp;
  document.getElementById('lbl-dpp').textContent = defaultDpp.toFixed(1) + 'pp';

  // Discount rate: always 12% default
  document.getElementById('sl-disc').value = 12;
  try { onDiscChange(); } catch(e) {}

  // Currency
  var ccyEls = ['sel-fccy','sel-pccy'];
  for (var ci = 0; ci < ccyEls.length; ci++) {
    var el = document.getElementById(ccyEls[ci]);
    if (el) el.value = co.cur;
  }
  onCurrencyChange();

  // UI chrome
  document.getElementById('btn-reset').style.display = '';
  var hint = document.getElementById('onboard-hint');
  if (hint) { hint.style.animation = 'none'; hint.style.opacity = '0'; }

  // ── Price: always fetch live, never use stored ──
  document.getElementById('inp-price').value = '';
  _loadingPreset = false;
  setDataDates(filingDate, 'Fetching price…');

  // ── Show margin adjustment note if FCF is negative ──
  if (defaultDpp > 0) {
    showToast(co.n + ' loaded ✓ — margin increase applied (negative FCF)');
  } else {
    showToast(co.n + ' loaded ✓');
  }
  
  update();
  tryFetchLivePrice(ticker, filingDate);
}

// (search functions defined above in COMPANY DATABASE section)


let _rt;
window.addEventListener('resize',()=>{clearTimeout(_rt);_rt=setTimeout(()=>{const inp=buildInp(getInputs());if(!inp)return;if(activeTab==='dcf')drawSensChart(inp.price,inp.disc*100);else if(activeTab==='rev'){const irr=impliedIRR(inp,inp.price);drawIRRChart(inp.price,irr,inp.disc,_irrDragPrice)}else if(activeTab==='matrix'&&_matrixView==='chart')drawMatrixChart(_matrixChartScenario)},100)});

// ── Init — runs after DOM is ready, nothing can crash it ──
function _init() {
  try { _bindInputEvents(); } catch(e) {}
  try {
    var savedTheme=_store.get('vs-theme');
    if(savedTheme){
      document.documentElement.setAttribute('data-theme',savedTheme);
      var db=document.getElementById('dark-btn');
      if(db) db.textContent=savedTheme==='dark'?'☀️':'🌙';
    }
    var oh=document.getElementById('onboard-hint');
    if(_store.get('vs-onboarded')&&oh) oh.style.display='none';
  } catch(e) {}
  try { onDiscChange(); } catch(e) {}
  try { syncBenchPills(); } catch(e) {}
  setTimeout(function(){ try{ initIRRDrag(); }catch(e){} }, 200);
  try { loadFromURL(); } catch(e) {}
  if(!window.location.search||window.location.search==='?') {
    try { loadPreset('NFLX',true); } catch(e) {}
  }
}
// Run immediately if DOM ready, else wait
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', _init);
} else {
  _init();
}
// If blank=1, keep fields empty and show onboarding

</script>
</body>
</html>
